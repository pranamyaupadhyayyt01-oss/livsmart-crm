<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Livsmart CRM v3.0 Â· Unified Enterprise Suite</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%2314b8a6'/%3E%3Ctext y='22' x='5' font-size='18'%3EğŸ§ %3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
<!-- Firebase Compat SDK v10 -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<!-- JsSIP for WebRTC Calling -->
<script>
// JsSIP loader with fallback
(function(){
  function loadJsSIP(src, fallback) {
    var s = document.createElement('script');
    s.src = src;
    s.onerror = function() { if(fallback) loadJsSIP(fallback); else console.warn('JsSIP failed to load - SIP calling unavailable'); };
    s.onload = function() { console.log('JsSIP loaded from: ' + src); };
    document.head.appendChild(s);
  }
  loadJsSIP(
    'https://cdnjs.cloudflare.com/ajax/libs/jssip/3.9.1/jssip.min.js',
    'https://cdn.jsdelivr.net/npm/jssip@3.9.1/dist/jssip.min.js'
  );
})();
</script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS VARIABLES & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg: #060a12; --surface: #0b1121; --card: #101828; --card2: #141e30; --card3: #1a2540;
  --border: #1e2d45; --border2: #253650; --border3: #2d4060;
  --teal: #14b8a6; --teal2: #0d9488; --green: #10b981; --red: #ef4444;
  --orange: #f97316; --yellow: #eab308; --blue: #3b82f6; --cyan: #06b6d4;
  --purple: #8b5cf6; --pink: #ec4899; --indigo: #6366f1;
  --text: #f1f5f9; --text2: #cbd5e1; --muted: #64748b; --muted2: #94a3b8;
  --sidebar-w: 250px;
  --shadow: 0 4px 24px rgba(0,0,0,.4);
  --shadow-lg: 0 8px 40px rgba(0,0,0,.5);
  --radius: 12px; --radius-sm: 8px; --radius-lg: 16px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body { background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; min-height: 100vh; overflow-x: hidden; }
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: var(--surface); }
::-webkit-scrollbar-thumb { background: var(--border3); border-radius: 99px; }
a { color: var(--teal); text-decoration: none; }
input, select, textarea, button { font-family: inherit; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loginScreen {
  display: flex; align-items: center; justify-content: center; min-height: 100vh;
  background: var(--bg); position: fixed; inset: 0; z-index: 9999; flex-direction: column;
}
#loginScreen::before {
  content: ''; position: fixed; inset: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 80% 60% at 20% 0%, rgba(20,184,166,.1), transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 100%, rgba(139,92,246,.08), transparent 60%),
    radial-gradient(ellipse 40% 40% at 50% 50%, rgba(59,130,246,.04), transparent 70%);
}
.login-card {
  background: rgba(16,24,40,.95); backdrop-filter: blur(24px);
  border: 1px solid var(--border); border-radius: 24px; padding: 44px;
  width: 100%; max-width: 440px; position: relative; z-index: 1;
  box-shadow: 0 32px 80px rgba(0,0,0,.6), 0 0 0 1px rgba(20,184,166,.05);
  animation: scaleIn .45s cubic-bezier(.34,1.56,.64,1) both;
}
.login-logo { text-align: center; margin-bottom: 36px; }
.login-logo .icon {
  width: 76px; height: 76px; background: linear-gradient(135deg, var(--teal), var(--green));
  border-radius: 22px; display: flex; align-items: center; justify-content: center;
  font-size: 34px; margin: 0 auto 16px; box-shadow: 0 0 50px rgba(20,184,166,.45);
  animation: glowPulse 3s ease-in-out infinite;
}
.login-logo h1 {
  font-size: 28px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase;
  background: linear-gradient(135deg, #fff 30%, var(--teal));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.login-logo p { font-size: 11px; color: var(--muted2); font-family: 'JetBrains Mono', monospace; margin-top: 5px; letter-spacing: 1px; }
.l-label { font-size: 11px; font-weight: 700; color: var(--muted2); text-transform: uppercase; letter-spacing: .6px; font-family: 'JetBrains Mono', monospace; display: block; margin-bottom: 7px; }
.l-inp {
  width: 100%; background: rgba(9,13,22,.9); border: 1px solid var(--border2);
  border-radius: 11px; padding: 13px 16px; color: var(--text); font-size: 14px;
  transition: all .2s; outline: none; margin-bottom: 18px;
}
.l-inp:focus { border-color: var(--teal); box-shadow: 0 0 0 3px rgba(20,184,166,.15); }
.l-inp::placeholder { color: var(--muted); }
.l-btn {
  width: 100%; padding: 15px; border-radius: 11px; border: none;
  background: linear-gradient(135deg, var(--teal), var(--green)); color: #fff;
  font-size: 15px; font-weight: 800; cursor: pointer; transition: all .2s; margin-top: 4px;
}
.l-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(20,184,166,.45); }
.l-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }
.l-err {
  padding: 11px 15px; border-radius: 9px; font-size: 12px; font-weight: 600;
  background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.25); color: #f87171;
  margin-bottom: 16px; display: none; font-family: 'JetBrains Mono', monospace;
}
.login-features { display: flex; gap: 12px; justify-content: center; margin-top: 24px; flex-wrap: wrap; }
.login-feat { font-size: 10px; color: var(--muted); font-family: 'JetBrains Mono', monospace; display: flex; align-items: center; gap: 4px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CRM APP LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#crmApp { display: none; min-height: 100vh; flex-direction: row; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
.sidebar {
  width: var(--sidebar-w); min-width: var(--sidebar-w); background: var(--surface);
  border-right: 1px solid var(--border); display: flex; flex-direction: column;
  position: fixed; top: 0; left: 0; height: 100vh; z-index: 200;
  transition: transform .3s cubic-bezier(.22,1,.36,1);
}
.sidebar-brand { padding: 18px 16px 14px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.sidebar-logo { display: flex; align-items: center; gap: 11px; }
.sidebar-logo-icon {
  width: 40px; height: 40px; background: linear-gradient(135deg, var(--teal), var(--green));
  border-radius: 11px; display: flex; align-items: center; justify-content: center;
  font-size: 20px; box-shadow: 0 0 20px rgba(20,184,166,.35);
  animation: glowPulse 3s ease-in-out infinite; flex-shrink: 0;
}
.sidebar-logo h1 {
  font-size: 15px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase;
  background: linear-gradient(135deg, #fff, var(--teal));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.sidebar-logo span { font-size: 9px; color: var(--muted2); font-family: 'JetBrains Mono', monospace; display: block; margin-top: 1px; }
.sidebar-user {
  padding: 11px 14px; display: flex; align-items: center; gap: 10px;
  background: var(--card); border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.user-avatar {
  width: 36px; height: 36px; border-radius: 10px;
  background: linear-gradient(135deg, var(--purple), var(--pink));
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; font-weight: 800; flex-shrink: 0; color: #fff;
}
.user-info .name { font-size: 12px; font-weight: 700; }
.user-info .role {
  font-size: 9px; color: var(--teal); font-family: 'JetBrains Mono', monospace;
  background: rgba(20,184,166,.1); padding: 1px 7px; border-radius: 4px;
  margin-top: 2px; display: inline-block; text-transform: uppercase;
}

/* Universal Search in sidebar */
.sidebar-search { padding: 10px 12px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.s-search-inp {
  width: 100%; background: var(--card2); border: 1px solid var(--border2);
  border-radius: 8px; padding: 8px 12px; color: var(--text); font-size: 12px;
  font-family: 'JetBrains Mono', monospace; outline: none; transition: border-color .2s;
}
.s-search-inp:focus { border-color: var(--teal); }
.s-search-inp::placeholder { color: var(--muted); }

.sidebar-nav { flex: 1; overflow-y: auto; padding: 8px 0; }
.nav-group-label {
  font-size: 9px; font-weight: 700; color: var(--muted); text-transform: uppercase;
  letter-spacing: 1px; font-family: 'JetBrains Mono', monospace;
  padding: 10px 16px 4px; margin-top: 4px;
}
.nav-item {
  display: flex; align-items: center; gap: 10px; padding: 9px 14px;
  cursor: pointer; transition: all .15s; margin: 1px 8px; border-radius: 8px;
  font-size: 12px; font-weight: 700; color: var(--muted2); letter-spacing: .2px; user-select: none;
  position: relative;
}
.nav-item:hover { background: rgba(255,255,255,.04); color: var(--text); }
.nav-item.active { background: rgba(20,184,166,.13); color: var(--teal); border: 1px solid rgba(20,184,166,.22); }
.nav-item.active::before {
  content: ''; position: absolute; left: -8px; top: 50%; transform: translateY(-50%);
  width: 3px; height: 60%; background: var(--teal); border-radius: 0 2px 2px 0;
}
.nav-icon { font-size: 15px; flex-shrink: 0; width: 20px; text-align: center; }
.nav-badge {
  margin-left: auto; font-size: 9px; padding: 1px 7px; border-radius: 99px;
  background: rgba(20,184,166,.2); color: var(--teal);
  font-family: 'JetBrains Mono', monospace; font-weight: 700;
}
.nav-badge.red { background: rgba(239,68,68,.2); color: var(--red); }
.nav-badge.orange { background: rgba(249,115,22,.2); color: var(--orange); }
.nav-badge.blue { background: rgba(59,130,246,.2); color: var(--blue); }

.sidebar-footer { padding: 10px 8px; border-top: 1px solid var(--border); flex-shrink: 0; }
.logout-btn-sidebar {
  width: 100%; padding: 9px; border-radius: 8px; border: 1px solid rgba(239,68,68,.2);
  background: rgba(239,68,68,.06); color: var(--red); font-size: 12px; font-weight: 700;
  cursor: pointer; transition: all .2s; display: flex; align-items: center; justify-content: center; gap: 6px;
}
.logout-btn-sidebar:hover { background: rgba(239,68,68,.14); }

/* â”€â”€â”€ MAIN CONTENT â”€â”€â”€ */
.main-content { margin-left: var(--sidebar-w); flex: 1; min-height: 100vh; display: flex; flex-direction: column; }

/* â”€â”€â”€ TOPBAR â”€â”€â”€ */
.topbar {
  background: var(--surface); border-bottom: 1px solid var(--border);
  padding: 0 24px; display: flex; align-items: center; gap: 12px; height: 56px;
  position: sticky; top: 0; z-index: 100; flex-shrink: 0;
}
.topbar-title { font-size: 15px; font-weight: 800; letter-spacing: .3px; }
.topbar-breadcrumb { font-size: 10px; color: var(--muted2); font-family: 'JetBrains Mono', monospace; }
.topbar-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
.topbar-date {
  font-size: 11px; color: var(--muted2); font-family: 'JetBrains Mono', monospace;
  background: var(--card); border: 1px solid var(--border); padding: 4px 10px; border-radius: 6px;
}
.live-dot { display: flex; align-items: center; gap: 5px; font-size: 10px; font-family: 'JetBrains Mono', monospace; color: var(--green); }
.live-dot::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: var(--green); box-shadow: 0 0 6px var(--green); display: inline-block; }
#hamburger { display: none; background: none; border: none; color: var(--text); font-size: 20px; cursor: pointer; padding: 4px; }

/* Notification bell */
.notif-btn {
  position: relative; background: var(--card); border: 1px solid var(--border);
  border-radius: 8px; padding: 6px 10px; cursor: pointer; color: var(--muted2);
  font-size: 15px; display: flex; align-items: center; transition: all .2s;
}
.notif-btn:hover { border-color: var(--teal); color: var(--teal); }
.notif-count {
  position: absolute; top: -5px; right: -5px; background: var(--red);
  color: #fff; font-size: 9px; font-weight: 800; width: 16px; height: 16px;
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-family: 'JetBrains Mono', monospace;
}

/* â”€â”€â”€ PANELS â”€â”€â”€ */
.panel-area { flex: 1; overflow-y: auto; padding: 24px; }
.panel { display: none; }
.panel.active { display: block; animation: fadeUp .35s cubic-bezier(.22,1,.36,1) both; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMMON COMPONENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sec-hdr { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
.sec-hdr h2 { font-size: 15px; font-weight: 800; letter-spacing: .5px; text-transform: uppercase; white-space: nowrap; }
.sec-line { flex: 1; height: 1px; background: var(--border); min-width: 20px; }

/* Badges */
.badge { padding: 3px 10px; border-radius: 99px; font-size: 10px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.badge-teal { background: rgba(20,184,166,.12); border: 1px solid rgba(20,184,166,.25); color: var(--teal); }
.badge-blue { background: rgba(59,130,246,.12); border: 1px solid rgba(59,130,246,.25); color: var(--blue); }
.badge-green { background: rgba(16,185,129,.12); border: 1px solid rgba(16,185,129,.25); color: var(--green); }
.badge-red { background: rgba(239,68,68,.12); border: 1px solid rgba(239,68,68,.25); color: var(--red); }
.badge-orange { background: rgba(249,115,22,.12); border: 1px solid rgba(249,115,22,.25); color: var(--orange); }
.badge-purple { background: rgba(139,92,246,.12); border: 1px solid rgba(139,92,246,.25); color: var(--purple); }
.badge-yellow { background: rgba(234,179,8,.12); border: 1px solid rgba(234,179,8,.25); color: var(--yellow); }

/* Cards */
.card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; transition: border-color .2s, box-shadow .2s; }
.card:hover { border-color: var(--border2); }
.card-sm { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; }
.card-hdr { font-size: 11px; font-weight: 700; color: var(--muted2); text-transform: uppercase; letter-spacing: .6px; font-family: 'JetBrains Mono', monospace; margin-bottom: 14px; }

/* Grids */
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
.grid4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
.grid5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }

/* KPI Cards */
.kpi {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 16px; position: relative; overflow: hidden; transition: transform .2s, box-shadow .2s;
}
.kpi:hover { transform: translateY(-3px); box-shadow: 0 8px 28px rgba(0,0,0,.35); }
.kpi::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
.kpi.teal::before { background: linear-gradient(90deg, var(--teal), var(--green)); }
.kpi.blue::before { background: linear-gradient(90deg, var(--blue), var(--cyan)); }
.kpi.green::before { background: linear-gradient(90deg, var(--green), #34d399); }
.kpi.red::before { background: linear-gradient(90deg, var(--red), #f87171); }
.kpi.orange::before { background: linear-gradient(90deg, var(--orange), var(--yellow)); }
.kpi.purple::before { background: linear-gradient(90deg, var(--purple), var(--pink)); }
.kpi.indigo::before { background: linear-gradient(90deg, var(--indigo), var(--blue)); }
.kpi .lbl { font-size: 10px; font-weight: 600; color: var(--muted2); letter-spacing: .8px; text-transform: uppercase; margin-bottom: 6px; font-family: 'JetBrains Mono', monospace; }
.kpi .val { font-size: 26px; font-weight: 800; letter-spacing: -1px; }
.kpi .sub { font-size: 11px; color: var(--muted); margin-top: 4px; }
.kpi .trend { position: absolute; right: 14px; top: 14px; font-size: 18px; }

/* Buttons */
.btn {
  padding: 9px 18px; border-radius: var(--radius-sm); font-size: 12px; font-weight: 700;
  cursor: pointer; border: none; font-family: 'Syne', sans-serif;
  display: inline-flex; align-items: center; gap: 6px;
  transition: all .18s; white-space: nowrap; letter-spacing: .2px;
}
.btn-pri { background: linear-gradient(135deg, var(--teal), var(--green)); color: #fff; box-shadow: 0 3px 14px rgba(20,184,166,.3); }
.btn-pri:hover { transform: translateY(-1px); box-shadow: 0 6px 22px rgba(20,184,166,.42); }
.btn-blue { background: linear-gradient(135deg, var(--blue), var(--cyan)); color: #fff; }
.btn-blue:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(59,130,246,.4); }
.btn-purple { background: linear-gradient(135deg, var(--purple), var(--pink)); color: #fff; }
.btn-purple:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(139,92,246,.4); }
.btn-orange { background: linear-gradient(135deg, var(--orange), var(--yellow)); color: #fff; }
.btn-orange:hover { transform: translateY(-1px); }
.btn-sec { background: rgba(20,184,166,.1); border: 1px solid rgba(20,184,166,.25); color: var(--teal); }
.btn-sec:hover { background: rgba(20,184,166,.18); }
.btn-danger { background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.25); color: var(--red); }
.btn-danger:hover { background: rgba(239,68,68,.18); }
.btn-ghost { background: var(--card2); border: 1px solid var(--border2); color: var(--muted2); }
.btn-ghost:hover { border-color: var(--teal); color: var(--text); }
.btn-wa { background: linear-gradient(135deg, #25d366, #128c7e); color: #fff; }
.btn-wa:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(37,211,102,.4); }
.btn-sm { padding: 5px 12px; font-size: 11px; border-radius: 6px; }
.btn-xs { padding: 3px 8px; font-size: 10px; border-radius: 5px; }
.btn:disabled { opacity: .5; cursor: not-allowed; transform: none !important; }

/* Form elements */
.form-inp, .form-sel, .form-ta {
  background: var(--card2); border: 1px solid var(--border2); border-radius: var(--radius-sm);
  padding: 9px 13px; color: var(--text); font-size: 13px; font-family: 'Syne', sans-serif;
  transition: border-color .2s, box-shadow .2s; outline: none; width: 100%;
}
.form-inp:focus, .form-sel:focus, .form-ta:focus { border-color: var(--teal); box-shadow: 0 0 0 3px rgba(20,184,166,.1); }
.form-inp::placeholder, .form-ta::placeholder { color: var(--muted); }
.form-sel option { background: var(--card2); }
.form-ta { resize: vertical; min-height: 80px; line-height: 1.6; }
.form-label { font-size: 11px; font-weight: 700; color: var(--muted2); text-transform: uppercase; letter-spacing: .5px; font-family: 'JetBrains Mono', monospace; display: block; margin-bottom: 6px; }
.form-grp { margin-bottom: 14px; }
.form-row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
.form-hint { font-size: 10px; color: var(--muted); font-family: 'JetBrains Mono', monospace; margin-top: 4px; }

/* Tables */
.tbl-wrap { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
.tbl-scroll { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 12px; }
thead tr { background: #080c16; }
th { padding: 10px 14px; text-align: left; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .6px; color: var(--muted2); border-bottom: 1px solid var(--border); white-space: nowrap; font-family: 'JetBrains Mono', monospace; cursor: pointer; user-select: none; }
th.r { text-align: right; }
th:hover { color: var(--text); }
td { padding: 9px 14px; border-bottom: 1px solid rgba(30,45,69,.5); font-family: 'JetBrains Mono', monospace; font-size: 11px; }
td.r { text-align: right; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(20,184,166,.025); }
tr.tl-hdr td { font-weight: 700; font-size: 12px; }
tr.grand td { background: #08101e; font-weight: 800; border-top: 1px solid var(--border); color: #fff; }
td.srt-up::after { content: ' â†‘'; color: var(--teal); }
td.srt-dn::after { content: ' â†“'; color: var(--teal); }

/* Status badges */
.sb { padding: 3px 8px; border-radius: 5px; font-size: 10px; font-weight: 700; font-family: 'JetBrains Mono', monospace; white-space: nowrap; }
.sb-red { background: rgba(239,68,68,.15); color: var(--red); }
.sb-orange { background: rgba(249,115,22,.15); color: var(--orange); }
.sb-yellow { background: rgba(234,179,8,.15); color: var(--yellow); }
.sb-green { background: rgba(16,185,129,.15); color: var(--green); }
.sb-blue { background: rgba(59,130,246,.15); color: var(--blue); }
.sb-purple { background: rgba(139,92,246,.15); color: var(--purple); }
.sb-teal { background: rgba(20,184,166,.15); color: var(--teal); }
.sb-gray { background: rgba(100,116,139,.15); color: var(--muted2); }

/* Search bar */
.search-bar {
  width: 100%; background: var(--card2); border: 1px solid var(--border2);
  border-radius: var(--radius-sm); padding: 9px 14px; color: var(--text);
  font-size: 13px; font-family: 'Syne', sans-serif; transition: border-color .2s;
  margin-bottom: 12px; outline: none;
}
.search-bar:focus { border-color: var(--teal); }

/* Upload zone */
.upload-zone {
  border: 2px dashed var(--border2); border-radius: var(--radius-lg); padding: 48px 40px;
  text-align: center; cursor: pointer; transition: all .25s; background: var(--card);
  position: relative; overflow: hidden;
}
.upload-zone:hover, .upload-zone.drag { border-color: var(--teal); background: rgba(20,184,166,.04); }
.upload-zone .uz-icon { font-size: 42px; margin-bottom: 14px; display: block; }
.upload-zone h3 { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
.upload-zone p { color: var(--muted2); font-size: 13px; }
.chips { display: flex; gap: 8px; justify-content: center; margin-top: 14px; flex-wrap: wrap; }
.chip { font-family: 'JetBrains Mono', monospace; font-size: 10px; padding: 3px 10px; border-radius: 99px; background: rgba(20,184,166,.08); border: 1px solid rgba(20,184,166,.2); color: var(--teal); }

/* Progress */
.prog-wrap { display: none; margin: 16px 0; }
.prog-lbl { font-size: 11px; color: var(--muted2); font-family: 'JetBrains Mono', monospace; margin-bottom: 7px; }
.prog-track { height: 4px; background: var(--border); border-radius: 99px; overflow: hidden; }
.prog-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--teal), var(--green), var(--teal)); background-size: 400px 100%; border-radius: 99px; transition: width .5s cubic-bezier(.22,1,.36,1); }

/* Alerts */
.alert { padding: 10px 16px; border-radius: 8px; font-size: 12px; margin-top: 10px; display: none; font-family: 'JetBrains Mono', monospace; }
.alert-ok { background: rgba(16,185,129,.08); border: 1px solid rgba(16,185,129,.2); color: var(--green); }
.alert-err { background: rgba(239,68,68,.08); border: 1px solid rgba(239,68,68,.2); color: var(--red); }
.alert-warn { background: rgba(249,115,22,.08); border: 1px solid rgba(249,115,22,.2); color: var(--orange); }
.alert-info { background: rgba(59,130,246,.08); border: 1px solid rgba(59,130,246,.2); color: var(--blue); }

/* Tab bar */
.tab-bar { display: flex; gap: 2px; background: var(--card); border: 1px solid var(--border); border-radius: 9px; padding: 3px; }
.tab-btn { padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; color: var(--muted2); border: none; background: none; font-family: 'Syne', sans-serif; transition: all .15s; white-space: nowrap; }
.tab-btn.on { background: var(--teal); color: #fff; box-shadow: 0 0 14px rgba(20,184,166,.35); }

/* Toast */
.toast {
  position: fixed; bottom: 24px; right: 24px; background: var(--card);
  border: 1px solid var(--border); border-radius: 11px; padding: 13px 20px;
  font-size: 12px; font-weight: 600; z-index: 9999; display: none; gap: 8px;
  align-items: center; box-shadow: 0 10px 32px rgba(0,0,0,.5);
  font-family: 'JetBrains Mono', monospace; min-width: 280px;
}
.toast.show { display: flex; animation: slideLeft .3s ease both; }
.toast.ok { border-color: rgba(20,184,166,.35); color: var(--teal); }
.toast.err { border-color: rgba(239,68,68,.35); color: var(--red); }
.toast.warn { border-color: rgba(249,115,22,.35); color: var(--orange); }
.toast.info { border-color: rgba(59,130,246,.35); color: var(--blue); }

/* Modal */
.modal-bg {
  position: fixed; inset: 0; background: rgba(6,10,18,.88); z-index: 400;
  display: none; align-items: center; justify-content: center;
  padding: 24px; backdrop-filter: blur(6px);
}
.modal-bg.show { display: flex; }
.modal {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 28px; width: 100%; max-width: 540px; max-height: 92vh; overflow-y: auto;
  animation: scaleIn .3s cubic-bezier(.34,1.56,.64,1) both;
}
.modal.lg { max-width: 720px; }
.modal.xl { max-width: 900px; }
.modal h3 { font-size: 16px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
.modal-footer { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }

.dial-key {
  padding:14px;border-radius:10px;border:1px solid var(--border);
  background:var(--card2);color:var(--text);font-size:18px;font-weight:600;
  cursor:pointer;font-family:'JetBrains Mono',monospace;transition:all .15s;
}
.dial-key:hover { background:#14b8a620; border-color:#14b8a6; }
.dial-key:active { transform:scale(0.95); background:#14b8a640; }

/* Collapsible sections */
.collapsible-hdr { cursor: pointer; user-select: none; display: flex; align-items: center; flex-wrap: wrap; }
.collapse-btn { margin-left: 8px; width: 24px; height: 24px; border-radius: 5px; background: rgba(20,184,166,.12); border: 1px solid rgba(20,184,166,.25); color: var(--teal); font-size: 11px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: transform .25s; }
.collapse-btn.c { transform: rotate(-90deg); }
.sec-collapsible.collapsed { display: none !important; }

/* Stat pills */
.stat-pill { display: flex; align-items: center; gap: 8px; background: var(--card2); border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; }
.stat-pill .sp-val { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 15px; }
.stat-pill .sp-lbl { font-size: 11px; color: var(--muted2); }
.stat-row { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }

/* Priority indicators */
.prio-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; display: inline-block; }
.prio-urgent { background: var(--red); box-shadow: 0 0 6px var(--red); }
.prio-high { background: var(--orange); }
.prio-normal { background: var(--green); }
.prio-low { background: var(--muted); }

/* Welcome banner */
.welcome-banner {
  background: linear-gradient(135deg, rgba(20,184,166,.1), rgba(16,185,129,.07));
  border: 1px solid rgba(20,184,166,.2); border-radius: var(--radius-lg);
  padding: 24px 28px; margin-bottom: 24px; position: relative; overflow: hidden;
}
.welcome-banner::before { content: 'ğŸ§ '; position: absolute; right: 24px; top: 50%; transform: translateY(-50%); font-size: 64px; opacity: .12; }
.welcome-banner h2 { font-size: 22px; font-weight: 800; margin-bottom: 5px; }
.welcome-banner p { font-size: 13px; color: var(--muted2); font-family: 'JetBrains Mono', monospace; }

/* Quick actions */
.quick-action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 24px; }
.quick-action {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 18px 16px; cursor: pointer; transition: all .22s;
  text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px;
}
.quick-action:hover { border-color: var(--teal); transform: translateY(-4px); box-shadow: 0 10px 28px rgba(0,0,0,.25); }
.quick-action .qa-icon { font-size: 28px; }
.quick-action .qa-title { font-size: 13px; font-weight: 700; }
.quick-action .qa-desc { font-size: 10px; color: var(--muted2); font-family: 'JetBrains Mono', monospace; }

/* â”€â”€â”€ TICKET STATUS COLORS â”€â”€â”€ */
.ticket-open { --tc: var(--red); }
.ticket-pending { --tc: var(--orange); }
.ticket-resolved { --tc: var(--green); }
.ticket-closed { --tc: var(--muted); }
.ticket-card { border-left: 3px solid var(--tc, var(--border)); }

/* â”€â”€â”€ LEAD STATUS â”€â”€â”€ */
.lead-new { --lc: var(--blue); }
.lead-contacted { --lc: var(--orange); }
.lead-qualified { --lc: var(--teal); }
.lead-converted { --lc: var(--green); }
.lead-lost { --lc: var(--red); }
.lead-card { border-left: 3px solid var(--lc, var(--border)); }

/* â”€â”€â”€ SLA BADGE â”€â”€â”€ */
.sla-ok { background: rgba(16,185,129,.15); color: var(--green); border-radius: 6px; padding: 3px 8px; font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700; }
.sla-warn { background: rgba(249,115,22,.15); color: var(--orange); border-radius: 6px; padding: 3px 8px; font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700; }
.sla-breach { background: rgba(239,68,68,.2); color: var(--red); border-radius: 6px; padding: 3px 8px; font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700; animation: flashRed 1.5s ease-in-out infinite; }
@keyframes flashRed { 0%,100%{opacity:1}50%{opacity:.6} }

/* â”€â”€â”€ CALL LOG CARDS â”€â”€â”€ */
.call-card { background: var(--card2); border: 1px solid var(--border2); border-radius: 10px; padding: 14px 16px; display: flex; align-items: flex-start; gap: 12px; transition: all .2s; cursor: pointer; margin-bottom: 8px; }
.call-card:hover { border-color: var(--teal); background: rgba(20,184,166,.03); }

/* â”€â”€â”€ CONDITIONAL FORMAT â”€â”€â”€ */
.cf-green { background: rgba(16,185,129,.12) !important; color: #34d399 !important; font-weight: 700; }
.cf-red { background: rgba(239,68,68,.12) !important; color: #f87171 !important; font-weight: 700; }
.cf-orange { background: rgba(249,115,22,.12) !important; color: #fb923c !important; font-weight: 700; }
.cf-yellow { background: rgba(234,179,8,.12) !important; color: #fbbf24 !important; font-weight: 700; }
.cf-bar { display: inline-flex; align-items: center; gap: 5px; }
.cf-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.cf-dot.g { background: #10b981; } .cf-dot.r { background: #ef4444; }
.cf-dot.o { background: #f97316; } .cf-dot.y { background: #eab308; }
.drop-major { background: rgba(239,68,68,.18) !important; color: #f87171 !important; }
.drop-minor { background: rgba(249,115,22,.15) !important; color: #fdba74 !important; }

/* â”€â”€â”€ HEATMAP â”€â”€â”€ */
.heatmap { overflow-x: auto; }
.heatmap table { border-collapse: collapse; font-size: 11px; }
.heatmap th { padding: 6px 10px; background: #080c16; color: var(--muted2); font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; border: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; white-space: nowrap; }
.heatmap td { padding: 6px 10px; border: 1px solid var(--border); text-align: center; font-family: 'JetBrains Mono', monospace; font-weight: 600; transition: all .15s; cursor: default; }
.heatmap td:first-child { text-align: left; font-weight: 700; white-space: nowrap; background: #080c16; color: var(--text); }
.hm-na { color: var(--muted); background: var(--card) !important; }

/* â”€â”€â”€ AGENT REMARKS â”€â”€â”€ */
.rough-area {
  width: 100%; background: var(--card2); border: 1px solid var(--border2); border-radius: 12px;
  padding: 14px 16px; color: var(--text); font-size: 13.5px; font-family: 'Syne', sans-serif;
  font-weight: 400; line-height: 1.7; outline: none; resize: vertical; min-height: 100px;
  transition: border-color .2s; margin-bottom: 16px;
}
.rough-area:focus { border-color: var(--teal); }
.rough-area::placeholder { color: var(--muted); font-size: 13px; }
.gen-btn {
  width: 100%; padding: 14px; border-radius: 10px; border: none;
  background: linear-gradient(135deg, var(--teal), var(--green)); color: #fff;
  font-size: 15px; font-weight: 800; font-family: 'Syne', sans-serif;
  cursor: pointer; transition: all .2s; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 8px;
}
.gen-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(20,184,166,.4); }
.gen-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }
.out-block { background: var(--card2); border: 1px solid var(--border2); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
.out-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.out-title { font-size: 12px; font-weight: 700; color: var(--teal); }
.copy-btn { padding: 4px 12px; border-radius: 6px; font-size: 10px; font-weight: 700; cursor: pointer; border: 1px solid rgba(20,184,166,.3); background: rgba(20,184,166,.08); color: var(--teal); font-family: 'JetBrains Mono', monospace; transition: all .15s; }
.copy-btn:hover { background: rgba(20,184,166,.15); }
.out-body { font-size: 12px; line-height: 1.7; color: var(--text); white-space: pre-wrap; font-family: 'Syne', sans-serif; }

/* â”€â”€â”€ CANCEL TOOL â”€â”€â”€ */
.ag-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all .15s; border: 1px solid; user-select: none; }
.ag-on { background: rgba(20,184,166,.12); border-color: rgba(20,184,166,.3); color: var(--teal); }
.ag-off { background: var(--card2); border-color: var(--border2); color: var(--muted); }
.rc-bar { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
.rc-bar:last-child { border-bottom: none; }
.rc-label { width: 200px; font-size: 12px; font-weight: 600; flex-shrink: 0; }
.rc-track { flex: 1; height: 6px; background: var(--border); border-radius: 99px; overflow: hidden; }
.rc-fill { height: 100%; border-radius: 99px; }
.rc-count { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--muted2); width: 40px; text-align: right; }

/* â”€â”€â”€ REPORT TL BADGES â”€â”€â”€ */
.tl-badge { padding: 3px 9px; border-radius: 5px; font-size: 10px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.tl-rk { background: rgba(59,130,246,.15); color: #93c5fd; }
.tl-ro { background: rgba(16,185,129,.15); color: #6ee7b7; }
.tl-ya { background: rgba(249,115,22,.15); color: #fdba74; }
.tl-at { background: rgba(139,92,246,.15); color: #c4b5fd; }
.acht-badge { display: inline-flex; align-items: center; gap: 4px; font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 11px; }
.acht-m { color: var(--cyan); } .acht-s { color: var(--muted2); }

/* â”€â”€â”€ TOGGLE â”€â”€â”€ */
.toggle { display: flex; align-items: center; gap: 10px; cursor: pointer; }
.toggle-track { width: 44px; height: 24px; background: var(--border2); border-radius: 99px; position: relative; transition: background .2s; flex-shrink: 0; }
.toggle-track.on { background: var(--teal); }
.toggle-thumb { width: 18px; height: 18px; background: #fff; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: left .2s; }
.toggle-track.on .toggle-thumb { left: 23px; }

/* â”€â”€â”€ RISK CARDS â”€â”€â”€ */
.risk-card { background: var(--card2); border: 1px solid var(--border2); border-radius: 10px; padding: 16px; position: relative; overflow: hidden; }
.risk-card.high { border-color: rgba(239,68,68,.3); }
.risk-card.warn { border-color: rgba(249,115,22,.3); }
.risk-card.stable { border-color: rgba(16,185,129,.3); }

/* â”€â”€â”€ CUSTOMER 360 â”€â”€â”€ */
.c360-card {
  background: linear-gradient(135deg, rgba(20,184,166,.08), rgba(16,185,129,.05));
  border: 1px solid rgba(20,184,166,.2); border-radius: var(--radius-lg); padding: 24px;
  margin-bottom: 20px;
}
.c360-name { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
.c360-phone { font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--teal); }

/* â”€â”€â”€ REGION BADGES â”€â”€â”€ */
.region-n { background: rgba(59,130,246,.12); border: 1px solid rgba(59,130,246,.2); color: var(--blue); border-radius: 6px; padding: 2px 8px; font-size: 10px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.region-s { background: rgba(16,185,129,.12); border: 1px solid rgba(16,185,129,.2); color: var(--green); border-radius: 6px; padding: 2px 8px; font-size: 10px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.region-e { background: rgba(249,115,22,.12); border: 1px solid rgba(249,115,22,.2); color: var(--orange); border-radius: 6px; padding: 2px 8px; font-size: 10px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.region-w { background: rgba(139,92,246,.12); border: 1px solid rgba(139,92,246,.2); color: var(--purple); border-radius: 6px; padding: 2px 8px; font-size: 10px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

/* â”€â”€â”€ TARGET TRACKER â”€â”€â”€ */
.target-ring { width: 100px; height: 100px; position: relative; flex-shrink: 0; }
.target-ring svg { transform: rotate(-90deg); }
.target-ring .ring-bg { fill: none; stroke: var(--border2); stroke-width: 8; }
.target-ring .ring-fill { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 1s cubic-bezier(.22,1,.36,1); }
.target-ring .ring-text { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; }
.target-ring .ring-pct { font-size: 18px; font-weight: 800; line-height: 1; }
.target-ring .ring-lbl { font-size: 9px; color: var(--muted); text-transform: uppercase; }

/* â”€â”€â”€ ADMIN PANEL â”€â”€â”€ */
.admin-stat { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; text-align: center; }
.admin-stat .as-val { font-size: 28px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
.admin-stat .as-lbl { font-size: 10px; color: var(--muted2); text-transform: uppercase; letter-spacing: .5px; margin-top: 4px; }

/* â”€â”€â”€ SERVICEABILITY â”€â”€â”€ */
.service-check-result { background: var(--card2); border: 1px solid var(--border2); border-radius: var(--radius); padding: 20px; margin-top: 16px; }
.service-check-result.available { border-color: rgba(16,185,129,.4); background: rgba(16,185,129,.05); }
.service-check-result.unavailable { border-color: rgba(239,68,68,.4); background: rgba(239,68,68,.05); }

/* â”€â”€â”€ BUYBACK CALC â”€â”€â”€ */
.calc-result { background: linear-gradient(135deg, rgba(20,184,166,.1), rgba(16,185,129,.08)); border: 1px solid rgba(20,184,166,.25); border-radius: var(--radius); padding: 20px; margin-top: 16px; text-align: center; }
.calc-result .cr-val { font-size: 36px; font-weight: 800; color: var(--teal); font-family: 'JetBrains Mono', monospace; }
.calc-result .cr-lbl { font-size: 12px; color: var(--muted2); margin-top: 4px; }

/* â”€â”€â”€ WATERMARK â”€â”€â”€ */
.watermark { position: fixed; bottom: 10px; right: 14px; font-size: 9px; font-family: 'JetBrains Mono', monospace; color: rgba(100,116,139,.22); pointer-events: none; z-index: 99; text-align: right; line-height: 1.5; }

/* â”€â”€â”€ MISC â”€â”€â”€ */
.empty-state { text-align: center; padding: 60px 20px; color: var(--muted2); }
.empty-state .es-icon { font-size: 48px; margin-bottom: 14px; }
.empty-state h3 { font-size: 16px; font-weight: 700; margin-bottom: 8px; color: var(--text2); }
.empty-state p { font-size: 13px; max-width: 340px; margin: 0 auto 20px; }
.divider { height: 1px; background: var(--border); margin: 20px 0; }
.color-teal { color: var(--teal) !important; } .color-green { color: var(--green) !important; }
.color-red { color: var(--red) !important; } .color-orange { color: var(--orange) !important; }
.good { color: var(--green); } .warn { color: var(--red); font-weight: 700; }
.text-muted { color: var(--muted2); } .text-mono { font-family: 'JetBrains Mono', monospace; }
.sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(6,10,18,.75); z-index: 199; backdrop-filter: blur(2px); }

/* â”€â”€â”€ ANIMATIONS â”€â”€â”€ */
@keyframes fadeUp { from { opacity: 0; transform: translateY(18px); } to { opacity: 1; transform: translateY(0); } }
@keyframes scaleIn { from { opacity: 0; transform: scale(.88); } to { opacity: 1; transform: scale(1); } }
@keyframes slideLeft { from { opacity: 0; transform: translateX(22px); } to { opacity: 1; transform: translateX(0); } }
@keyframes glowPulse { 0%,100%{box-shadow:0 0 10px rgba(20,184,166,.3)}50%{box-shadow:0 0 26px rgba(20,184,166,.65)} }
@keyframes spin { to { transform: rotate(360deg); } }
.fade-in { animation: fadeUp .35s cubic-bezier(.22,1,.36,1) both; }
.spinner { animation: spin .8s linear infinite; display: inline-block; }

/* â”€â”€â”€ MOBILE â”€â”€â”€ */
@media(max-width:900px){
  .sidebar { transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
  .main-content { margin-left: 0; }
  #hamburger { display: block; }
  .grid4,.grid5 { grid-template-columns: repeat(2,1fr); }
  .grid3 { grid-template-columns: 1fr 1fr; }
  .grid2 { grid-template-columns: 1fr; }
  .sidebar-overlay { display: block !important; display: none; }
  .panel-area { padding: 16px; }
  .topbar { padding: 0 16px; }
}

/* â”€â”€â”€ MANAGER SECTION â”€â”€â”€ */
.sc-panel { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 14px; }
.sc-panel-hdr { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
.sc-panel-title { font-size: 10px; font-family: 'JetBrains Mono', monospace; color: var(--muted2); text-transform: uppercase; letter-spacing: .8px; }
.sc-toggle-icon { font-size: 11px; color: var(--muted); transition: transform .2s; }
.sc-panel.open .sc-toggle-icon { transform: rotate(180deg); }
.sc-body { display: none; padding: 12px 14px; }
.sc-panel.open .sc-body { display: block; }
.team-chip { display: inline-flex; align-items: center; gap: 4px; padding: 5px 12px; border-radius: 99px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all .15s; border: 1px solid var(--border2); background: var(--card2); color: var(--muted2); font-family: 'JetBrains Mono', monospace; margin: 3px; }
.team-chip.on { background: rgba(20,184,166,.15); border-color: rgba(20,184,166,.4); color: var(--teal); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-logo">
      <div class="icon">ğŸ§ </div>
      <h1>Livsmart CRM</h1>
      <p>Unified Enterprise Suite Â· v2.0</p>
    </div>
    <div class="l-err" id="loginErr"></div>
    <label class="l-label">Email Address</label>
    <input class="l-inp" id="loginEmail" type="email" placeholder="agent@livsmart.in" onkeydown="if(event.key==='Enter')doLogin()">
    <label class="l-label">Password</label>
    <input class="l-inp" id="loginPwd" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="l-btn" id="loginBtn" onclick="doLogin()">ğŸ” Login Karo</button>
    <div class="login-features">
      <span class="login-feat">ğŸ”’ Secure Auth</span>
      <span class="login-feat">âš¡ Real-time</span>
      <span class="login-feat">ğŸ¤– AI Powered</span>
      <span class="login-feat">ğŸ“± WhatsApp</span>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN CRM APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="crmApp">
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- â”€â”€â”€ SIDEBAR â”€â”€â”€ -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">ğŸ§ </div>
      <div>
        <h1>Livsmart</h1>
        <span>CRM Suite v3.0</span>
      </div>
    </div>
  </div>
  <div class="sidebar-user">
    <div class="user-avatar" id="userAvatar">P</div>
    <div class="user-info">
      <div class="name" id="sidebarUserName">Loading...</div>
      <div class="role" id="sidebarUserRole">agent</div>
    </div>
  </div>
  <div class="sidebar-search">
    <input class="s-search-inp" id="globalSearch" placeholder="ğŸ” Search: phone, ticket, name..." onkeydown="if(event.key==='Enter')doGlobalSearch(this.value)">
  </div>
  <nav class="sidebar-nav" id="sidebarNav">
    <div class="nav-group-label">Main</div>
    <div class="nav-item active" id="nav-home" onclick="switchPanel('home')">
      <span class="nav-icon">ğŸ </span> Home Dashboard
    </div>

    <div class="nav-group-label">Sales Suite</div>
    <div class="nav-item" id="nav-leads" onclick="switchPanel('leads')">
      <span class="nav-icon">ğŸ’°</span> Lead Manager
      <span class="nav-badge blue" id="leadBadge">0</span>
    </div>
    <div class="nav-item" id="nav-targets" onclick="switchPanel('targets')">
      <span class="nav-icon">ğŸ¯</span> Target Tracker
    </div>
    <div class="nav-item" id="nav-buyback" onclick="switchPanel('buyback')">
      <span class="nav-icon">ğŸ”</span> Buyback Calc
    </div>

    <div class="nav-group-label">CX Service</div>
    <div class="nav-item" id="nav-tickets" onclick="switchPanel('tickets')">
      <span class="nav-icon">ğŸ«</span> Ticket Manager
      <span class="nav-badge red" id="ticketBadge">0</span>
    </div>
    <div class="nav-item" id="nav-service" onclick="switchPanel('service')">
      <span class="nav-icon">ğŸ“</span> Serviceability
    </div>
    <div class="nav-item" id="nav-c360" onclick="switchPanel('c360')">
      <span class="nav-icon">ğŸ‘</span> Customer 360
    </div>

    <div class="nav-group-label">Analytics</div>
    <div class="nav-item" id="nav-report" onclick="switchPanel('report')">
      <span class="nav-icon">ğŸ“ˆ</span> Report Generator
    </div>
    <div class="nav-item" id="nav-cset" onclick="switchPanel('cset')">
      <span class="nav-icon">ğŸŒ¡</span> CSET Dashboard
    </div>
    <div class="nav-item" id="nav-monthly" onclick="switchPanel('monthly')">
      <span class="nav-icon">ğŸ“…</span> Monthly Report
    </div>
    <div class="nav-item" id="nav-agents" onclick="switchPanel('agents')">
      <span class="nav-icon">ğŸ‘¥</span> Agent Manager
    </div>

    <div class="nav-group-label">Tools</div>
    <div class="nav-item" id="nav-calls" onclick="switchPanel('calls')">
      <span class="nav-icon">ğŸ“</span> Call Log
    </div>
    <div class="nav-item" id="nav-cancel" onclick="switchPanel('cancel')">
      <span class="nav-icon">ğŸš«</span> Cancellation
    </div>
    <div class="nav-item" id="nav-remarks" onclick="switchPanel('remarks')">
      <span class="nav-icon">ğŸ¤–</span> AI Remarks
    </div>

    <div class="nav-group-label" id="mgr-group" style="display:none">Manager</div>
    <div class="nav-item" id="nav-manager" onclick="switchPanel('manager')" style="display:none">
      <span class="nav-icon">ğŸ”’</span> Manager View
    </div>
    <div class="nav-item" id="nav-admin" onclick="switchPanel('admin')" style="display:none">
      <span class="nav-icon">âš™ï¸</span> Admin Panel
    </div>
  </nav>
  <div class="sidebar-footer">
    <button class="logout-btn-sidebar" onclick="doLogout()">ğŸšª Logout</button>
  </div>
</aside>

<!-- â”€â”€â”€ MAIN CONTENT â”€â”€â”€ -->
<div class="main-content">
  <div class="topbar">
    <button id="hamburger" onclick="toggleSidebar()">â˜°</button>
    <div>
      <div class="topbar-title" id="topbarTitle">ğŸ  Home Dashboard</div>
      <div class="topbar-breadcrumb">Livsmart CRM v3.0 â†’ <span id="topbarBreadcrumb">Dashboard</span></div>
    </div>
    <div class="topbar-right">
      <div class="topbar-date" id="topbarDate"></div>
      <button class="notif-btn" onclick="switchPanel('tickets')" title="Pending SLA Tickets">
        ğŸ”” <span class="notif-count" id="slaAlertCount">0</span>
      </button>
      <div class="live-dot">Live</div>
    </div>
  </div>

  <!-- â•â• PANELS â•â• -->
  <div class="panel-area">

<!-- â•â•â•â•â•â• PANEL: HOME â•â•â•â•â•â• -->
<div class="panel active" id="panel-home">
  <div class="welcome-banner">
    <h2>Namaste, <span id="welcomeName">Agent</span>! ğŸ™</h2>
    <p id="welcomeSubtitle">Aaj ka din productive ho Â· LIVSMART CRM v3.0 Â· Enterprise Suite â€” All-in-One</p>
  </div>
  <div class="grid4" id="homeKPIs" style="margin-bottom:24px">
    <div class="kpi teal"><div class="lbl">Today's Calls</div><div class="val" id="hk1">â€”</div><div class="sub">Call log</div><div class="trend">ğŸ“</div></div>
    <div class="kpi blue"><div class="lbl">Open Tickets</div><div class="val" id="hk2">â€”</div><div class="sub">Awaiting resolution</div><div class="trend">ğŸ«</div></div>
    <div class="kpi orange"><div class="lbl">Active Leads</div><div class="val" id="hk3">â€”</div><div class="sub">In pipeline</div><div class="trend">ğŸ’°</div></div>
    <div class="kpi red"><div class="lbl">SLA Breaching</div><div class="val" id="hk4">â€”</div><div class="sub">Need urgent action</div><div class="trend">âš ï¸</div></div>
  </div>
  <div class="sec-hdr"><h2>Quick Actions</h2><div class="sec-line"></div></div>
  <div class="quick-action-grid">
    <div class="quick-action" onclick="openCallModal()"><div class="qa-icon">ğŸ“</div><div class="qa-title">Log Call</div><div class="qa-desc">Quick call entry</div></div>
    <div class="quick-action" onclick="openTicketModal()"><div class="qa-icon">ğŸ«</div><div class="qa-title">New Ticket</div><div class="qa-desc">CX issue register karo</div></div>
    <div class="quick-action" onclick="openLeadModal()"><div class="qa-icon">ğŸ’°</div><div class="qa-title">Add Lead</div><div class="qa-desc">Sales lead add karo</div></div>
    <div class="quick-action" onclick="switchPanel('c360')"><div class="qa-icon">ğŸ‘</div><div class="qa-title">Customer 360</div><div class="qa-desc">Full customer view</div></div>
    <div class="quick-action" onclick="switchPanel('report')"><div class="qa-icon">ğŸ“ˆ</div><div class="qa-title">Report</div><div class="qa-desc">CSV upload karo</div></div>
    <div class="quick-action" onclick="switchPanel('remarks')"><div class="qa-icon">ğŸ¤–</div><div class="qa-title">AI Remarks</div><div class="qa-desc">Claude se remarks lo</div></div>
    <div class="quick-action" onclick="switchPanel('buyback')"><div class="qa-icon">ğŸ”</div><div class="qa-title">Buyback Calc</div><div class="qa-desc">EMI/Buyback calculate karo</div></div>
    <div class="quick-action" onclick="switchPanel('service')"><div class="qa-icon">ğŸ“</div><div class="qa-title">Serviceability</div><div class="qa-desc">Pincode check karo</div></div>
  </div>
  <div class="grid2" style="margin-top:8px">
    <div>
      <div class="sec-hdr"><h2 style="font-size:14px">ğŸ« Recent Tickets</h2><div class="sec-line"></div><button class="btn btn-ghost btn-sm" onclick="switchPanel('tickets')">All â†’</button></div>
      <div id="homeRecentTickets"><div class="empty-state" style="padding:30px"><div class="es-icon" style="font-size:30px">ğŸ«</div><p style="font-size:12px">Koi tickets nahi abhi</p></div></div>
    </div>
    <div>
      <div class="sec-hdr"><h2 style="font-size:14px">ğŸ’° Hot Leads</h2><div class="sec-line"></div><button class="btn btn-ghost btn-sm" onclick="switchPanel('leads')">All â†’</button></div>
      <div id="homeHotLeads"><div class="empty-state" style="padding:30px"><div class="es-icon" style="font-size:30px">ğŸ’°</div><p style="font-size:12px">Koi leads nahi abhi</p></div></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: LEAD MANAGER â•â•â•â•â•â• -->
<div class="panel" id="panel-leads">
  <div class="sec-hdr">
    <h2>ğŸ’° Lead Manager</h2>
    <span class="badge badge-blue" id="leadTotalBadge">0 leads</span>
    <div class="sec-line"></div>
    <button class="btn btn-pri btn-sm" onclick="openLeadModal()">+ New Lead</button>
    <button class="btn btn-ghost btn-sm" onclick="exportLeads()">ğŸ“¤ Export</button>
  </div>

  <!-- Lead KPIs -->
  <div class="grid5" style="margin-bottom:20px">
    <div class="kpi blue"><div class="lbl">Total Leads</div><div class="val" id="lk1">0</div><div class="trend">ğŸ“‹</div></div>
    <div class="kpi teal"><div class="lbl">New</div><div class="val" id="lk2">0</div><div class="trend">ğŸ†•</div></div>
    <div class="kpi orange"><div class="lbl">Contacted</div><div class="val" id="lk3">0</div><div class="trend">ğŸ“</div></div>
    <div class="kpi green"><div class="lbl">Converted</div><div class="val" id="lk4">0</div><div class="trend">âœ…</div></div>
    <div class="kpi red"><div class="lbl">Lost</div><div class="val" id="lk5">0</div><div class="trend">âŒ</div></div>
  </div>

  <!-- Filters -->
  <div class="card" style="padding:12px 16px;margin-bottom:14px">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <input class="form-inp" id="leadSearch" placeholder="ğŸ” Name, phone, source..." oninput="renderLeads()" style="flex:1;min-width:200px">
      <select class="form-sel" id="leadStatusFilter" onchange="renderLeads()" style="width:150px">
        <option value="">All Status</option>
        <option value="new">ğŸ†• New</option>
        <option value="contacted">ğŸ“ Contacted</option>
        <option value="qualified">â­ Qualified</option>
        <option value="converted">âœ… Converted</option>
        <option value="lost">âŒ Lost</option>
      </select>
      <select class="form-sel" id="leadRegionFilter" onchange="renderLeads()" style="width:130px">
        <option value="">All Regions</option>
        <option value="north">ğŸ”µ North</option>
        <option value="south">ğŸŸ¢ South</option>
        <option value="east">ğŸŸ  East</option>
        <option value="west">ğŸŸ£ West</option>
      </select>
      <select class="form-sel" id="leadSourceFilter" onchange="renderLeads()" style="width:130px">
        <option value="">All Sources</option>
        <option value="inbound">ğŸ“¥ Inbound</option>
        <option value="outbound">ğŸ“¤ Outbound</option>
        <option value="referral">ğŸ¤ Referral</option>
        <option value="social">ğŸ“± Social</option>
        <option value="website">ğŸŒ Website</option>
      </select>
      <button class="btn btn-ghost btn-sm" onclick="resetLeadFilters()">â†º Reset</button>
    </div>
  </div>

  <!-- Lead table -->
  <div class="tbl-wrap">
    <div class="tbl-scroll">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Customer</th>
            <th>Phone</th>
            <th>Status</th>
            <th>Source</th>
            <th>Region</th>
            <th>Value (â‚¹)</th>
            <th>Product</th>
            <th>Agent</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="leadsTbody">
          <tr><td colspan="11" style="text-align:center;padding:40px;color:var(--muted2)">ğŸ’° Pehla lead add karo!</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: TARGET TRACKER â•â•â•â•â•â• -->
<div class="panel" id="panel-targets">
  <div class="sec-hdr">
    <h2>ğŸ¯ Target Tracker</h2>
    <span class="badge badge-orange" id="targetMonthBadge">Loading...</span>
    <div class="sec-line"></div>
    <button class="btn btn-pri btn-sm" onclick="openTargetModal()">+ Set Target</button>
  </div>

  <!-- Overall progress rings -->
  <div class="grid4" style="margin-bottom:20px" id="targetRingsGrid">
    <div class="card" style="display:flex;align-items:center;gap:16px">
      <div class="target-ring" id="ring-sales">
        <svg width="100" height="100" viewBox="0 0 100 100">
          <circle class="ring-bg" cx="50" cy="50" r="42"/>
          <circle class="ring-fill" cx="50" cy="50" r="42" stroke="var(--teal)" stroke-dasharray="264" stroke-dashoffset="264" id="ring-sales-fill"/>
        </svg>
        <div class="ring-text"><div class="ring-pct color-teal" id="ring-sales-pct">0%</div><div class="ring-lbl">Sales</div></div>
      </div>
      <div>
        <div style="font-size:11px;color:var(--muted2);margin-bottom:4px">Sales Target</div>
        <div style="font-size:20px;font-weight:800" id="t-sales-val">â‚¹0 / â‚¹0</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px" id="t-sales-sub">â€”</div>
      </div>
    </div>
    <div class="card" style="display:flex;align-items:center;gap:16px">
      <div class="target-ring" id="ring-calls">
        <svg width="100" height="100" viewBox="0 0 100 100">
          <circle class="ring-bg" cx="50" cy="50" r="42"/>
          <circle class="ring-fill" cx="50" cy="50" r="42" stroke="var(--blue)" stroke-dasharray="264" stroke-dashoffset="264" id="ring-calls-fill"/>
        </svg>
        <div class="ring-text"><div class="ring-pct" style="color:var(--blue)" id="ring-calls-pct">0%</div><div class="ring-lbl">Calls</div></div>
      </div>
      <div>
        <div style="font-size:11px;color:var(--muted2);margin-bottom:4px">Calls Target</div>
        <div style="font-size:20px;font-weight:800" id="t-calls-val">0 / 0</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px" id="t-calls-sub">â€”</div>
      </div>
    </div>
    <div class="card" style="display:flex;align-items:center;gap:16px">
      <div class="target-ring" id="ring-conv">
        <svg width="100" height="100" viewBox="0 0 100 100">
          <circle class="ring-bg" cx="50" cy="50" r="42"/>
          <circle class="ring-fill" cx="50" cy="50" r="42" stroke="var(--green)" stroke-dasharray="264" stroke-dashoffset="264" id="ring-conv-fill"/>
        </svg>
        <div class="ring-text"><div class="ring-pct" style="color:var(--green)" id="ring-conv-pct">0%</div><div class="ring-lbl">Leads</div></div>
      </div>
      <div>
        <div style="font-size:11px;color:var(--muted2);margin-bottom:4px">Lead Conversions</div>
        <div style="font-size:20px;font-weight:800" id="t-conv-val">0 / 0</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px" id="t-conv-sub">â€”</div>
      </div>
    </div>
    <div class="card" style="display:flex;align-items:center;gap:16px">
      <div class="target-ring">
        <svg width="100" height="100" viewBox="0 0 100 100">
          <circle class="ring-bg" cx="50" cy="50" r="42"/>
          <circle class="ring-fill" cx="50" cy="50" r="42" stroke="var(--orange)" stroke-dasharray="264" stroke-dashoffset="264" id="ring-csat-fill"/>
        </svg>
        <div class="ring-text"><div class="ring-pct" style="color:var(--orange)" id="ring-csat-pct">â€”</div><div class="ring-lbl">CSET</div></div>
      </div>
      <div>
        <div style="font-size:11px;color:var(--muted2);margin-bottom:4px">CSET Score</div>
        <div style="font-size:20px;font-weight:800" id="t-csat-val">â€”</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px">Target: 95%</div>
      </div>
    </div>
  </div>

  <!-- Agent-wise target table -->
  <div class="sec-hdr"><h2 style="font-size:14px">ğŸ‘¤ Agent-wise Progress</h2><div class="sec-line"></div></div>
  <div class="tbl-wrap">
    <div class="tbl-scroll">
      <table>
        <thead><tr><th>Agent</th><th>TL</th><th class="r">Sales â‚¹</th><th class="r">Target â‚¹</th><th class="r">Achiev%</th><th class="r">Calls</th><th class="r">Leads</th><th class="r">Conv%</th><th>Progress</th><th>Actions</th></tr></thead>
        <tbody id="targetTbody"><tr><td colspan="10" style="text-align:center;padding:40px;color:var(--muted2)">ğŸ¯ Koi targets set nahi. Pehle set karo!</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: BUYBACK CALCULATOR â•â•â•â•â•â• -->
<div class="panel" id="panel-buyback">
  <div class="sec-hdr">
    <h2>ğŸ” Buyback & EMI Calculator</h2>
    <span class="badge badge-teal">Sales Tool</span>
    <div class="sec-line"></div>
  </div>
  <div class="grid2" style="max-width:900px;gap:24px">
    <div>
      <div class="card">
        <div class="card-hdr">ğŸ’° Buyback Calculator</div>
        <div class="form-grp">
          <label class="form-label">Product Name</label>
          <input class="form-inp" id="bb-product" placeholder="e.g. Livsmart Air Purifier AP500">
        </div>
        <div class="form-grp">
          <label class="form-label">Original Purchase Price (â‚¹)</label>
          <input class="form-inp" id="bb-price" type="number" placeholder="15000" oninput="calcBuyback()">
        </div>
        <div class="form-grp">
          <label class="form-label">Purchase Date</label>
          <input class="form-inp" id="bb-date" type="date" onchange="calcBuyback()">
        </div>
        <div class="form-grp">
          <label class="form-label">Product Condition</label>
          <select class="form-sel" id="bb-condition" onchange="calcBuyback()">
            <option value="excellent">â­â­â­â­â­ Excellent</option>
            <option value="good">â­â­â­â­ Good</option>
            <option value="fair">â­â­â­ Fair</option>
            <option value="poor">â­â­ Poor</option>
          </select>
        </div>
        <div class="form-grp">
          <label class="form-label">Buyback Policy</label>
          <select class="form-sel" id="bb-policy" onchange="calcBuyback()">
            <option value="standard">Standard (30% depreciation/yr)</option>
            <option value="premium">Premium (20% depreciation/yr)</option>
            <option value="loyalty">Loyalty (15% depreciation/yr)</option>
          </select>
        </div>
        <div id="bbResult" style="display:none" class="calc-result">
          <div class="cr-val" id="bbVal">â‚¹0</div>
          <div class="cr-lbl" id="bbBreakdown">Buyback Value</div>
          <div style="margin-top:12px;display:flex;gap:20px;justify-content:center;flex-wrap:wrap">
            <div style="text-align:center"><div style="font-size:12px;color:var(--muted2)">Age</div><div class="text-mono" id="bbAge">â€”</div></div>
            <div style="text-align:center"><div style="font-size:12px;color:var(--muted2)">Depreciation</div><div class="text-mono" id="bbDepr">â€”</div></div>
            <div style="text-align:center"><div style="font-size:12px;color:var(--muted2)">Condition Adj.</div><div class="text-mono" id="bbCond">â€”</div></div>
          </div>
        </div>
      </div>
    </div>
    <div>
      <div class="card" style="margin-bottom:16px">
        <div class="card-hdr">ğŸ“Š EMI Calculator</div>
        <div class="form-grp">
          <label class="form-label">Loan Amount (â‚¹)</label>
          <input class="form-inp" id="emi-amount" type="number" placeholder="50000" oninput="calcEMI()">
        </div>
        <div class="form-grp">
          <label class="form-label">Interest Rate (% per annum)</label>
          <input class="form-inp" id="emi-rate" type="number" placeholder="12" step="0.1" oninput="calcEMI()">
        </div>
        <div class="form-grp">
          <label class="form-label">Tenure (months)</label>
          <select class="form-sel" id="emi-tenure" onchange="calcEMI()">
            <option value="3">3 months</option><option value="6">6 months</option>
            <option value="9">9 months</option><option value="12" selected>12 months</option>
            <option value="18">18 months</option><option value="24">24 months</option>
            <option value="36">36 months</option>
          </select>
        </div>
        <div id="emiResult" style="display:none" class="calc-result">
          <div class="cr-val" id="emiVal">â‚¹0</div>
          <div class="cr-lbl">Monthly EMI</div>
          <div style="margin-top:12px;display:flex;gap:20px;justify-content:center;flex-wrap:wrap">
            <div style="text-align:center"><div style="font-size:12px;color:var(--muted2)">Total Amount</div><div class="text-mono" id="emiTotal">â€”</div></div>
            <div style="text-align:center"><div style="font-size:12px;color:var(--muted2)">Total Interest</div><div class="text-mono" id="emiInterest">â€”</div></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-hdr">ğŸ§® Upgrade Value Calc</div>
        <div class="form-grp">
          <label class="form-label">New Product Price (â‚¹)</label>
          <input class="form-inp" id="upg-new" type="number" placeholder="25000" oninput="calcUpgrade()">
        </div>
        <div class="form-grp">
          <label class="form-label">Customer Pays After Buyback</label>
          <div id="upgResult" style="font-size:24px;font-weight:800;color:var(--teal);font-family:'JetBrains Mono',monospace;margin-top:8px" id="upgVal">â€”</div>
        </div>
        <button class="btn btn-wa btn-sm" id="upgWaBtn" style="display:none" onclick="sendUpgradeWA()">ğŸ’¬ WhatsApp Quote Bhejo</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: TICKET MANAGER â•â•â•â•â•â• -->
<div class="panel" id="panel-tickets">
  <div class="sec-hdr">
    <h2>ğŸ« Ticket Manager</h2>
    <span class="badge badge-red" id="ticketOpenBadge">0 Open</span>
    <div class="sec-line"></div>
    <button class="btn btn-pri btn-sm" onclick="openTicketModal()">+ New Ticket</button>
    <button class="btn btn-ghost btn-sm" onclick="exportTickets()">ğŸ“¤ Export</button>
  </div>

  <!-- Ticket KPIs -->
  <div class="grid5" style="margin-bottom:20px">
    <div class="kpi red"><div class="lbl">Open</div><div class="val" id="tk1">0</div><div class="trend">ğŸ”´</div></div>
    <div class="kpi orange"><div class="lbl">Pending</div><div class="val" id="tk2">0</div><div class="trend">ğŸŸ </div></div>
    <div class="kpi green"><div class="lbl">Resolved</div><div class="val" id="tk3">0</div><div class="trend">âœ…</div></div>
    <div class="kpi teal"><div class="lbl">Closed</div><div class="val" id="tk4">0</div><div class="trend">ğŸ”’</div></div>
    <div class="kpi purple"><div class="lbl">SLA Breach</div><div class="val" id="tk5">0</div><div class="trend">ğŸš¨</div></div>
  </div>

  <!-- Filters -->
  <div class="card" style="padding:12px 16px;margin-bottom:14px">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <input class="form-inp" id="ticketSearch" placeholder="ğŸ” Ticket ID, customer, phone..." oninput="renderTickets()" style="flex:1;min-width:200px">
      <select class="form-sel" id="ticketStatusFilter" onchange="renderTickets()" style="width:140px">
        <option value="">All Status</option>
        <option value="open">ğŸ”´ Open</option>
        <option value="pending">ğŸŸ  Pending</option>
        <option value="resolved">âœ… Resolved</option>
        <option value="closed">ğŸ”’ Closed</option>
      </select>
      <select class="form-sel" id="ticketPriorityFilter" onchange="renderTickets()" style="width:130px">
        <option value="">All Priority</option>
        <option value="urgent">ğŸ”´ Urgent</option>
        <option value="high">ğŸŸ  High</option>
        <option value="normal">ğŸŸ¢ Normal</option>
        <option value="low">âšª Low</option>
      </select>
      <select class="form-sel" id="ticketCatFilter" onchange="renderTickets()" style="width:140px">
        <option value="">All Categories</option>
        <option value="delivery">ğŸšš Delivery</option>
        <option value="product">ğŸ“¦ Product Issue</option>
        <option value="billing">ğŸ’³ Billing</option>
        <option value="returns">ğŸ”„ Returns</option>
        <option value="installation">ğŸ”§ Installation</option>
        <option value="complaint">ğŸ˜¡ Complaint</option>
        <option value="enquiry">â“ Enquiry</option>
      </select>
      <select class="form-sel" id="ticketSLAFilter" onchange="renderTickets()" style="width:120px">
        <option value="">All SLA</option>
        <option value="breach">âš  Breached</option>
        <option value="warn">ğŸŸ¡ Warning</option>
        <option value="ok">ğŸŸ¢ OK</option>
      </select>
      <button class="btn btn-ghost btn-sm" onclick="resetTicketFilters()">â†º Reset</button>
    </div>
  </div>

  <!-- Ticket list -->
  <div id="ticketsList">
    <div class="empty-state">
      <div class="es-icon">ğŸ«</div>
      <h3>Koi tickets nahi</h3>
      <p>Pehla ticket banao ya filter change karo</p>
      <button class="btn btn-pri btn-sm" onclick="openTicketModal()">+ New Ticket</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: SERVICEABILITY â•â•â•â•â•â• -->
<div class="panel" id="panel-service">
  <div class="sec-hdr">
    <h2>ğŸ“ Serviceability Checker</h2>
    <span class="badge badge-teal">Pincode Based</span>
    <div class="sec-line"></div>
  </div>
  <div class="grid2" style="max-width:900px">
    <div>
      <div class="card">
        <div class="card-hdr">ğŸ” Check Serviceability</div>
        <div class="form-grp">
          <label class="form-label">Customer Pincode *</label>
          <input class="form-inp" id="svc-pin" maxlength="6" placeholder="110001" oninput="this.value=this.value.replace(/\D/g,'')">
        </div>
        <div class="form-grp">
          <label class="form-label">Service Type</label>
          <select class="form-sel" id="svc-type">
            <option value="delivery">ğŸšš Delivery</option>
            <option value="installation">ğŸ”§ Installation</option>
            <option value="service">ğŸ›  Service/Repair</option>
            <option value="pickup">ğŸ“¦ Pickup</option>
          </select>
        </div>
        <div class="form-grp">
          <label class="form-label">Product Category</label>
          <select class="form-sel" id="svc-cat">
            <option value="air_purifier">Air Purifier</option>
            <option value="water_purifier">Water Purifier</option>
            <option value="solar">Solar Panel</option>
            <option value="appliance">Home Appliance</option>
          </select>
        </div>
        <button class="btn btn-pri" style="width:100%;justify-content:center" onclick="checkServiceability()">ğŸ“ Check Karo</button>

        <div id="svcResult" style="display:none;margin-top:16px">
          <div class="service-check-result" id="svcResultCard">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
              <div style="font-size:32px" id="svcIcon">âœ…</div>
              <div>
                <div style="font-size:16px;font-weight:800" id="svcStatus">Available</div>
                <div style="font-size:12px;color:var(--muted2)" id="svcArea">Checking...</div>
              </div>
            </div>
            <div style="display:flex;gap:16px;flex-wrap:wrap">
              <div><div style="font-size:10px;color:var(--muted2)">ETA</div><div class="text-mono" id="svcETA">â€”</div></div>
              <div><div style="font-size:10px;color:var(--muted2)">Charges</div><div class="text-mono" id="svcCharge">â€”</div></div>
              <div><div style="font-size:10px;color:var(--muted2)">Partner</div><div class="text-mono" id="svcPartner">â€”</div></div>
            </div>
            <button class="btn btn-wa btn-sm" style="margin-top:12px" onclick="sendSvcWA()">ğŸ’¬ Customer Ko WhatsApp Karo</button>
          </div>
        </div>
      </div>

      <!-- Manage pincodes -->
      <div class="card" style="margin-top:16px">
        <div class="card-hdr" style="display:flex;align-items:center;justify-content:space-between">
          <span>ğŸ—º Managed Pincodes</span>
          <button class="btn btn-sec btn-sm" onclick="openPincodeModal()">+ Add Pincode</button>
        </div>
        <input class="search-bar" id="pinSearch" placeholder="ğŸ” Pincode ya city search..." oninput="renderPincodes()" style="margin-bottom:8px">
        <div id="pincodeList" style="max-height:280px;overflow-y:auto">
          <div class="empty-state" style="padding:20px"><p style="font-size:12px">Koi pincodes nahi. Add karo!</p></div>
        </div>
      </div>
    </div>

    <div>
      <!-- Quick serviceability table -->
      <div class="card">
        <div class="card-hdr">ğŸ“Š Region-wise Coverage</div>
        <div id="regionCoverage">
          <div class="empty-state" style="padding:20px"><p style="font-size:12px">Pincodes add karo coverage dekhne ke liye</p></div>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <div class="card-hdr">ğŸ“ Recent Checks</div>
        <div id="recentSvcChecks">
          <div class="empty-state" style="padding:20px"><p style="font-size:12px">Koi recent checks nahi</p></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: CUSTOMER 360 â•â•â•â•â•â• -->
<div class="panel" id="panel-c360">
  <div class="sec-hdr">
    <h2>ğŸ‘ Customer 360Â°</h2>
    <span class="badge badge-purple">Universal Search</span>
    <div class="sec-line"></div>
  </div>

  <!-- Big search -->
  <div class="card" style="margin-bottom:20px;padding:24px">
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:40px;margin-bottom:8px">ğŸ”</div>
      <h3 style="font-size:18px;margin-bottom:6px">Customer khojo</h3>
      <p style="font-size:13px;color:var(--muted2)">Phone number, email, ya ticket ID se full customer view lo</p>
    </div>
    <div style="display:flex;gap:10px;max-width:600px;margin:0 auto">
      <input class="form-inp" id="c360Search" placeholder="ğŸ“± 9876543210 ya TKT-001..." style="flex:1;font-size:14px;padding:12px 16px" onkeydown="if(event.key==='Enter')searchCustomer360()">
      <button class="btn btn-pri" onclick="searchCustomer360()" style="padding:12px 24px">ğŸ” Search</button>
    </div>
  </div>

  <!-- Customer profile (shown after search) -->
  <div id="c360Profile" style="display:none">
    <div class="c360-card">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:16px">
        <div>
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
            <div style="width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,var(--purple),var(--pink));display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;color:#fff" id="c360Avatar">?</div>
            <div>
              <div class="c360-name" id="c360Name">â€”</div>
              <div class="c360-phone" id="c360Phone">â€”</div>
            </div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap" id="c360Tags"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-wa btn-sm" id="c360WaBtn" onclick="c360WhatsApp()">ğŸ’¬ WhatsApp Karo</button>
          <button class="btn btn-pri btn-sm" onclick="openTicketModal(true)">+ Ticket</button>
          <button class="btn btn-sec btn-sm" onclick="openCallModal(true)">+ Log Call</button>
        </div>
      </div>
    </div>

    <div class="grid3">
      <div class="card">
        <div class="card-hdr">ğŸ“ Call History</div>
        <div id="c360Calls"><div class="empty-state" style="padding:20px"><p style="font-size:12px">Koi calls nahi mili</p></div></div>
      </div>
      <div class="card">
        <div class="card-hdr">ğŸ« Ticket History</div>
        <div id="c360Tickets"><div class="empty-state" style="padding:20px"><p style="font-size:12px">Koi tickets nahi mili</p></div></div>
      </div>
      <div class="card">
        <div class="card-hdr">ğŸ“Š Customer Summary</div>
        <div id="c360Summary"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: CALL LOG â•â•â•â•â•â• -->
<div class="panel" id="panel-calls">
  <div class="sec-hdr">
    <h2>ğŸ“ Call Log</h2>
    <span class="badge badge-teal">Indian BPO/Sales</span>
    <div class="sec-line"></div>
    <button class="btn btn-pri btn-sm" onclick="openDialer()">ğŸ“ Dialer</button>
    <button class="btn btn-ghost btn-sm" onclick="openCallModal()">+ Log Call</button>
    <button class="btn btn-ghost btn-sm" onclick="exportCallLog()">ğŸ“¤ Export</button>
    <button class="btn btn-ghost btn-sm" onclick="openSIPSettings()" title="SIP Settings">âš™ï¸ SIP</button>
  </div>

  <!-- â”€â”€ DIALER WIDGET â”€â”€ -->
  <div id="dialerWidget" style="display:none;margin-bottom:16px">
    <div class="card" style="background:linear-gradient(135deg,#0f1f1a,#0a1628);border:1px solid #14b8a6;border-radius:16px;padding:20px;max-width:360px;margin:0 auto">
      <div style="text-align:center;margin-bottom:12px">
        <div id="sipStatusDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#ef4444;margin-right:6px"></div>
        <span id="sipStatusText" style="font-size:12px;color:var(--muted);font-family:'JetBrains Mono',monospace">SIP: Disconnected</span>
      </div>

      <!-- Number display -->
      <div style="background:#060a12;border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;margin-bottom:14px;position:relative">
        <div id="dialDisplay" style="font-size:22px;font-family:'JetBrains Mono',monospace;color:#14b8a6;min-height:32px;letter-spacing:2px">Enter Number</div>
        <div id="callerName" style="font-size:11px;color:var(--muted);margin-top:4px"></div>
        <button onclick="dialBackspace()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer">âŒ«</button>
      </div>

      <!-- Call status bar -->
      <div id="callStatusBar" style="display:none;text-align:center;margin-bottom:10px;padding:8px;border-radius:8px;background:rgba(20,184,166,0.1);border:1px solid #14b8a6">
        <span id="callStatusIcon">ğŸ“</span>
        <span id="callStatusMsg" style="font-size:13px;font-weight:600;color:#14b8a6;margin:0 8px">Connecting...</span>
        <span id="liveTimer" style="font-family:'JetBrains Mono',monospace;font-size:13px;color:#14b8a6">00:00</span>
      </div>

      <!-- Dialpad -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px" id="dialpadGrid">
        <button onclick="dialPad('1')" class="dial-key">1</button>
        <button onclick="dialPad('2')" class="dial-key">2</button>
        <button onclick="dialPad('3')" class="dial-key">3</button>
        <button onclick="dialPad('4')" class="dial-key">4</button>
        <button onclick="dialPad('5')" class="dial-key">5</button>
        <button onclick="dialPad('6')" class="dial-key">6</button>
        <button onclick="dialPad('7')" class="dial-key">7</button>
        <button onclick="dialPad('8')" class="dial-key">8</button>
        <button onclick="dialPad('9')" class="dial-key">9</button>
        <button onclick="dialPad('*')" class="dial-key">*</button>
        <button onclick="dialPad('0')" class="dial-key">0</button>
        <button onclick="dialPad('#')" class="dial-key">#</button>
      </div>

      <!-- Action buttons -->
      <div style="display:flex;gap:8px">
        <button id="callBtn" onclick="startCall()" style="flex:1;padding:14px;border-radius:10px;border:none;background:#14b8a6;color:#000;font-size:16px;font-weight:700;cursor:pointer;transition:all .2s">ğŸ“ Call</button>
        <button id="hangupBtn" onclick="hangupCall()" style="display:none;flex:1;padding:14px;border-radius:10px;border:none;background:#ef4444;color:#fff;font-size:16px;font-weight:700;cursor:pointer">ğŸ”´ Hang Up</button>
        <a id="telFallback" href="#" style="display:none;flex:1;padding:14px;border-radius:10px;border:none;background:#3b82f6;color:#fff;font-size:14px;font-weight:700;cursor:pointer;text-decoration:none;text-align:center;line-height:1.2">ğŸ“± Mobile<br>Dial</a>
      </div>

      <!-- Post-call quick log -->
      <div id="postCallBar" style="display:none;margin-top:12px;padding:12px;background:var(--card2);border-radius:10px;border:1px solid var(--border)">
        <div style="font-size:12px;color:var(--muted);margin-bottom:8px">âš¡ Quick Log karo:</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button onclick="quickLog('connected')" class="btn btn-sm" style="background:#16a34a;color:#fff;border:none">âœ… Connected</button>
          <button onclick="quickLog('not_connected')" class="btn btn-sm" style="background:#dc2626;color:#fff;border:none">ğŸ“µ NC</button>
          <button onclick="quickLog('callback')" class="btn btn-sm" style="background:#d97706;color:#fff;border:none">ğŸ”„ Callback</button>
          <button onclick="quickLog('busy')" class="btn btn-sm" style="background:#7c3aed;color:#fff;border:none">ğŸ“² Busy</button>
        </div>
      </div>
    </div>
  </div>
  <div class="grid5" style="margin-bottom:20px">
    <div class="kpi teal"><div class="lbl">Total Calls</div><div class="val" id="ck1">0</div><div class="trend">ğŸ“</div></div>
    <div class="kpi green"><div class="lbl">Connected</div><div class="val" id="ck2">0</div><div class="trend">âœ…</div></div>
    <div class="kpi red"><div class="lbl">Not Connected</div><div class="val" id="ck3">0</div><div class="trend">ğŸ“µ</div></div>
    <div class="kpi orange"><div class="lbl">Callback Pending</div><div class="val" id="ck4">0</div><div class="trend">ğŸ”„</div></div>
    <div class="kpi purple"><div class="lbl">Avg Duration</div><div class="val" id="ck5">â€”</div><div class="trend">â±</div></div>
  </div>
  <div class="card" style="padding:12px 16px;margin-bottom:14px">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <input class="form-inp" id="callSearch" placeholder="ğŸ” Customer naam, number ya agent..." oninput="renderCallLog()" style="flex:1;min-width:200px">
      <select class="form-sel" id="callStatusFilter" onchange="renderCallLog()" style="width:160px">
        <option value="">All Status</option>
        <option value="connected">âœ… Connected</option>
        <option value="not_connected">ğŸ“µ Not Connected</option>
        <option value="busy">ğŸ“² Busy</option>
        <option value="callback">ğŸ”„ Callback</option>
        <option value="voicemail">ğŸ“¬ Voicemail</option>
      </select>
      <select class="form-sel" id="callDateFilter" onchange="renderCallLog()" style="width:130px">
        <option value="">All Dates</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
      </select>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('callSearch').value='';document.getElementById('callStatusFilter').value='';document.getElementById('callDateFilter').value='';renderCallLog()">â†º Reset</button>
    </div>
  </div>
  <div id="callLogList">
    <div class="empty-state"><div class="es-icon">ğŸ“</div><h3>Koi call nahi</h3><p>Pehla call log karo ya filter change karo</p></div>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: REPORT GENERATOR â•â•â•â•â•â• -->
<div class="panel" id="panel-report">
  <div class="sec-hdr">
    <h2>ğŸ“ˆ Report Generator</h2>
    <span class="badge badge-blue">CSV / Excel â†’ Styled Report</span>
    <div class="sec-line"></div>
    <span id="reportDate" style="font-size:12px;color:var(--blue);font-family:'JetBrains Mono',monospace;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);border-radius:6px;padding:3px 10px;font-weight:600"></span>
  </div>
  <div class="upload-zone" id="upZone" onclick="document.getElementById('fi').click()"
       ondragover="onDrag(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
    <span class="uz-icon">ğŸ“¥</span>
    <h3>CSV ya Excel file yahan drop karo</h3>
    <p>ya click karke browse karo</p>
    <div class="chips">
      <span class="chip">.csv</span><span class="chip">.xlsx</span><span class="chip">.xls</span>
      <span class="chip" style="background:rgba(16,185,129,.08);border-color:rgba(16,185,129,.2);color:var(--green)">40MB+ âœ“</span>
    </div>
  </div>
  <input type="file" id="fi" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleFile(this)">
  <div class="card" id="fileBar" style="display:none;padding:12px 16px;flex-direction:row;align-items:center;gap:12px;margin-top:12px">
    <span style="font-size:20px">ğŸ“„</span>
    <div><div style="font-size:13px;font-weight:700" id="fName">â€”</div><div style="font-size:10px;color:var(--muted2);font-family:'JetBrains Mono',monospace" id="fMeta">â€”</div></div>
    <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="resetReport()">âœ• Reset</button>
  </div>
  <div class="prog-wrap" id="progWrap">
    <div class="prog-lbl" id="progLbl">Processing...</div>
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
  </div>
  <div class="stat-row" id="statRow" style="display:none">
    <div class="stat-pill"><span class="sp-val" id="s1">0</span><span class="sp-lbl">Raw Rows</span></div>
    <div class="stat-pill"><span class="sp-val" id="s2" style="color:var(--red)">0</span><span class="sp-lbl">Offhours</span></div>
    <div class="stat-pill"><span class="sp-val" id="s3" style="color:var(--orange)">0</span><span class="sp-lbl">NC Removed</span></div>
    <div class="stat-pill"><span class="sp-val" id="s4" style="color:var(--green)">0</span><span class="sp-lbl">Final Rows</span></div>
    <div class="stat-pill"><span class="sp-val" id="s5" style="color:var(--red)">0</span><span class="sp-lbl">Unmapped</span></div>
  </div>
  <div id="unmapBox" style="display:none;background:rgba(234,179,8,.08);border:1px solid rgba(234,179,8,.3);border-radius:10px;padding:14px 18px;margin-top:12px">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;cursor:pointer" onclick="toggleUnmapBox()">
      <span>âš ï¸</span>
      <strong style="color:var(--yellow);font-size:13px">Unmapped Agent Numbers</strong>
      <span id="unmapCount" style="background:rgba(234,179,8,.2);color:var(--yellow);border-radius:99px;padding:1px 9px;font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:700"></span>
      <button onclick="event.stopPropagation();toggleUnmapBox()" style="margin-left:auto;background:rgba(234,179,8,.15);border:1px solid rgba(234,179,8,.3);color:var(--yellow);border-radius:6px;padding:3px 12px;font-size:12px;cursor:pointer;font-family:'JetBrains Mono',monospace" id="unmapToggleBtn">â–¼ Hide</button>
    </div>
    <div id="unmapCards" style="display:flex;flex-direction:column;gap:8px"></div>
  </div>
  <div class="card" id="targetBar" style="display:none;padding:14px 18px;margin-top:12px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--muted2);text-transform:uppercase;letter-spacing:.5px;font-family:'JetBrains Mono',monospace">ğŸ¯ Conditional Formatting Targets</div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-ghost btn-sm" id="presetDefault" onclick="applyPreset('default')">ğŸ“‹ Default</button>
        <button class="btn btn-ghost btn-sm" id="presetStrict" onclick="applyPreset('strict')">ğŸ”¥ Strict</button>
        <button class="btn btn-ghost btn-sm" id="presetRelaxed" onclick="applyPreset('relaxed')">ğŸ˜Œ Relaxed</button>
      </div>
    </div>
    <div style="display:flex;gap:14px;flex-wrap:wrap;align-items:flex-end">
      <div>
        <div class="form-label">CSET Target (%)</div>
        <input style="background:var(--card2);border:1px solid var(--border2);border-radius:7px;padding:7px 11px;color:var(--text);font-size:13px;font-family:'JetBrains Mono',monospace;font-weight:700;width:100px;outline:none" id="tgt-csat" type="number" min="0" max="100" step="0.5" value="95" oninput="onTargetChange()">
      </div>
      <div>
        <div class="form-label">ACHT Target (mm:ss)</div>
        <input style="background:var(--card2);border:1px solid var(--border2);border-radius:7px;padding:7px 11px;color:var(--text);font-size:13px;font-family:'JetBrains Mono',monospace;font-weight:700;width:100px;outline:none" id="tgt-acht" type="text" placeholder="4:30" value="4:30" oninput="onTargetChange()">
      </div>
      <div>
        <div class="form-label">Survey% Target</div>
        <input style="background:var(--card2);border:1px solid var(--border2);border-radius:7px;padding:7px 11px;color:var(--text);font-size:13px;font-family:'JetBrains Mono',monospace;font-weight:700;width:100px;outline:none" id="tgt-surv" type="number" min="0" max="100" step="0.5" value="20" oninput="onTargetChange()">
      </div>
    </div>
  </div>
  <div id="toolbar" style="display:none;margin:16px 0;align-items:center;flex-wrap:wrap;gap:10px;justify-content:space-between">
    <div class="tab-bar">
      <button class="tab-btn on" onclick="switchTab(0)">ğŸ“Š Agent Report</button>
      <button class="tab-btn" onclick="switchTab(1)">â° Hourly</button>
      <button class="tab-btn" onclick="switchTab(2)">ğŸ“‹ Data</button>
    </div>
    <button class="btn btn-blue" onclick="dlExcel()">â¬‡ Download Styled Excel</button>
  </div>
  <div class="tbl-wrap fade-in" id="t0"><div class="tbl-scroll"><table id="agentTbl"></table></div></div>
  <div class="tbl-wrap fade-in" id="t1" style="display:none"><div class="tbl-scroll"><table id="hourlyTbl"></table></div></div>
  <div class="tbl-wrap fade-in" id="t2" style="display:none"><div class="tbl-scroll"><table id="procTbl"></table></div></div>
  <div class="alert alert-ok" id="dlOk" style="margin-top:10px">âœ… Excel download ho gayi!</div>
</div>

<!-- â•â•â•â•â•â• PANEL: CSET DASHBOARD â•â•â•â•â•â• -->
<div class="panel" id="panel-cset">
  <div class="sec-hdr">
    <h2>ğŸŒ¡ CSET Intelligence Dashboard</h2>
    <span class="badge badge-teal">Auto Drop Detection</span>
    <div class="sec-line"></div>
  </div>
  <div id="dashEmpty" class="card">
    <div class="empty-state">
      <div class="es-icon">ğŸ“ˆ</div>
      <h3>Koi data nahi</h3>
      <p>Pehle Report Generator mein CSV upload karo, phir yahan aao</p>
      <button class="btn btn-pri btn-sm" onclick="switchPanel('report')">ğŸ“ˆ Report Generator â†’</button>
    </div>
  </div>
  <div id="dashFilters" style="display:none;margin-bottom:18px">
    <div class="card" style="padding:14px 18px">
      <div class="form-label" style="margin-bottom:12px">âš¡ ADVANCED FILTERS</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
        <div><div class="form-label">TL Filter</div><select class="form-sel" id="df-tl" onchange="applyDashFilters()" style="min-width:130px"><option value="">All TLs</option></select></div>
        <div><div class="form-label">Risk Level</div><select class="form-sel" id="df-risk" onchange="applyDashFilters()"><option value="">All Risk</option><option value="HIGH">ğŸ”´ High Risk</option><option value="WARN">ğŸŸ¡ Warning</option><option value="STABLE">ğŸŸ¢ Stable</option></select></div>
        <div><div class="form-label">Min Calls</div><input class="form-inp" id="df-mincalls" type="number" min="0" value="0" style="width:90px" onchange="applyDashFilters()"></div>
        <div><div class="form-label">CSET Below %</div><input class="form-inp" id="df-csat" type="number" min="0" max="100" placeholder="85" style="width:90px" onchange="applyDashFilters()"></div>
        <button class="btn btn-ghost btn-sm" onclick="resetDashFilters()">â†º Reset</button>
        <span id="df-count" class="text-muted text-mono" style="font-size:11px;align-self:center"></span>
      </div>
    </div>
  </div>
  <div id="dashContent" style="display:none">
    <div class="grid5" style="margin-bottom:20px" id="kpiGrid"></div>
    <div class="sec-hdr collapsible-hdr" onclick="toggleSection('secDrop',this)"><h2 style="font-size:14px">â° Hour-wise CSET Drop Detection</h2><span class="collapse-btn">â–¼</span><div class="sec-line"></div></div>
    <div id="secDrop" class="tbl-wrap sec-collapsible" style="margin-bottom:20px"><div class="tbl-scroll"><table id="dropTbl"></table></div></div>
    <div class="sec-hdr collapsible-hdr" onclick="toggleSection('secRisk',this)"><h2 style="font-size:14px">ğŸš¨ Agent Risk & Root Cause</h2><span class="collapse-btn">â–¼</span><div class="sec-line"></div></div>
    <div id="secRisk" class="grid2 sec-collapsible" style="margin-bottom:20px">
      <div><div class="sec-hdr"><h2 style="font-size:14px">ğŸš¨ Agent Risk Status</h2><div class="sec-line"></div></div><div id="riskGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px"></div></div>
      <div><div class="sec-hdr"><h2 style="font-size:14px">ğŸ” Root Cause Frequency</h2><div class="sec-line"></div></div><div class="card" id="rcChart"></div></div>
    </div>
    <div class="sec-hdr collapsible-hdr" onclick="toggleSection('secHeatmap',this)"><h2 style="font-size:14px">ğŸŒ¡ CSET Heatmap â€” Agent Ã— Hour</h2><span class="collapse-btn">â–¼</span><div class="sec-line"></div></div>
    <div id="secHeatmap" class="tbl-wrap sec-collapsible" style="margin-bottom:20px"><div class="heatmap" id="heatmapWrap"></div></div>
    <div class="sec-hdr collapsible-hdr" onclick="toggleSection('secWorst',this)"><h2 style="font-size:14px">âš¡ Worst Hour Analysis</h2><span class="collapse-btn">â–¼</span><div class="sec-line"></div></div>
    <div id="secWorst" class="tbl-wrap sec-collapsible" style="margin-bottom:20px"><div class="tbl-scroll"><table id="worstHourTbl"></table></div></div>
    <div class="sec-hdr collapsible-hdr" onclick="toggleSection('secTips',this)">
      <h2 style="font-size:14px">ğŸ’¡ Agent Action Tips</h2>
      <span class="badge badge-orange">AI-Style</span>
      <span class="collapse-btn">â–¼</span><div class="sec-line"></div>
      <div style="display:flex;gap:8px">
        <select class="form-sel" id="tipsTLFilter" onchange="renderAgentTips()" style="min-width:120px;font-size:12px"><option value="">All TLs</option></select>
        <select class="form-sel" id="tipsFocusFilter" onchange="renderAgentTips()" style="min-width:140px;font-size:12px">
          <option value="">All Issues</option><option value="csat">ğŸ”´ Low CSET</option>
          <option value="surv">ğŸŸ  Low Survey%</option><option value="acht">â± High ACHT</option>
          <option value="drop">ğŸ“‰ Drop Pattern</option>
        </select>
      </div>
    </div>
    <div id="secTips" class="sec-collapsible"><div id="agentTipsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;margin-bottom:28px"></div></div>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: MONTHLY REPORT â•â•â•â•â•â• -->
<div class="panel" id="panel-monthly">
  <div class="sec-hdr"><h2>ğŸ“… Monthly Report</h2><span class="badge badge-orange">Multi-Day Aggregate</span><div class="sec-line"></div></div>
  <div class="upload-zone" id="monthlyUpZone" onclick="document.getElementById('monthlyFi').click()"
       ondragover="onMonthlyDrag(event)" ondragleave="onMonthlyDragLeave(event)" ondrop="onMonthlyDrop(event)" style="margin-bottom:16px">
    <span class="uz-icon">ğŸ“…</span>
    <h3>Multiple files yahan drop karo</h3>
    <p>Har din ka alag CSV/Excel â€” sab ek saath select karo</p>
    <div class="chips"><span class="chip">Multiple files</span><span class="chip">.csv .xlsx .xls</span></div>
  </div>
  <input type="file" id="monthlyFi" accept=".csv,.xlsx,.xls" multiple style="display:none" onchange="handleMonthlyFiles(this)">
  <div id="monthlyFilesList" style="display:none;margin-bottom:16px">
    <div class="card" style="padding:14px 18px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div class="form-label">ğŸ“‚ Loaded Files</div>
        <div style="display:flex;gap:8px"><span id="monthlyTotalBadge" class="text-muted text-mono" style="font-size:11px"></span><button class="btn btn-danger btn-sm" onclick="resetMonthly()">âœ• Reset All</button></div>
      </div>
      <div id="monthlyFilesGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px"></div>
    </div>
  </div>
  <div class="prog-wrap" id="monthlyProg"><div class="prog-lbl" id="monthlyProgLbl">Processing...</div><div class="prog-track"><div class="prog-fill" id="monthlyProgFill"></div></div></div>
  <div id="monthlyStats" style="display:none">
    <div class="stat-row" id="monthlyStatRow"></div>
    <div class="sec-hdr"><h2 style="font-size:14px">ğŸ“† Date-wise Summary</h2><div class="sec-line"></div></div>
    <div class="tbl-wrap fade-in" style="margin-bottom:20px"><div class="tbl-scroll"><table id="monthlyDateTbl"></table></div></div>
    <div class="sec-hdr"><h2 style="font-size:14px">ğŸ‘¤ Agent Monthly Aggregate</h2><div class="sec-line"></div></div>
    <div style="display:flex;gap:10px;margin-bottom:10px">
      <select class="form-sel" id="monthlyTLFilter" onchange="renderMonthlyAgent()" style="min-width:130px"><option value="">All TLs</option></select>
      <input class="form-inp" id="monthlySearch" placeholder="ğŸ” Agent name search..." oninput="renderMonthlyAgent()">
    </div>
    <div class="tbl-wrap fade-in" style="margin-bottom:20px"><div class="tbl-scroll"><table id="monthlyAgentTbl"></table></div></div>
    <div class="sec-hdr"><h2 style="font-size:14px">ğŸ‘” TL Monthly Summary</h2><div class="sec-line"></div></div>
    <div class="tbl-wrap fade-in" style="margin-bottom:20px"><div class="tbl-scroll"><table id="monthlyTLTbl"></table></div></div>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button class="btn btn-blue" onclick="dlMonthlyExcel()">â¬‡ Download Monthly Excel</button>
      <button class="btn btn-ghost" onclick="document.getElementById('monthlyFi').click()">â• Add More Files</button>
    </div>
    <div class="alert alert-ok" id="monthlyDlOk" style="margin-top:10px">âœ… Monthly Excel download ho gayi!</div>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: AGENT MANAGER â•â•â•â•â•â• -->
<div class="panel" id="panel-agents">
  <div class="sec-hdr"><h2>ğŸ‘¥ Agent Manager</h2><span class="badge badge-teal" id="totalAgentBadge">0 agents</span><div class="sec-line"></div></div>
  <div class="card" style="margin-bottom:20px">
    <div style="font-size:12px;font-weight:700;margin-bottom:14px;color:var(--muted2);text-transform:uppercase;letter-spacing:.5px;font-family:'JetBrains Mono',monospace">â• Naya Agent Add Karo</div>
    <div class="form-row">
      <div style="flex:1.5"><label class="form-label">Agent Number</label><input class="form-inp" id="inp-num" placeholder="9876543210 ya @webrtchab"></div>
      <div style="flex:2"><label class="form-label">Agent Name</label><input class="form-inp" id="inp-name" placeholder="Rahul Sharma"></div>
      <div style="flex:1"><label class="form-label">TL Name</label><select class="form-sel" id="inp-tl"></select></div>
      <button class="btn btn-sec" style="align-self:flex-end" onclick="addAgent()">+ Add</button>
      <button class="btn btn-ghost" style="align-self:flex-end" onclick="showAddTL()">+ TL</button>
    </div>
    <div id="addTLRow" style="display:none;margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--yellow)">ğŸ· Naya TL Add Karo</div>
      <div class="form-row">
        <input class="form-inp" id="inp-tl-name" placeholder="TL ka naam" style="flex:2">
        <select class="form-sel" id="inp-tl-color" style="flex:1"><option value="blue">Blue</option><option value="green">Green</option><option value="orange">Orange</option><option value="purple">Purple</option></select>
        <button class="btn btn-sec btn-sm" onclick="addTL()">Add TL</button>
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('addTLRow').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>
  <div class="sec-hdr"><h2 style="font-size:14px">ğŸ‘” TL-wise Agent Count</h2><div class="sec-line"></div></div>
  <div class="grid4" style="margin-bottom:20px" id="tlCards"></div>
  <div style="display:flex;gap:10px;margin-bottom:12px">
    <input class="search-bar" id="agentSearch" placeholder="ğŸ” Name, number ya TL..." oninput="renderAgents()" style="margin:0;flex:1">
    <select class="form-sel" id="filterTL" onchange="renderAgents()" style="min-width:130px"><option value="">All TLs</option></select>
  </div>
  <div class="tbl-wrap"><table><thead><tr><th>#</th><th>Agent Number</th><th>Agent Name</th><th>TL</th><th>Actions</th></tr></thead><tbody id="agentsTbody"></tbody></table></div>
  <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
    <button class="btn btn-pri" onclick="saveAgents()">ğŸ’¾ Save Changes</button>
    <button class="btn btn-ghost" onclick="exportAgents()">ğŸ“¤ Export JSON</button>
    <button class="btn btn-ghost" onclick="document.getElementById('importFile').click()">ğŸ“¥ Import JSON</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importAgents(this)">
  </div>
  <div class="alert alert-ok" id="saveAlert"></div>
</div>

<!-- â•â•â•â•â•â• PANEL: CANCELLATION TOOL â•â•â•â•â•â• -->
<div class="panel" id="panel-cancel">
  <div class="sec-hdr"><h2>ğŸš« Cancellation & Retention</h2><span class="badge badge-red">Retention Analysis</span><div class="sec-line"></div></div>
  <div class="card" style="margin-bottom:16px" id="cancelAgentBox">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div class="form-label">Active Agents <span id="cancelAgentCount" style="background:rgba(20,184,166,.2);color:var(--teal);padding:1px 6px;border-radius:99px;font-size:10px">0</span></div>
      <div style="display:flex;gap:8px"><button class="btn btn-ghost btn-sm" onclick="toggleAllCancel(true)">âœ… All ON</button><button class="btn btn-ghost btn-sm" onclick="toggleAllCancel(false)">âŒ All OFF</button></div>
    </div>
    <div id="cancelTagsWrap" style="display:flex;flex-wrap:wrap;gap:4px"></div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <input class="form-inp" id="cancelNewAgent" placeholder="Custom agent naam, Enter dabaao..." style="flex:1" onkeydown="if(event.key==='Enter')addCancelAgent()">
      <button class="btn btn-ghost btn-sm" onclick="addCancelAgent()">+ Add</button>
    </div>
  </div>
  <div style="display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
    <input type="date" class="form-inp" id="cancelDateFrom" onchange="checkCancelDate()" style="width:160px">
    <input type="date" class="form-inp" id="cancelDateTo" onchange="checkCancelDate()" style="width:160px">
    <span id="cancelDateBadge" style="display:none" class="badge badge-orange">ğŸŸ  Date Active</span>
    <button class="btn btn-ghost btn-sm" onclick="clearCancelDates()">Clear Dates</button>
  </div>
  <div class="upload-zone" id="cancelUpZone" onclick="document.getElementById('cancelFi').click()"
       ondragover="onCancelDrag(event)" ondragleave="onCancelDragLeave(event)" ondrop="onCancelDrop(event)">
    <span class="uz-icon">ğŸ“‚</span><h3>Cancellation data upload karo</h3><p>CSV ya Excel file drag karo</p>
    <div class="chips"><span class="chip">.csv</span><span class="chip">.xlsx</span></div>
  </div>
  <input type="file" id="cancelFi" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleCancelFile(this)">
  <div class="prog-wrap" id="cancelProgWrap"><div class="prog-lbl" id="cancelProgLbl">Processing...</div><div class="prog-track"><div class="prog-fill" id="cancelProgFill"></div></div></div>
  <div class="alert alert-err" id="cancelErrAlert" style="display:none;margin-top:8px"></div>
  <div id="cancelResults" style="display:none">
    <div class="grid4" style="margin:16px 0">
      <div class="kpi teal"><div class="lbl">Total Requests</div><div class="val" id="kTotal">0</div><div class="trend">ğŸ“‹</div></div>
      <div class="kpi green"><div class="lbl">True Retained</div><div class="val" id="kRetained">0</div><div class="trend">âœ…</div></div>
      <div class="kpi red"><div class="lbl">Cancellations</div><div class="val" id="kCancelled">0</div><div class="trend">âŒ</div></div>
      <div class="kpi orange"><div class="lbl">Retention %</div><div class="val" id="kRetPct">0%</div><div class="trend">ğŸ’ª</div></div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
      <div class="tab-bar">
        <button class="tab-btn on" onclick="switchCancelTab(0)">ğŸ“Š Agent</button>
        <button class="tab-btn" onclick="switchCancelTab(1)">ğŸ“‹ Status</button>
        <button class="tab-btn" onclick="switchCancelTab(2)">ğŸ“Œ Reasons</button>
        <button class="tab-btn" onclick="switchCancelTab(3)">â° Hourly</button>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="resetCancelTool()">ğŸ”„ Reset</button>
      <button class="btn btn-blue btn-sm" onclick="exportCancelExcel()">â¬‡ Excel</button>
    </div>
    <div id="ct0">
      <div class="sec-hdr"><h2 style="font-size:14px">Agent-wise Report</h2><span id="cancelAgentBadge" class="badge badge-teal">0 agents</span><div class="sec-line"></div></div>
      <input class="search-bar" id="cancelSearch" placeholder="ğŸ” Agent search..." oninput="filterCancelAgents()">
      <div class="tbl-wrap"><div class="tbl-scroll"><table id="cancelAgentTbl"></table></div></div>
    </div>
    <div id="ct1" style="display:none"><div class="grid2"><div class="card"><div class="card-hdr">ğŸ“Š Status Distribution</div><div id="cancelStatusBreakdown"></div></div><div class="card"><div class="card-hdr">ğŸ† Top Retainers</div><div id="cancelTopRetainers"></div></div></div></div>
    <div id="ct2" style="display:none"><div class="grid2"><div class="card"><div class="card-hdr">âŒ Top Cancel Reasons</div><div id="cancelReasons"></div></div><div class="card"><div class="card-hdr">âœ… Retained Reasons</div><div id="retainedReasons"></div></div></div></div>
    <div id="ct3" style="display:none"><div class="card"><div class="card-hdr">ğŸ• Hour-wise Breakdown</div><div id="cancelHourlyBreakdown"></div></div></div>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: AI REMARKS â•â•â•â•â•â• -->
<div class="panel" id="panel-remarks">
  <div class="sec-hdr"><h2>ğŸ¤– AI Remarks Generator</h2><span class="badge badge-purple">Claude AI Powered</span><div class="sec-line"></div></div>
  <div style="max-width:800px">
    <div class="form-row" style="margin-bottom:16px">
      <div style="flex:1"><label class="form-label">Agent Name</label><input class="form-inp" id="rmAgent" placeholder="Agent ka naam"></div>
      <div style="flex:2">
        <label class="form-label">Anthropic API Key</label>
        <div style="display:flex;gap:8px">
          <input class="form-inp" id="rmApiKey" type="password" placeholder="sk-ant-..." style="flex:1;font-family:'JetBrains Mono',monospace;font-size:11px">
          <button class="btn btn-ghost btn-sm" onclick="saveApiKey()">Save</button>
        </div>
      </div>
    </div>
    <div id="keyStatus" style="font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--muted);margin-bottom:16px"></div>
    <div class="sc-panel open" id="scPanel">
      <div class="sc-panel-hdr" onclick="toggleRmPanel()">
        <div class="sc-panel-title">Scenario / SC Selection <span id="scCount" style="background:rgba(20,184,166,.2);color:var(--teal);padding:1px 6px;border-radius:99px;margin-left:6px">0</span></div>
        <span class="sc-toggle-icon">â–²</span>
      </div>
      <div class="sc-body"><div id="scChipsWrap" style="display:flex;flex-wrap:wrap"></div></div>
    </div>
    <div style="margin-bottom:16px">
      <div style="font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--muted2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px">Teams <button class="btn btn-ghost btn-sm" style="margin-left:8px" onclick="openAddTeamModal()">+ Add Team</button></div>
      <div id="teamChipsWrap" style="display:flex;flex-wrap:wrap"></div>
      <div id="extraTeamChips" style="display:flex;flex-wrap:wrap;margin-top:4px"></div>
    </div>
    <!-- Remark type selector -->
    <div class="form-grp">
      <label class="form-label">Remark Type</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px"><input type="radio" name="rmType" value="cx" checked> ğŸ§ CX/Support</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px"><input type="radio" name="rmType" value="sales"> ğŸ’° Sales</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px"><input type="radio" name="rmType" value="retention"> ğŸš« Retention</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px"><input type="radio" name="rmType" value="escalation"> ğŸš¨ Escalation</label>
      </div>
    </div>
    <label class="form-label">Customer Issue (Rough points likho)</label>
    <textarea class="rough-area" id="roughInp" placeholder="e.g. customer ka product kharab hua, wo cancel karna chahta tha, humne replacement offer kiya, abhi happy hai..."></textarea>
    <button class="gen-btn" id="genBtn" onclick="doGen()"><span>âœ¨ Remarks Generate Karo</span></button>
    <div id="rmOutput" style="margin-top:20px"></div>
    <div style="margin-top:20px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div class="form-label">History</div>
        <button class="btn btn-danger btn-sm" onclick="clearRmHist()">Clear</button>
      </div>
      <div id="rmHistList"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: MANAGER VIEW â•â•â•â•â•â• -->
<div class="panel" id="panel-manager">
  <div class="sec-hdr"><h2>ğŸ”’ Manager Intelligence View</h2><span class="badge badge-purple">RESTRICTED</span><div class="sec-line"></div><button class="btn btn-danger btn-sm" onclick="lockManager()">ğŸ”’ Lock</button></div>
  <div id="mgrEmpty" class="card"><div class="empty-state"><div class="es-icon">ğŸ“Š</div><h3>Koi data nahi</h3><p>Pehle Report Generator mein CSV upload karo</p><button class="btn btn-pri btn-sm" onclick="switchPanel('report')">ğŸ“ˆ Report Generator â†’</button></div></div>
  <div id="mgrContent" style="display:none">
    <div class="sec-hdr"><h2 style="font-size:14px">ğŸ“Š TL-wise Performance</h2><div class="sec-line"></div></div>
    <div class="tbl-wrap" style="margin-bottom:20px"><div class="tbl-scroll"><table id="tlPerfTbl"></table></div></div>
    <div class="grid2" style="margin-bottom:20px">
      <div><div class="sec-hdr"><h2 style="font-size:14px">ğŸš¨ Top Risk Agents</h2><div class="sec-line"></div></div><div id="mgrRiskCards"></div></div>
      <div><div class="sec-hdr"><h2 style="font-size:14px">ğŸ“‰ CSET Volatility Score</h2><div class="sec-line"></div></div><div class="card" id="voltChart"></div></div>
    </div>
    <div class="sec-hdr"><h2 style="font-size:14px">ğŸŒ¡ Hour Ã— TL Heatmap</h2><div class="sec-line"></div></div>
    <div class="tbl-wrap" style="margin-bottom:20px"><div class="heatmap" id="mgrHeatmap"></div></div>
    <div class="sec-hdr"><h2 style="font-size:14px">ğŸ” Root Cause & Actions</h2><div class="sec-line"></div></div>
    <div class="card" id="mgrRcSection"></div>
  </div>
</div>
<div id="mgrPwdOverlay" style="display:none;position:fixed;inset:0;background:rgba(6,10,18,.96);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(10px)">
  <div class="card" style="width:380px;text-align:center;padding:40px">
    <div style="font-size:40px;margin-bottom:16px">ğŸ”</div>
    <h3 style="margin-bottom:6px">Manager Access</h3>
    <p style="font-size:13px;color:var(--muted2);margin-bottom:24px">Restricted section. Password enter karo.</p>
    <div style="color:var(--red);font-size:12px;margin-bottom:10px;display:none" id="mgrPwdErr">âŒ Wrong password</div>
    <input style="width:100%;background:var(--card2);border:1px solid var(--border2);border-radius:8px;padding:12px;color:var(--text);font-size:16px;text-align:center;letter-spacing:4px;font-family:'JetBrains Mono',monospace;margin-bottom:12px;outline:none" id="mgrPwdInp" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')checkMgrPwd()">
    <button class="btn btn-pri" style="width:100%;justify-content:center;margin-bottom:8px" onclick="checkMgrPwd()">Unlock â†’</button>
    <button class="btn btn-ghost" style="width:100%;justify-content:center" onclick="cancelMgrPwd()">Cancel</button>
  </div>
</div>

<!-- â•â•â•â•â•â• PANEL: ADMIN â•â•â•â•â•â• -->
<div class="panel" id="panel-admin">
  <div class="sec-hdr"><h2>âš™ï¸ Admin Panel</h2><span class="badge badge-purple">Admin Only</span><div class="sec-line"></div></div>
  <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">
    <button class="tab-btn on" id="at0" onclick="switchAdminTab(0)">ğŸ“Š Dashboard</button>
    <button class="tab-btn" id="at1" onclick="switchAdminTab(1)">ğŸ‘¥ Users</button>
    <button class="tab-btn" id="at2" onclick="switchAdminTab(2)">ğŸ“‹ Audit Log</button>
    <button class="tab-btn" id="at3" onclick="switchAdminTab(3)">âš™ï¸ Settings</button>
  </div>
  <div id="adminTab0">
    <div class="grid4" id="adminKPIs">
      <div class="kpi purple"><div class="lbl">Total Users</div><div class="val" id="ak1">â€”</div><div class="trend">ğŸ‘¥</div></div>
      <div class="kpi teal"><div class="lbl">Active Today</div><div class="val" id="ak2">â€”</div><div class="trend">âœ…</div></div>
      <div class="kpi blue"><div class="lbl">Total Agents</div><div class="val" id="ak3">â€”</div><div class="trend">ğŸ¯</div></div>
      <div class="kpi orange"><div class="lbl">Calls Today</div><div class="val" id="ak4">â€”</div><div class="trend">ğŸ“</div></div>
    </div>
    <div class="sec-hdr" style="margin-top:20px"><h2 style="font-size:14px">Recent Activity</h2><div class="sec-line"></div></div>
    <div id="adminActivity" class="card" style="padding:0"><div class="empty-state" style="padding:30px"><p>Loading activity...</p></div></div>
  </div>
  <div id="adminTab1" style="display:none">
    <div style="display:flex;gap:10px;margin-bottom:16px">
      <input class="search-bar" id="userSearch" placeholder="ğŸ” User search..." oninput="renderAdminUsers()" style="margin:0;flex:1">
      <button class="btn btn-purple" onclick="openAddUserModal()">+ Add User</button>
    </div>
    <div class="tbl-wrap"><div class="tbl-scroll"><table id="adminUserTbl"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Last Login</th><th>Actions</th></tr></thead><tbody id="adminUserBody"><tr><td colspan="6" style="text-align:center;padding:30px;color:var(--muted2)">Loading users...</td></tr></tbody></table></div></div>
  </div>
  <div id="adminTab2" style="display:none">
    <div class="tbl-wrap"><div class="tbl-scroll"><table id="adminAuditTbl"><thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead><tbody id="adminAuditBody"><tr><td colspan="4" style="text-align:center;padding:30px;color:var(--muted2)">Loading audit log...</td></tr></tbody></table></div></div>
  </div>
  <div id="adminTab3" style="display:none">
    <div class="card">
      <div class="card-hdr">System Settings</div>
      <div style="display:flex;align-items:center;padding:14px 0;border-bottom:1px solid var(--border);gap:16px">
        <div style="flex:1"><div style="font-size:13px;font-weight:700;margin-bottom:3px">CRM Version</div><div class="text-muted text-mono" style="font-size:11px">Livsmart CRM v3.0 â€” All-in-One Enterprise Platform</div></div>
        <span class="badge badge-green">v2.0 Latest</span>
      </div>
      <div style="display:flex;align-items:center;padding:14px 0;border-bottom:1px solid var(--border);gap:16px">
        <div style="flex:1"><div style="font-size:13px;font-weight:700;margin-bottom:3px">Firebase Status</div><div class="text-muted text-mono" style="font-size:11px">livsmart-hub-default-rtdb Â· Real-time connected</div></div>
        <span class="badge badge-green">ğŸŸ¢ Connected</span>
      </div>
      <div style="display:flex;align-items:center;padding:14px 0;gap:16px">
        <div style="flex:1"><div style="font-size:13px;font-weight:700;margin-bottom:3px">Total Agents</div><div class="text-muted text-mono" style="font-size:11px">MASTER agent database</div></div>
        <span class="badge badge-teal" id="settingsAgentCount">Loading...</span>
      </div>
    </div>
    <!-- WhatsApp Config -->
    <div class="card" style="margin-top:16px">
      <div class="card-hdr">ğŸ’¬ WhatsApp Template Config</div>
      <div class="form-grp"><label class="form-label">Company WhatsApp Number</label><input class="form-inp" id="cfg-wa-num" placeholder="919876543210" value="919876543210"></div>
      <div class="form-grp"><label class="form-label">Default Greeting Template</label><textarea class="form-ta" id="cfg-wa-greet" rows="3" placeholder="Namaste {name}! Main Livsmart se bol raha hun...">Namaste {name}! ğŸ™ Main Livsmart CRM se bol raha hun. Aapki query ke baare mein baat karni thi. Kya aap abhi baat kar sakte hain?</textarea></div>
      <button class="btn btn-sec btn-sm" onclick="saveCfg()">ğŸ’¾ Save Config</button>
    </div>
  </div>
</div>

  </div><!-- /panel-area -->
</div><!-- /main-content -->
</div><!-- /crmApp -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- New Call Modal -->
<div class="modal-bg" id="callModal">
  <div class="modal" style="max-width:580px">
    <h3>ğŸ“ Naya Call Log</h3>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Customer Name *</label><input class="form-inp" id="cm-name" placeholder="Rajesh Sharma"></div>
      <div class="form-grp">
        <label class="form-label">Phone Number *</label>
        <div style="position:relative">
          <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--muted2);font-family:'JetBrains Mono',monospace">+91</span>
          <input class="form-inp" id="cm-phone" placeholder="9876543210" maxlength="10" type="tel" style="padding-left:42px">
        </div>
      </div>
    </div>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Call Status *</label><select class="form-sel" id="cm-status"><option value="connected">âœ… Connected</option><option value="not_connected">ğŸ“µ Not Connected</option><option value="busy">ğŸ“² Busy</option><option value="callback">ğŸ”„ Callback Required</option><option value="voicemail">ğŸ“¬ Voicemail</option></select></div>
      <div class="form-grp"><label class="form-label">Call Duration</label><input class="form-inp" id="cm-duration" placeholder="mm:ss e.g. 5:30"></div>
    </div>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Call Type</label><select class="form-sel" id="cm-type"><option value="inbound">ğŸ“¥ Inbound</option><option value="outbound">ğŸ“¤ Outbound</option><option value="followup">ğŸ”„ Follow-up</option></select></div>
      <div class="form-grp"><label class="form-label">Product/Service</label><input class="form-inp" id="cm-product" placeholder="Livsmart Premium"></div>
    </div>
    <div class="form-grp"><label class="form-label">Customer Issue / Reason</label><input class="form-inp" id="cm-issue" placeholder="Customer ne kya bola..."></div>
    <div class="form-grp"><label class="form-label">Resolution / Action Taken</label><textarea class="form-ta" id="cm-resolution" placeholder="Kya solution diya..."></textarea></div>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Follow-up Date</label><input class="form-inp" id="cm-followup" type="date"></div>
      <div class="form-grp"><label class="form-label">Priority</label><select class="form-sel" id="cm-priority"><option value="normal">ğŸŸ¢ Normal</option><option value="high">ğŸŸ  High</option><option value="urgent">ğŸ”´ Urgent</option></select></div>
    </div>
    <div class="form-grp"><label class="form-label">Agent Notes (Internal)</label><input class="form-inp" id="cm-notes" placeholder="Internal note..."></div>
    <!-- WhatsApp followup toggle -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <label class="toggle">
        <div class="toggle-track" id="waFollowToggle"><div class="toggle-thumb"></div></div>
        <span style="font-size:12px;color:var(--muted2)">ğŸ’¬ Auto WhatsApp Bhejo after save</span>
      </label>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeCallModal()">Cancel</button>
      <button class="btn btn-pri" onclick="saveCall()">ğŸ’¾ Save Call</button>
    </div>
  </div>
</div>

<!-- New Ticket Modal -->
<div class="modal-bg" id="ticketModal">
  <div class="modal" style="max-width:620px">
    <h3>ğŸ« Naya Ticket</h3>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Customer Name *</label><input class="form-inp" id="tm-name" placeholder="Customer ka naam"></div>
      <div class="form-grp"><label class="form-label">Phone Number *</label><input class="form-inp" id="tm-phone" placeholder="9876543210" type="tel" maxlength="10"></div>
    </div>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Category *</label><select class="form-sel" id="tm-cat"><option value="delivery">ğŸšš Delivery</option><option value="product">ğŸ“¦ Product Issue</option><option value="billing">ğŸ’³ Billing</option><option value="returns">ğŸ”„ Returns</option><option value="installation">ğŸ”§ Installation</option><option value="complaint">ğŸ˜¡ Complaint</option><option value="enquiry">â“ Enquiry</option></select></div>
      <div class="form-grp"><label class="form-label">Priority *</label><select class="form-sel" id="tm-priority"><option value="normal">ğŸŸ¢ Normal (24h SLA)</option><option value="high">ğŸŸ  High (12h SLA)</option><option value="urgent">ğŸ”´ Urgent (4h SLA)</option><option value="low">âšª Low (48h SLA)</option></select></div>
    </div>
    <div class="form-grp"><label class="form-label">Issue Description *</label><textarea class="form-ta" id="tm-issue" placeholder="Customer ki problem detail mein likho..." rows="3"></textarea></div>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Product/Order ID</label><input class="form-inp" id="tm-orderid" placeholder="ORD-12345 ya product serial"></div>
      <div class="form-grp"><label class="form-label">Region</label><select class="form-sel" id="tm-region"><option value="north">ğŸ”µ North</option><option value="south">ğŸŸ¢ South</option><option value="east">ğŸŸ  East</option><option value="west">ğŸŸ£ West</option></select></div>
    </div>
    <div class="form-grp"><label class="form-label">Pincode</label><input class="form-inp" id="tm-pincode" placeholder="110001" maxlength="6"></div>
    <div class="form-grp"><label class="form-label">Agent Notes</label><input class="form-inp" id="tm-notes" placeholder="Internal notes..."></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTicketModal()">Cancel</button>
      <button class="btn btn-pri" onclick="saveTicket()">ğŸ« Create Ticket</button>
    </div>
  </div>
</div>

<!-- View Ticket Modal -->
<div class="modal-bg" id="viewTicketModal">
  <div class="modal lg">
    <div id="viewTicketContent"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeViewTicketModal()">Close</button>
    </div>
  </div>
</div>

<!-- New Lead Modal -->
<div class="modal-bg" id="leadModal">
  <div class="modal" style="max-width:620px">
    <h3>ğŸ’° Naya Lead</h3>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Customer Name *</label><input class="form-inp" id="lm-name" placeholder="Customer ka naam"></div>
      <div class="form-grp"><label class="form-label">Phone Number *</label><input class="form-inp" id="lm-phone" placeholder="9876543210" type="tel" maxlength="10"></div>
    </div>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Lead Status</label><select class="form-sel" id="lm-status"><option value="new">ğŸ†• New</option><option value="contacted">ğŸ“ Contacted</option><option value="qualified">â­ Qualified</option><option value="converted">âœ… Converted</option><option value="lost">âŒ Lost</option></select></div>
      <div class="form-grp"><label class="form-label">Source</label><select class="form-sel" id="lm-source"><option value="inbound">ğŸ“¥ Inbound</option><option value="outbound">ğŸ“¤ Outbound</option><option value="referral">ğŸ¤ Referral</option><option value="social">ğŸ“± Social Media</option><option value="website">ğŸŒ Website</option></select></div>
    </div>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Product Interest</label><input class="form-inp" id="lm-product" placeholder="Air Purifier, Solar, etc."></div>
      <div class="form-grp"><label class="form-label">Estimated Value (â‚¹)</label><input class="form-inp" id="lm-value" type="number" placeholder="25000"></div>
    </div>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Region</label><select class="form-sel" id="lm-region"><option value="north">ğŸ”µ North</option><option value="south">ğŸŸ¢ South</option><option value="east">ğŸŸ  East</option><option value="west">ğŸŸ£ West</option></select></div>
      <div class="form-grp"><label class="form-label">Follow-up Date</label><input class="form-inp" id="lm-followup" type="date"></div>
    </div>
    <div class="form-grp"><label class="form-label">Notes</label><textarea class="form-ta" id="lm-notes" placeholder="Lead ke baare mein notes..."></textarea></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeLeadModal()">Cancel</button>
      <button class="btn btn-pri" onclick="saveLead()">ğŸ’° Save Lead</button>
    </div>
  </div>
</div>

<!-- Set Target Modal -->
<div class="modal-bg" id="targetModal">
  <div class="modal">
    <h3>ğŸ¯ Target Set Karo</h3>
    <div class="form-grp"><label class="form-label">Agent / Team</label><input class="form-inp" id="tgt-agent" placeholder="Agent naam ya 'Team'"></div>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Monthly Sales Target (â‚¹)</label><input class="form-inp" id="tgt-sales" type="number" placeholder="500000"></div>
      <div class="form-grp"><label class="form-label">Daily Calls Target</label><input class="form-inp" id="tgt-calls" type="number" placeholder="80"></div>
    </div>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Lead Conversions Target</label><input class="form-inp" id="tgt-leads" type="number" placeholder="20"></div>
      <div class="form-grp"><label class="form-label">Month</label><input class="form-inp" id="tgt-month" type="month"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTargetModal()">Cancel</button>
      <button class="btn btn-pri" onclick="saveTarget()">ğŸ¯ Set Target</button>
    </div>
  </div>
</div>

<!-- Add Pincode Modal -->
<div class="modal-bg" id="pincodeModal">
  <div class="modal">
    <h3>ğŸ“ Naya Pincode Add Karo</h3>
    <div class="form-grp"><label class="form-label">Pincode *</label><input class="form-inp" id="pin-code" maxlength="6" placeholder="110001" oninput="this.value=this.value.replace(/\D/g,'')"></div>
    <div class="form-grp"><label class="form-label">City / Area</label><input class="form-inp" id="pin-city" placeholder="New Delhi, Connaught Place"></div>
    <div class="form-grp"><label class="form-label">State</label><input class="form-inp" id="pin-state" placeholder="Delhi"></div>
    <div class="form-grp"><label class="form-label">Region</label><select class="form-sel" id="pin-region"><option value="north">ğŸ”µ North</option><option value="south">ğŸŸ¢ South</option><option value="east">ğŸŸ  East</option><option value="west">ğŸŸ£ West</option></select></div>
    <div class="form-grp"><label class="form-label">Service Available</label><select class="form-sel" id="pin-available"><option value="yes">âœ… Yes - Full Service</option><option value="limited">âš  Limited Service</option><option value="no">âŒ Not Available</option></select></div>
    <div class="form-grp"><label class="form-label">ETA (days)</label><input class="form-inp" id="pin-eta" type="number" placeholder="3" min="1"></div>
    <div class="form-grp"><label class="form-label">Service Charges (â‚¹)</label><input class="form-inp" id="pin-charge" type="number" placeholder="0 for free"></div>
    <div class="form-grp"><label class="form-label">Service Partner</label><input class="form-inp" id="pin-partner" placeholder="BlueDart, Delhivery, etc."></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="document.getElementById('pincodeModal').classList.remove('show')">Cancel</button>
      <button class="btn btn-pri" onclick="savePincode()">ğŸ“ Save Pincode</button>
    </div>
  </div>
</div>

<!-- Add Team Modal -->
<div class="modal-bg" id="addTeamModal">
  <div class="modal" style="max-width:380px">
    <h3>ğŸ· Naya Team Add Karo</h3>
    <div class="form-grp"><label class="form-label">Team Name</label><input class="form-inp" id="newTeamInp" placeholder="Team ka naam" onkeydown="if(event.key==='Enter')saveTeam()"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTeamModal()">Cancel</button>
      <button class="btn btn-pri" onclick="saveTeam()">â• Add Team</button>
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal-bg" id="addUserModal">
  <div class="modal">
    <h3>ğŸ‘¥ Naya User Add Karo</h3>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Full Name</label><input class="form-inp" id="nu-name" placeholder="Rahul Sharma"></div>
      <div class="form-grp"><label class="form-label">Email</label><input class="form-inp" id="nu-email" type="email" placeholder="rahul@livsmart.in"></div>
    </div>
    <div class="grid2">
      <div class="form-grp"><label class="form-label">Role</label><select class="form-sel" id="nu-role"><option value="agent">Agent</option><option value="manager">Manager</option><option value="admin">Admin</option></select></div>
      <div class="form-grp"><label class="form-label">Password</label><input class="form-inp" id="nu-pwd" type="password" placeholder="Min 6 chars"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeAddUserModal()">Cancel</button>
      <button class="btn btn-purple" onclick="addUser()">ğŸ‘¥ Add User</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>
<!-- Watermark -->
<div class="watermark">Designed by <strong style="color:rgba(20,184,166,.35)">Pranamya Upadhyay</strong><br>Livsmart CRM v3.0</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVSMART CRM v3.0 â€” COMPLETE JS ENGINE
// Pranamya Upadhyay Â· Firebase + AI + Report + Tools
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVSMART CRM v3.0 â€” COMPLETE JAVASCRIPT ENGINE
// Pranamya Upadhyay Â· Firebase + AI + Report + Cancellation + Remarks
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ FIREBASE INITIALIZATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
  apiKey: "AIzaSyAiMCrfVSNWSMw34m2KjcFqXzmA7dkkfl8",
  authDomain: "livsmart-hub.firebaseapp.com",
  databaseURL: "https://livsmart-hub-default-rtdb.firebaseio.com",
  projectId: "livsmart-hub",
  storageBucket: "livsmart-hub.firebasestorage.app",
  messagingSenderId: "172310029111",
  appId: "1:172310029111:web:890fd0a6db3e583808b0b2"
};
// Firebase safety check
if(typeof firebase === 'undefined') {
  document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#060a12;color:#14b8a6;font-family:sans-serif;flex-direction:column;gap:16px"><div style="font-size:48px">âš ï¸</div><div style="font-size:20px;font-weight:bold">Firebase load nahi hua</div><div style="color:#888;font-size:14px">Internet connection check karo aur page reload karo</div><button onclick="location.reload()" style="margin-top:16px;padding:10px 24px;background:#14b8a6;border:none;border-radius:8px;color:#000;font-weight:bold;cursor:pointer;font-size:14px">ğŸ”„ Reload</button></div>';
  throw new Error('Firebase SDK not loaded');
}
const _app = firebase.initializeApp(firebaseConfig);
const _auth = firebase.auth();
const _db = firebase.database();

// â”€â”€â”€ AUTH STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_auth.onAuthStateChanged(async (user) => {
  if (!user) {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('crmApp').style.display = 'none';
    // Reset login button if stuck
    const btn = document.getElementById('loginBtn');
    if(btn) { btn.disabled = false; btn.textContent = 'ğŸ” Login Karo'; }
    return;
  }
  try {
    const snap = await _db.ref('users/' + user.uid).get();
    
    // If user record doesn't exist in DB, create a basic one and allow login
    let userData;
    if (!snap.exists()) {
      userData = { name: user.email.split('@')[0], email: user.email, role: 'agent', active: true, createdAt: new Date().toISOString() };
      await _db.ref('users/' + user.uid).set(userData);
    } else {
      userData = snap.val();
    }
    
    // Check if account is explicitly disabled (active: false)
    if (userData.active === false) {
      const err = document.getElementById('loginErr');
      if(err) { err.textContent = 'âŒ Account disabled. Admin se contact karo.'; err.style.display = 'block'; }
      await _auth.signOut();
      return;
    }
    
    const profile = { uid: user.uid, email: user.email, ...userData };
    localStorage.setItem('lv_profile', JSON.stringify(profile));
    window._profile = profile;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('crmApp').style.display = 'flex';
    // initCRM ko alag try-catch mein - crash hone pe signOut mat karo
    try { initCRM(profile); } catch(e) { console.error('initCRM error:', e); }
    _db.ref('users/' + user.uid).update({ lastLogin: new Date().toISOString(), active: true }).catch(()=>{});
  } catch(e) {
    console.error('Auth DB error:', e);
    // DB error pe bhi CRM show karo - sirf profile se
    const profile2 = { uid: user.uid, email: user.email, name: user.email.split('@')[0], role: 'agent', active: true };
    window._profile = profile2;
    localStorage.setItem('lv_profile', JSON.stringify(profile2));
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('crmApp').style.display = 'flex';
    try { initCRM(profile2); } catch(e2) { console.error('initCRM error:', e2); }
  }
});

window.doLogin = async () => {
  const email = document.getElementById('loginEmail').value.trim();
  const pwd = document.getElementById('loginPwd').value;
  const btn = document.getElementById('loginBtn');
  const err = document.getElementById('loginErr');
  if (!email || !pwd) { err.textContent = 'âŒ Email aur password bharo'; err.style.display = 'block'; return; }
  btn.disabled = true; btn.textContent = 'â³ Logging in...'; err.style.display = 'none';
  try {
    await _auth.signInWithEmailAndPassword(email, pwd);
  } catch(e) {
    err.textContent = 'âŒ ' + (e.code === 'auth/wrong-password' ? 'Wrong password!' : e.code === 'auth/user-not-found' ? 'Account nahi mila!' : e.message);
    err.style.display = 'block'; btn.disabled = false; btn.textContent = 'ğŸ” Login Karo';
  }
};
window.doLogout = async () => { await _auth.signOut(); localStorage.removeItem('lv_profile'); window.location.reload(); };

// â”€â”€â”€ FIREBASE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fbSave = (path, data) => _db.ref(path).push({ ...data, createdAt: firebase.database.ServerValue.TIMESTAMP, createdBy: window._profile?.uid });
const fbSet  = (path, data) => _db.ref(path).set(data);
const fbGet  = async (path) => { const s = await _db.ref(path).get(); return s.exists() ? s.val() : null; };
const fbGetList = async (path) => { const v = await fbGet(path); return v ? Object.entries(v).map(([id,d])=>({id,...d})) : []; };
const fbRemove = (path) => _db.ref(path).remove();
const fbUpdate = (path, data) => _db.ref(path).update(data);

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, type='ok') {
  const t = document.getElementById('toast');
  if (!t) return;
  t.className = 'toast show ' + type;
  t.innerHTML = (type==='ok'?'âœ…':type==='err'?'âŒ':type==='warn'?'âš ï¸':'â„¹ï¸') + ' ' + msg;
  clearTimeout(window._toastT);
  window._toastT = setTimeout(() => t.className = 'toast', 3000);
}
function showAlert(id, msg, dur=3000) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg; el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', dur);
}

// â”€â”€â”€ PANEL SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _currentPanel = 'home';
function switchPanel(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const panel = document.getElementById('panel-' + name);
  const nav = document.getElementById('nav-' + name);
  if (panel) { panel.classList.add('active'); panel.style.animation='none'; panel.offsetHeight; panel.style.animation=''; }
  if (nav) nav.classList.add('active');
  _currentPanel = name;

  // Panel titles
  const titles = { home:'ğŸ  Home Dashboard',leads:'ğŸ’° Lead Manager',targets:'ğŸ¯ Target Tracker',buyback:'ğŸ” Buyback Calculator',tickets:'ğŸ« Ticket Manager',service:'ğŸ“ Serviceability',c360:'ğŸ‘ Customer 360Â°',calls:'ğŸ“ Call Log',report:'ğŸ“ˆ Report Generator',cset:'ğŸŒ¡ CSET Dashboard',monthly:'ğŸ“… Monthly Report',agents:'ğŸ‘¥ Agent Manager',cancel:'ğŸš« Cancellation Tool',remarks:'ğŸ¤– AI Remarks',manager:'ğŸ”’ Manager View',admin:'âš™ï¸ Admin Panel' };
  const t = document.getElementById('topbarTitle');
  const b = document.getElementById('topbarBreadcrumb');
  if(t) t.textContent = titles[name] || name;
  if(b) b.textContent = name;

  // Panel-specific init
  if(name==='home') renderHomeStats();
  if(name==='agents'){ renderTLCards(); renderAgents(); }
  if(name==='leads') { renderLeads(); updateLeadKPIs(); }
  if(name==='tickets') { renderTickets(); updateTicketKPIs(); }
  if(name==='calls') { renderCallLog(); updateCallKPIs(); }
  if(name==='targets') renderTargets();
  if(name==='manager') openManagerPanel();
  if(name==='monthly') initMonthlyPanel();
  if(name==='admin') renderAdminPanel();
  if(name==='cancel') initCancelPanel();
  if(name==='remarks') initRemarksPanel();
  if(name==='service') renderPincodes();

  closeSidebar();
}

// Backward compat alias (v14 uses navTo)
function navTo(tab) { switchPanel(tab); }

// â”€â”€â”€ SIDEBAR TOGGLE (mobile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar() {
  const s = document.getElementById('sidebar');
  const o = document.getElementById('sidebarOverlay');
  s.classList.toggle('open'); o.style.display = s.classList.contains('open') ? 'block' : 'none';
}
function closeSidebar() {
  const s = document.getElementById('sidebar');
  const o = document.getElementById('sidebarOverlay');
  s.classList.remove('open'); o.style.display = 'none';
}

// â”€â”€â”€ CRM INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initCRM(profile) {
  // User info
  const av = document.getElementById('userAvatar');
  const nm = document.getElementById('sidebarUserName');
  const rl = document.getElementById('sidebarUserRole');
  const wn = document.getElementById('welcomeName');
  if(av) av.textContent = (profile.name||'?')[0].toUpperCase();
  if(nm) nm.textContent = profile.name || profile.email;
  if(rl) rl.textContent = profile.role || 'agent';
  if(wn) wn.textContent = profile.name?.split(' ')[0] || 'Agent';

  // Date in topbar
  const d = document.getElementById('topbarDate');
  if(d) d.textContent = new Date().toLocaleDateString('hi-IN',{day:'numeric',month:'short',year:'numeric'});

  // Show manager/admin nav items if role allows
  const isManager = ['manager','admin'].includes(profile.role);
  const isAdmin = profile.role === 'admin';
  ['nav-manager','mgr-group'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.style.display = isManager ? 'block' : 'none';
  });
  ['nav-admin'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.style.display = isAdmin ? 'block' : 'none';
  });

  // Load agents from localStorage
  try {
    const saved = localStorage.getItem('livsmart_agents');
    if(saved) {
      const d = JSON.parse(saved);
      if(typeof agentsData !== 'undefined') { Object.assign(agentsData, d); }
      if(typeof MASTER !== 'undefined') { Object.assign(MASTER, d); }
    }
  } catch(e) { console.warn('Agent load error:', e); }
  initRemarksPanel();
  renderHomeStats();
  updateBadges();

  // Report date
  const rd = document.getElementById('reportDate');
  if(rd) rd.textContent = new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
}

// â”€â”€â”€ HOME STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderHomeStats() {
  try {
    const [calls, tickets, leads] = await Promise.all([
      fbGetList('call_logs'), fbGetList('tickets'), fbGetList('leads')
    ]);
    const today = new Date().toDateString();
    const todayCalls = calls.filter(c => c.createdAt && new Date(c.createdAt).toDateString()===today).length;
    const openTickets = tickets.filter(t => t.status==='open' || t.status==='pending').length;
    const activeLeads = leads.filter(l => l.status!=='converted' && l.status!=='lost').length;
    const slaBreaching = tickets.filter(t => t.status==='open' && t.sla_expiry && Date.now()>t.sla_expiry).length;

    setEl('hk1', todayCalls);
    setEl('hk2', openTickets);
    setEl('hk3', activeLeads);
    setEl('hk4', slaBreaching);
    setEl('ticketBadge', openTickets);
    setEl('leadBadge', activeLeads);
    setEl('slaAlertCount', slaBreaching);

    // Recent tickets
    const recTkt = document.getElementById('homeRecentTickets');
    if(recTkt) {
      const recent = tickets.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).slice(0,4);
      if(recent.length) {
        recTkt.innerHTML = recent.map(t => `
          <div class="call-card ticket-card ticket-${t.status||'open'}" onclick="switchPanel('tickets')">
            <div style="font-size:20px">${{delivery:'ğŸšš',product:'ğŸ“¦',billing:'ğŸ’³',complaint:'ğŸ˜¡',enquiry:'â“',returns:'ğŸ”„',installation:'ğŸ”§'}[t.category]||'ğŸ«'}</div>
            <div style="flex:1">
              <div style="font-size:12px;font-weight:700">${esc(t.customerName||'â€”')}</div>
              <div style="font-size:10px;color:var(--muted2);font-family:'JetBrains Mono',monospace">${t.tid||''} Â· ${t.category||''}</div>
            </div>
            <span class="sb sb-${t.status==='open'?'red':t.status==='pending'?'orange':t.status==='resolved'?'green':'gray'}">${t.status||'open'}</span>
          </div>`).join('');
      }
    }

    // Hot leads
    const hotLeads = document.getElementById('homeHotLeads');
    if(hotLeads) {
      const hot = leads.filter(l=>l.status!=='converted'&&l.status!=='lost').sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).slice(0,4);
      if(hot.length) {
        hotLeads.innerHTML = hot.map(l => `
          <div class="call-card lead-card lead-${l.status||'new'}" onclick="switchPanel('leads')">
            <div style="font-size:20px">ğŸ’°</div>
            <div style="flex:1">
              <div style="font-size:12px;font-weight:700">${esc(l.name||'â€”')}</div>
              <div style="font-size:10px;color:var(--muted2);font-family:'JetBrains Mono',monospace">${l.phone||''} Â· â‚¹${(l.value||0).toLocaleString()}</div>
            </div>
            <span class="sb sb-${l.status==='new'?'blue':l.status==='qualified'?'teal':l.status==='contacted'?'orange':'gray'}">${l.status||'new'}</span>
          </div>`).join('');
      }
    }
  } catch(e) { console.warn('Home stats error:', e); }
}

function updateBadges() {
  fbGetList('tickets').then(tickets => {
    const open = tickets.filter(t=>t.status==='open'||t.status==='pending').length;
    setEl('ticketBadge', open); setEl('slaAlertCount', open);
  }).catch(()=>{});
  fbGetList('leads').then(leads => {
    const active = leads.filter(l=>l.status!=='converted'&&l.status!=='lost').length;
    setEl('leadBadge', active);
  }).catch(()=>{});
}

function setEl(id, val) { const el=document.getElementById(id); if(el) el.textContent=val; }
function esc(s) { return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// â”€â”€â”€ WHATSAPP HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openWhatsApp(phone, msg='') {
  const clean = String(phone).replace(/\D/g,'');
  const num = clean.startsWith('91') ? clean : '91'+clean;
  window.open(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`, '_blank');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICKET MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _ticketCache = [];
let _ticketSort = { col: 'createdAt', dir: -1 };

async function updateTicketKPIs() {
  const tickets = await fbGetList('tickets').catch(()=>[]);
  _ticketCache = tickets;
  const open = tickets.filter(t=>t.status==='open').length;
  const pending = tickets.filter(t=>t.status==='pending').length;
  const resolved = tickets.filter(t=>t.status==='resolved').length;
  const closed = tickets.filter(t=>t.status==='closed').length;
  const breached = tickets.filter(t=>(t.status==='open'||t.status==='pending')&&t.sla_expiry&&Date.now()>t.sla_expiry).length;
  setEl('tk1',open); setEl('tk2',pending); setEl('tk3',resolved); setEl('tk4',closed); setEl('tk5',breached);
  setEl('ticketOpenBadge',`${open} Open`);
  setEl('ticketBadge', open+pending);
}

async function renderTickets() {
  await updateTicketKPIs();
  const tickets = _ticketCache;
  const search = (document.getElementById('ticketSearch')?.value||'').toLowerCase();
  const statusF = document.getElementById('ticketStatusFilter')?.value||'';
  const priorityF = document.getElementById('ticketPriorityFilter')?.value||'';
  const catF = document.getElementById('ticketCatFilter')?.value||'';

  let filtered = tickets.filter(t => {
    const matchSearch = !search || [t.customerName,t.phone,t.tid,t.category].join(' ').toLowerCase().includes(search);
    const matchStatus = !statusF || t.status===statusF;
    const matchPri = !priorityF || t.priority===priorityF;
    const matchCat = !catF || t.category===catF;
    return matchSearch && matchStatus && matchPri && matchCat;
  });

  filtered.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

  const container = document.getElementById('ticketsList');
  if(!container) return;
  if(!filtered.length) {
    container.innerHTML = '<div class="empty-state"><div class="es-icon">ğŸ«</div><h3>Koi tickets nahi</h3><p>Filter change karo ya naya ticket banao</p></div>';
    return;
  }

  const slaLabels = {urgent:4*3600000,high:12*3600000,normal:24*3600000,low:48*3600000};
  container.innerHTML = filtered.map(t => {
    const slaMs = slaLabels[t.priority]||86400000;
    const created = t.createdAt||Date.now();
    const elapsed = Date.now()-created;
    const slaClass = (t.status==='resolved'||t.status==='closed') ? 'sla-ok' : elapsed>slaMs ? 'sla-breach' : elapsed>slaMs*0.7 ? 'sla-warn' : 'sla-ok';
    const slaText = (t.status==='resolved'||t.status==='closed') ? 'âœ… Done' : elapsed>slaMs ? 'ğŸš¨ Breached' : elapsed>slaMs*0.7 ? 'âš  Soon' : 'ğŸŸ¢ OK';
    const catIcons = {delivery:'ğŸšš',product:'ğŸ“¦',billing:'ğŸ’³',complaint:'ğŸ˜¡',enquiry:'â“',returns:'ğŸ”„',installation:'ğŸ”§'};
    return `<div class="card ticket-card ticket-${t.status||'open'}" style="margin-bottom:10px;padding:14px 16px">
      <div style="display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap">
        <div style="font-size:24px">${catIcons[t.category]||'ğŸ«'}</div>
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px">
            <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted2)">${t.tid||'â€”'}</span>
            <span class="sb sb-${t.status==='open'?'red':t.status==='pending'?'orange':t.status==='resolved'?'green':'gray'}">${t.status||'open'}</span>
            <span class="sb sb-${t.priority==='urgent'?'red':t.priority==='high'?'orange':'green'}">${t.priority||'normal'}</span>
            <span class="${slaClass}">${slaText}</span>
          </div>
          <div style="font-size:14px;font-weight:700;margin-bottom:2px">${esc(t.customerName||'â€”')}</div>
          <div style="font-size:11px;color:var(--muted2);font-family:'JetBrains Mono',monospace">${t.phone||''} Â· ${t.category||''} Â· ${new Date(t.createdAt||0).toLocaleDateString('hi-IN')}</div>
          <div style="font-size:12px;color:var(--text2);margin-top:6px">${esc((t.issue||'').substring(0,120))}${(t.issue||'').length>120?'...':''}</div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:flex-start">
          <button class="btn btn-wa btn-xs" onclick="openWhatsApp('${t.phone}','Namaste! Main Livsmart se hun. Aapka ticket ${t.tid} ke baare mein call kar raha hun.')">ğŸ’¬</button>
          <select class="form-sel" style="font-size:11px;padding:4px 8px" onchange="updateTicketStatus('${t.id}',this.value)" title="Status change karo">
            <option value="open" ${t.status==='open'?'selected':''}>ğŸ”´ Open</option>
            <option value="pending" ${t.status==='pending'?'selected':''}>ğŸŸ  Pending</option>
            <option value="resolved" ${t.status==='resolved'?'selected':''}>âœ… Resolved</option>
            <option value="closed" ${t.status==='closed'?'selected':''}>ğŸ”’ Closed</option>
          </select>
          <button class="btn btn-danger btn-xs" onclick="deleteTicket('${t.id}')">âœ•</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

async function updateTicketStatus(id, status) {
  try { await fbUpdate('tickets/'+id, {status, updatedAt: Date.now()}); showToast('Ticket updated!'); renderTickets(); }
  catch(e) { showToast('Error: '+e.message,'err'); }
}
async function deleteTicket(id) {
  if(!confirm('Ticket delete karo?')) return;
  try { await fbRemove('tickets/'+id); showToast('Ticket deleted','warn'); renderTickets(); }
  catch(e) { showToast('Error','err'); }
}
function resetTicketFilters() {
  ['ticketSearch','ticketStatusFilter','ticketPriorityFilter','ticketCatFilter','ticketSLAFilter'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  renderTickets();
}
async function exportTickets() {
  const tickets = await fbGetList('tickets').catch(()=>[]);
  const csv = ['TID,Customer,Phone,Status,Priority,Category,Issue,Created'].concat(
    tickets.map(t => `${t.tid||''},${t.customerName||''},${t.phone||''},${t.status||''},${t.priority||''},${t.category||''},"${(t.issue||'').replace(/"/g,"'")}",${new Date(t.createdAt||0).toLocaleDateString()}`)
  ).join('\n');
  downloadFile('tickets.csv', csv, 'text/csv');
  showToast('Tickets exported!');
}

// TICKET MODAL
function openTicketModal(prefill=false) {
  const m = document.getElementById('ticketModal');
  if(m) m.classList.add('show');
}
function closeTicketModal() {
  const m = document.getElementById('ticketModal');
  if(m) m.classList.remove('show');
}
function closeViewTicketModal() {
  const m = document.getElementById('viewTicketModal');
  if(m) m.classList.remove('show');
}
async function saveTicket() {
  const name = document.getElementById('tm-name')?.value.trim();
  const phone = document.getElementById('tm-phone')?.value.trim();
  const issue = document.getElementById('tm-issue')?.value.trim();
  if(!name||!phone||!issue) { showToast('Saare required fields bharo!','err'); return; }

  const priority = document.getElementById('tm-priority')?.value||'normal';
  const slaMs = {urgent:4*3600000,high:12*3600000,normal:24*3600000,low:48*3600000}[priority]||86400000;
  const tid = 'TKT-' + Date.now().toString(36).toUpperCase();
  const ticketData = {
    tid, customerName:name, phone,
    category: document.getElementById('tm-cat')?.value||'enquiry',
    priority, status:'open',
    issue,
    orderid: document.getElementById('tm-orderid')?.value||'',
    region: document.getElementById('tm-region')?.value||'north',
    pincode: document.getElementById('tm-pincode')?.value||'',
    notes: document.getElementById('tm-notes')?.value||'',
    sla_expiry: Date.now()+slaMs
  };
  try {
    await fbSave('tickets', ticketData);
    showToast('Ticket created: '+tid);
    closeTicketModal();
    ['tm-name','tm-phone','tm-issue','tm-orderid','tm-pincode','tm-notes'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
    if(_currentPanel==='tickets') renderTickets();
    renderHomeStats();
  } catch(e) { showToast('Error: '+e.message,'err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEAD MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _leadCache = [];

async function updateLeadKPIs() {
  const leads = await fbGetList('leads').catch(()=>[]);
  _leadCache = leads;
  const counts = {new:0,contacted:0,qualified:0,converted:0,lost:0};
  leads.forEach(l => counts[l.status]=(counts[l.status]||0)+1);
  setEl('lk1',leads.length); setEl('lk2',counts.new||0); setEl('lk3',counts.contacted||0);
  setEl('lk4',counts.converted||0); setEl('lk5',counts.lost||0);
  setEl('leadTotalBadge',leads.length+' leads');
}

async function renderLeads() {
  await updateLeadKPIs();
  const leads = _leadCache;
  const search = (document.getElementById('leadSearch')?.value||'').toLowerCase();
  const statusF = document.getElementById('leadStatusFilter')?.value||'';
  const regionF = document.getElementById('leadRegionFilter')?.value||'';
  const sourceF = document.getElementById('leadSourceFilter')?.value||'';

  let filtered = leads.filter(l => {
    const matchSearch = !search || [l.name,l.phone,l.source,l.product].join(' ').toLowerCase().includes(search);
    return matchSearch && (!statusF||l.status===statusF) && (!regionF||l.region===regionF) && (!sourceF||l.source===sourceF);
  }).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

  const tbody = document.getElementById('leadsTbody');
  if(!tbody) return;
  const regionBadge = {north:'region-n',south:'region-s',east:'region-e',west:'region-w'};
  const statusColor = {new:'blue',contacted:'orange',qualified:'teal',converted:'green',lost:'red'};
  tbody.innerHTML = filtered.length ? filtered.map((l,i) => `
    <tr>
      <td>${i+1}</td>
      <td style="font-weight:700">${esc(l.name||'â€”')}</td>
      <td><a href="tel:+91${l.phone}" style="color:var(--teal);font-family:'JetBrains Mono',monospace">${l.phone||'â€”'}</a></td>
      <td><span class="sb sb-${statusColor[l.status]||'gray'}">${l.status||'new'}</span></td>
      <td>${l.source||'â€”'}</td>
      <td><span class="${regionBadge[l.region]||''}">${(l.region||'').toUpperCase()}</span></td>
      <td class="r" style="font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--teal)">â‚¹${(l.value||0).toLocaleString()}</td>
      <td>${esc(l.product||'â€”')}</td>
      <td style="font-size:10px;color:var(--muted2)">${l.agentName||'â€”'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:10px">${new Date(l.createdAt||0).toLocaleDateString('hi-IN')}</td>
      <td>
        <div style="display:flex;gap:4px">
          <button class="btn btn-wa btn-xs" onclick="openWhatsApp('${l.phone}','Namaste ${esc(l.name)}! Main Livsmart se bol raha hun - aapke ${esc(l.product||'')} query ke baare mein.')">ğŸ’¬</button>
          <select class="form-sel" style="font-size:10px;padding:3px 6px" onchange="updateLeadStatus('${l.id}',this.value)" title="Status update">
            <option value="new" ${l.status==='new'?'selected':''}>New</option>
            <option value="contacted" ${l.status==='contacted'?'selected':''}>Contacted</option>
            <option value="qualified" ${l.status==='qualified'?'selected':''}>Qualified</option>
            <option value="converted" ${l.status==='converted'?'selected':''}>Converted</option>
            <option value="lost" ${l.status==='lost'?'selected':''}>Lost</option>
          </select>
          <button class="btn btn-danger btn-xs" onclick="deleteLead('${l.id}')">âœ•</button>
        </div>
      </td>
    </tr>`).join('') : '<tr><td colspan="11" style="text-align:center;padding:40px;color:var(--muted2)">ğŸ’° Koi leads nahi mili</td></tr>';
}

async function updateLeadStatus(id, status) {
  try { await fbUpdate('leads/'+id,{status, updatedAt:Date.now()}); showToast('Lead updated!'); renderLeads(); }
  catch(e) { showToast('Error','err'); }
}
async function deleteLead(id) {
  if(!confirm('Lead delete karo?')) return;
  try { await fbRemove('leads/'+id); showToast('Lead deleted','warn'); renderLeads(); }
  catch(e) { showToast('Error','err'); }
}
function resetLeadFilters() {
  ['leadSearch','leadStatusFilter','leadRegionFilter','leadSourceFilter'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  renderLeads();
}
async function exportLeads() {
  const leads = await fbGetList('leads').catch(()=>[]);
  const csv = ['Name,Phone,Status,Source,Region,Value,Product,Date'].concat(
    leads.map(l => `${l.name||''},${l.phone||''},${l.status||''},${l.source||''},${l.region||''},${l.value||0},${l.product||''},${new Date(l.createdAt||0).toLocaleDateString()}`)
  ).join('\n');
  downloadFile('leads.csv', csv, 'text/csv');
  showToast('Leads exported!');
}

// LEAD MODAL
function openLeadModal() { const m=document.getElementById('leadModal'); if(m) m.classList.add('show'); }
function closeLeadModal() { const m=document.getElementById('leadModal'); if(m) m.classList.remove('show'); }
async function saveLead() {
  const name = document.getElementById('lm-name')?.value.trim();
  const phone = document.getElementById('lm-phone')?.value.trim();
  if(!name||!phone) { showToast('Name aur phone bharo!','err'); return; }
  const data = {
    name, phone,
    status: document.getElementById('lm-status')?.value||'new',
    source: document.getElementById('lm-source')?.value||'inbound',
    product: document.getElementById('lm-product')?.value||'',
    value: parseInt(document.getElementById('lm-value')?.value||0)||0,
    region: document.getElementById('lm-region')?.value||'north',
    followup: document.getElementById('lm-followup')?.value||'',
    notes: document.getElementById('lm-notes')?.value||''
  };
  try {
    await fbSave('leads', data);
    showToast('Lead saved! ğŸ’°');
    closeLeadModal();
    ['lm-name','lm-phone','lm-product','lm-value','lm-notes','lm-followup'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
    if(_currentPanel==='leads') renderLeads();
    renderHomeStats();
  } catch(e) { showToast('Error: '+e.message,'err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALL LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _callCache = [];

async function updateCallKPIs() {
  const calls = await fbGetList('call_logs').catch(()=>[]);
  _callCache = calls;
  const connected = calls.filter(c=>c.status==='connected').length;
  const nc = calls.filter(c=>c.status==='not_connected').length;
  const cb = calls.filter(c=>c.status==='callback').length;
  setEl('ck1',calls.length); setEl('ck2',connected); setEl('ck3',nc); setEl('ck4',cb);
  // Avg duration
  const durations = calls.filter(c=>c.durationSec>0).map(c=>c.durationSec);
  if(durations.length) {
    const avg = Math.round(durations.reduce((a,b)=>a+b,0)/durations.length);
    setEl('ck5', `${Math.floor(avg/60)}:${String(avg%60).padStart(2,'0')}`);
  }
}

async function renderCallLog() {
  await updateCallKPIs();
  const calls = _callCache;
  const search = (document.getElementById('callSearch')?.value||'').toLowerCase();
  const statusF = document.getElementById('callStatusFilter')?.value||'';
  const dateF = document.getElementById('callDateFilter')?.value||'';

  const now = new Date();
  let filtered = calls.filter(c => {
    const matchS = !search||[c.customerName,c.phone,c.agentName].join(' ').toLowerCase().includes(search);
    const matchSt = !statusF||c.status===statusF;
    let matchD = true;
    if(dateF && c.createdAt) {
      const d = new Date(c.createdAt);
      if(dateF==='today') matchD = d.toDateString()===now.toDateString();
      else if(dateF==='week') matchD = (now-d)<7*86400000;
      else if(dateF==='month') matchD = d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
    }
    return matchS&&matchSt&&matchD;
  }).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

  const container = document.getElementById('callLogList');
  if(!container) return;
  const statusIcon = {connected:'âœ…',not_connected:'ğŸ“µ',busy:'ğŸ“²',callback:'ğŸ”„',voicemail:'ğŸ“¬'};
  container.innerHTML = filtered.length ? filtered.map(c => `
    <div class="call-card" onclick="">
      <div style="font-size:22px">${statusIcon[c.status]||'ğŸ“'}</div>
      <div style="flex:1">
        <div style="font-size:13px;font-weight:700">${esc(c.customerName||'â€”')} <span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted2)">${c.phone||''}</span></div>
        <div style="font-size:11px;color:var(--muted2);margin-top:2px">${esc(c.issue||'')} ${c.duration?'Â· â± '+c.duration:''}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--muted2)">${new Date(c.createdAt||0).toLocaleTimeString('hi-IN',{hour:'2-digit',minute:'2-digit'})}</div>
        <div style="font-size:10px;color:var(--muted2)">${c.agentName||''}</div>
        <div style="display:flex;gap:4px;margin-top:4px;justify-content:flex-end">
          <button class="btn btn-xs" style="background:#14b8a620;color:#14b8a6;border:1px solid #14b8a640" onclick="event.stopPropagation();callNumber('${c.phone}','${c.customerName||''}')" title="Call karo">ğŸ“</button>
          <button class="btn btn-wa btn-xs" onclick="event.stopPropagation();openWhatsApp('${c.phone}')">ğŸ’¬</button>
        </div>
      </div>
    </div>`).join('') :
    '<div class="empty-state"><div class="es-icon">ğŸ“</div><h3>Koi calls nahi</h3><p>Filter change karo ya naya call log karo</p></div>';
}

async function exportCallLog() {
  const calls = await fbGetList('call_logs').catch(()=>[]);
  const csv = ['Customer,Phone,Status,Duration,Issue,Agent,Date'].concat(
    calls.map(c=>`${c.customerName||''},${c.phone||''},${c.status||''},${c.duration||''},${(c.issue||'').replace(/,/g,';')},${c.agentName||''},${new Date(c.createdAt||0).toLocaleDateString()}`)
  ).join('\n');
  downloadFile('calls.csv',csv,'text/csv');
  showToast('Calls exported!');
}

// CALL MODAL
function openCallModal() { const m=document.getElementById('callModal'); if(m) m.classList.add('show'); }
function closeCallModal() { const m=document.getElementById('callModal'); if(m) m.classList.remove('show'); }
async function saveCall() {
  const name = document.getElementById('cm-name')?.value.trim();
  const phone = document.getElementById('cm-phone')?.value.trim();
  if(!name||!phone) { showToast('Name aur phone bharo!','err'); return; }
  const dur = document.getElementById('cm-duration')?.value||'';
  const parts = dur.split(':');
  const durSec = parts.length===2 ? parseInt(parts[0]||0)*60+parseInt(parts[1]||0) : 0;
  const data = {
    customerName:name, phone,
    status: document.getElementById('cm-status')?.value||'connected',
    duration: dur, durationSec: durSec,
    type: document.getElementById('cm-type')?.value||'inbound',
    product: document.getElementById('cm-product')?.value||'',
    issue: document.getElementById('cm-issue')?.value||'',
    resolution: document.getElementById('cm-resolution')?.value||'',
    followup: document.getElementById('cm-followup')?.value||'',
    priority: document.getElementById('cm-priority')?.value||'normal',
    notes: document.getElementById('cm-notes')?.value||''
  };
  try {
    await fbSave('call_logs', data);
    showToast('Call logged! ğŸ“');
    closeCallModal();
    ['cm-name','cm-phone','cm-duration','cm-product','cm-issue','cm-resolution','cm-notes','cm-followup'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
    if(_currentPanel==='calls') renderCallLog();
    renderHomeStats();
  } catch(e) { showToast('Error: '+e.message,'err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOMER 360
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function searchCustomer360() {
  const q = (document.getElementById('c360Search')?.value||'').trim();
  if(!q) { showToast('Phone ya ticket ID daalo!','warn'); return; }

  try {
    const [calls, tickets, leads] = await Promise.all([
      fbGetList('call_logs'), fbGetList('tickets'), fbGetList('leads')
    ]);
    const isPhone = /^\d{10}$/.test(q.replace(/\D/g,''));
    const phone = isPhone ? q.replace(/\D/g,'') : null;

    const custCalls = calls.filter(c => phone ? c.phone===phone : c.tid===q);
    const custTickets = tickets.filter(t => phone ? t.phone===phone : t.tid===q);
    const custLeads = leads.filter(l => phone ? l.phone===phone : false);

    if(!custCalls.length && !custTickets.length && !custLeads.length) {
      showToast('Koi record nahi mila!','warn'); return;
    }

    const profile = document.getElementById('c360Profile');
    if(profile) profile.style.display = 'block';

    const name = custCalls[0]?.customerName || custTickets[0]?.customerName || custLeads[0]?.name || 'Unknown';
    const displayPhone = phone || custTickets[0]?.phone || custCalls[0]?.phone || 'â€”';

    setEl('c360Name', name);
    setEl('c360Phone', '+91 ' + displayPhone);
    setEl('c360Avatar', name[0]?.toUpperCase()||'?');
    document.getElementById('c360WaBtn')?.setAttribute('onclick', `openWhatsApp('${displayPhone}')`);

    // Tags
    const tags = document.getElementById('c360Tags');
    if(tags) {
      const badges = [];
      if(custCalls.length) badges.push(`<span class="badge badge-teal">${custCalls.length} calls</span>`);
      if(custTickets.length) badges.push(`<span class="badge badge-blue">${custTickets.length} tickets</span>`);
      if(custLeads.length) badges.push(`<span class="badge badge-green">${custLeads.length} leads</span>`);
      const totalVal = custLeads.reduce((s,l)=>s+(l.value||0),0);
      if(totalVal) badges.push(`<span class="badge badge-orange">â‚¹${totalVal.toLocaleString()}</span>`);
      tags.innerHTML = badges.join('');
    }

    // Call history
    const callsEl = document.getElementById('c360Calls');
    if(callsEl) callsEl.innerHTML = custCalls.slice(0,6).map(c=>`
      <div class="call-card" style="margin-bottom:6px">
        <span>${c.status==='connected'?'âœ…':'ğŸ“µ'}</span>
        <div style="flex:1;font-size:11px">
          <div style="font-weight:700">${c.issue||'Call logged'}</div>
          <div style="color:var(--muted2)">${new Date(c.createdAt||0).toLocaleDateString()}</div>
        </div>
        <span style="font-family:'JetBrains Mono',monospace;font-size:10px">${c.duration||''}</span>
      </div>`).join('') || '<div class="empty-state" style="padding:20px"><p style="font-size:12px">Koi calls nahi</p></div>';

    // Ticket history
    const tktEl = document.getElementById('c360Tickets');
    if(tktEl) tktEl.innerHTML = custTickets.slice(0,6).map(t=>`
      <div class="call-card ticket-card ticket-${t.status||'open'}" style="margin-bottom:6px">
        <span>ğŸ«</span>
        <div style="flex:1;font-size:11px">
          <div style="font-weight:700">${t.tid||''} Â· ${t.category||''}</div>
          <div style="color:var(--muted2)">${(t.issue||'').substring(0,60)}</div>
        </div>
        <span class="sb sb-${t.status==='open'?'red':t.status==='resolved'?'green':'orange'}">${t.status||'open'}</span>
      </div>`).join('') || '<div class="empty-state" style="padding:20px"><p style="font-size:12px">Koi tickets nahi</p></div>';

    // Summary
    const sumEl = document.getElementById('c360Summary');
    if(sumEl) sumEl.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:10px">
        <div class="stat-pill"><span class="sp-val">${custCalls.length}</span><span class="sp-lbl">Total Calls</span></div>
        <div class="stat-pill"><span class="sp-val">${custTickets.filter(t=>t.status==='open').length}</span><span class="sp-lbl">Open Tickets</span></div>
        <div class="stat-pill"><span class="sp-val" style="color:var(--teal)">â‚¹${custLeads.reduce((s,l)=>s+(l.value||0),0).toLocaleString()}</span><span class="sp-lbl">Lead Value</span></div>
        <div class="stat-pill"><span class="sp-val">${custCalls.filter(c=>c.status==='connected').length}</span><span class="sp-lbl">Connected Calls</span></div>
      </div>`;

  } catch(e) { showToast('Search error: '+e.message,'err'); }
}
function c360WhatsApp() { showToast('WhatsApp link open ho raha hai!'); }
function doGlobalSearch(q) { if(q) { switchPanel('c360'); setTimeout(()=>{ const el=document.getElementById('c360Search'); if(el){el.value=q; searchCustomer360();} },300); } }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUYBACK CALCULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcBuyback() {
  const price = parseFloat(document.getElementById('bb-price')?.value||0);
  const date = document.getElementById('bb-date')?.value;
  const condition = document.getElementById('bb-condition')?.value||'good';
  const policy = document.getElementById('bb-policy')?.value||'standard';
  if(!price||!date) return;

  const ageMs = Date.now() - new Date(date).getTime();
  const ageYears = ageMs / (365.25*86400000);
  const deprRate = {standard:0.30,premium:0.20,loyalty:0.15}[policy]||0.30;
  const condMult = {excellent:1.0,good:0.90,fair:0.75,poor:0.55}[condition]||0.90;
  const depr = Math.min(deprRate * ageYears, 0.85);
  const buyback = price * (1 - depr) * condMult;

  const resultEl = document.getElementById('bbResult');
  if(resultEl) resultEl.style.display = 'block';
  setEl('bbVal', 'â‚¹'+Math.round(buyback).toLocaleString());
  setEl('bbBreakdown', `Original: â‚¹${price.toLocaleString()} â†’ After depreciation & condition`);
  setEl('bbAge', ageYears.toFixed(1)+' yrs');
  setEl('bbDepr', (depr*100).toFixed(0)+'%');
  setEl('bbCond', (condMult*100).toFixed(0)+'%');
  window._lastBuyback = buyback;
  calcUpgrade();
}

function calcEMI() {
  const amount = parseFloat(document.getElementById('emi-amount')?.value||0);
  const rate = parseFloat(document.getElementById('emi-rate')?.value||0);
  const tenure = parseInt(document.getElementById('emi-tenure')?.value||12);
  if(!amount||!rate) return;

  const monthlyRate = rate/(12*100);
  const emi = amount * monthlyRate * Math.pow(1+monthlyRate,tenure) / (Math.pow(1+monthlyRate,tenure)-1);
  const total = emi * tenure;
  const interest = total - amount;

  const resultEl = document.getElementById('emiResult');
  if(resultEl) resultEl.style.display = 'block';
  setEl('emiVal','â‚¹'+Math.round(emi).toLocaleString());
  setEl('emiTotal','â‚¹'+Math.round(total).toLocaleString());
  setEl('emiInterest','â‚¹'+Math.round(interest).toLocaleString());
}

function calcUpgrade() {
  const newPrice = parseFloat(document.getElementById('upg-new')?.value||0);
  const buyback = window._lastBuyback||0;
  const upgValEl = document.getElementById('upgVal');
  const upgBtnEl = document.getElementById('upgWaBtn');
  if(newPrice && buyback && upgValEl) {
    const pay = newPrice - buyback;
    upgValEl.textContent = 'â‚¹'+Math.round(pay).toLocaleString();
    if(upgBtnEl) upgBtnEl.style.display = 'inline-flex';
  }
}

function sendUpgradeWA() {
  const phone = prompt('Customer ka phone number:');
  if(phone) openWhatsApp(phone, `Namaste! ğŸ™ Aapka upgrade offer:\n\nBuyback Value: â‚¹${Math.round(window._lastBuyback||0).toLocaleString()}\nNaya Product Price: â‚¹${document.getElementById('upg-new')?.value||0}\nAap sirf â‚¹${document.getElementById('upgVal')?.textContent||0} mein upgrade kar sakte hain!\n\nAaj hi contact karein - Livsmart ğŸ§ `);
}
function sendSvcWA() {
  const msg = `Namaste! ğŸ™ Livsmart Serviceability Update:\n\nArea: ${document.getElementById('svcArea')?.textContent||'â€”'}\nStatus: ${document.getElementById('svcStatus')?.textContent||'â€”'}\nETA: ${document.getElementById('svcETA')?.textContent||'â€”'}\n\nAapki service ke liye hum committed hain! - Team Livsmart`;
  const phone = prompt('Customer phone:'); if(phone) openWhatsApp(phone, msg);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TARGETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderTargets() {
  const targets = await fbGetList('targets').catch(()=>[]);
  const tbody = document.getElementById('targetTbody');
  if(!tbody) return;

  // Set current month badge
  const mb = document.getElementById('targetMonthBadge');
  if(mb) mb.textContent = new Date().toLocaleString('hi-IN',{month:'long',year:'numeric'});

  if(!targets.length) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--muted2)">ğŸ¯ Koi targets set nahi</td></tr>';
    return;
  }

  tbody.innerHTML = targets.map(t => {
    const pct = t.salesTarget ? Math.min(Math.round((t.achieved||0)/t.salesTarget*100),100) : 0;
    const color = pct>=100?'var(--green)':pct>=70?'var(--orange)':'var(--red)';
    return `<tr>
      <td style="font-weight:700">${esc(t.agent||'â€”')}</td>
      <td style="font-size:10px;color:var(--muted2)">${t.tl||'â€”'}</td>
      <td class="r" style="font-family:'JetBrains Mono',monospace">â‚¹${(t.achieved||0).toLocaleString()}</td>
      <td class="r" style="font-family:'JetBrains Mono',monospace">â‚¹${(t.salesTarget||0).toLocaleString()}</td>
      <td class="r ${pct>=100?'cf-green':pct>=70?'cf-orange':'cf-red'}">${pct}%</td>
      <td class="r">${t.actualCalls||0} / ${t.callsTarget||0}</td>
      <td class="r">${t.actualLeads||0} / ${t.leadsTarget||0}</td>
      <td class="r">${t.actualLeads && t.leadsTarget ? Math.round((t.actualLeads/t.leadsTarget)*100)+'%' : 'â€”'}</td>
      <td style="min-width:120px">
        <div style="height:6px;background:var(--border2);border-radius:99px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:${color};border-radius:99px;transition:width 1s"></div>
        </div>
      </td>
      <td>
        <button class="btn btn-danger btn-xs" onclick="deleteTarget('${t.id}')">âœ•</button>
      </td>
    </tr>`;
  }).join('');

  // Aggregate rings
  const totalSales = targets.reduce((s,t)=>s+(t.achieved||0),0);
  const totalTarget = targets.reduce((s,t)=>s+(t.salesTarget||0),0);
  const overallPct = totalTarget ? Math.min(Math.round(totalSales/totalTarget*100),100) : 0;
  animateRing('ring-sales-fill', overallPct);
  setEl('ring-sales-pct', overallPct+'%');
  setEl('t-sales-val', `â‚¹${totalSales.toLocaleString()} / â‚¹${totalTarget.toLocaleString()}`);
}

function animateRing(fillId, pct) {
  const el = document.getElementById(fillId);
  if(!el) return;
  const circumference = 264;
  const offset = circumference - (pct/100) * circumference;
  setTimeout(()=>{ el.style.strokeDashoffset = offset; }, 200);
}

function openTargetModal() { const m=document.getElementById('targetModal'); if(m) m.classList.add('show'); const el=document.getElementById('tgt-month'); if(el&&!el.value){const d=new Date();el.value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}  }
function closeTargetModal() { const m=document.getElementById('targetModal'); if(m) m.classList.remove('show'); }
async function saveTarget() {
  const agent = document.getElementById('tgt-agent')?.value.trim();
  if(!agent) { showToast('Agent naam bharo!','err'); return; }
  const data = {
    agent,
    salesTarget: parseInt(document.getElementById('tgt-sales')?.value||0)||0,
    callsTarget: parseInt(document.getElementById('tgt-calls')?.value||0)||0,
    leadsTarget: parseInt(document.getElementById('tgt-leads')?.value||0)||0,
    month: document.getElementById('tgt-month')?.value||new Date().toISOString().slice(0,7),
    achieved: 0, actualCalls: 0, actualLeads: 0
  };
  try { await fbSave('targets', data); showToast('Target set!'); closeTargetModal(); renderTargets(); }
  catch(e) { showToast('Error','err'); }
}
async function deleteTarget(id) {
  if(!confirm('Delete?')) return;
  try { await fbRemove('targets/'+id); showToast('Deleted','warn'); renderTargets(); }
  catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVICEABILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _pincodeCache = [];
let _svcHistory = [];

async function renderPincodes() {
  _pincodeCache = await fbGetList('pincodes').catch(()=>[]);
  const search = (document.getElementById('pinSearch')?.value||'').toLowerCase();
  const filtered = _pincodeCache.filter(p => !search || [p.code,p.city,p.state].join(' ').toLowerCase().includes(search));

  const el = document.getElementById('pincodeList');
  if(!el) return;
  el.innerHTML = filtered.length ? filtered.map(p => `
    <div class="call-card" style="margin-bottom:6px">
      <div style="font-size:18px">${p.available==='yes'?'âœ…':p.available==='limited'?'âš ï¸':'âŒ'}</div>
      <div style="flex:1">
        <div style="font-weight:700;font-family:'JetBrains Mono',monospace">${p.code}</div>
        <div style="font-size:11px;color:var(--muted2)">${p.city||''}, ${p.state||''} Â· ${p.eta||'â€”'} days Â· â‚¹${p.charge||0}</div>
      </div>
      <button class="btn btn-danger btn-xs" onclick="deletePincode('${p.id}')">âœ•</button>
    </div>`).join('') :
    '<div class="empty-state" style="padding:20px"><p style="font-size:12px">Koi pincodes nahi</p></div>';

  // Region coverage
  const coverageEl = document.getElementById('regionCoverage');
  if(coverageEl) {
    const byRegion = {};
    _pincodeCache.forEach(p => { byRegion[p.region]=(byRegion[p.region]||0)+1; });
    coverageEl.innerHTML = Object.entries(byRegion).map(([r,c])=>`
      <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
        <span style="width:80px;font-size:12px;font-weight:700;text-transform:capitalize">${r}</span>
        <div style="flex:1;height:6px;background:var(--border2);border-radius:99px;overflow:hidden"><div style="height:100%;width:${Math.min(c*10,100)}%;background:var(--teal);border-radius:99px"></div></div>
        <span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted2)">${c}</span>
      </div>`).join('') || '<p style="font-size:12px;color:var(--muted2);padding:10px">Koi data nahi</p>';
  }
}

async function checkServiceability() {
  const pin = document.getElementById('svc-pin')?.value.trim();
  if(!pin||pin.length!==6) { showToast('6-digit pincode daalo!','warn'); return; }

  await renderPincodes();
  const found = _pincodeCache.find(p => p.code===pin);
  const resultDiv = document.getElementById('svcResult');
  const resultCard = document.getElementById('svcResultCard');
  if(!resultDiv||!resultCard) return;

  resultDiv.style.display = 'block';
  if(found) {
    resultCard.className = 'service-check-result ' + (found.available==='yes'?'available':found.available==='limited'?'':' unavailable');
    setEl('svcIcon', found.available==='yes'?'âœ…':found.available==='limited'?'âš ï¸':'âŒ');
    setEl('svcStatus', found.available==='yes'?'Service Available':found.available==='limited'?'Limited Service':'Not Available');
    setEl('svcArea', `${found.city||'â€”'}, ${found.state||'â€”'}`);
    setEl('svcETA', (found.eta||'â€”')+' days');
    setEl('svcCharge', found.charge?'â‚¹'+found.charge:'Free');
    setEl('svcPartner', found.partner||'Livsmart Logistics');
  } else {
    resultCard.className = 'service-check-result unavailable';
    setEl('svcIcon','âŒ'); setEl('svcStatus','Service Not Found');
    setEl('svcArea',`Pincode ${pin} database mein nahi hai`);
    setEl('svcETA','â€”'); setEl('svcCharge','â€”'); setEl('svcPartner','â€”');
  }
  _svcHistory.unshift({pin, area:found?.city||'Unknown', status:found?.available||'not_found', time:new Date().toLocaleTimeString()});
  if(_svcHistory.length>10) _svcHistory=_svcHistory.slice(0,10);
  const histEl = document.getElementById('recentSvcChecks');
  if(histEl) histEl.innerHTML = _svcHistory.map(h=>`
    <div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);font-size:11px">
      <span>${h.status==='yes'?'âœ…':h.status==='limited'?'âš ï¸':'âŒ'}</span>
      <span style="font-family:'JetBrains Mono',monospace;font-weight:700">${h.pin}</span>
      <span style="color:var(--muted2)">${h.area}</span>
      <span style="margin-left:auto;color:var(--muted2)">${h.time}</span>
    </div>`).join('');
}

function openPincodeModal() { const m=document.getElementById('pincodeModal'); if(m) m.classList.add('show'); }
async function savePincode() {
  const code = document.getElementById('pin-code')?.value.trim();
  if(!code||code.length!==6) { showToast('Valid 6-digit pincode daalo!','err'); return; }
  const data = {
    code, city:document.getElementById('pin-city')?.value||'',
    state:document.getElementById('pin-state')?.value||'',
    region:document.getElementById('pin-region')?.value||'north',
    available:document.getElementById('pin-available')?.value||'yes',
    eta:document.getElementById('pin-eta')?.value||'3',
    charge:document.getElementById('pin-charge')?.value||'0',
    partner:document.getElementById('pin-partner')?.value||''
  };
  try {
    await fbSave('pincodes', data);
    showToast('Pincode added!');
    document.getElementById('pincodeModal')?.classList.remove('show');
    renderPincodes();
  } catch(e) { showToast('Error','err'); }
}
async function deletePincode(id) {
  if(!confirm('Delete?')) return;
  try { await fbRemove('pincodes/'+id); showToast('Deleted','warn'); renderPincodes(); }
  catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _adminTabIdx = 0;
function switchAdminTab(idx) {
  [0,1,2,3].forEach(i => { document.getElementById('adminTab'+i)?.style && (document.getElementById('adminTab'+i).style.display = i===idx?'block':'none'); document.getElementById('at'+i)?.classList[i===idx?'add':'remove']('on'); });
  _adminTabIdx = idx;
  if(idx===1) renderAdminUsers();
}
async function renderAdminPanel() {
  try {
    const [users, calls, agents] = await Promise.all([fbGet('users'), fbGetList('call_logs'), fbGetList('agents')]);
    const userCount = users ? Object.keys(users).length : 0;
    const today = new Date().toDateString();
    const activeToday = users ? Object.values(users).filter(u => u.lastLogin && new Date(u.lastLogin).toDateString()===today).length : 0;
    const todayCalls = calls.filter(c => c.createdAt && new Date(c.createdAt).toDateString()===today).length;
    setEl('ak1',userCount); setEl('ak2',activeToday); setEl('ak3',agents.length||Object.keys(MASTER||{}).length); setEl('ak4',todayCalls);
    setEl('settingsAgentCount', (agents.length||Object.keys(MASTER||{}).length)+' agents');

    // Activity
    const actEl = document.getElementById('adminActivity');
    if(actEl) {
      const recentCalls = calls.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).slice(0,8);
      actEl.innerHTML = recentCalls.map(c=>`
        <div style="display:flex;align-items:center;gap:12px;padding:10px 16px;border-bottom:1px solid var(--border);font-size:12px">
          <span>ğŸ“</span>
          <span style="font-weight:700">${esc(c.agentName||'Agent')}</span>
          <span style="color:var(--muted2)">â†’ ${esc(c.customerName||'Customer')}</span>
          <span class="sb sb-${c.status==='connected'?'green':'red'}">${c.status||'â€”'}</span>
          <span style="margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted2)">${new Date(c.createdAt||0).toLocaleTimeString()}</span>
        </div>`).join('') || '<div style="padding:20px;text-align:center;color:var(--muted2)">Koi activity nahi</div>';
    }
  } catch(e) { console.warn('Admin error:', e); }
}
async function renderAdminUsers() {
  const users = await fbGet('users').catch(()=>{});
  const tbody = document.getElementById('adminUserBody');
  if(!tbody) return;
  if(!users) { tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted2)">Koi users nahi</td></tr>'; return; }
  const search = (document.getElementById('userSearch')?.value||'').toLowerCase();
  tbody.innerHTML = Object.entries(users).filter(([uid,u])=>!search||[u.name,u.email,u.role].join(' ').toLowerCase().includes(search)).map(([uid,u])=>`
    <tr>
      <td style="font-weight:700">${esc(u.name||'â€”')}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px">${esc(u.email||'â€”')}</td>
      <td><span class="badge badge-${u.role==='admin'?'red':u.role==='manager'?'purple':'teal'}">${u.role||'agent'}</span></td>
      <td><span class="sb sb-${u.active?'green':'red'}">${u.active?'Active':'Inactive'}</span></td>
      <td style="font-size:11px;color:var(--muted2)">${u.lastLogin?new Date(u.lastLogin).toLocaleDateString():'-'}</td>
      <td>
        <button class="btn btn-${u.active?'danger':'success'} btn-xs" onclick="toggleUserActive('${uid}',${!u.active})">${u.active?'Deactivate':'Activate'}</button>
      </td>
    </tr>`).join('');
}
async function toggleUserActive(uid, val) {
  try { await fbUpdate('users/'+uid,{active:val}); showToast('User updated!'); renderAdminUsers(); }
  catch(e){ showToast('Error','err'); }
}
function openAddUserModal() { const m=document.getElementById('addUserModal'); if(m) m.classList.add('show'); }
function closeAddUserModal() { const m=document.getElementById('addUserModal'); if(m) m.classList.remove('show'); }
async function addUser() {
  const name=document.getElementById('nu-name')?.value.trim();
  const email=document.getElementById('nu-email')?.value.trim();
  const pwd=document.getElementById('nu-pwd')?.value;
  const role=document.getElementById('nu-role')?.value||'agent';
  if(!name||!email||!pwd||pwd.length<6){ showToast('Saare fields bharo (min 6 char password)','err'); return; }
  try {
    const cred = await _auth.createUserWithEmailAndPassword(email, pwd);
    await fbSet('users/'+cred.user.uid,{name,email,role,active:true,createdAt:new Date().toISOString()});
    showToast('User created! ğŸ‘¥'); closeAddUserModal();
    ['nu-name','nu-email','nu-pwd'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
    renderAdminUsers();
  } catch(e){ showToast(e.message,'err'); }
}
function saveCfg() { showToast('Config saved! ğŸ’¾'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MANAGER VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mgrUnlocked = false;
const MGR_PASSWORD = 'livsmart@mgr2024';

function openManagerPanel() {
  if(mgrUnlocked) { buildManager(); return; }
  const overlay = document.getElementById('mgrPwdOverlay');
  if(overlay){ overlay.style.display='flex'; setTimeout(()=>document.getElementById('mgrPwdInp')?.focus(),100); }
}
function cancelMgrPwd() { const o=document.getElementById('mgrPwdOverlay'); if(o) o.style.display='none'; switchPanel('home'); }
function checkMgrPwd() {
  const v = document.getElementById('mgrPwdInp')?.value;
  if(v === MGR_PASSWORD) {
    const o=document.getElementById('mgrPwdOverlay'); if(o) o.style.display='none';
    const el=document.getElementById('mgrPwdInp'); if(el) el.value='';
    const errEl=document.getElementById('mgrPwdErr'); if(errEl) errEl.style.display='none';
    mgrUnlocked = true;
    buildManager();
  } else {
    const errEl=document.getElementById('mgrPwdErr'); if(errEl) errEl.style.display='block';
    const el=document.getElementById('mgrPwdInp'); if(el) el.value='';
  }
}
document.addEventListener('DOMContentLoaded', ()=>{
  const el=document.getElementById('mgrPwdInp');
  if(el) el.addEventListener('keydown',e=>{if(e.key==='Enter')checkMgrPwd();});
});

function lockManager() {
  mgrUnlocked = false;
  setEl('mgrContent',''); 
  const mc=document.getElementById('mgrContent'); if(mc) mc.style.display='none';
  const me=document.getElementById('mgrEmpty'); if(me) me.style.display='block';
  switchPanel('home');
}

function buildManagerFirebase() {
  const me=document.getElementById('mgrEmpty');
  const mc=document.getElementById('mgrContent');
  if(!DATA?.work) { if(me) me.style.display='block'; if(mc) mc.style.display='none'; return; }
  if(me) me.style.display='none';
  if(mc) mc.style.display='block';

  const work = DATA.work;

  // TL Performance Table
  const tlMap = {};
  work.forEach(a => {
    const tl = a.tl||'Unknown';
    if(!tlMap[tl]) tlMap[tl]={tl,agents:0,calls:0,csat:0,csatN:0,acht:0,surv:0,survN:0};
    const t=tlMap[tl];
    t.agents++; t.calls+=a.calls;
    if(a.csat!=null){t.csat+=a.csat;t.csatN++;}
    if(a.avgAcht) t.acht+=a.avgAcht;
    if(a.survPct!=null){t.surv+=a.survPct;t.survN++;}
  });
  const tlData = Object.values(tlMap);
  const tlTbl = document.getElementById('tlPerfTbl');
  if(tlTbl) {
    tlTbl.innerHTML = `<thead><tr><th>TL</th><th class="r">Agents</th><th class="r">Calls</th><th class="r">CSET%</th><th class="r">ACHT</th><th class="r">Survey%</th></tr></thead><tbody>${
      tlData.sort((a,b)=>b.calls-a.calls).map(t=>`<tr>
        <td style="font-weight:700">${esc(t.tl)}</td>
        <td class="r">${t.agents}</td>
        <td class="r">${t.calls}</td>
        <td class="r ${t.csatN?csatCF(t.csatN?t.csat/t.csatN:null,getTargets().csat):''}">${t.csatN?pct(t.csat/t.csatN):'â€”'}</td>
        <td class="r">${t.acht?fmtAcht(t.acht/t.agents):'â€”'}</td>
        <td class="r">${t.survN?pct(t.surv/t.survN):'â€”'}</td>
      </tr>`).join('')
    }</tbody>`;
  }

  // Risk cards
  const riskEl = document.getElementById('mgrRiskCards');
  if(riskEl) {
    const risky = work.filter(a=>a.risk==='HIGH'||a.risk==='WARN').sort((a,b)=>a.risk==='HIGH'?-1:1).slice(0,6);
    riskEl.innerHTML = risky.map(a=>`
      <div class="risk-card ${a.risk==='HIGH'?'high':'warn'}" style="margin-bottom:10px">
        <div style="font-weight:700;margin-bottom:4px">${esc(a.name||'â€”')}</div>
        <div style="font-size:10px;color:var(--muted2)">${a.tl||'â€”'} Â· ${a.calls} calls</div>
        <div style="font-size:11px;margin-top:6px">CSET: <strong>${a.csat!=null?pct(a.csat):'â€”'}</strong></div>
      </div>`).join('') || '<p style="color:var(--muted2);font-size:12px">Koi high-risk agents nahi!</p>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function downloadFile(name, content, type='text/csv') {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content],{type}));
  a.download = name; a.click();
}
function formatINR(n) { return 'â‚¹'+(n||0).toLocaleString('en-IN'); }
function generateId() { return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', ()=>{
  const gs = document.getElementById('globalSearch');
  if(gs) gs.addEventListener('keydown', e => {
    if(e.key==='Enter') doGlobalSearch(gs.value.trim());
  });
});


// â•â•â•â• REPORT / CSET / MONTHLY / AGENTS ENGINE (v14) â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SMART AUTO-MAP SYSTEM â€” unmapped numbers ko identify & assign
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderUnmapCards(unmappedNums, work){
  const container = document.getElementById('unmapCards');
  if(!container) return;

  // For each unmapped number, try to auto-suggest based on call count similarity
  const agentNames = [...new Set(Object.values(MASTER).map(v=>v[0]))].sort();

  let html = '';
  unmappedNums.forEach(num => {
    // Count calls for this number in current work data (before mapping)
    // We store raw unmapped rows separately â€” use DATA raw count approach
    const callCount = work ? 0 : 0; // placeholder, actual count shown below

    // Try to find similar existing agent by checking if same number prefix
    const numClean = num.replace('@webrtchab','').replace('+91','');
    const autoSuggest = Object.entries(MASTER).find(([k,v]) => {
      const kClean = k.replace('@webrtchab','');
      return kClean.slice(0,5) === numClean.slice(0,5) && k !== num;
    });
    const suggestedAgent = autoSuggest ? autoSuggest[1][0] : '';
    const suggestedTL = autoSuggest ? autoSuggest[1][1] : (getTLOrder()[0]||'');

    const cardId = 'umc_' + num.replace(/[^a-z0-9]/gi,'_');

    html += `<div id="${cardId}" style="background:var(--card2);border:1px solid rgba(234,179,8,.2);border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--yellow);min-width:200px">
        ğŸ“µ <strong>${num}</strong>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex:1;flex-wrap:wrap">
        <select id="sel_agent_${cardId}" style="background:var(--card);border:1px solid var(--border2);border-radius:6px;padding:5px 10px;color:var(--text);font-size:12px;font-family:'Syne',sans-serif;min-width:160px">
          <option value="">-- Existing Agent --</option>
          ${agentNames.map(n=>`<option value="${n}" ${n===suggestedAgent?'selected':''}>${n}</option>`).join('')}
          <option value="__new__">+ New Agent naam</option>
        </select>
        <input id="inp_newname_${cardId}" placeholder="Naaya naam likho" style="display:none;background:var(--card);border:1px solid var(--border2);border-radius:6px;padding:5px 10px;color:var(--text);font-size:12px;font-family:'Syne',sans-serif;min-width:150px">
        <select id="sel_tl_${cardId}" style="background:var(--card);border:1px solid var(--border2);border-radius:6px;padding:5px 10px;color:var(--text);font-size:12px;font-family:'Syne',sans-serif">
          ${getTLOrder().map(t=>`<option value="${t}" ${t===suggestedTL?'selected':''}>${t}</option>`).join('')}
        </select>
        <button onclick="assignUnmapped('${num}','${cardId}')" style="background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.4);color:var(--green);border-radius:6px;padding:5px 14px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Syne',sans-serif">
          âœ… Assign
        </button>
        <button onclick="skipUnmapped('${cardId}')" style="background:rgba(100,116,139,.1);border:1px solid rgba(100,116,139,.2);color:var(--muted2);border-radius:6px;padding:5px 10px;font-size:11px;cursor:pointer;font-family:'JetBrains Mono',monospace">
          Skip
        </button>
        ${suggestedAgent ? `<span style="font-size:10px;color:var(--muted2);font-family:'JetBrains Mono',monospace">ğŸ’¡ Auto-suggest: ${suggestedAgent}</span>` : ''}
      </div>
    </div>`;
  });

  container.innerHTML = html;
  // Update count badge
  const countBadge = document.getElementById('unmapCount');
  if(countBadge) countBadge.textContent = unmappedNums.length + ' numbers';

  // Show/hide new name input on select change
  unmappedNums.forEach(num => {
    const cardId = 'umc_' + num.replace(/[^a-z0-9]/gi,'_');
    const sel = document.getElementById('sel_agent_'+cardId);
    const inp = document.getElementById('inp_newname_'+cardId);
    if(sel && inp){
      sel.addEventListener('change', ()=>{
        inp.style.display = sel.value === '__new__' ? 'block' : 'none';
      });
    }
  });
}

function assignUnmapped(num, cardId){
  const sel = document.getElementById('sel_agent_'+cardId);
  const inp = document.getElementById('inp_newname_'+cardId);
  const tlSel = document.getElementById('sel_tl_'+cardId);
  if(!sel || !tlSel) return;

  let agentName = sel.value === '__new__' ? (inp?.value||'').trim() : sel.value;
  const tl = tlSel.value;

  if(!agentName){ alert('Agent naam select ya likho!'); return; }

  // Add to MASTER permanently (runtime)
  const key = normAgNum(num);
  MASTER[key] = [agentName, tl];
  // Also add to agentsData so it persists in Agent Manager
  if(typeof agentsData !== 'undefined') agentsData[key] = [agentName, tl];

  // Save to localStorage so it persists across sessions
  try{
    const saved = JSON.parse(localStorage.getItem('livsmart_agents')||'{}');
    saved[key] = [agentName, tl];
    localStorage.setItem('livsmart_agents', JSON.stringify(saved));
  }catch(e){}

  // Remove card with animation
  const card = document.getElementById(cardId);
  if(card){ card.style.opacity='0'; card.style.transform='translateX(20px)'; card.style.transition='all .3s'; setTimeout(()=>card.remove(), 300); }

  // Update stat counter
  const s5 = document.getElementById('s5');
  if(s5){
    const newCount = Math.max(0, parseInt(s5.textContent||'0') - 1);
    s5.textContent = newCount;
    s5.style.color = newCount > 0 ? 'var(--red)' : 'var(--green)';
  }

  // Re-process entire report with updated MASTER
  if(DATA && DATA._raw && DATA._raw.length){
    showToast(`âœ… "${agentName}" mapped! Report refresh ho raha hai...`);
    setTimeout(()=>{ buildReport(DATA._raw, DATA.fileName); }, 400);
  } else {
    showToast(`âœ… "${agentName}" saved! Nayi file upload karo to reflect.`);
  }
}

function skipUnmapped(cardId){
  const card = document.getElementById(cardId);
  if(card){ card.style.opacity='0.3'; card.style.pointerEvents='none'; }
}

function _v14ShowToast(msg){
  let t = document.getElementById('toast');
  if(!t){
    t = document.createElement('div');
    t.id='liveToast';
    t.style.cssText="position:fixed;bottom:60px;right:20px;background:#1e2d45;border:1px solid var(--green);border-radius:8px;padding:10px 18px;font-size:12px;color:var(--green);font-family:'JetBrains Mono',monospace;z-index:9999;transition:opacity .3s";
    document.body.appendChild(t);
  }
  t.textContent=msg; t.style.opacity='1';
  setTimeout(()=>t.style.opacity='0', 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Collapse/Expand CSET Dashboard Sections
function toggleUnmapBox(){
  const cards = document.getElementById('unmapCards');
  const btn = document.getElementById('unmapToggleBtn');
  if(!cards || !btn) return;
  const isHidden = cards.style.display === 'none';
  cards.style.display = isHidden ? 'flex' : 'none';
  btn.textContent = isHidden ? 'â–¼ Hide' : 'â–¶ Show';
}

function toggleSection(id, hdr){
  const el = document.getElementById(id);
  if(!el) return;
  const btn = hdr ? hdr.querySelector('.collapse-btn') : null;
  const isCollapsed = el.classList.contains('collapsed');
  if(isCollapsed){
    el.classList.remove('collapsed');
    if(btn){ btn.classList.remove('collapsed'); btn.textContent='â–¼'; }
  } else {
    el.classList.add('collapsed');
    if(btn){ btn.classList.add('collapsed'); btn.textContent='â–¶'; }
  }
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UUIDs to exclude â€” calls present in this CSV but not in Excel export (data race condition)
const EXCLUDE_UUIDS = new Set([
  '43415e53-2785-47b1-a53f-98cb27d1a88b', // Prerana Sharma 4.9s
  'fabcca7a-1533-421f-8ca3-84253bacc487', // Shivam Rai 29.4s
  '9a5ef1ef-292a-4f2c-b69f-06046ebbc333', // Deepika 53.6s
  '13487fb9-a513-46f9-839d-551783f4cd76', // Harish Bhanja 6.6s
  '437ce970-d99d-454e-9ca4-b89f47587f73', // Lucky Singh 67.3s
]);

let MASTER = {
  // â”€â”€ RAHUL KUMAR TEAM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  '7428956808@webrtchab':['Ashish Saroj','Rahul Kumar'],
  '9580831006@webrtchab':['Ashish Saroj','Rahul Kumar'],
  '7303348047@webrtchab':['Deepankar','Rahul Kumar'],
  '7667504274@webrtchab':['Dwijendra Kumar','Rahul Kumar'],
  '9354707857@webrtchab':['Jaya Kumari','Rahul Kumar'],
  '9625562003@webrtchab':['Kajal kumari','Rahul Kumar'],
  '8264252845@webrtchab':['Kritika Kaur Sangotra','Rahul Kumar'],
  '7011468485@webrtchab':['Kuldeep Singh Bhandhari','Rahul Kumar'],
  '8264687135@webrtchab':['Mansi','Rahul Kumar'],
  '9211958100@webrtchab':['Prerana Sharma','Rahul Kumar'],
  '7477330964@webrtchab':['Prerana Sharma','Rahul Kumar'],
  '9149034313@webrtchab':['Shivam Rai','Rahul Kumar'],
  '7347544965@webrtchab':['Sourav Kumar Jha','Rahul Kumar'],
  '9355348178@webrtchab':['Sourav Kumar Jha','Rahul Kumar'],
  '9355754613@webrtchab':['Sourav Kumar Jha','Rahul Kumar'],
  '8882545910@webrtchab':['Jatin Bhardwaj','Rahul Kumar'],
  '8839103683@webrtchab':['Shivam Upadhyay','Rahul Kumar'],
  '9773766094@webrtchab':['Priyanka Kumari','Rahul Kumar'],
  '9560295842@webrtchab':['Sahil Kumar','Rahul Kumar'],
  '9289801633@webrtchab':['Deepak Sangwan','Rahul Kumar'],
  '7479884219@webrtchab':['Md Shagil Nasir','Rahul Kumar'],
  '8287613499@webrtchab':['Faraz Anwar','Rahul Kumar'],
  '9818433620@webrtchab':['Sarita','Rahul Kumar'],
  '8076430115@webrtchab':['Sarita','Rahul Kumar'],
  '8826898990@webrtchab':['sujal','Rahul Kumar'],
  '9319653783@webrtchab':['Kajal','Rahul Kumar'],
  '7463932919@webrtchab':['Lucky Mehta','Rahul Kumar'],
  '7428702745@webrtchab':['Lucky Mehta','Rahul Kumar'],
  '8595113659@webrtchab':['Piyush','Rahul Kumar'],
  '7428956851@webrtchab':['Piyush','Rahul Kumar'],
  '9810614720@webrtchab':['SACHIN','Rahul Kumar'],
  '8595105248@webrtchab':['SACHIN','Rahul Kumar'],
  '9891665406@webrtchab':['Mohit Sharma','Rahul Kumar'],
  '9871131237@webrtchab':['Nitesh Maurya','Rahul Kumar'],
  '7428047818@webrtchab':['Nitesh Maurya','Rahul Kumar'],
  '6386444279@webrtchab':['Arvind Mashish','Rahul Kumar'],
  '7042377299@webrtchab':['Arvind Mashish','Rahul Kumar'],
  '8287582110@webrtchab':['Neha Kumari','Rahul Kumar'],
  '7042724455@webrtchab':['Neha Kumari','Rahul Kumar'],
  '9599511782@webrtchab':['Neeraj Singh','Rahul Kumar'],
  '8354056710@webrtchab':['Himanshu Pal','Rahul Kumar'],
  '8587889063@webrtchab':['Rajeshwar Rai','Rahul Kumar'],
  '9599720231@webrtchab':['Saniya Pasha','Rahul Kumar'],
  '7303721715@webrtchab':['Saniya Pasha','Rahul Kumar'],
  '7677107410@webrtchab':['Nikhil Kumar','Rahul Kumar'],
  '7347544965@webrtchab':['Sourav Kumar Jha','Rahul Kumar'],
  '7827456369@webrtchab':['Tejpal','Rahul Kumar'],
  // â”€â”€ ROSHNI TEAM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  '9650708610@webrtchab':['Deepika','ROSHNI'],
  '9555555057@webrtchab':['Dev Attri','ROSHNI'],
  '9311369192@webrtchab':['Khushi','ROSHNI'],
  '8447905121@webrtchab':['Khushi','ROSHNI'],
  '7827985388@webrtchab':['Laxmi','ROSHNI'],
  '8744911764@webrtchab':['Neetu Kumari','ROSHNI'],
  '7307570245@webrtchab':['Neha Yadav','ROSHNI'],
  '8178551845@webrtchab':['Priti Biswas','ROSHNI'],
  '9667587493@webrtchab':['Twinkle Kumari','ROSHNI'],
  '9717901848@webrtchab':['karan kanojia','ROSHNI'],
  '9599280122@webrtchab':['Abhishek Bagari','ROSHNI'],
  '8745091712@webrtchab':['Arvind Kushwaha','ROSHNI'],
  '9643923979@webrtchab':['Rohit Kumar','ROSHNI'],
  '9599516910@webrtchab':['Rohit Kumar','ROSHNI'],
  '8076375085@webrtchab':['Rohit Kumar','ROSHNI'],
  '9289417203@webrtchab':['Snehlata Tiwari','ROSHNI'],
  '9588379832@webrtchab':['Khushbu','ROSHNI'],
  '9891773528@webrtchab':['Vijay Kushwaha','ROSHNI'],
  '9711143075@webrtchab':['Vijay','ROSHNI'],
  '8601392847@webrtchab':['Naicy Patel','ROSHNI'],
  '9811332796@webrtchab':['Suraj Kumar','ROSHNI'],
  '8619056462@webrtchab':['Pooja Kanwar','ROSHNI'],
  '7765098625@webrtchab':['ABHISHEK KUMAR','ROSHNI'],
  '9654298691@webrtchab':['Pankaj Kumar','ROSHNI'],
  '7050587541@webrtchab':['Md Arif','ROSHNI'],
  '8604117365@webrtchab':['Amar Kushwaha','ROSHNI'],
  '8882629284@webrtchab':['Megha Som','ROSHNI'],
  '8384021202@webrtchab':['Mayank Aggarwal','ROSHNI'],
  '9319773784@webrtchab':['Natali Singh','ROSHNI'],
  '9990420866@webrtchab':['Sonika','ROSHNI'],
  '9667155654@webrtchab':['Chinmay Pahadi','ROSHNI'],
  '9625981197@webrtchab':['Ashish','ROSHNI'],
  '7651835928@webrtchab':['Harshika','ROSHNI'],
  '8708046967@webrtchab':['Deepali Sharma','ROSHNI'],
  // â”€â”€ YATENDER TEAM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  '9999183517@webrtchab':['Aakash lohia','YATENDER'],
  '9870207026@webrtchab':['Anuj Kumar','YATENDER'],
  '9354445472@webrtchab':['Daksh','YATENDER'],
  '8076852245@webrtchab':['Harish Bhanja','YATENDER'],
  '6393182311@webrtchab':['Harsh Pal','YATENDER'],
  '8810366377@webrtchab':['Jyoti kumari','YATENDER'],
  '9971277853@webrtchab':['Jyoti kumari','YATENDER'],
  '9540739291@webrtchab':['Lucky Singh','YATENDER'],
  '9315563226@webrtchab':['Mohini Chauhan','YATENDER'],
  '7668702458@webrtchab':['Mohini Chauhan','YATENDER'],
  '7985322716@webrtchab':['Pranamya Upadhyay','YATENDER'],
  '9990595467@webrtchab':['Rajat Raj','YATENDER'],
  '8447235134@webrtchab':['Rajesh Nishad','YATENDER'],
  '8527891400@webrtchab':['Sachin Kashiv','YATENDER'],
  '9667693022@webrtchab':['AMIT Rai','YATENDER'],
  '9871105134@webrtchab':['Varsha','YATENDER'],
  '8076670240@webrtchab':['Varsha','YATENDER'],
  '7042121470@webrtchab':['Vijay Shekhawat','YATENDER'],
  '9785314154@webrtchab':['Vijay','YATENDER'],
  '7985422593@webrtchab':['Akash Raut','YATENDER'],
  '7042121654@webrtchab':['Akash Raut','YATENDER'],
  '9065186047@webrtchab':['Rahul Kumar','YATENDER'],
  '8287287837@webrtchab':['Manish Kumar','YATENDER'],
  '9382384123@webrtchab':['Muskan Burnwal','YATENDER'],
  '9891773441@webrtchab':['Tushar Dhyani','YATENDER'],
  '9355288655@webrtchab':['Shivani Machal','YATENDER'],
  '9518181501@webrtchab':['Shubhankar Mandal','YATENDER'],
  '8972222832@webrtchab':['Ahana dutta','YATENDER'],
  '9205151774@webrtchab':['Deepesh Kumar','YATENDER'],
  '9093670402@webrtchab':['Amartya Dey','YATENDER'],
  '9065957843@webrtchab':['Himanshu Shekhar','YATENDER'],
  '7428205190@webrtchab':['Pawan Kumar','YATENDER'],
  '7463919746@webrtchab':['Nikhil Jaiswal','YATENDER'],
  '7428652009@webrtchab':['Kanchan Jasoria','YATENDER'],
  // â”€â”€ ATUL TEAM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  '9716602208@webrtchab':['Mohit','ATUL'],
  '9576623290@webrtchab':['Sanjeev Kumar1','ATUL'],
  '9599514781@webrtchab':['Sanjeev Kumar1','ATUL'],
  '8800542482@webrtchab':['Arpit sood','ATUL'],
  '6201761292@webrtchab':['Aman Dubey','ATUL'],
  '8800505815@webrtchab':['Aman Dubey','ATUL'],
  '9810618936@webrtchab':['Sushil Singh','ATUL'],
  '8800509429@webrtchab':['Mohima Mondal','ATUL'],
  '8882257259@webrtchab':['Neeraj Singh','ATUL'],
  '9289417201@webrtchab':['Shrishti Choudhary','ATUL'],
  '8178568443@webrtchab':['Riya Mishra','ATUL'],
  '9773949814@webrtchab':['Mohit Pandey','ATUL'],
  '8595891394@webrtchab':['Md Kalamudeen','ATUL'],
  '9354885688@webrtchab':['Aman sood','ATUL'],
  '8527266433@webrtchab':['Sanjeev Kumar','ATUL'],
  '7701985332@webrtchab':['Shivani Singh','ATUL'],
  '8131088998@webrtchab':['Sutapa','ATUL'],
  // â”€â”€ TANU TEAM (excluded from reports) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  '7428786661@webrtchab':['Jivesh Miglani','TANU'],
  '8130105098@webrtchab':['Shiwali','TANU'],
  '8512012372@webrtchab':['Shiwali','TANU'],
}

// TL list (dynamic)
let TL_LIST = ['Rahul Kumar','ROSHNI','YATENDER','ATUL'];

// Load previously saved agent mappings from localStorage
(function loadSavedAgents(){
  try{
    const saved = JSON.parse(localStorage.getItem('livsmart_agents')||'{}');
    let count = 0;
    for(const [k,v] of Object.entries(saved)){
      if(!MASTER[k]){ MASTER[k]=v; count++; }
    }
    if(count > 0) console.log('[Livsmart] Loaded '+count+' saved agent mappings from localStorage');
  }catch(e){}
})();
const TL_CLS = {'Rahul Kumar':'rk','ROSHNI':'ro','YATENDER':'ya','ATUL':'at'};
const TL_COLOR_MAP = {'Rahul Kumar':'#3b82f6','ROSHNI':'#10b981','YATENDER':'#f97316','ATUL':'#8b5cf6'};
const TL_HEX = {'Rahul Kumar':'FF2E75B6','ROSHNI':'FF70AD47','YATENDER':'FFED7D31','ATUL':'FF7030A0'};

const EXCLUDE_TL = new Set(['Sales queue','OJT','Support','TANU','#N/A','']);
// MGR_PASSWORD and mgrUnlocked defined in main CRM engine above
let DATA = null;

// â”€â”€ TL_ORDER (dynamic) â”€â”€
function getTLOrder(){ return TL_LIST.filter(t => !EXCLUDE_TL.has(t)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navTo(tab){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  const panel = document.getElementById('panel-'+tab);
  panel.classList.add('active');
  // retrigger animation
  panel.style.animation='none';
  panel.offsetHeight; // reflow
  panel.style.animation='';
  document.getElementById('nt-'+tab).classList.add('active');
  if(tab==='dashboard') buildDashboard();
  if(tab==='agents'){ renderTLCards(); renderAgents(); }
  if(tab==='manager') buildManager();
  if(tab==='monthly') initMonthlyPanel();
}

// navToMgr and checkPwd â†’ aliases for our main manager functions
function navToMgr(){ openManagerPanel(); }
function checkPwd(){ checkMgrPwd(); }


// cancelPwd, lockManager defined in main CRM engine above

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function normAgNum(s){
  s = String(s||'').trim();
  if(s.startsWith('+91') && !s.includes('@')) return s.slice(3)+'@webrtchab';
  if(/^\d{10}$/.test(s)) return s+'@webrtchab';
  return s;
}
function normTL(t){ if(!t)return''; return String(t).trim().toLowerCase()==='atul'?'ATUL':String(t).trim(); }
function parseHour(v){
  if(v===null||v===undefined||v==='')return null;
  if(typeof v==='number'){ if(v>0&&v<1)return v*24; if(v>=0&&v<=23)return v; }
  const s=String(v).trim();
  const m=s.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
  if(m)return parseInt(m[1])+parseInt(m[2])/60;
  return null;
}
function parseDur(v){
  if(v===null||v===undefined||v===''||v===false) return 0;
  if(typeof v==='number'){
    if(v===0) return 0;
    // Excel time fraction: values like 0.003 = seconds/86400
    if(v>0&&v<1) return Math.round(v*86400);
    // Plain seconds (most DB exports give integer seconds)
    return Math.round(v);
  }
  const s=String(v).trim();
  if(!s||s==='0') return 0;
  // HH:MM:SS or MM:SS
  const m3=s.match(/^(\d+):(\d{2}):(\d{2}(?:\.\d+)?)$/);
  if(m3) return parseInt(m3[1])*3600+parseInt(m3[2])*60+parseFloat(m3[3]);
  const m2=s.match(/^(\d+):(\d{2}(?:\.\d+)?)$/);
  if(m2) return parseInt(m2[1])*60+parseFloat(m2[2]);
  // plain number string
  const n=parseFloat(s);
  if(!isNaN(n)) return n>0&&n<1?Math.round(n*86400):Math.round(n);
  return 0;
}
function hms(s){ s=Math.max(0,Math.round(s)); const m=~~(s/60); const sec=s%60; return `${m}m ${String(sec).padStart(2,'0')}s`; }
function hmsLong(s){ s=Math.max(0,Math.round(s)); return `${String(~~(s/3600)).padStart(2,'0')}:${String(~~((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }
function fmtAcht(avgSec){
  if(!avgSec||avgSec<=0) return '<span class="acht-badge"><span class="acht-s">â€”</span></span>';
  const m=~~(avgSec/60); const s=Math.round(avgSec%60);
  return `<span class="acht-badge"><span class="acht-m">${m}m</span><span class="acht-s">${String(s).padStart(2,'0')}s</span></span>`;
}
function pct(v,d=0){ if(v===null)return'N/A'; return d>0?(v*100).toFixed(d)+'%':Math.round(v*100)+'%'; }
function fmtHour(h){ return `${String(~~h).padStart(2,'0')}:00`; }

function agg(rows){
  const n=rows.length;
  const fb1=rows.filter(r=>r._fb1).length;
  const fb21=rows.filter(r=>r._fb21).length;
  const fb22=rows.filter(r=>r._fb22).length;
  const fb23=rows.filter(r=>r._fb23).length;
  const fb2N=rows.filter(r=>r._fb2N).length;
  const resp=rows.filter(r=>r._hasFb).length;
  const secs=rows.reduce((a,r)=>a+r._sec,0);
  const csat=resp>0?fb1/resp:null;
  const surv=n>0?resp/n:0;
  const acht=n>0?hms(secs/n):'â€”';
  const avgSec=n>0?secs/n:0;
  return{fb1,fb21,fb22,fb23,fb2N,resp,n,csat,surv,acht,secs,avgSec};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE PROCESSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function prog(p,lbl){ document.getElementById('progFill').style.width=p+'%'; document.getElementById('progLbl').textContent=lbl; }
function onDrag(e){e.preventDefault();document.getElementById('upZone').classList.add('drag')}
function onDragLeave(){document.getElementById('upZone').classList.remove('drag')}
function onDrop(e){e.preventDefault();onDragLeave();if(e.dataTransfer.files[0])processFile(e.dataTransfer.files[0])}
function handleFile(el){if(el.files[0])processFile(el.files[0])}

function processFile(file){
  const ext=file.name.split('.').pop().toLowerCase();
  document.getElementById('fName').textContent=file.name;
  document.getElementById('fMeta').textContent=`${(file.size/1024).toFixed(1)} KB Â· ${ext.toUpperCase()}`;
  document.getElementById('fileBar').style.display='flex';
  document.getElementById('upZone').style.display='none';
  document.getElementById('progWrap').style.display='block';
  prog(5,'ğŸ“‚ File padh raha hun...');
  if(ext==='csv'){
    // Chunked streaming â€” handles 40MB+ files without freezing
    const allRows = [];
    const fileSizeMB = (file.size/1024/1024).toFixed(1);
    Papa.parse(file,{
      header:true, skipEmptyLines:true, dynamicTyping:false,
      chunkSize: 1024*1024, // 1MB per chunk for speed
      chunk: function(results){
        results.data.forEach(r=>allRows.push(r));
        const pct = Math.min(78, 5 + Math.round((allRows.length / Math.max(allRows.length, 50000)) * 73));
        prog(pct, `ğŸ“¥ ${(allRows.length/1000).toFixed(1)}k rows padhe... (${fileSizeMB}MB)`);
      },
      complete: ()=>{
        prog(80, `âœ… ${allRows.length.toLocaleString()} rows mili â€” processing shuru...`);
        setTimeout(()=>buildReport(allRows, file.name), 30);
      },
      error: (err)=>{ prog(0,'âŒ File read error: '+err.message); alert('File read error: '+err.message); }
    });
  } else {
    // Excel â€” optimized for large files (40MB+)
    const fileSizeMB = file.size/1024/1024;
    prog(10, `ğŸ“‚ Excel padh raha hun... (${fileSizeMB.toFixed(1)} MB)`);
    const reader=new FileReader();
    reader.onload=e=>{
      prog(55,'âš™ Excel parse ho raha hai â€” thoda wait karo...');
      // Use setTimeout to allow UI to update before heavy parse
      setTimeout(()=>{
        try{
          // For large files, use dense mode which is much faster
          const opts = {type:'array', cellDates:false, dense:fileSizeMB>15};
          prog(65,'âš™ Data extract ho raha hai...');
          const wb=XLSX.read(e.target.result, opts);
          const sn=wb.SheetNames.includes('Raw Data')?'Raw Data':wb.SheetNames[0];
          prog(80,'âš™ Rows process ho rahi hain...');
          setTimeout(()=>{
            try{
              const rows=XLSX.utils.sheet_to_json(wb.Sheets[sn],{defval:''});
              prog(92,`âœ… ${rows.length.toLocaleString()} rows mili â€” final processing...`);
              setTimeout(()=>buildReport(rows,file.name), 30);
            }catch(err2){ alert('Excel parse error: '+err2.message); }
          }, 50);
        }catch(err){ alert('Excel read error: '+err.message); }
      },80);
    };
    reader.onerror = () => alert('File read fail. Browser memory kam ho sakti hai. CSV format try karo.');
    reader.readAsArrayBuffer(file);
  }
}

function resetReport(){
  DATA=null;
  document.getElementById('fi').value='';
  document.getElementById('fileBar').style.display='none';
  document.getElementById('upZone').style.display='block';
  document.getElementById('progWrap').style.display='none';
  document.getElementById('statRow').style.display='none';
  document.getElementById('toolbar').style.display='none';
  document.getElementById('targetBar').style.display='none';
  document.getElementById('unmapBox').style.display='none';
  document.getElementById('dlOk').style.display='none';
  ['t0','t1','t2'].forEach(id=>document.getElementById(id).style.display='none');
}

// Smart auto-detect duration column from first row
function detectDurCol(sampleRow){
  // Priority order â€” exact matches first
  const candidates = [
    'conversation_duration','conv_duration','call_duration',
    'Conv Duration','Conversation Duration','Call Duration',
    'duration','Duration','dur','Dur','talk_time','TalkTime',
    'handle_time','aht','AHT','seconds','Seconds'
  ];
  for(const c of candidates){
    if(c in sampleRow && sampleRow[c]!==undefined && sampleRow[c]!=='') return c;
  }
  // Fallback: scan all keys for anything with "duration" or "time" that has numeric-ish values
  for(const k of Object.keys(sampleRow)){
    const kl=k.toLowerCase();
    if((kl.includes('duration')||kl.includes('dur'))&&!kl.includes('date')){
      return k;
    }
  }
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUILD REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildReport(raw, fileName){ if(!raw||!raw.length) return;
  prog(82,'ğŸ” Offhours + NC filter ho raha hai...');
  // Yield to UI thread first
  setTimeout(()=>{
    const totalRaw=raw.length;
    // Step 1: Filter offhours + not connected
    const df1=[];
    for(let i=0;i<raw.length;i++){
      if(String(raw[i].call_status||'').trim().toLowerCase()==='offhours') continue;
      df1.push(raw[i]);
    }
    const remOff=totalRaw-df1.length;
    const df2=[];
    for(let i=0;i<df1.length;i++){
      const ts=String(df1[i].call_transfer_status||'').trim().toLowerCase();
      if(ts==='not connected'||ts==='missed') continue;
      df2.push(df1[i]);
    }
    const remNC=df1.length-df2.length;

    prog(86,'ğŸ”— VLOOKUP + time parse â€” chunked processing...');

    const unmapped=new Set();
    const durCol = df2.length ? detectDurCol(df2[0]) : null;
    const timeCol = df2.length ? (df2[0].call_time!==undefined?'call_time':df2[0].Time!==undefined?'Time':df2[0].call_Time!==undefined?'call_Time':null) : null;

    // Chunked processing â€” process 5000 rows per tick to avoid freeze
    const CHUNK=5000;
    const mapped_rows=[];
    let idx=0;

    function processChunk(){
      const end=Math.min(idx+CHUNK, df2.length);
      for(let i=idx;i<end;i++){
        const r=df2[i];
        // Skip calls that are in CSV but not in Excel (data race condition)
        if(EXCLUDE_UUIDS.has(String(r.call_uuid||'').trim())) continue;
        const raw_num=String(r.agent_number||'').trim();
        const agNum=normAgNum(raw_num);
        const mapped=MASTER[agNum]||MASTER[raw_num];
        const agent=mapped?mapped[0]:'';
        const tl=mapped?normTL(mapped[1]):'';
        if(!mapped&&raw_num&&raw_num!=='False'&&raw_num!=='None') unmapped.add(raw_num);

        const fb=String(r.feedback||'').trim();
        const rawTime = timeCol ? r[timeCol] : (r.call_time??r.Time??r.call_Time??null);
        const hDec=parseHour(rawTime);
        const hInt=hDec!==null?Math.floor(hDec):null;
        const rawDur = durCol ? r[durCol] : (
          r.conversation_duration ?? r.conv_duration ?? r.duration ?? r.Duration
          ?? r.call_duration ?? r['Conv Duration'] ?? r['Conversation Duration']
          ?? r['Call Duration'] ?? null
        );
        const sec=parseDur(rawDur);
        let timeStr='â€”';
        if(hDec!==null){const h=~~hDec,m=~~((hDec-h)*60),s=~~(((hDec-h)*60-m)*60);timeStr=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
        mapped_rows.push({
          ...r,_agent:agent,_tl:tl,_sec:sec,_hour:hInt,_timeStr:timeStr,
          _fb1:fb==='1'?1:0,_fb21:fb==='2,1'?1:0,_fb22:fb==='2,2'?1:0,
          _fb23:fb==='2,3'?1:0,_fb2N:fb==='2,None'?1:0,
          _hasFb:['1','2,1','2,2','2,3','2,None'].includes(fb)?1:0,
        });
      }
      idx=end;
      const pct=86+Math.round((idx/df2.length)*10);
      prog(pct,`ğŸ”— ${idx.toLocaleString()} / ${df2.length.toLocaleString()} rows process... (${Math.round(idx/df2.length*100)}%)`);
      if(idx<df2.length){
        setTimeout(processChunk,0); // yield to browser between chunks
      } else {
        finalize(mapped_rows, unmapped, totalRaw, remOff, remNC, fileName, df2);
      }
    }
    processChunk();
  },30);
}

function finalize(df, unmapped, totalRaw, remOff, remNC, fileName, rawRows){
  const work=df.filter(r=>r._agent&&!EXCLUDE_TL.has(r._tl));
  // Track unmapped rows that have feedback - these cause 1-2 count difference
  const unmappedFbRows = df.filter(r=>!r._agent && r._hasFb);
  if(unmappedFbRows.length > 0){
    console.warn(`[Livsmart] ${unmappedFbRows.length} unmapped rows have feedback â€” assign them to fix count.`);
  }

  prog(96,'ğŸ“Š Tables bana raha hun...');

  document.getElementById('s1').textContent=totalRaw.toLocaleString();
  document.getElementById('s2').textContent=remOff.toLocaleString();
  document.getElementById('s3').textContent=remNC.toLocaleString();
  document.getElementById('s4').textContent=work.length.toLocaleString();
  const s5el=document.getElementById('s5');
  s5el.textContent=unmapped.size;
  s5el.style.color=unmapped.size>0?'var(--red)':'var(--green)';
  s5el.parentElement.title=unmapped.size>0?'Unmapped numbers! Assign karo to fix count':'Sab mapped âœ…';
  document.getElementById('statRow').style.display='flex';
  document.querySelectorAll('#statRow .stat-pill').forEach((el,i)=>{
    el.style.animation=`fadeUp .4s ${i*0.07}s cubic-bezier(.22,1,.36,1) both`;
  });

  if(unmapped.size){
    document.getElementById('unmapBox').style.display='block';
    renderUnmapCards([...unmapped], work);
  } else document.getElementById('unmapBox').style.display='none';

  DATA={work,totalRaw,remOff,remNC,fileName,_raw:rawRows||[]};

  setTimeout(()=>{
    renderAgent(work);
    renderHourly(work);
    renderProc(work);
    prog(100,'âœ… Report ready!');
    setTimeout(()=>document.getElementById('progWrap').style.display='none',600);
    document.getElementById('toolbar').style.display='flex';
    document.getElementById('targetBar').style.display='block';
    switchTab(0);
    // Show date range from data
    const allDates = [...new Set(work.map(r=>r.call_date||r.Date||'').filter(Boolean))].sort();
    let dateLabel = '', dateRange = '';
    if(allDates.length === 1){
      const dt = new Date(allDates[0]);
      const opts = {weekday:'long', year:'numeric', month:'long', day:'numeric'};
      dateLabel = isNaN(dt) ? allDates[0] : dt.toLocaleDateString('en-IN', opts);
    } else if(allDates.length > 1){
      dateLabel = `${allDates[0]} â†’ ${allDates[allDates.length-1]}`;
      dateRange = `(${allDates.length} dates)`;
    }
    const el = document.getElementById('reportDate');
    if(el) el.textContent = dateLabel ? `ğŸ“… ${dateLabel}` : 'ğŸ“‚ File upload karo';
    const elRange = document.getElementById('reportDateRange')||{textContent:''};
    if(elRange){ elRange.textContent = dateRange; elRange.style.display = dateRange ? 'inline' : 'none'; }
    // Update nav bar date chip
    const navChip = document.getElementById('navDateChip')||{textContent:''};
    if(navChip){ navChip.textContent = dateLabel || ''; navChip.style.display = dateLabel ? 'inline-flex' : 'none'; }
  },20);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TARGET SETTINGS & CONDITIONAL FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PRESETS = {
  default:  { csat: 95, acht: '4:30', surv: 20 },
  strict:   { csat: 97, acht: '4:00', surv: 25 },
  relaxed:  { csat: 90, acht: '5:00', surv: 15 },
};

function getTargets(){
  const csatPct = parseFloat(document.getElementById('tgt-csat').value)||95;
  const achtStr = document.getElementById('tgt-acht').value||'4:30';
  const survPct = parseFloat(document.getElementById('tgt-surv').value)||20;
  // Parse acht mm:ss â†’ seconds
  const achtParts = achtStr.split(':');
  const achtSec = achtParts.length===2 ? parseInt(achtParts[0])*60+parseInt(achtParts[1]) : parseInt(achtParts[0])*60;
  return { csat: csatPct/100, achtSec, surv: survPct/100, csatPct, survPct, achtStr };
}

function applyPreset(name){
  const p = PRESETS[name];
  if(!p) return;
  document.getElementById('tgt-csat').value = p.csat;
  document.getElementById('tgt-acht').value = p.acht;
  document.getElementById('tgt-surv').value = p.surv;
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('presetCustom').style.display='none';
  const btn = document.getElementById('preset'+name.charAt(0).toUpperCase()+name.slice(1));
  if(btn) btn.classList.add('active');
  if(DATA) renderAgent(DATA.work);
}

function onTargetChange(){
  // Mark as custom preset
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
  const customBtn = document.getElementById('presetCustom');
  customBtn.style.display='block';
  customBtn.classList.add('active');
  if(DATA) renderAgent(DATA.work);
}

// CSS class for CSAT value based on target
function csatCF(val, tgt){
  if(val===null) return '';
  const ratio = val/tgt;
  if(ratio>=1) return 'cf-green';
  if(ratio>=0.95) return 'cf-yellow';
  if(ratio>=0.90) return 'cf-orange';
  return 'cf-red';
}
function csatDot(val, tgt){
  if(val===null) return '';
  const ratio = val/tgt;
  if(ratio>=1) return 'g';
  if(ratio>=0.95) return 'y';
  if(ratio>=0.90) return 'o';
  return 'r';
}
// ACHT: green if â‰¤ target, red if > target (lower is better)
function achtCF(avgSec, tgtSec){
  if(!avgSec||avgSec<=0) return '';
  return avgSec<=tgtSec ? 'cf-green' : avgSec<=tgtSec*1.1 ? 'cf-yellow' : avgSec<=tgtSec*1.2 ? 'cf-orange' : 'cf-red';
}
function achtDot(avgSec, tgtSec){
  if(!avgSec||avgSec<=0) return '';
  return avgSec<=tgtSec ? 'g' : avgSec<=tgtSec*1.1 ? 'y' : avgSec<=tgtSec*1.2 ? 'o' : 'r';
}
// Survey: same as CSAT (higher is better)
function survCF(val, tgt){
  const ratio = val/tgt;
  if(ratio>=1) return 'cf-green';
  if(ratio>=0.95) return 'cf-yellow';
  if(ratio>=0.90) return 'cf-orange';
  return 'cf-red';
}
function survDot(val, tgt){
  const ratio = val/tgt;
  if(ratio>=1) return 'g';
  if(ratio>=0.95) return 'y';
  if(ratio>=0.90) return 'o';
  return 'r';
}

// Render ACHT cell with conditional formatting
function achtCell(avgSec, tgtSec){
  const cfCls = achtCF(avgSec, tgtSec);
  const dot = achtDot(avgSec, tgtSec);
  const txt = fmtAcht(avgSec);
  if(!dot) return txt;
  return `<span class="cf-bar ${cfCls}"><span class="cf-dot ${dot}"></span>${txt}</span>`;
}

// Excel color for targets
function xlCsatColor(val, tgt, C){
  if(val===null) return {bg:C.LIGHT2,fg:C.BLACK};
  const ratio=val/tgt;
  if(ratio>=1) return {bg:C.GREEN_BG,fg:C.GREEN_FG};
  if(ratio>=0.95) return {bg:C.YEL_BG,fg:C.YEL_FG};
  if(ratio>=0.90) return {bg:C.ORG_BG,fg:C.ORG_FG};
  return {bg:C.RED_BG,fg:C.RED_FG};
}
function xlAchtColor(avgSec, tgtSec, bgr, C){
  if(!avgSec||avgSec<=0) return {bg:bgr,fg:C.BLACK};
  if(avgSec<=tgtSec) return {bg:C.GREEN_BG,fg:C.GREEN_FG};
  if(avgSec<=tgtSec*1.1) return {bg:C.YEL_BG,fg:C.YEL_FG};
  if(avgSec<=tgtSec*1.2) return {bg:C.ORG_BG,fg:C.ORG_FG};
  return {bg:C.RED_BG,fg:C.RED_FG};
}
function xlSurvColor(val, tgt, C){
  const ratio=val/tgt;
  if(ratio>=1) return {bg:C.GREEN_BG,fg:C.GREEN_FG};
  if(ratio>=0.95) return {bg:C.YEL_BG,fg:C.YEL_FG};
  if(ratio>=0.90) return {bg:C.ORG_BG,fg:C.ORG_FG};
  return {bg:C.RED_BG,fg:C.RED_FG};
}

//  RENDER TABLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAgent(work){
  const T = getTargets();
  const hdrs=['Agent / TL','Rating 1','2,1','2,2','2,3','2,None','Response','Total Calls','C-Sat%','Survey%','ACHT'];
  let h=`<thead><tr>${hdrs.map((x,i)=>`<th${i>0?' class="r"':''}>${x}</th>`).join('')}</tr></thead><tbody>`;
  for(const tl of getTLOrder()){
    const tlR=work.filter(r=>r._tl===tl);
    if(!tlR.length)continue;
    const t=agg(tlR);
    const cls=TL_CLS[tl]||'';
    h+=`<tr class="tl-hdr ${cls}"><td>${tl.toUpperCase()}</td>
      <td class="r">${t.fb1}</td><td class="r">${t.fb21}</td><td class="r">${t.fb22}</td>
      <td class="r">${t.fb23}</td><td class="r">${t.fb2N}</td><td class="r">${t.resp}</td>
      <td class="r">${t.n}</td>
      <td class="r">${pct(t.csat)}</td>
      <td class="r">${pct(t.surv)}</td>
      <td class="r">${fmtAcht(t.avgSec)}</td></tr>`;
    for(const ag of [...new Set(tlR.map(r=>r._agent))].sort()){
      const a=agg(tlR.filter(r=>r._agent===ag));
      const cc=csatCF(a.csat,T.csat);
      const cd=csatDot(a.csat,T.csat);
      const sc=survCF(a.surv,T.surv);
      const sd=survDot(a.surv,T.surv);
      h+=`<tr class="agent"><td style="padding-left:22px">â†³ ${ag}</td>
        <td class="r">${a.fb1}</td><td class="r">${a.fb21}</td><td class="r">${a.fb22}</td>
        <td class="r">${a.fb23}</td><td class="r">${a.fb2N}</td><td class="r">${a.resp}</td>
        <td class="r">${a.n}</td>
        <td class="r ${cc}"><span class="cf-bar"><span class="cf-dot ${cd}"></span>${pct(a.csat)}</span></td>
        <td class="r ${sc}"><span class="cf-bar"><span class="cf-dot ${sd}"></span>${pct(a.surv)}</span></td>
        <td class="r">${achtCell(a.avgSec,T.achtSec)}</td></tr>`;
    }
  }
  const g=agg(work);
  const gcc=csatCF(g.csat,T.csat);
  const gcd=csatDot(g.csat,T.csat);
  const gsc=survCF(g.surv,T.surv);
  const gsd=survDot(g.surv,T.surv);
  h+=`<tr class="grand"><td>GRAND TOTAL</td>
    <td class="r">${g.fb1}</td><td class="r">${g.fb21}</td><td class="r">${g.fb22}</td>
    <td class="r">${g.fb23}</td><td class="r">${g.fb2N}</td><td class="r">${g.resp}</td>
    <td class="r">${g.n}</td>
    <td class="r ${gcc}"><span class="cf-bar"><span class="cf-dot ${gcd}"></span>${pct(g.csat)}</span></td>
    <td class="r ${gsc}"><span class="cf-bar"><span class="cf-dot ${gsd}"></span>${pct(g.surv)}</span></td>
    <td class="r">${achtCell(g.avgSec,T.achtSec)}</td></tr></tbody>`;
  document.getElementById('agentTbl').innerHTML=h;
  document.getElementById('t0').style.display='block';
}

function renderHourly(work){
  const idx = buildIndex(work);
  const hours=[...new Set(work.map(r=>r._hour).filter(h=>h!==null))].sort((a,b)=>a-b);
  const hdrs=['TL / Agent',...hours.map(h=>fmtHour(h)+(h>=19?' ğŸŒ™':'')),'Total'];
  let h=`<thead><tr>${hdrs.map((x,i)=>`<th${i>0?' class="r"':''}>${x}</th>`).join('')}</tr></thead><tbody>`;
  for(const tl of getTLOrder()){
    const tlR=work.filter(r=>r._tl===tl);
    if(!tlR.length)continue;
    const cls=TL_CLS[tl]||'';
    h+=`<tr class="tl-hdr ${cls}"><td>${tl.toUpperCase()}</td>`;
    hours.forEach(hr=>{const c=(idx.byHour[hr]||[]).filter(r=>r._tl===tl).length;h+=`<td class="r">${c||'â€”'}</td>`;});
    h+=`<td class="r">${tlR.length}</td></tr>`;
    for(const ag of [...new Set(tlR.map(r=>r._agent))].sort()){
      const agR=idx.byAgent[ag]||[];
      h+=`<tr class="agent"><td style="padding-left:22px">â†³ ${ag}</td>`;
      hours.forEach(hr=>{const c=(idx.byAgentHour[ag+'|'+hr]||[]).length;h+=`<td class="r ${c===0?'zero':''}">${c===0?'â€”':c}</td>`;});
      h+=`<td class="r">${agR.length}</td></tr>`;
    }
  }
  h+=`<tr class="grand"><td>GRAND TOTAL</td>`;
  hours.forEach(hr=>{h+=`<td class="r">${(idx.byHour[hr]||[]).length}</td>`;});
  h+=`<td class="r">${work.length}</td></tr></tbody>`;
  document.getElementById('hourlyTbl').innerHTML=h;
}

function renderProc(work){
  const cols=['ID','Date','Time','Hour','TL','Agent','Duration','Feedback'];
  let h=`<thead><tr>${cols.map((c,i)=>`<th${i>5?' class="r"':''}>${c}</th>`).join('')}</tr></thead><tbody>`;
  work.slice(0,500).forEach(r=>{
    h+=`<tr class="agent">
      <td>${r.id||r.ID||''}</td>
      <td>${r.call_date||r.Date||''}</td>
      <td>${r._timeStr}</td>
      <td class="r">${r._hour!==null?r._hour:'â€”'}</td>
      <td>${r._tl}</td><td>${r._agent}</td>
      <td class="r">${hms(r._sec)}</td>
      <td class="r">${r.feedback||r.Feedback||'â€”'}</td></tr>`;
  });
  if(work.length>500)h+=`<tr><td colspan="8" style="text-align:center;padding:12px;color:var(--muted)">... ${work.length-500} aur rows Excel mein hain</td></tr>`;
  h+='</tbody>';
  document.getElementById('procTbl').innerHTML=h;
}

function switchTab(idx){
  document.querySelectorAll('.tab-btn').forEach((t,i)=>{
    t.classList.toggle('on',i===idx);
    if(i===idx){t.style.animation='none';t.offsetHeight;t.style.animation='';}
  });
  ['t0','t1','t2'].forEach((id,i)=>{
    const el=document.getElementById(id);
    el.style.display=i===idx?'block':'none';
    if(i===idx){el.style.animation='none';el.offsetHeight;el.style.animation='fadeUp .3s ease both';}
  });
}

// Animated number counter for KPI val elements
function animateCounters(){
  document.querySelectorAll('.kpi .val').forEach(el=>{
    const raw=el.textContent.trim();
    const num=parseFloat(raw.replace(/[^0-9.]/g,''));
    if(isNaN(num)||num===0) return;
    const isPercent=raw.includes('%');
    const hasComma=raw.includes(',');
    const hasDot=raw.includes('.');
    const decimals=hasDot?(raw.split('.')[1]?.replace('%','').length||1):0;
    const dur=800;
    const start=performance.now();
    const from=0;
    const fn=ts=>{
      const p=Math.min((ts-start)/dur,1);
      const ease=1-Math.pow(1-p,4); // ease out quart
      const cur=from+(num-from)*ease;
      let display=decimals>0?cur.toFixed(decimals):Math.round(cur).toLocaleString();
      el.textContent=display+(isPercent?'%':'');
      if(p<1) requestAnimationFrame(fn);
    };
    requestAnimationFrame(fn);
  });
}

function applyReportFilter(){
  // placeholder - TL filter removed from report toolbar
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADVANCED DASHBOARD FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _filteredWork = null;

function resetDashFilters(){
  document.getElementById('df-tl').value='';
  document.getElementById('df-risk').value='';
  document.getElementById('df-mincalls').value='0';
  document.getElementById('df-csat').value='';
  document.getElementById('df-hourFrom').value='';
  document.getElementById('df-hourTo').value='';
  document.getElementById('df-rc').value='';
  applyDashFilters();
}

function applyDashFilters(){
  if(!DATA) return;
  const tlF = document.getElementById('df-tl').value;
  const riskF = document.getElementById('df-risk').value;
  const minCalls = parseInt(document.getElementById('df-mincalls').value)||0;
  const csatMax = document.getElementById('df-csat').value !== '' ? parseFloat(document.getElementById('df-csat').value)/100 : null;
  const hourFrom = document.getElementById('df-hourFrom').value !== '' ? parseFloat(document.getElementById('df-hourFrom').value) : null;
  const hourTo = document.getElementById('df-hourTo').value !== '' ? parseFloat(document.getElementById('df-hourTo').value) : null;
  const rcF = document.getElementById('df-rc').value;

  let work = DATA.work;

  // TL filter
  if(tlF) work = work.filter(r => r._tl === tlF);

  // Hour range filter
  if(hourFrom !== null) work = work.filter(r => r._hour !== null && r._hour >= hourFrom);
  if(hourTo !== null) work = work.filter(r => r._hour !== null && r._hour <= hourTo);

  // Agent-level filters (min calls, csat, risk)
  if(riskF || minCalls > 0 || csatMax !== null) {
    const _fIdx = buildIndex(work);
    const riskMap = {};
    getAgentRiskMapIdx(DATA.work,[...new Set(DATA.work.map(r=>r._hour).filter(h=>h!==null))].sort((a,b)=>a-b),_dashIdx||buildIndex(DATA.work)).forEach(a => { riskMap[a.agent] = a; });
    const allowed = new Set(
      Object.keys(_fIdx.byAgent).filter(ag => {
        const agRows = _fIdx.byAgent[ag];
        if(agRows.length < minCalls) return false;
        const a = agg(agRows);
        if(csatMax !== null && (a.csat === null || a.csat >= csatMax)) return false;
        if(riskF && riskMap[ag]?.risk !== riskF) return false;
        return true;
      })
    );
    work = work.filter(r => allowed.has(r._agent));
  }

  // Root cause filter (affects drop table only, stored separately)
  _filteredWork = work;
  _filterRC = rcF;

  document.getElementById('df-count').textContent = `${work.length} calls â€¢ ${[...new Set(work.map(r=>r._agent))].length} agents`;

  buildDashboardWithWork(work, rcF);
}

let _filterRC = '';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CSET INTELLIGENCE DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildDashboard(){
  if(!DATA){document.getElementById('dashEmpty').style.display='block';document.getElementById('dashContent').style.display='none';document.getElementById('dashFilters').style.display='none';return;}
  document.getElementById('dashEmpty').style.display='none';
  document.getElementById('dashContent').style.display='block';
  document.getElementById('dashFilters').style.display='block';

  // Populate TL filter
  const tlSel = document.getElementById('df-tl');
  const curTL = tlSel.value;
  tlSel.innerHTML = '<option value="">All TLs</option>' + getTLOrder().map(t=>`<option value="${t}"${t===curTL?' selected':''}>${t}</option>`).join('');
  initTipsFilters();
  buildDashboardWithWork(DATA.work, '');
}

function buildIndex(work){
  // Pre-build indexes for O(1) lookups instead of O(n) filter every time
  const byAgent = {};  // agent -> rows[]
  const byAgentHour = {}; // agent|hour -> rows[]
  const byHour = {}; // hour -> rows[]
  for(const r of work){
    if(!byAgent[r._agent]) byAgent[r._agent]=[];
    byAgent[r._agent].push(r);
    const ahKey = r._agent+'|'+r._hour;
    if(!byAgentHour[ahKey]) byAgentHour[ahKey]=[];
    byAgentHour[ahKey].push(r);
    if(r._hour!==null){
      if(!byHour[r._hour]) byHour[r._hour]=[];
      byHour[r._hour].push(r);
    }
  }
  return {byAgent, byAgentHour, byHour};
}

let _dashIdx = null; // cached index

function buildDashboardWithWork(work, rcFilter){
  // Show loading indicator
  document.getElementById('dashContent').style.opacity='0.4';

  setTimeout(()=>{
    // Build index once
    _dashIdx = buildIndex(work);
    const idx = _dashIdx;
    const g=agg(work);
    const hours=[...new Set(work.map(r=>r._hour).filter(h=>h!==null))].sort((a,b)=>a-b);

    // KPIs first (fast)
    document.getElementById('kpiGrid').innerHTML=`
      <div class="kpi blue" style="animation:kpiPop .5s .0s cubic-bezier(.34,1.56,.64,1) both"><div class="lbl">Total Calls</div><div class="val">${g.n.toLocaleString()}</div><div class="sub">Final processed</div><div class="trend">ğŸ“</div></div>
      <div class="kpi ${g.csat!==null&&g.csat<0.85?'red':'green'}" style="animation:kpiPop .5s .08s cubic-bezier(.34,1.56,.64,1) both"><div class="lbl">Overall CSET</div><div class="val">${pct(g.csat)}</div><div class="sub">${g.resp} responses</div><div class="trend">${g.csat!==null&&g.csat<0.85?'ğŸ”´':'ğŸŸ¢'}</div></div>
      <div class="kpi orange" style="animation:kpiPop .5s .16s cubic-bezier(.34,1.56,.64,1) both"><div class="lbl">Survey%</div><div class="val">${pct(g.surv)}</div><div class="sub">${g.n} calls</div><div class="trend">ğŸ“‹</div></div>
      <div class="kpi green" style="animation:kpiPop .5s .24s cubic-bezier(.34,1.56,.64,1) both"><div class="lbl">Drop Hours</div><div class="val" id="kpiDropVal">...</div><div class="sub">Across all agents</div><div class="trend">â³</div></div>
      <div class="kpi green" style="animation:kpiPop .5s .32s cubic-bezier(.34,1.56,.64,1) both"><div class="lbl">High Risk Agents</div><div class="val" id="kpiRiskVal">...</div><div class="sub">Need attention</div><div class="trend">â³</div></div>`;

    document.getElementById('dashContent').style.opacity='1';
    setTimeout(animateCounters, 100);

    // Render sections progressively with yields between each
    setTimeout(()=>{
      const dropHours=computeDropHoursIdx(work, hours, idx);
      const totalDrops=dropHours.filter(d=>d.isMajor||d.isDrop).length;
      const kpiDrop=document.getElementById('kpiDropVal')||{innerHTML:''};
      if(kpiDrop){kpiDrop.textContent=totalDrops;kpiDrop.closest('.kpi').className=`kpi ${totalDrops>3?'red':totalDrops>0?'orange':'green'}`;}

      renderDropTable(work, hours, dropHours, rcFilter);

      setTimeout(()=>{
        const riskMap = getAgentRiskMapIdx(work, hours, idx);
        const highRisk=riskMap.filter(a=>a.risk==='HIGH').length;
        const kpiRisk=document.getElementById('kpiRiskVal')||{innerHTML:''};
        if(kpiRisk){kpiRisk.textContent=highRisk;kpiRisk.closest('.kpi').className=`kpi ${highRisk>0?'red':'green'}`;}

        renderRiskCardsIdx(work, riskMap);
        renderRCChart(work, hours, dropHours);

        setTimeout(()=>{
          renderHeatmapIdx(work, hours, 'heatmapWrap', idx);
          renderWorstHourIdx(work, hours, idx);

          setTimeout(()=>{
            initTipsFilters();
            renderAgentTips();
          }, 30);
        }, 30);
      }, 30);
    }, 30);
  }, 20);
}

function computeDropHours(work, hours){
  return computeDropHoursIdx(work, hours, buildIndex(work));
}
function computeDropHoursIdx(work, hours, idx){
  const agents=Object.keys(idx.byAgent);
  const drops=[];
  for(const ag of agents){
    const agRows=idx.byAgent[ag];
    const tl=agRows[0]._tl;
    for(let i=1;i<hours.length;i++){
      const hr=hours[i],prev=hours[i-1];
      const cur=idx.byAgentHour[ag+'|'+hr]||[];
      const prv=idx.byAgentHour[ag+'|'+prev]||[];
      if(!cur.length||!prv.length)continue;
      const curA=agg(cur),prvA=agg(prv);
      if(curA.csat===null||prvA.csat===null)continue;
      const delta=curA.csat-prvA.csat;
      const isDrop=delta<0;
      const isMajor=delta<-0.05;
      const aht=curA.secs/cur.length;
      const rootCause=detectRootCause(curA,prvA,cur,aht);
      drops.push({agent:ag,tl,hr,prev,cur:curA,prv:prvA,delta,isDrop,isMajor,rootCause,rows:cur});
    }
  }
  return drops;
}

function detectRootCause(cur,prv,rows,aht){
  const badFb=(cur.fb21+cur.fb22+cur.fb23+cur.fb2N);
  if(aht>600)return'â± AHT Spike';
  if(cur.resp<3)return'ğŸ“‰ Low Survey Volume';
  if(badFb>cur.resp*0.5&&cur.resp>0)return'âŒ High Bad Survey';
  if(rows.length>20)return'ğŸ“ High Call Load';
  if(cur.csat!==null&&cur.csat<0.6)return'âš  Critical Drop';
  return'â†• Natural Variation';
}

function getAgentRiskMap(work){
  return getAgentRiskMapIdx(work, [...new Set(work.map(r=>r._hour).filter(h=>h!==null))].sort((a,b)=>a-b), buildIndex(work));
}
function getAgentRiskMapIdx(work, hours, idx){
  return Object.keys(idx.byAgent).map(ag=>{
    const agRows=idx.byAgent[ag];
    const agHours=[...new Set(agRows.map(r=>r._hour).filter(h=>h!==null))].sort((a,b)=>a-b);
    let dropCount=0;
    for(let i=1;i<agHours.length;i++){
      const cur=agg(idx.byAgentHour[ag+'|'+agHours[i]]||[]);
      const prv=agg(idx.byAgentHour[ag+'|'+agHours[i-1]]||[]);
      if(cur.csat!==null&&prv.csat!==null&&cur.csat<prv.csat)dropCount++;
    }
    const tot=agg(agRows);
    const risk=dropCount>=3?'HIGH':dropCount>=1?'WARN':'STABLE';
    const tl=agRows[0]?._tl||'';
    return{agent:ag,tl,dropCount,risk,tot};
  }).sort((a,b)=>b.dropCount-a.dropCount);
}

function renderDropTable(work,hours,dropHours,rcFilter){
  let filtered = dropHours.filter(d=>d.isDrop||d.isMajor);
  if(rcFilter) filtered = filtered.filter(d => d.rootCause === rcFilter);
  const agents=[...new Set(work.map(r=>r._agent))].sort();
  let h=`<thead><tr>
    <th>Agent</th><th>TL</th><th class="r">Hour</th><th class="r">Prev CSET</th>
    <th class="r">Curr CSET</th><th class="r">Drop %</th><th>Status</th>
    <th class="r">AHT</th><th>Root Cause</th></tr></thead><tbody>`;

  if(!filtered.length){h+='<tr><td colspan="9" style="text-align:center;padding:20px;color:var(--muted)">âœ… Koi significant drop nahi mili is data mein</td></tr>';
  } else {
    filtered.sort((a,b)=>a.delta-b.delta).forEach(d=>{
      const cls=d.isMajor?'drop-major':d.isDrop?'drop-minor':'';
      const statusBadge=d.isMajor?'<span class="sb sb-red">ğŸ”´ MAJOR DROP</span>':'<span class="sb sb-orange">ğŸŸ  DROP</span>';
      const aht=d.rows.reduce((s,r)=>s+r._sec,0)/d.rows.length;
      h+=`<tr><td><strong>${d.agent}</strong></td>
        <td><span class="tl-badge tl-${(TL_CLS[d.tl]||'rk')}">${d.tl}</span></td>
        <td class="r ${cls}">${fmtHour(d.hr)}</td>
        <td class="r">${pct(d.prv.csat)}</td>
        <td class="r ${cls}">${pct(d.cur.csat)}</td>
        <td class="r ${cls}">${d.delta>=0?'+':''}${Math.round(d.delta*100)}%</td>
        <td>${statusBadge}</td>
        <td class="r ${aht>600?'warn':''}">${fmtAcht(aht)}</td>
        <td style="font-size:11px">${d.rootCause}</td></tr>`;
    });
  }
  h+='</tbody>';
  document.getElementById('dropTbl').innerHTML=h;
}

function renderRiskCards(work){ renderRiskCardsIdx(work, getAgentRiskMap(work)); }
function renderRiskCardsIdx(work, riskMap){
  const risks=getAgentRiskMap(work);
  const container=document.getElementById('riskGrid');
  container.innerHTML=risks.slice(0,9).map(({agent,tl,dropCount,risk,tot})=>{
    const cls=risk==='HIGH'?'high':risk==='WARN'?'warn':'stable';
    const icon=risk==='HIGH'?'ğŸ”´':risk==='WARN'?'ğŸŸ¡':'ğŸŸ¢';
    const badge=risk==='HIGH'?'<span class="sb sb-red">HIGH RISK</span>':risk==='WARN'?'<span class="sb sb-orange">WARNING</span>':'<span class="sb sb-green">STABLE</span>';
    return`<div class="risk-card ${cls}">
      <div class="rc-status">${icon}</div>
      <div class="rc-name">${agent}</div>
      <div class="rc-tl"><span class="tl-badge tl-${TL_CLS[tl]||'rk'}">${tl}</span></div>
      <div style="margin-bottom:8px">${badge}</div>
      <div class="rc-stats">
        <div class="rcs"><div class="rcs-val" style="color:${risk==='HIGH'?'var(--red)':risk==='WARN'?'var(--orange)':'var(--green)'}">${dropCount}</div><div class="rcs-lbl">Drop Hrs</div></div>
        <div class="rcs"><div class="rcs-val">${tot.n}</div><div class="rcs-lbl">Calls</div></div>
        <div class="rcs"><div class="rcs-val ${tot.csat!==null&&tot.csat<0.85?'warn':'good'}">${pct(tot.csat,1)}</div><div class="rcs-lbl">CSET</div></div>
      </div></div>`;
  }).join('');
}

function renderRCChart(work,hours,dropHours){
  const causes={};
  dropHours.filter(d=>d.isDrop||d.isMajor).forEach(d=>{causes[d.rootCause]=(causes[d.rootCause]||0)+1;});
  const sorted=Object.entries(causes).sort((a,b)=>b[1]-a[1]);
  const max=sorted[0]?.[1]||1;
  const colors=['var(--red)','var(--orange)','var(--yellow)','var(--blue)','var(--purple)','var(--green)'];
  const container=document.getElementById('rcChart');
  if(!sorted.length){container.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)">âœ… Koi drops nahi mili</div>';return;}
  container.innerHTML=sorted.map(([cause,cnt],i)=>`
    <div class="rc-bar">
      <div class="rc-label">${cause}</div>
      <div class="rc-track"><div class="rc-fill" style="width:${(cnt/max*100).toFixed(0)}%;background:${colors[i%colors.length]}"></div></div>
      <div class="rc-count">${cnt}</div>
    </div>`).join('');
}

function renderHeatmap(work,hours,containerId){
  renderHeatmapIdx(work,hours,containerId,buildIndex(work));
}
function renderHeatmapIdx(work,hours,containerId,idx){
  const agents=Object.keys(idx.byAgent).sort();
  let h='<table><thead><tr><th>Agent</th>';
  hours.forEach(hr=>h+=`<th>${fmtHour(hr)}</th>`);
  h+='<th>Avg</th></tr></thead><tbody>';
  agents.forEach(ag=>{
    const agRows=idx.byAgent[ag];
    const tl=agRows[0]?._tl||'';
    h+=`<tr><td>${ag}<br><span style="font-size:9px;color:var(--muted)">${tl}</span></td>`;
    const csats=[];
    hours.forEach(hr=>{
      const hr_rows=idx.byAgentHour[ag+'|'+hr]||[];
      if(!hr_rows.length){h+='<td class="hm-na">â€”</td>';return;}
      const a=agg(hr_rows);
      if(a.csat===null){h+='<td class="hm-na">N/A</td>';return;}
      csats.push(a.csat);
      const bg=a.csat<0.7?'rgba(239,68,68,.35)':a.csat<0.85?'rgba(249,115,22,.3)':a.csat<0.95?'rgba(234,179,8,.25)':'rgba(16,185,129,.25)';
      const col=a.csat<0.7?'#fca5a5':a.csat<0.85?'#fdba74':a.csat<0.95?'#fde047':'#6ee7b7';
      h+=`<td style="background:${bg};color:${col}">${Math.round(a.csat*100)}%</td>`;
    });
    const avg=csats.length?csats.reduce((a,b)=>a+b,0)/csats.length:null;
    h+=`<td style="font-weight:700">${avg!==null?pct(avg):'â€”'}</td></tr>`;
  });
  h+='</tbody></table>';
  document.getElementById(containerId).innerHTML=h;
}

function renderWorstHour(work,hours){ renderWorstHourIdx(work,hours,buildIndex(work)); }
function renderWorstHourIdx(work,hours,idx){
  let h=`<thead><tr><th>Hour</th><th class="r">Total Calls</th><th class="r">Avg CSET</th>
    <th class="r">Drop Agents</th><th class="r">Avg AHT</th><th>Risk Level</th><th>Note</th></tr></thead><tbody>`;
  hours.forEach(hr=>{
    const hrRows=idx.byHour[hr]||[];
    if(!hrRows.length)return;
    const a=agg(hrRows);
    // Use index for drop detection
    const agents=[...new Set(hrRows.map(r=>r._agent))];
    let uniqueDropAgents=0;
    for(const ag of agents){
      const cur=agg(idx.byAgentHour[ag+'|'+hr]||[]);
      const prv=agg(idx.byAgentHour[ag+'|'+(hr-1)]||[]);
      if(cur.csat!==null&&prv.csat!==null&&cur.csat<prv.csat) uniqueDropAgents++;
    }
    const avgAht=a.n>0?a.secs/a.n:0;
    const risk=uniqueDropAgents>=3?'<span class="sb sb-red">CRITICAL</span>':uniqueDropAgents>=1?'<span class="sb sb-orange">WATCH</span>':'<span class="sb sb-green">NORMAL</span>';
    const note=avgAht>600?'â± High AHT Zone':a.csat!==null&&a.csat<0.85?'ğŸ“‰ CSET Alert':'âœ… OK';
    h+=`<tr><td><strong>${fmtHour(hr)}</strong></td>
      <td class="r">${a.n}</td>
      <td class="r ${a.csat!==null&&a.csat<0.85?'warn':'good'}">${pct(a.csat)}</td>
      <td class="r">${uniqueDropAgents}</td>
      <td class="r ${avgAht>600?'warn':''}">${fmtAcht(avgAht)}</td>
      <td>${risk}</td><td style="font-size:11px">${note}</td></tr>`;
  });
  h+='</tbody>';
  document.getElementById('worstHourTbl').innerHTML=h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AGENT TIPS ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAgentTips(){
  if(!DATA) return;
  const T = getTargets();
  const tlF = document.getElementById('tipsTLFilter').value;
  const focusF = document.getElementById('tipsFocusFilter').value;

  let work = DATA.work;
  if(tlF) work = work.filter(r=>r._tl===tlF);

  const _tIdx = _dashIdx || buildIndex(DATA.work);
  const riskMap = {};
  getAgentRiskMapIdx(DATA.work, [...new Set(DATA.work.map(r=>r._hour).filter(h=>h!==null))].sort((a,b)=>a-b), _tIdx).forEach(a=>{ riskMap[a.agent]=a; });
  const _wIdx = buildIndex(work);
  const agents = Object.keys(_wIdx.byAgent);

  // Build per-agent tip data
  const tips = agents.map(ag=>{
    const agRows = _wIdx.byAgent[ag]||[];
    const a = agg(agRows);
    const tl = agRows[0]?._tl||'';
    const risk = riskMap[ag] || {dropCount:0,risk:'STABLE'};

    // Score issues
    const issues = [];
    const csatRatio = a.csat!==null ? a.csat/T.csat : null;
    const survRatio = a.surv/T.surv;
    const achtRatio = a.avgSec>0 ? a.avgSec/T.achtSec : null;

    if(csatRatio!==null && csatRatio<1) issues.push({type:'csat', severity: csatRatio<0.90?'critical':csatRatio<0.95?'warn':'watch', val:a.csat});
    if(survRatio<1) issues.push({type:'surv', severity: survRatio<0.70?'critical':survRatio<0.85?'warn':'watch', val:a.surv});
    if(achtRatio!==null && achtRatio>1) issues.push({type:'acht', severity: achtRatio>1.2?'critical':achtRatio>1.1?'warn':'watch', val:a.avgSec});
    if(risk.dropCount>=2) issues.push({type:'drop', severity: risk.dropCount>=3?'critical':'warn', val:risk.dropCount});

    // Filter
    if(focusF && !issues.some(i=>i.type===focusF)) return null;
    if(!focusF && issues.length===0) return null; // hide perfect agents unless filter set

    const priority = issues.some(i=>i.severity==='critical')?'CRITICAL'
      :issues.some(i=>i.severity==='warn')?'WARN'
      :issues.length>0?'WATCH':'GOOD';

    return {ag, tl, a, issues, priority, risk, csatRatio, survRatio, achtRatio};
  }).filter(Boolean);

  // Sort: critical first, then by number of issues
  const sortOrder = {CRITICAL:0,WARN:1,WATCH:2,GOOD:3};
  tips.sort((a,b)=>sortOrder[a.priority]-sortOrder[b.priority]||b.issues.length-a.issues.length);

  const container = document.getElementById('agentTipsGrid');
  if(!tips.length){
    container.innerHTML=`<div class="tip-no-data">âœ… ${focusF?'Is category mein':'Sab'} agents targets ke andar hain!</div>`;
    return;
  }

  container.innerHTML = tips.map((t,idx)=>{
    const cardCls = t.priority==='CRITICAL'?'tc-red':t.priority==='WARN'?'tc-orange':t.priority==='WATCH'?'tc-yellow':'tc-green';
    const priCls = t.priority==='CRITICAL'?'tp-critical':t.priority==='WARN'?'tp-warn':t.priority==='WATCH'?'tp-watch':'tp-good';
    const cls = TL_CLS[t.tl]||'rk';
    const delay = (idx%12)*0.04;

    // Generate specific tips
    const tipLines = [];

    if(t.a.csat!==null && t.csatRatio<1){
      const gap = Math.round((T.csat - t.a.csat)*100);
      const need = t.a.resp>0 ? Math.ceil(T.csat*t.a.resp - t.a.fb1) : '?';
      tipLines.push(`<strong>CSET ${pct(t.a.csat)} â†’ Target ${T.csatPct}%</strong> â€” ${gap}% gap. ${t.a.resp>5?`Approx ${Math.max(0,Math.ceil(T.csat*t.a.resp - t.a.fb1))} aur Rating 1 chahiye.`:''} Call recording review karo.`);
      if(t.a.fb21>0||t.a.fb22>0||t.a.fb23>0) tipLines.push(`Bad ratings: <strong>2,1=${t.a.fb21} Â· 2,2=${t.a.fb22} Â· 2,3=${t.a.fb23}</strong> â€” specific pain points identify karo.`);
    }

    if(t.survRatio<1){
      const gap = Math.round((T.surv - t.a.surv)*100);
      tipLines.push(`<strong>Survey% ${pct(t.a.surv)} â†’ Target ${T.survPct}%</strong> â€” ${gap}% gap. Call ke end mein survey script push karo consistently.`);
      if(t.a.n>0) tipLines.push(`${t.a.n} calls mein se sirf <strong>${t.a.resp} response</strong> mili â€” har call pe survey reminder dena zaroori.`);
    }

    if(t.achtRatio!==null && t.achtRatio>1){
      const overBy = Math.round((t.a.avgSec - T.achtSec));
      tipLines.push(`<strong>ACHT ${hms(t.a.avgSec)} â†’ Target ${T.achtStr}</strong> â€” ${overBy}s zyada. Script compress karo, unnecessary hold avoid karo.`);
    }

    if(t.risk.dropCount>=2){
      tipLines.push(`<strong>${t.risk.dropCount} CSET drop hours</strong> detected â€” kisi specific ghante mein performance girta hai. Hourly tab mein dekho.`);
    }

    if(tipLines.length===0) tipLines.push('Performance sahi hai. Regular monitoring jaari rakho.');

    return `<div class="tip-card ${cardCls}" style="animation-delay:${delay}s">
      <div class="tip-header">
        <div>
          <div class="tip-agent">${t.ag}</div>
          <div class="tip-tl"><span class="tl-badge tl-${cls}">${t.tl}</span> Â· ${t.a.n} calls</div>
        </div>
        <div class="tip-priority ${priCls}">${t.priority==='CRITICAL'?'ğŸ”´ CRITICAL':t.priority==='WARN'?'ğŸŸ  WARN':t.priority==='WATCH'?'ğŸŸ¡ WATCH':'ğŸŸ¢ GOOD'}</div>
      </div>
      <div class="tip-metrics">
        <div class="tip-metric">
          <div class="tm-val" style="color:${t.a.csat===null?'var(--muted)':t.csatRatio>=1?'var(--green)':t.csatRatio>=0.95?'var(--yellow)':t.csatRatio>=0.90?'var(--orange)':'var(--red)'}">${t.a.csat!==null?pct(t.a.csat):'N/A'}</div>
          <div class="tm-lbl">CSET</div>
        </div>
        <div class="tip-metric">
          <div class="tm-val" style="color:${t.survRatio>=1?'var(--green)':t.survRatio>=0.85?'var(--yellow)':'var(--orange)'}">${pct(t.a.surv)}</div>
          <div class="tm-lbl">Survey%</div>
        </div>
        <div class="tip-metric">
          <div class="tm-val" style="color:${t.achtRatio===null||t.achtRatio<=1?'var(--green)':t.achtRatio<=1.1?'var(--yellow)':t.achtRatio<=1.2?'var(--orange)':'var(--red)'}">${hms(t.a.avgSec)}</div>
          <div class="tm-lbl">ACHT</div>
        </div>
        <div class="tip-metric">
          <div class="tm-val" style="color:${t.risk.dropCount>=3?'var(--red)':t.risk.dropCount>=1?'var(--orange)':'var(--green)'}">${t.risk.dropCount}</div>
          <div class="tm-lbl">Drops</div>
        </div>
      </div>
      <ul class="tip-list">
        ${tipLines.map(l=>`<li><span class="tip-bullet"></span><span>${l}</span></li>`).join('')}
      </ul>
    </div>`;
  }).join('');
}

// Populate tips TL filter and render
function initTipsFilters(){
  const sel = document.getElementById('tipsTLFilter');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">All TLs</option>' + getTLOrder().map(t=>`<option value="${t}"${t===cur?' selected':''}>${t}</option>`).join('');
}
let agentsData={...MASTER};

function renderTLCards(){
  const tls=getTLOrder();
  const el=document.getElementById('tlCards');
  if(!el) return;
  el.innerHTML=tls.map(tl=>{
    const count=Object.values(agentsData).filter(v=>normTL(v[1])===tl).length;
    const cls=TL_CLS[tl]||'rk';
    const clr=TL_COLOR_MAP[tl]||'#3b82f6';
    return`<div class="kpi" style="border-top:2px solid ${clr}">
      <div class="lbl">${tl}</div>
      <div class="val" style="color:${clr}">${count}</div>
      <div class="sub">agents</div>
    </div>`;
  }).join('');
}

function renderAgents(){
  const q=document.getElementById('agentSearch').value.toLowerCase();
  const filterTL=document.getElementById('filterTL').value;
  const entries=Object.entries(agentsData).filter(([num,[name,tl]])=>{
    const match=!q||(num.toLowerCase().includes(q)||name.toLowerCase().includes(q)||tl.toLowerCase().includes(q));
    const tlMatch=!filterTL||normTL(tl)===filterTL;
    return match&&tlMatch;
  });
  const total=Object.keys(agentsData).length;
  const _tab=document.getElementById('totalAgentBadge');
  const _ac=document.getElementById('agentCount');
  if(_tab) _tab.textContent=`${total} agents`;
  if(_ac) _ac.textContent=`${total} agents`;

  const tbody=document.getElementById('agentsTbody');
  tbody.innerHTML=entries.map(([num,[name,tl]],i)=>{
    const cls=TL_CLS[normTL(tl)]||'rk';
    const safeNum=num.replace(/'/g,"\'");
    return`<tr id="row_${i}">
      <td style="color:var(--muted);font-size:11px">${i+1}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted2)">${num}</td>
      <td>
        <input value="${name}" 
          style="background:transparent;border:none;border-bottom:1px solid transparent;color:var(--text);font-weight:700;font-size:12px;font-family:'Syne',sans-serif;width:100%;padding:2px 4px;border-radius:0;transition:border-color .2s"
          onfocus="this.style.borderBottomColor='var(--blue)';this.style.background='var(--card2)'"
          onblur="this.style.borderBottomColor='transparent';this.style.background='transparent';changeAgentName('${safeNum}',this.value)"
          title="Click karke naam edit karo">
      </td>
      <td><span class="tl-badge tl-${cls}">${tl}</span></td>
      <td style="display:flex;gap:6px;align-items:center">
        <select style="background:var(--card2);border:1px solid var(--border2);border-radius:5px;padding:3px 6px;color:var(--text);font-size:11px;font-family:'Syne',sans-serif" onchange="changeTL('${safeNum}',this.value)">
          ${getTLOrder().map(t=>`<option value="${t}"${normTL(t)===normTL(tl)?' selected':''}>${t}</option>`).join('')}
        </select>
        <button class="btn btn-danger btn-sm" onclick="deleteAgent('${safeNum}')">âœ•</button>
      </td></tr>`;
  }).join('');

  // Update TL filter dropdown
  const fd=document.getElementById('filterTL');
  const cur=fd.value;
  fd.innerHTML='<option value="">All TLs</option>'+getTLOrder().map(t=>`<option value="${t}"${t===cur?' selected':''}>${t}</option>`).join('');
  if(cur)fd.value=cur;

  // Update TL select in form
  const inp=document.getElementById('inp-tl');
  inp.innerHTML=getTLOrder().map(t=>`<option value="${t}">${t}</option>`).join('');
}

function changeAgentName(num, newName){
  newName = newName.trim();
  if(!newName || !agentsData[num]) return;
  const oldName = agentsData[num][0];
  if(oldName === newName) return;
  agentsData[num][0] = newName;
  MASTER[num][0] = newName;
  // Update all other numbers mapped to same old name (same agent, multiple numbers)
  let sameCount = 0;
  for(const [k,v] of Object.entries(agentsData)){
    if(k !== num && v[0] === oldName){ v[0]=newName; if(MASTER[k]) MASTER[k][0]=newName; sameCount++; }
  }
  // Auto-save
  try{ const s=JSON.parse(localStorage.getItem('livsmart_agents')||'{}'); 
    for(const [k,v] of Object.entries(agentsData)) s[k]=v;
    localStorage.setItem('livsmart_agents',JSON.stringify(s)); }catch(e){}
  const msg = sameCount > 0 
    ? `âœ… "${oldName}" â†’ "${newName}" (${sameCount+1} numbers update hue)`
    : `âœ… "${oldName}" â†’ "${newName}" saved!`;
  showAlert('saveAlert', msg);
  renderAgents(); renderTLCards();
}

function addAgent(){
  const num=document.getElementById('inp-num').value.trim();
  const name=document.getElementById('inp-name').value.trim();
  const tl=document.getElementById('inp-tl').value;
  if(!num||!name){alert('Number aur Name dono bharo!');return;}
  const key=normAgNum(num);

  // Case 1: Number pehle se exist karta hai
  if(agentsData[key]){
    const existing=agentsData[key];
    const isSameName = existing[0].toLowerCase()===name.toLowerCase();
    if(isSameName){
      // Sirf TL update karo
      if(existing[1]!==tl){
        const confirmMsg=`"${name}" pehle se ${existing[1]} mein hai.\nKya TL change karke ${tl} karna hai?`;
        if(!confirm(confirmMsg)) return;
        agentsData[key][1]=tl; MASTER[key][1]=tl;
        try{ const s=JSON.parse(localStorage.getItem('livsmart_agents')||'{}'); s[key]=[name,tl]; localStorage.setItem('livsmart_agents',JSON.stringify(s)); }catch(e){}
        renderAgents();renderTLCards();
        showAlert('saveAlert',`âœ… "${name}" ka TL update ho gaya: ${existing[1]} â†’ ${tl}`);
      } else {
        showAlert('saveAlert',`â„¹ï¸ "${name}" (${key}) pehle se exist karta hai â€” koi change nahi.`);
      }
      return;
    } else {
      // Same number, alag naam â€” confirm update
      if(!confirm(`âš ï¸ Yeh number pehle se "${existing[0]}" (${existing[1]}) ke liye mapped hai.\nKya naam badal kar "${name}" karna hai?`)) return;
    }
  }

  // Case 2: Naam pehle se kisi aur number pe exist karta hai (multiple numbers, same agent)
  const existingNums = Object.entries(agentsData).filter(([k,[n]])=>n.toLowerCase()===name.toLowerCase() && k!==key);
  if(existingNums.length > 0){
    const numList = existingNums.map(([k])=>k).join(', ');
    const msg=`"${name}" pehle se in numbers pe mapped hai:\n${numList}\n\nKya yeh same agent ka naaya number add karna hai?`;
    if(!confirm(msg)) return;
    // It's the same agent â€” add this as additional number
  }

  agentsData[key]=[name,tl];
  MASTER[key]=[name,tl];
  try{ const s=JSON.parse(localStorage.getItem('livsmart_agents')||'{}'); s[key]=[name,tl]; localStorage.setItem('livsmart_agents',JSON.stringify(s)); }catch(e){}
  document.getElementById('inp-num').value='';
  document.getElementById('inp-name').value='';
  renderAgents();renderTLCards();

  const dupNote = existingNums.length>0 ? ` (+${existingNums.length} aur number bhi mapped)` : '';
  showAlert('saveAlert',`âœ… "${name}" add ho gaya!${dupNote} (Auto-saved)`);
}

function showAddTL(){document.getElementById('addTLRow').style.display='block';}

function addTL(){
  const name=document.getElementById('inp-tl-name').value.trim();
  const color=document.getElementById('inp-tl-color').value;
  if(!name){alert('TL name bharo!');return;}
  if(TL_LIST.includes(name)){alert('Yeh TL already hai!');return;}
  TL_LIST.push(name);
  TL_CLS[name]=color==='blue'?'rk':color==='green'?'ro':color==='orange'?'ya':color==='purple'?'at':'rk';
  TL_COLOR_MAP[name]=color==='blue'?'#3b82f6':color==='green'?'#10b981':color==='orange'?'#f97316':color==='purple'?'#8b5cf6':'#ec4899';
  document.getElementById('inp-tl-name').value='';
  document.getElementById('addTLRow').style.display='none';
  renderAgents();renderTLCards();
  showAlert('saveAlert',`âœ… TL "${name}" add ho gaya!`);
}

function deleteAgent(num){
  const name=agentsData[num]?.[0]||num;
  if(confirm(`"${name}" ko delete karna chahte ho?`)){
    delete agentsData[num];delete MASTER[num];
    try{ const s=JSON.parse(localStorage.getItem('livsmart_agents')||'{}'); delete s[num]; localStorage.setItem('livsmart_agents',JSON.stringify(s)); }catch(e){}
    renderAgents();renderTLCards();
  }
}
function changeTL(num,tl){if(!agentsData[num])return;agentsData[num][1]=tl;MASTER[num][1]=tl;try{const s=JSON.parse(localStorage.getItem('livsmart_agents')||'{}');s[num]=[agentsData[num][0],tl];localStorage.setItem('livsmart_agents',JSON.stringify(s));}catch(e){}renderAgents();renderTLCards();showAlert('saveAlert','âœ… TL updated!');}

function saveAgents(){
  localStorage.setItem('livsmart_agents',JSON.stringify(agentsData));
  showAlert('saveAlert',`âœ… ${Object.keys(agentsData).length} agents saved!`);
}

function exportAgents(){
  const blob=new Blob([JSON.stringify(agentsData,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='livsmart_agents.json';a.click();
}

function importAgents(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      agentsData={...agentsData,...data};
      Object.assign(MASTER,data);
      renderAgents();renderTLCards();
      showAlert('saveAlert',`âœ… ${Object.keys(data).length} agents import ho gaye!`);
    }catch(err){alert('Invalid JSON file!');}
  };
  reader.readAsText(file);
  input.value='';
}

function showAlert(id,msg,dur=3000){
  const el=document.getElementById(id);
  el.textContent=msg;el.style.display='block';
  setTimeout(()=>el.style.display='none',dur);
}

// Load saved agents
try{const s=localStorage.getItem('livsmart_agents');if(s){const d=JSON.parse(s);agentsData={...agentsData,...d};Object.assign(MASTER,d);}}catch(e){}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MANAGER VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildManager(){
  if(!DATA){document.getElementById('mgrEmpty').style.display='block';document.getElementById('mgrContent').style.display='none';return;}
  document.getElementById('mgrEmpty').style.display='none';
  document.getElementById('mgrContent').style.display='block';
  const{work}=DATA;
  const hours=[...new Set(work.map(r=>r._hour).filter(h=>h!==null))].sort((a,b)=>a-b);

  // TL Performance Table
  let h=`<thead><tr>
    <th>TL</th><th class="r">Total Calls</th><th class="r">Rating 1</th><th class="r">Response</th>
    <th class="r">CSET%</th><th class="r">Survey%</th><th class="r">Avg AHT</th>
    <th class="r">Drop Agents</th><th>Risk</th><th class="r">Volatility</th></tr></thead><tbody>`;
  for(const tl of getTLOrder()){
    const tlR=work.filter(r=>r._tl===tl);if(!tlR.length)continue;
    const t=agg(tlR);
    const cls=TL_CLS[tl]||'rk';
    // Volatility = stddev of agent CSATs
    const agCSATs=[];
    [...new Set(tlR.map(r=>r._agent))].forEach(ag=>{
      const a=agg(tlR.filter(r=>r._agent===ag));
      if(a.csat!==null)agCSATs.push(a.csat);
    });
    const volt=agCSATs.length>1?Math.sqrt(agCSATs.reduce((s,v)=>{const m=agCSATs.reduce((a,b)=>a+b,0)/agCSATs.length;return s+(v-m)**2;},0)/agCSATs.length):0;
    const dropAgents=[...new Set(tlR.map(r=>r._agent))].filter(ag=>{
      const agR=tlR.filter(r=>r._agent===ag);
      const agHours=[...new Set(agR.map(r=>r._hour).filter(h=>h!==null))].sort((a,b)=>a-b);
      for(let i=1;i<agHours.length;i++){
        const c=agg(agR.filter(r=>r._hour===agHours[i]));
        const p=agg(agR.filter(r=>r._hour===agHours[i-1]));
        if(c.csat!==null&&p.csat!==null&&c.csat<p.csat)return true;
      }return false;
    }).length;
    const risk=t.csat!==null&&t.csat<0.85?'<span class="sb sb-red">CRITICAL</span>':t.csat!==null&&t.csat<0.90?'<span class="sb sb-orange">AT RISK</span>':'<span class="sb sb-green">GOOD</span>';
    h+=`<tr class="tl-hdr ${cls}">
      <td>${tl}</td><td class="r">${t.n}</td><td class="r">${t.fb1}</td><td class="r">${t.resp}</td>
      <td class="r ${t.csat!==null&&t.csat<0.85?'warn':'good'}">${pct(t.csat)}</td>
      <td class="r ${t.surv<0.10?'surv-warn':''}">${pct(t.surv)}</td>
      <td class="r">${fmtAcht(t.avgSec)}</td>
      <td class="r">${dropAgents}</td><td>${risk}</td>
      <td class="r ${volt>0.15?'warn':''}">${volt.toFixed(3)}</td></tr>`;
  }
  const g=agg(work);
  h+=`<tr class="grand"><td>GRAND TOTAL</td><td class="r">${g.n}</td><td class="r">${g.fb1}</td>
    <td class="r">${g.resp}</td><td class="r">${pct(g.csat)}</td><td class="r">${pct(g.surv)}</td>
    <td class="r">${fmtAcht(g.avgSec)}</td><td class="r">â€”</td><td>â€”</td><td class="r">â€”</td></tr></tbody>`;
  document.getElementById('tlPerfTbl').innerHTML=h;

  // Top Risk Agents
  const risks=getAgentRiskMap(work).slice(0,5);
  document.getElementById('mgrRiskCards').innerHTML=risks.map(({agent,tl,dropCount,risk,tot})=>{
    const cls=risk==='HIGH'?'high':risk==='WARN'?'warn':'stable';
    const icon=risk==='HIGH'?'ğŸ”´':risk==='WARN'?'ğŸŸ¡':'ğŸŸ¢';
    const badge=risk==='HIGH'?'<span class="sb sb-red">HIGH RISK</span>':risk==='WARN'?'<span class="sb sb-orange">WARNING</span>':'<span class="sb sb-green">STABLE</span>';
    const action=risk==='HIGH'?'âš¡ IMMEDIATE COACHING':risk==='WARN'?'ğŸ‘ MONITOR CLOSELY':'âœ… ROUTINE CHECK';
    return`<div class="risk-card ${cls}" style="margin-bottom:10px">
      <div class="rc-status">${icon}</div>
      <div class="rc-name">${agent}</div>
      <div class="rc-tl"><span class="tl-badge tl-${TL_CLS[tl]||'rk'}">${tl}</span> ${badge}</div>
      <div style="font-size:11px;color:var(--muted2);margin:8px 0">${action}</div>
      <div class="rc-stats">
        <div class="rcs"><div class="rcs-val ${risk==='HIGH'?'risk-high':risk==='WARN'?'risk-warn':'risk-stable'}">${dropCount}</div><div class="rcs-lbl">Drops</div></div>
        <div class="rcs"><div class="rcs-val">${tot.n}</div><div class="rcs-lbl">Calls</div></div>
        <div class="rcs"><div class="rcs-val ${tot.csat!==null&&tot.csat<0.85?'warn':'good'}">${pct(tot.csat,1)}</div><div class="rcs-lbl">CSET</div></div>
        <div class="rcs"><div class="rcs-val">${pct(tot.surv,0)}</div><div class="rcs-lbl">Survey</div></div>
      </div></div>`;
  }).join('');

  // Volatility Chart
  const _vIdx = _dashIdx || buildIndex(work);
  const agVolts=getAgentRiskMapIdx(work,[...new Set(work.map(r=>r._hour).filter(h=>h!==null))].sort((a,b)=>a-b),_vIdx).map(a=>{
    const agR=_vIdx.byAgent[a.agent]||[];
    const csats=[];
    [...new Set(agR.map(r=>r._hour).filter(h=>h!==null))].forEach(hr=>{
      const ha=agg(_vIdx.byAgentHour[a.agent+'|'+hr]||[]);
      if(ha.csat!==null)csats.push(ha.csat);
    });
    const volt=csats.length>1?Math.sqrt(csats.reduce((s,v)=>{const m=csats.reduce((a,b)=>a+b,0)/csats.length;return s+(v-m)**2;},0)/csats.length):0;
    return{...a,volt};
  }).sort((a,b)=>b.volt-a.volt).slice(0,8);
  const maxVolt=agVolts[0]?.volt||0.01;
  document.getElementById('voltChart').innerHTML=agVolts.map(a=>{
    const pctW=(a.volt/maxVolt*100).toFixed(0);
    const col=a.volt>0.2?'var(--red)':a.volt>0.1?'var(--orange)':'var(--green)';
    return`<div class="volt-bar">
      <div class="volt-name">${a.agent}</div>
      <div class="volt-track"><div class="volt-fill" style="width:${pctW}%;background:${col}"></div></div>
      <div class="volt-score" style="color:${col}">${a.volt.toFixed(3)}</div>
    </div>`;
  }).join('');

  // Hour Ã— TL heatmap
  renderHourTLHeatmap(work,hours);

  // Root Cause + Actions
  const drops=computeDropHours(work,hours);
  const rcFreq={};
  drops.filter(d=>d.isDrop||d.isMajor).forEach(d=>{rcFreq[d.rootCause]=(rcFreq[d.rootCause]||0)+1;});
  const actions={
    'â± AHT Spike':'Process training, script adherence review, call handling coaching',
    'ğŸ“‰ Low Survey Volume':'Push survey script, agent reminder, TL monitoring',
    'âŒ High Bad Survey':'1-on-1 feedback session, call recording review, coaching plan',
    'ğŸ“ High Call Load':'Queue rebalancing, skill-based routing review',
    'âš  Critical Drop':'Immediate supervisor escalation, real-time monitoring',
    'â†• Natural Variation':'No action needed, continue monitoring',
    'âš  Negative Behaviour Feedback':'HR notification, behaviour coaching, written warning if repeat',
  };
  const rcHtml=Object.entries(rcFreq).sort((a,b)=>b[1]-a[1]).map(([cause,cnt])=>`
    <div style="padding:14px;border-bottom:1px solid var(--border)">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
        <strong style="font-size:13px">${cause}</strong>
        <span class="sb sb-blue">${cnt} occurrence${cnt>1?'s':''}</span>
      </div>
      <div style="font-size:12px;color:var(--muted2)">ğŸ’¡ ${actions[cause]||'Monitor and review'}</div>
    </div>`).join('');
  document.getElementById('mgrRcSection').innerHTML=rcHtml||'<div style="text-align:center;padding:30px;color:var(--muted)">âœ… Koi significant drops nahi mili</div>';
}

function renderHourTLHeatmap(work,hours){
  const tls=getTLOrder().filter(tl=>work.some(r=>r._tl===tl));
  let h='<table><thead><tr><th>TL</th>';
  hours.forEach(hr=>h+=`<th>${fmtHour(hr)}</th>`);
  h+='<th>Avg</th></tr></thead><tbody>';
  const _tlIdx=buildIndex(work);
  tls.forEach(tl=>{
    const tlR=work.filter(r=>r._tl===tl);
    const cls=TL_CLS[tl]||'rk';
    h+=`<tr><td style="font-weight:700"><span class="tl-badge tl-${cls}">${tl}</span></td>`;
    const csats=[];
    hours.forEach(hr=>{
      const hrR=(_tlIdx.byHour[hr]||[]).filter(r=>r._tl===tl);
      if(!hrR.length){h+='<td class="hm-na">â€”</td>';return;}
      const a=agg(hrR);
      if(a.csat===null){h+='<td class="hm-na">N/A</td>';return;}
      csats.push(a.csat);
      const bg=a.csat<0.7?'rgba(239,68,68,.35)':a.csat<0.85?'rgba(249,115,22,.3)':a.csat<0.95?'rgba(234,179,8,.25)':'rgba(16,185,129,.25)';
      const col=a.csat<0.7?'#fca5a5':a.csat<0.85?'#fdba74':a.csat<0.95?'#fde047':'#6ee7b7';
      h+=`<td style="background:${bg};color:${col};font-weight:700">${Math.round(a.csat*100)}%</td>`;
    });
    const avg=csats.length?csats.reduce((a,b)=>a+b,0)/csats.length:null;
    h+=`<td style="font-weight:800">${avg!==null?pct(avg,1):'â€”'}</td></tr>`;
  });
  h+='</tbody></table>';
  document.getElementById('mgrHeatmap').innerHTML=h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXCEL EXPORT (ExcelJS - Proper Colors)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function dlExcel(){
  if(!DATA)return;
  const{work,totalRaw,remOff,remNC}=DATA;
  // Build date range for export title
  const _xlDates=[...new Set(work.map(r=>r.call_date||r.Date||'').filter(Boolean))].sort();
  const date=_xlDates.length===1?_xlDates[0]:_xlDates.length>1?`${_xlDates[0]} to ${_xlDates[_xlDates.length-1]}`:'';
  const T=getTargets();
  const C={
    DARK:'FF1F4E79',MED:'FF2E75B6',LIGHT:'FFBDD7EE',LIGHT2:'FFDCE6F1',
    WHITE:'FFFFFFFF',BLACK:'FF000000',
    GREEN_BG:'FFC6EFCE',GREEN_FG:'FF276221',
    RED_BG:'FFFFC7CE',RED_FG:'FF9C0006',
    ORG_BG:'FFFFEB9C',ORG_FG:'FF9C6500',
    YEL_BG:'FFFFFF99',YEL_FG:'FF7D6608',
    BORDER:'FFB8CCE4',
  };
  const TL_BG_XL={'Rahul Kumar':'FF2E75B6','ROSHNI':'FF70AD47','YATENDER':'FFED7D31','ATUL':'FF7030A0'};

  const wb=new ExcelJS.Workbook();
  wb.creator='Pranamya Upadhyay â€” Livsmart Intelligence Hub v14';
  wb.lastModifiedBy='Pranamya Upadhyay';

  function applyStyle(cell,{bold=false,fg='FF000000',bg='FFFFFFFF',sz=10,h='center',v='middle',fmt=null,italic=false}={}){
    cell.font={bold,color:{argb:fg},name:'Calibri',size:sz,italic};
    cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:bg}};
    cell.alignment={horizontal:h,vertical:v,wrapText:false};
    cell.border={top:{style:'thin',color:{argb:C.BORDER}},bottom:{style:'thin',color:{argb:C.BORDER}},left:{style:'thin',color:{argb:C.BORDER}},right:{style:'thin',color:{argb:C.BORDER}}};
    if(fmt)cell.numFmt=fmt;
  }

  // SHEET 1: AGENT REPORT
  const ws1=wb.addWorksheet('Agent Report');
  ws1.views=[{showGridLines:false,state:'frozen',ySplit:3}];
  ws1.columns=[{width:28},{width:10},{width:7},{width:7},{width:7},{width:9},{width:10},{width:12},{width:10},{width:10},{width:12}];

  ws1.mergeCells(1,1,1,11);
  const t1=ws1.getCell(1,1);
  t1.value=`ğŸ“Š Agent Performance Report â€” ${date}`;
  applyStyle(t1,{bold:true,fg:C.WHITE,bg:C.DARK,sz:13,h:'left'});
  ws1.getRow(1).height=28;

  ws1.mergeCells(2,1,2,11);
  const s1=ws1.getCell(2,1);
  s1.value=`Raw: ${totalRaw}   â–¶   offhours: ${remOff}   â–¶   Not Connected: ${remNC}   â–¶   Final: ${work.length}   |   Targets â†’ CSET: ${T.csatPct}%   ACHT: ${T.achtStr}   Survey: ${T.survPct}%   |   Pranamya Upadhyay`;
  applyStyle(s1,{bold:true,fg:'FF1F4E79',bg:C.LIGHT,sz:9,h:'left'});
  ws1.getRow(2).height=16;

  const hdrs=['Agent / TL','Rating 1','2,1','2,2','2,3','2,None','Response','Total Calls','C-Sat%','Survey%','ACHT'];
  ws1.getRow(3).height=22;
  hdrs.forEach((h,i)=>{const c=ws1.getCell(3,i+1);c.value=h;applyStyle(c,{bold:true,fg:C.WHITE,bg:C.MED,sz:10,h:i===0?'left':'center'});});

  let row=4,agIdx=0;
  for(const tl of getTLOrder()){
    const tlR=work.filter(r=>r._tl===tl);if(!tlR.length)continue;
    const t=agg(tlR);const bg=TL_BG_XL[tl]||C.MED;
    ws1.getRow(row).height=20;
    [tl.toUpperCase(),t.fb1,t.fb21,t.fb22,t.fb23,t.fb2N,t.resp,t.n,t.csat!==null?t.csat:'N/A',t.surv,hmsLong(t.avgSec)].forEach((v,i)=>{
      const c=ws1.getCell(row,i+1);c.value=v;
      applyStyle(c,{bold:true,fg:C.WHITE,bg,sz:11,h:i===0?'left':'center',fmt:(i===8||i===9)&&typeof v==='number'?'0%':null});
    });row++;
    for(const ag of [...new Set(tlR.map(r=>r._agent))].sort()){
      const a=agg(tlR.filter(r=>r._agent===ag));
      const bgr=agIdx%2===0?C.LIGHT2:C.WHITE;
      ws1.getRow(row).height=15;
      [ag,a.fb1,a.fb21,a.fb22,a.fb23,a.fb2N,a.resp,a.n,a.csat!==null?a.csat:'N/A',a.surv,a.acht].forEach((v,i)=>{
        const c=ws1.getCell(row,i+1);c.value=i===10?hmsLong(a.avgSec):v;
        let b2=bgr,f2='FF000000';
        if(i===8&&typeof v==='number'){const cl=xlCsatColor(a.csat,T.csat,C);b2=cl.bg;f2=cl.fg;}
        if(i===9){const cl=xlSurvColor(a.surv,T.surv,C);b2=cl.bg;f2=cl.fg;}
        if(i===10&&a.avgSec>0){const cl=xlAchtColor(a.avgSec,T.achtSec,bgr,C);b2=cl.bg;f2=cl.fg;}
        applyStyle(c,{bold:false,fg:f2,bg:b2,sz:10,h:i===0?'left':'center',fmt:(i===8||i===9)&&typeof v==='number'?'0%':null});
      });agIdx++;row++;
    }
  }
  const g=agg(work);ws1.getRow(row).height=22;
  ['GRAND TOTAL',g.fb1,g.fb21,g.fb22,g.fb23,g.fb2N,g.resp,g.n,g.csat!==null?g.csat:'N/A',g.surv,hmsLong(g.avgSec)].forEach((v,i)=>{
    const c=ws1.getCell(row,i+1);c.value=v;
    applyStyle(c,{bold:true,fg:C.WHITE,bg:C.DARK,sz:11,h:i===0?'left':'center',fmt:(i===8||i===9)&&typeof v==='number'?'0%':null});
  });

  // SHEET 2: TL SUMMARY
  const ws2=wb.addWorksheet('TL Summary');
  ws2.views=[{showGridLines:false}];
  ws2.columns=[{width:20},{width:10},{width:7},{width:7},{width:7},{width:9},{width:10},{width:12},{width:10},{width:10},{width:12}];
  ws2.mergeCells(1,1,1,11);const t2=ws2.getCell(1,1);t2.value=`ğŸ“‹ TL Summary â€” ${date}`;applyStyle(t2,{bold:true,fg:C.WHITE,bg:C.DARK,sz:13,h:'left'});ws2.getRow(1).height=28;
  hdrs.forEach((h,i)=>{const c=ws2.getCell(2,i+1);c.value=h.replace('Agent / TL','TL');applyStyle(c,{bold:true,fg:C.WHITE,bg:C.MED,sz:10,h:i===0?'left':'center'});});ws2.getRow(2).height=22;
  let tr=3;for(const tl of getTLOrder()){
    const tlR=work.filter(r=>r._tl===tl);if(!tlR.length)continue;
    const t=agg(tlR);const bg=TL_BG_XL[tl]||C.MED;ws2.getRow(tr).height=24;
    [tl,t.fb1,t.fb21,t.fb22,t.fb23,t.fb2N,t.resp,t.n,t.csat!==null?t.csat:'N/A',t.surv,hmsLong(t.avgSec)].forEach((v,i)=>{
      const c=ws2.getCell(tr,i+1);c.value=v;applyStyle(c,{bold:true,fg:C.WHITE,bg,sz:12,h:i===0?'left':'center',fmt:(i===8||i===9)&&typeof v==='number'?'0%':null});
    });tr++;
  }
  const g2=agg(work);
  ['GRAND TOTAL',g2.fb1,g2.fb21,g2.fb22,g2.fb23,g2.fb2N,g2.resp,g2.n,g2.csat!==null?g2.csat:'N/A',g2.surv,hmsLong(g2.avgSec)].forEach((v,i)=>{
    const c=ws2.getCell(tr,i+1);c.value=v;applyStyle(c,{bold:true,fg:C.WHITE,bg:C.DARK,sz:11,h:i===0?'left':'center',fmt:(i===8||i===9)&&typeof v==='number'?'0%':null});
  });

  // SHEET 3: HOURLY
  const hours=[...new Set(work.map(r=>r._hour).filter(h=>h!==null))].sort((a,b)=>a-b);
  const ws3=wb.addWorksheet('Hourly Calls');
  ws3.views=[{showGridLines:false,state:'frozen',ySplit:2,xSplit:1}];
  ws3.columns=[{width:26},...hours.map(()=>({width:7})),{width:9}];
  ws3.mergeCells(1,1,1,hours.length+2);const t3=ws3.getCell(1,1);t3.value=`â° Hourly Call Count â€” ${date}`;applyStyle(t3,{bold:true,fg:C.WHITE,bg:C.DARK,sz:13,h:'left'});ws3.getRow(1).height=28;
  const hHdrs=['TL / Agent',...hours.map(h=>`${String(~~h).padStart(2,'0')}:00${h>=19?' ğŸŒ™':''}`),'Total'];
  hHdrs.forEach((h,i)=>{const c=ws3.getCell(2,i+1);c.value=h;applyStyle(c,{bold:true,fg:C.WHITE,bg:C.MED,h:i===0?'left':'center'});});ws3.getRow(2).height=22;
  let hr3=3,hi=0;
  for(const tl of getTLOrder()){
    const tlR=work.filter(r=>r._tl===tl);if(!tlR.length)continue;
    const bg=TL_BG_XL[tl]||C.MED;ws3.getRow(hr3).height=20;
    [tl.toUpperCase(),...hours.map(h=>tlR.filter(r=>r._hour===h).length),tlR.length].forEach((v,i)=>{
      const c=ws3.getCell(hr3,i+1);c.value=v;applyStyle(c,{bold:true,fg:C.WHITE,bg,h:i===0?'left':'center'});
    });hr3++;
    for(const ag of [...new Set(tlR.map(r=>r._agent))].sort()){
      const agR=tlR.filter(r=>r._agent===ag);const agBg=hi%2===0?C.LIGHT2:C.WHITE;ws3.getRow(hr3).height=15;
      [ag,...hours.map(h=>agR.filter(r=>r._hour===h).length),agR.length].forEach((v,i)=>{
        const c=ws3.getCell(hr3,i+1);c.value=i>0&&v===0?'':v;applyStyle(c,{fg:i>0&&v===0?'FFCCCCCC':'FF000000',bg:agBg,h:i===0?'left':'center'});
      });hi++;hr3++;
    }
  }
  ws3.getRow(hr3).height=22;
  ['GRAND TOTAL',...hours.map(h=>work.filter(r=>r._hour===h).length),work.length].forEach((v,i)=>{
    const c=ws3.getCell(hr3,i+1);c.value=v;applyStyle(c,{bold:true,fg:C.WHITE,bg:C.DARK,h:i===0?'left':'center'});
  });

  // SHEET 4: PROCESSED DATA
  const ws4=wb.addWorksheet('Processed Data');
  ws4.views=[{showGridLines:false,state:'frozen',ySplit:1}];
  ws4.columns=[{width:10},{width:12},{width:10},{width:6},{width:14},{width:24},{width:10},{width:8},{width:10}];
  ['ID','Date','Time','Hour','TL','Agent','Duration','Sec','Feedback'].forEach((cn,i)=>{
    const c=ws4.getCell(1,i+1);c.value=cn;applyStyle(c,{bold:true,fg:C.WHITE,bg:C.DARK,sz:9});
  });
  work.forEach((r,ri)=>{
    const pr=ri+2;const bg=ri%2===0?C.LIGHT2:C.WHITE;ws4.getRow(pr).height=14;
    [r.id||r.ID||'',r.call_date||r.Date||'',r._timeStr,r._hour,r._tl,r._agent,hmsLong(r._sec),r._sec,r.feedback||r.Feedback||''].forEach((v,i)=>{
      const c=ws4.getCell(pr,i+1);c.value=v;applyStyle(c,{fg:'FF000000',bg,sz:9,h:i<6?'left':'center'});
    });
  });

  const btn=document.querySelector('.btn-pri');
  if(btn){btn.disabled=true;btn.textContent='â³ Generating...';}
  try{
    const buf=await wb.xlsx.writeBuffer();
    const blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    const ts=new Date();const stamp=`${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,'0')}${String(ts.getDate()).padStart(2,'0')}_${String(ts.getHours()).padStart(2,'0')}${String(ts.getMinutes()).padStart(2,'0')}${String(ts.getSeconds()).padStart(2,'0')}`;
    a.download=`Livsmart_Report_${String(date).replace(/[^0-9\-]/g,'_')}_${stamp}.xlsx`;a.click();URL.revokeObjectURL(a.href);
    document.getElementById('dlOk').style.display='block';
    setTimeout(()=>document.getElementById('dlOk').style.display='none',3000);
  }finally{if(btn){btn.disabled=false;btn.textContent='â¬‡ Download Styled Excel';}}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONTHLY REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let MONTHLY_DATA = {}; // { filename: {rows, date, fileName} }
let MONTHLY_WORK = []; // merged rows

function initMonthlyPanel(){
  // Populate TL filter
  const sel = document.getElementById('monthlyTLFilter');
  const cur = sel.value;
  sel.innerHTML = '<option value="">All TLs</option>' + getTLOrder().map(t=>`<option value="${t}"${t===cur?' selected':''}>${t}</option>`).join('');
}

function onMonthlyDrag(e){e.preventDefault();document.getElementById('monthlyUpZone').classList.add('drag')}
function onMonthlyDragLeave(){document.getElementById('monthlyUpZone').classList.remove('drag')}
function onMonthlyDrop(e){e.preventDefault();onMonthlyDragLeave();if(e.dataTransfer.files.length)handleMonthlyFiles({files:e.dataTransfer.files})}

function handleMonthlyFiles(input){
  const files = Array.from(input.files);
  if(!files.length) return;
  document.getElementById('monthlyProg').style.display='block';
  let done=0;
  const process = (file) => new Promise(resolve => {
    const ext = file.name.split('.').pop().toLowerCase();
    if(ext==='csv'){
      Papa.parse(file,{header:true,skipEmptyLines:true,dynamicTyping:false,complete:r=>{resolve({rows:r.data,name:file.name});} });
    } else {
      const reader = new FileReader();
      reader.onload = e => {
        const wb = XLSX.read(e.target.result,{type:'array',cellDates:false});
        const sn = wb.SheetNames.includes('Raw Data')?'Raw Data':wb.SheetNames[0];
        resolve({rows:XLSX.utils.sheet_to_json(wb.Sheets[sn],{defval:''}),name:file.name});
      };
      reader.readAsArrayBuffer(file);
    }
  });

  Promise.all(files.map(process)).then(results => {
    results.forEach(({rows,name}) => {
      document.getElementById('monthlyProgLbl').textContent = `âš™ Processing: ${name}`;
      document.getElementById('monthlyProgFill').style.width = `${Math.round((++done/files.length)*100)}%`;
      // Run same buildReport logic to get processed rows
      const processed = processRawRows(rows);
      MONTHLY_DATA[name] = {work: processed, fileName: name, date: processed[0]?.call_date||processed[0]?.Date||name};
    });
    // Merge all
    MONTHLY_WORK = Object.values(MONTHLY_DATA).flatMap(d=>d.work);
    renderMonthlyUI();
    document.getElementById('monthlyProg').style.display='none';
    document.getElementById('monthlyUpZone').style.display='none';
  });
}

function processRawRows(raw){
  const durCol = raw.length ? detectDurCol(raw[0]) : null;
  // Same processing as buildReport but returns work array
  const work=[];
  raw.forEach(r=>{
    const num = normAgNum(String(r.agent_number||r['Agent Number']||r.agent||'').trim());
    const info = MASTER[num]||agentsData[num];
    const tlRaw = r.tl||r.TL||r['Team Leader']||'';
    const tl = info?normTL(info[1]):normTL(tlRaw);
    if(EXCLUDE_TL.has(tl)||!tl) return;
    const agent = info?info[0]:(r.agent_name||r['Agent Name']||num);
    const fb = String(r.feedback||r.Feedback||'').trim();
    const _fb1=fb==='Rating 1'||fb==='1';
    const _fb21=fb==='Rating 2,1'||fb==='2,1';
    const _fb22=fb==='Rating 2,2'||fb==='2,2';
    const _fb23=fb==='Rating 2,3'||fb==='2,3';
    const _fb2N=fb==='Rating 2,None'||fb==='2,None'||fb==='Rating 2';
    const _hasFb=_fb1||_fb21||_fb22||_fb23||_fb2N;
    const _sec=parseDur(
      durCol ? r[durCol]
      : r.conversation_duration ?? r.conv_duration ?? r.duration ?? r.Duration
        ?? r.call_duration ?? r['Conv Duration'] ?? r['Conversation Duration']
        ?? r['Call Duration'] ?? 0
    );
    const _hour=parseHour(r.call_time||r.Time||r.time||null);
    const conn=String(r.call_status||r.Status||r.status||'').trim().toLowerCase();
    if(conn==='not connected'||conn==='not_connected') return;
    const timeVal=r.call_time||r.Time||r.time||'';
    const timeNum=parseHour(timeVal);
    if(timeNum!==null&&(timeNum<9||timeNum>=20)) return;
    work.push({...r,_tl:tl,_agent:agent,_fb1,_fb21,_fb22,_fb23,_fb2N,_hasFb,_sec,_hour,_timeStr:String(timeVal)});
  });
  return work;
}

function resetMonthly(){
  MONTHLY_DATA={};MONTHLY_WORK=[];
  document.getElementById('monthlyUpZone').style.display='block';
  document.getElementById('monthlyFilesList').style.display='none';
  document.getElementById('monthlyStats').style.display='none';
  document.getElementById('monthlyFi').value='';
}

function renderMonthlyUI(){
  if(!MONTHLY_WORK.length) return;
  document.getElementById('monthlyFilesList').style.display='block';
  document.getElementById('monthlyStats').style.display='block';

  // Files grid
  const files = Object.entries(MONTHLY_DATA);
  document.getElementById('monthlyTotalBadge').textContent=`${files.length} files â€¢ ${MONTHLY_WORK.length} total calls`;
  document.getElementById('monthlyFilesGrid').innerHTML = files.map(([name,d])=>`
    <div style="background:var(--card2);border:1px solid var(--border2);border-radius:8px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:12px;font-weight:700;margin-bottom:2px">${d.date}</div>
        <div style="font-size:10px;color:var(--muted2);font-family:'JetBrains Mono',monospace">${name.length>28?name.slice(0,26)+'..':name} Â· ${d.work.length} calls</div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="removeMonthlyFile('${name.replace(/'/g,"\\'")}')" style="padding:3px 8px;font-size:10px">âœ•</button>
    </div>`).join('');

  // Stat pills
  const g = agg(MONTHLY_WORK);
  const days = Object.keys(MONTHLY_DATA).length;
  document.getElementById('monthlyStatRow').innerHTML=`
    <div class="stat-pill"><span class="sp-val" style="color:var(--blue)">${days}</span><span class="sp-lbl">Days Loaded</span></div>
    <div class="stat-pill"><span class="sp-val" style="color:var(--text)">${g.n.toLocaleString()}</span><span class="sp-lbl">Total Calls</span></div>
    <div class="stat-pill"><span class="sp-val" style="color:${g.csat!==null&&g.csat<0.85?'var(--red)':'var(--green)'}">${pct(g.csat)}</span><span class="sp-lbl">Avg CSET</span></div>
    <div class="stat-pill"><span class="sp-val" style="color:var(--orange)">${pct(g.surv)}</span><span class="sp-lbl">Survey%</span></div>
    <div class="stat-pill"><span class="sp-val" style="color:var(--cyan)">${hms(g.avgSec)}</span><span class="sp-lbl">Avg ACHT</span></div>
    <div class="stat-pill"><span class="sp-val" style="color:var(--purple)">${g.fb1}</span><span class="sp-lbl">Rating 1</span></div>`;

  renderMonthlyDateTable();
  renderMonthlyAgent();
  renderMonthlyTL();
  initMonthlyPanel(); // refresh TL filter
}

function removeMonthlyFile(name){
  delete MONTHLY_DATA[name];
  MONTHLY_WORK = Object.values(MONTHLY_DATA).flatMap(d=>d.work);
  if(!Object.keys(MONTHLY_DATA).length){ resetMonthly(); return; }
  renderMonthlyUI();
}

function renderMonthlyDateTable(){
  const hdrs=['Date','File','Total Calls','Rating 1','Response','CSET%','Survey%','ACHT'];
  let h=`<thead><tr>${hdrs.map((x,i)=>`<th${i>2?' class="r"':''}>${x}</th>`).join('')}</tr></thead><tbody>`;
  const entries = Object.entries(MONTHLY_DATA).sort((a,b)=>String(a[1].date).localeCompare(String(b[1].date)));
  entries.forEach(([name,d])=>{
    const a=agg(d.work);
    h+=`<tr class="agent">
      <td><strong>${d.date}</strong></td>
      <td style="font-size:10px;color:var(--muted2);font-family:'JetBrains Mono',monospace">${name.length>30?name.slice(0,28)+'..':name}</td>
      <td class="r">${a.n}</td><td class="r">${a.fb1}</td><td class="r">${a.resp}</td>
      <td class="r ${a.csat!==null&&a.csat<0.85?'warn':'good'}">${pct(a.csat)}</td>
      <td class="r ${a.surv<0.10?'surv-warn':''}">${pct(a.surv)}</td>
      <td class="r">${fmtAcht(a.avgSec)}</td></tr>`;
  });
  const g=agg(MONTHLY_WORK);
  h+=`<tr class="grand"><td>GRAND TOTAL</td><td>â€”</td>
    <td class="r">${g.n}</td><td class="r">${g.fb1}</td><td class="r">${g.resp}</td>
    <td class="r">${pct(g.csat)}</td><td class="r">${pct(g.surv)}</td>
    <td class="r">${fmtAcht(g.avgSec)}</td></tr></tbody>`;
  document.getElementById('monthlyDateTbl').innerHTML=h;
}

function renderMonthlyAgent(){
  const tlF = document.getElementById('monthlyTLFilter').value;
  const q = (document.getElementById('monthlySearch').value||'').toLowerCase();
  let work = MONTHLY_WORK;
  if(tlF) work = work.filter(r=>r._tl===tlF);

  const agents = [...new Set(work.map(r=>r._agent))].filter(ag=>!q||ag.toLowerCase().includes(q)).sort();
  const hdrs=['Agent','TL','Total Calls','Rating 1','2,1','2,2','2,3','Response','CSET%','Survey%','ACHT'];
  let h=`<thead><tr>${hdrs.map((x,i)=>`<th${i>2?' class="r"':''}>${x}</th>`).join('')}</tr></thead><tbody>`;
  const _maIdx=buildIndex(work);
  agents.forEach(ag=>{
    const agR=_maIdx.byAgent[ag]||[];
    const a=agg(agR);
    const tl=agR[0]?._tl||'';
    const cls=TL_CLS[tl]||'rk';
    h+=`<tr class="agent">
      <td><strong>${ag}</strong></td>
      <td><span class="tl-badge tl-${cls}">${tl}</span></td>
      <td class="r">${a.n}</td><td class="r">${a.fb1}</td>
      <td class="r">${a.fb21}</td><td class="r">${a.fb22}</td><td class="r">${a.fb23}</td>
      <td class="r">${a.resp}</td>
      <td class="r ${a.csat!==null&&a.csat<0.85?'warn':'good'}">${pct(a.csat)}</td>
      <td class="r ${a.surv<0.10?'surv-warn':''}">${pct(a.surv)}</td>
      <td class="r">${fmtAcht(a.avgSec)}</td></tr>`;
  });
  const g=agg(work);
  h+=`<tr class="grand"><td>GRAND TOTAL</td><td>â€”</td>
    <td class="r">${g.n}</td><td class="r">${g.fb1}</td><td class="r">${g.fb21}</td>
    <td class="r">${g.fb22}</td><td class="r">${g.fb23}</td><td class="r">${g.resp}</td>
    <td class="r">${pct(g.csat)}</td><td class="r">${pct(g.surv)}</td>
    <td class="r">${fmtAcht(g.avgSec)}</td></tr></tbody>`;
  document.getElementById('monthlyAgentTbl').innerHTML=h;
}

function renderMonthlyTL(){
  const hdrs=['TL','Total Calls','Rating 1','Response','CSET%','Survey%','ACHT','Agents'];
  let h=`<thead><tr>${hdrs.map((x,i)=>`<th${i>1?' class="r"':''}>${x}</th>`).join('')}</tr></thead><tbody>`;
  for(const tl of getTLOrder()){
    const tlR=MONTHLY_WORK.filter(r=>r._tl===tl);
    if(!tlR.length) continue;
    const t=agg(tlR);
    const cls=TL_CLS[tl]||'rk';
    const agentCount=[...new Set(tlR.map(r=>r._agent))].length;
    h+=`<tr class="tl-hdr ${cls}">
      <td>${tl.toUpperCase()}</td>
      <td class="r">${t.n}</td><td class="r">${t.fb1}</td><td class="r">${t.resp}</td>
      <td class="r ${t.csat!==null&&t.csat<0.85?'warn':'good'}">${pct(t.csat)}</td>
      <td class="r ${t.surv<0.10?'surv-warn':''}">${pct(t.surv)}</td>
      <td class="r">${fmtAcht(t.avgSec)}</td>
      <td class="r">${agentCount}</td></tr>`;
  }
  const g=agg(MONTHLY_WORK);
  h+=`<tr class="grand"><td>GRAND TOTAL</td>
    <td class="r">${g.n}</td><td class="r">${g.fb1}</td><td class="r">${g.resp}</td>
    <td class="r">${pct(g.csat)}</td><td class="r">${pct(g.surv)}</td>
    <td class="r">${fmtAcht(g.avgSec)}</td>
    <td class="r">${[...new Set(MONTHLY_WORK.map(r=>r._agent))].length}</td></tr></tbody>`;
  document.getElementById('monthlyTLTbl').innerHTML=h;
}

async function dlMonthlyExcel(){
  if(!MONTHLY_WORK.length) return;
  const wb = new ExcelJS.Workbook();
  wb.creator = 'Pranamya Upadhyay â€” Livsmart v14';
  const C={
    DARK:'FF1F4E79',MED:'FF2E75B6',LIGHT:'FFBDD7EE',LIGHT2:'FFDCE6F1',
    WHITE:'FFFFFFFF',BLACK:'FF000000',
    GREEN_BG:'FFC6EFCE',GREEN_FG:'FF276221',
    RED_BG:'FFFFC7CE',RED_FG:'FF9C0006',
    ORG_BG:'FFFFEB9C',ORG_FG:'FF9C6500',
    BORDER:'FFB8CCE4',
  };
  const TL_BG_XL={'Rahul Kumar':'FF2E75B6','ROSHNI':'FF70AD47','YATENDER':'FFED7D31','ATUL':'FF7030A0'};

  function applyStyle(cell,{bold=false,fg='FF000000',bg='FFFFFFFF',sz=10,h='center',fmt=null}={}){
    cell.font={bold,color:{argb:fg},name:'Calibri',size:sz};
    cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:bg}};
    cell.alignment={horizontal:h,vertical:'middle'};
    cell.border={top:{style:'thin',color:{argb:C.BORDER}},bottom:{style:'thin',color:{argb:C.BORDER}},left:{style:'thin',color:{argb:C.BORDER}},right:{style:'thin',color:{argb:C.BORDER}}};
    if(fmt)cell.numFmt=fmt;
  }

  const monthRange = Object.values(MONTHLY_DATA).map(d=>d.date).sort().join(' â†’ ');

  // SHEET 1: Date-wise Summary
  const ws1 = wb.addWorksheet('Date-wise Summary');
  ws1.views=[{showGridLines:false}];
  ws1.columns=[{width:14},{width:32},{width:12},{width:10},{width:10},{width:10},{width:10},{width:14}];
  ws1.mergeCells(1,1,1,8);
  const t1=ws1.getCell(1,1);t1.value=`ğŸ“… Monthly Report â€” ${monthRange}`;
  applyStyle(t1,{bold:true,fg:C.WHITE,bg:C.DARK,sz:13,h:'left'});ws1.getRow(1).height=28;
  ['Date','File','Total Calls','Rating 1','Response','CSET%','Survey%','ACHT'].forEach((h,i)=>{
    const c=ws1.getCell(2,i+1);c.value=h;applyStyle(c,{bold:true,fg:C.WHITE,bg:C.MED,sz:10,h:i<2?'left':'center'});
  });ws1.getRow(2).height=20;
  let row=3;
  Object.entries(MONTHLY_DATA).sort((a,b)=>String(a[1].date).localeCompare(String(b[1].date))).forEach(([name,d])=>{
    const a=agg(d.work);
    const bg=row%2===0?C.LIGHT2:C.WHITE;ws1.getRow(row).height=15;
    [d.date,name,a.n,a.fb1,a.resp,a.csat!==null?a.csat:'N/A',a.surv,hms(a.avgSec)].forEach((v,i)=>{
      const c=ws1.getCell(row,i+1);c.value=v;
      applyStyle(c,{fg:C.BLACK,bg,sz:10,h:i<2?'left':'center',fmt:(i===5||i===6)&&typeof v==='number'?'0%':null});
    });row++;
  });
  const g=agg(MONTHLY_WORK);ws1.getRow(row).height=22;
  ['GRAND TOTAL','',g.n,g.fb1,g.resp,g.csat!==null?g.csat:'N/A',g.surv,hms(g.avgSec)].forEach((v,i)=>{
    const c=ws1.getCell(row,i+1);c.value=v;
    applyStyle(c,{bold:true,fg:C.WHITE,bg:C.DARK,sz:11,h:i<2?'left':'center',fmt:(i===5||i===6)&&typeof v==='number'?'0%':null});
  });

  // SHEET 2: Agent Aggregate
  const ws2=wb.addWorksheet('Agent Aggregate');
  ws2.views=[{showGridLines:false,state:'frozen',ySplit:3}];
  ws2.columns=[{width:28},{width:14},{width:12},{width:9},{width:7},{width:7},{width:7},{width:10},{width:10},{width:10},{width:12}];
  ws2.mergeCells(1,1,1,11);
  const t2=ws2.getCell(1,1);t2.value=`ğŸ‘¤ Agent Monthly Aggregate â€” ${monthRange}`;
  applyStyle(t2,{bold:true,fg:C.WHITE,bg:C.DARK,sz:13,h:'left'});ws2.getRow(1).height=28;
  ['Agent','TL','Total Calls','Rating 1','2,1','2,2','2,3','Response','CSET%','Survey%','ACHT'].forEach((h,i)=>{
    const c=ws2.getCell(2,i+1);c.value=h;applyStyle(c,{bold:true,fg:C.WHITE,bg:C.MED,sz:10,h:i<2?'left':'center'});
  });ws2.getRow(2).height=20;
  let r2=3,ai=0;
  for(const tl of getTLOrder()){
    const tlR=MONTHLY_WORK.filter(r=>r._tl===tl);if(!tlR.length)continue;
    const t=agg(tlR);const bg=TL_BG_XL[tl]||C.MED;ws2.getRow(r2).height=20;
    [tl.toUpperCase(),'',t.n,t.fb1,t.fb21,t.fb22,t.fb23,t.resp,t.csat!==null?t.csat:'N/A',t.surv,hms(t.avgSec)].forEach((v,i)=>{
      const c=ws2.getCell(r2,i+1);c.value=v;applyStyle(c,{bold:true,fg:C.WHITE,bg,sz:11,h:i<2?'left':'center',fmt:(i===8||i===9)&&typeof v==='number'?'0%':null});
    });r2++;
    for(const ag of [...new Set(tlR.map(r=>r._agent))].sort()){
      const a=agg(tlR.filter(r=>r._agent===ag));
      const abg=ai%2===0?C.LIGHT2:C.WHITE;ws2.getRow(r2).height=15;
      [ag,tl,a.n,a.fb1,a.fb21,a.fb22,a.fb23,a.resp,a.csat!==null?a.csat:'N/A',a.surv,hms(a.avgSec)].forEach((v,i)=>{
        const c=ws2.getCell(r2,i+1);c.value=v;
        let b2=abg,f2=C.BLACK;
        if(i===8&&a.csat!==null&&a.csat<0.85){b2=C.RED_BG;f2=C.RED_FG;}
        if(i===8&&a.csat!==null&&a.csat>=0.85){b2=C.GREEN_BG;f2=C.GREEN_FG;}
        if(i===9&&a.surv<0.10){b2=C.ORG_BG;f2=C.ORG_FG;}
        applyStyle(c,{fg:f2,bg:b2,sz:10,h:i<2?'left':'center',fmt:(i===8||i===9)&&typeof v==='number'?'0%':null});
      });ai++;r2++;
    }
  }
  ws2.getRow(r2).height=22;
  const g2=agg(MONTHLY_WORK);
  ['GRAND TOTAL','',g2.n,g2.fb1,g2.fb21,g2.fb22,g2.fb23,g2.resp,g2.csat!==null?g2.csat:'N/A',g2.surv,hms(g2.avgSec)].forEach((v,i)=>{
    const c=ws2.getCell(r2,i+1);c.value=v;applyStyle(c,{bold:true,fg:C.WHITE,bg:C.DARK,sz:11,h:i<2?'left':'center',fmt:(i===8||i===9)&&typeof v==='number'?'0%':null});
  });

  // SHEET 3: TL Summary
  const ws3=wb.addWorksheet('TL Summary');
  ws3.views=[{showGridLines:false}];
  ws3.columns=[{width:20},{width:12},{width:10},{width:10},{width:10},{width:10},{width:12},{width:10}];
  ws3.mergeCells(1,1,1,8);
  const t3=ws3.getCell(1,1);t3.value=`ğŸ‘” TL Monthly Summary â€” ${monthRange}`;
  applyStyle(t3,{bold:true,fg:C.WHITE,bg:C.DARK,sz:13,h:'left'});ws3.getRow(1).height=28;
  ['TL','Total Calls','Rating 1','Response','CSET%','Survey%','ACHT','Agents'].forEach((h,i)=>{
    const c=ws3.getCell(2,i+1);c.value=h;applyStyle(c,{bold:true,fg:C.WHITE,bg:C.MED,sz:10,h:i===0?'left':'center'});
  });ws3.getRow(2).height=20;
  let r3=3;
  for(const tl of getTLOrder()){
    const tlR=MONTHLY_WORK.filter(r=>r._tl===tl);if(!tlR.length)continue;
    const t=agg(tlR);const bg=TL_BG_XL[tl]||C.MED;ws3.getRow(r3).height=22;
    const agCnt=[...new Set(tlR.map(r=>r._agent))].length;
    [tl,t.n,t.fb1,t.resp,t.csat!==null?t.csat:'N/A',t.surv,hms(t.avgSec),agCnt].forEach((v,i)=>{
      const c=ws3.getCell(r3,i+1);c.value=v;applyStyle(c,{bold:true,fg:C.WHITE,bg,sz:12,h:i===0?'left':'center',fmt:(i===4||i===5)&&typeof v==='number'?'0%':null});
    });r3++;
  }
  const g3=agg(MONTHLY_WORK);ws3.getRow(r3).height=22;
  ['GRAND TOTAL',g3.n,g3.fb1,g3.resp,g3.csat!==null?g3.csat:'N/A',g3.surv,hms(g3.avgSec),[...new Set(MONTHLY_WORK.map(r=>r._agent))].length].forEach((v,i)=>{
    const c=ws3.getCell(r3,i+1);c.value=v;applyStyle(c,{bold:true,fg:C.WHITE,bg:C.DARK,sz:11,h:i===0?'left':'center',fmt:(i===4||i===5)&&typeof v==='number'?'0%':null});
  });

  const btn=document.querySelector('#panel-monthly .btn-pri');
  if(btn){btn.disabled=true;btn.textContent='â³ Generating...';}
  try{
    const buf=await wb.xlsx.writeBuffer();
    const blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    const ts2=new Date();const stamp2=`${ts2.getFullYear()}${String(ts2.getMonth()+1).padStart(2,'0')}${String(ts2.getDate()).padStart(2,'0')}_${String(ts2.getHours()).padStart(2,'0')}${String(ts2.getMinutes()).padStart(2,'0')}${String(ts2.getSeconds()).padStart(2,'0')}`;a.download=`Livsmart_Monthly_${monthRange.replace(/[^0-9\-â†’]/g,'_')}_${stamp2}.xlsx`;a.click();URL.revokeObjectURL(a.href);
    document.getElementById('monthlyDlOk').style.display='block';
    setTimeout(()=>document.getElementById('monthlyDlOk').style.display='none',3000);
  }finally{if(btn){btn.disabled=false;btn.textContent='â¬‡ Download Monthly Excel';}}
}

// â”€â”€ INIT â”€â”€
// Safe init - elements may not exist if panel not active
(function safeInit(){
  const rd = document.getElementById('reportDate');
  if(rd) rd.textContent='ğŸ“‚ File upload karo';
  updateAgentCount();
})();
function updateAgentCount(){
  const n=Object.keys(agentsData).length;
  const ac=document.getElementById('agentCount');
  const tab=document.getElementById('totalAgentBadge');
  if(ac) ac.textContent=`${n} agents`;
  if(tab) tab.textContent=`${n} agents`;
}
renderTLCards();

// â•â•â•â• CANCELLATION TOOL ENGINE â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREDEFINED AGENTS (34 from image)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_AGENTS = [
  'Aakash Lohia','ARVIND KUSHWAHA','Daksh','Deepankar','Deepika',
  'Dev Attri','Dwijendra Kumar','Harish Bhanja','Harsh null',
  'Harshika Srivastava','Jaya Kumari','Jyoti Kumari','Kajal Kumari',
  'Khushi null','Kritika Kaur Sangotra','Kuldeep Singh Bhandhari',
  'LAXMI','Lucky Singh','Mansi','MOHINI CHAUHAN','Muskan null',
  'Neetu null','Neha null','Pankaj Kumar','Pranamya Upadhyay',
  'Priti Biswas','Priyanka Kumari','Rajat Raj','Rajesh Nishad',
  'SACHIN KASHIV','Shivam Rai Rai','Shivani null','Twinkle Kumari','Varsha'
];
const AGENT_FILTER = {};
DEFAULT_AGENTS.forEach(a => AGENT_FILTER[a] = true);

function renderTags() {
  const wrap = document.getElementById('cancelTagsWrap');
  wrap.innerHTML = Object.keys(AGENT_FILTER).map(a => {
    const on = AGENT_FILTER[a];
    const esc = a.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    return `<span class="ag-tag ${on?'on':'off'}" onclick="toggleAgent('${esc}')">
      ${on?'âœ“':''} ${a}
      ${!DEFAULT_AGENTS.includes(a)?`<button class="ag-remove" onclick="event.stopPropagation();removeAgent('${esc}')">âœ•</button>`:''}
    </span>`;
  }).join('');
  const active = Object.values(AGENT_FILTER).filter(Boolean).length;
  document.getElementById('cancelAgentCount').textContent = `${active}/${Object.keys(AGENT_FILTER).length} active`;
}
function toggleAgent(n) { AGENT_FILTER[n] = !AGENT_FILTER[n]; renderTags(); }
function toggleAll(s) { Object.keys(AGENT_FILTER).forEach(a => AGENT_FILTER[a] = s); renderTags(); }
function removeAgent(n) { if (DEFAULT_AGENTS.includes(n)) return; delete AGENT_FILTER[n]; renderTags(); }
function addCancelAgentEntry() {
  const inp = document.getElementById('cancelNewAgent');
  const name = inp.value.trim();
  if (!name || AGENT_FILTER.hasOwnProperty(name)) return;
  AGENT_FILTER[name] = true; renderTags(); inp.value = '';
}
renderTags();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navTo(tab) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + tab).classList.add('active');
  document.getElementById('nt-cancel-' + tab).classList.add('active');
  if (tab === 'charts') buildCharts();
  if (tab === 'targets') renderTargets();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkDate() {
  const f = document.getElementById('cancelDateFrom').value;
  const t = document.getElementById('cancelDateTo').value;
  document.getElementById('cancelDateBadge').style.display = (f || t) ? 'inline-flex' : 'none';
}
function clearDates() {
  document.getElementById('cancelDateFrom').value = '';
  document.getElementById('cancelDateTo').value = '';
  document.getElementById('cancelDateBadge').style.display = 'none';
}
function inRange(dateStr) {
  const from = document.getElementById('cancelDateFrom').value;
  const to = document.getElementById('cancelDateTo').value;
  if (!from && !to) return true;
  if (!dateStr) return true;
  const d = dateStr.trim().split(' ')[0];
  if (from && d < from) return false;
  if (to && d > to) return false;
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _cancelOnDrag(e) { e.preventDefault(); document.getElementById('cancelUpZone').classList.add('drag'); }
function cancelOnDragLeave() { document.getElementById('cancelUpZone').classList.remove('drag'); }
function cancelOnDrop(e) { e.preventDefault(); cancelOnDragLeave(); if (e.dataTransfer.files[0]) processCancelFile(e.dataTransfer.files[0]); }
function handleCancelFile2(el) { if (el.files[0]) processCancelFile(el.files[0]); }
function progCancel(p, lbl) { const pf=document.getElementById("cancelProgFill"); const pl=document.getElementById("cancelProgLbl"); if(pf) pf.style.width = p + "%"; if(pl) pl.textContent = lbl; }
function showErr(msg) { const a = document.getElementById('cancelErrAlert'); a.textContent = 'âŒ ' + msg; a.style.display = 'block'; document.getElementById('cancelProgWrap').style.display = 'none'; }

function processCancelFile(file) {
  document.getElementById('cancelProgWrap').style.display = 'block';
  prog(5, 'File reading...');
  const ext = file.name.split('.').pop().toLowerCase();
  if (ext === 'csv') {
    Papa.parse(file, {
      header: true, skipEmptyLines: true,
      complete(res) { prog(80, 'Processing...'); setTimeout(() => buildReport(res.data, file.name), 50); },
      error(e) { showErr('CSV error: ' + e.message); }
    });
  } else {
    const reader = new FileReader();
    reader.onload = function (e) {
      prog(40, 'Parsing Excel...');
      setTimeout(() => {
        try {
          const wb = XLSX.read(e.target.result, { type: 'array' });
          const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' });
          prog(80, 'Processing...'); setTimeout(() => buildReport(data, file.name), 50);
        } catch (err) { showErr('Excel error: ' + err.message); }
      }, 50);
    };
    reader.readAsArrayBuffer(file);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let AGENT_DATA = {}, HOURLY_DATA = {}, ALL_STATUSES = {}, ALL_REASONS_CANCEL = {}, ALL_REASONS_RETAIN = {}, CUR_FILE = '';

function buildCancelReport(raw, fileName) {
  if (!raw || !raw.length) { showErr('File mein data nahi mila'); return; }
  prog(90, 'Building...'); CUR_FILE = fileName;
  AGENT_DATA = {}; HOURLY_DATA = {}; ALL_STATUSES = {}; ALL_REASONS_CANCEL = {}; ALL_REASONS_RETAIN = {};

  const headers = Object.keys(raw[0]);
  function fc(...names) { return headers.find(h => names.some(n => h.toLowerCase().replace(/\s/g, '').includes(n.toLowerCase().replace(/\s/g, '')))); }
  const C_STATUS   = fc('Status', 'status') || 'Status';
  const C_CREATED  = fc('CreatedBy', 'created_by', 'Created By') || 'Created By';
  const C_APPROVED = fc('ApprovedBy', 'approved_by', 'Approved By') || 'Approved By';
  const C_REASON   = fc('Reason', 'reason') || 'Reason';
  const C_DATE     = fc('CreateDate', 'Create Date', 'date') || 'Create Date';

  // â˜… BUG FIX: Build lowercase map â€” handles trailing/leading spaces in CSV
  const FMAP = {};
  Object.keys(AGENT_FILTER).forEach(a => { FMAP[a.toLowerCase().trim()] = { canonical: a, active: AGENT_FILTER[a] }; });

  let totalAll = 0, skipped = 0;

  for (const row of raw) {
    const status   = (row[C_STATUS] || '').toString().trim().toUpperCase();
    const agentRaw = (row[C_CREATED] || '').toString().trim();
    const approved = (row[C_APPROVED] || '').toString().trim();
    const reason   = (row[C_REASON] || '').toString().trim() || 'Not Specified';
    const dateStr  = (row[C_DATE] || '').toString().trim();
    if (!agentRaw) continue;
    totalAll++;

    // Date filter
    if (!inRange(dateStr)) { skipped++; continue; }

    // â˜… Match using lowercase â€” fixes 'LAXMI ' trailing space bug
    const match = FMAP[agentRaw.toLowerCase()];
    if (!match || !match.active) { skipped++; continue; }
    const agent = match.canonical;

    // TRUE RETAINED = RETAINED status + Approved By filled
    const isRetained = status === 'RETAINED' && approved.length > 0;

    let hour = -1;
    if (dateStr) { const m = dateStr.match(/(\d{1,2}):\d{2}/); if (m) hour = parseInt(m[1]); }

    if (!AGENT_DATA[agent]) AGENT_DATA[agent] = { total: 0, retained: 0, cancelled: 0, statuses: {}, rc: {}, rr: {} };
    AGENT_DATA[agent].total++;
    if (isRetained) {
      AGENT_DATA[agent].retained++;
      ALL_REASONS_RETAIN[reason] = (ALL_REASONS_RETAIN[reason] || 0) + 1;
      AGENT_DATA[agent].rr[reason] = (AGENT_DATA[agent].rr[reason] || 0) + 1;
    } else {
      AGENT_DATA[agent].cancelled++;
      ALL_REASONS_CANCEL[reason] = (ALL_REASONS_CANCEL[reason] || 0) + 1;
      AGENT_DATA[agent].rc[reason] = (AGENT_DATA[agent].rc[reason] || 0) + 1;
    }
    AGENT_DATA[agent].statuses[status] = (AGENT_DATA[agent].statuses[status] || 0) + 1;
    ALL_STATUSES[status] = (ALL_STATUSES[status] || 0) + 1;
    if (hour >= 0) {
      if (!HOURLY_DATA[hour]) HOURLY_DATA[hour] = { total: 0, retained: 0, cancelled: 0 };
      HOURLY_DATA[hour].total++;
      if (isRetained) HOURLY_DATA[hour].retained++; else HOURLY_DATA[hour].cancelled++;
    }
  }

  prog(100, 'Done!');
  setTimeout(() => { document.getElementById('cancelProgWrap').style.display = 'none'; }, 400);

  const total = Object.values(AGENT_DATA).reduce((s, d) => s + d.total, 0);
  const ret   = Object.values(AGENT_DATA).reduce((s, d) => s + d.retained, 0);
  const can   = Object.values(AGENT_DATA).reduce((s, d) => s + d.cancelled, 0);
  const retPct = can > 0 ? ((ret / can) * 100).toFixed(1) : '0.0';

  document.getElementById('kTotal').textContent    = total.toLocaleString();
  document.getElementById('kRetained').textContent = ret.toLocaleString();
  document.getElementById('kCancelled').textContent = can.toLocaleString();
  document.getElementById('kRetPct').textContent   = retPct + '%';
  document.getElementById('kAgents').textContent   = Object.keys(AGENT_DATA).length;
  document.getElementById('kSkipped').textContent  = skipped;
  document.getElementById('cancelAgentBadge').textContent = Object.keys(AGENT_DATA).length + ' agents';
  document.getElementById('cancelFileBadge').textContent = 'ğŸ“‚ ' + fileName;
  document.getElementById('cancelFileBadge').style.display = 'inline-block';

  document.getElementById('cancelUpZone').style.display = 'none';
  document.getElementById('cancelResults').style.display = 'block';
  document.getElementById('chartsEmptyNote').style.display = 'none';
  document.getElementById('chartsContent').style.display = 'block';
  document.getElementById('targetEmpty').style.display = 'none';
  document.getElementById('targetContent').style.display = 'block';

  buildAgentTable(); buildStatusTab(total, ret, can); buildReasonTab(); buildHourlyTab();
  saveToHistory(fileName, total, ret, can, retPct);
  renderTargets();
  showToast('âœ… ' + total + ' records loaded! (' + Object.keys(AGENT_DATA).length + ' agents)', 'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB 0: AGENT TABLE (with sort)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sortCol = 5, sortDir = -1;
function buildAgentTable() {
  const SC = Object.keys(ALL_STATUSES).sort();
  const t = document.getElementById('cancelAgentTbl');
  const hdrs = ['#', 'Agent Name', 'Total', 'âœ… Retained', 'âŒ Cancelled', 'Retention %', 'Top Cancel Reason', ...SC];
  let html = `<thead><tr>${hdrs.map((h, i) => `<th class="${i > 1 ? 'r' : ''}" onclick="sortTable(${i})">${h} ${sortCol === i ? (sortDir > 0 ? 'â†‘' : 'â†“') : ''}</th>`).join('')}</tr></thead><tbody id="agentBody">`;

  let rows = Object.entries(AGENT_DATA).map(([agent, d]) => {
    const rp = d.cancelled > 0 ? (d.retained / d.cancelled * 100) : (d.retained > 0 ? 100 : 0);
    const tr = Object.entries(d.rc).sort((a, b) => b[1] - a[1])[0]?.[0] || 'â€”';
    return { agent, d, rp, tr };
  });

  rows.sort((a, b) => {
    let va, vb;
    if (sortCol === 1) { va = a.agent; vb = b.agent; return sortDir * va.localeCompare(vb); }
    if (sortCol === 2) { va = a.d.total; vb = b.d.total; }
    else if (sortCol === 3) { va = a.d.retained; vb = b.d.retained; }
    else if (sortCol === 4) { va = a.d.cancelled; vb = b.d.cancelled; }
    else { va = a.rp; vb = b.rp; }
    return sortDir * (va - vb);
  });

  let gT = 0, gR = 0, gC = 0;
  rows.forEach(({ agent, d, rp, tr }, i) => {
    gT += d.total; gR += d.retained; gC += d.cancelled;
    const rc = rp >= 40 ? 'var(--green)' : rp >= 20 ? 'var(--orange)' : 'var(--red)';
    html += `<tr data-ag="${agent.toLowerCase()}">
      <td style="color:var(--muted);font-weight:700">${i + 1}</td>
      <td style="font-weight:700;font-family:'Syne',sans-serif;font-size:12px">${agent}</td>
      <td class="r"><span class="sb sb-blue">${d.total}</span></td>
      <td class="r" style="color:var(--green);font-weight:700">${d.retained}</td>
      <td class="r" style="color:var(--red);font-weight:700">${d.cancelled}</td>
      <td class="r">
        <span style="font-weight:800;color:${rc}">${rp.toFixed(1)}%</span>
        <div class="rate-bar-wrap" style="width:46px;display:inline-block;vertical-align:middle;margin-left:6px">
          <div class="rate-bar-fill" style="width:${Math.min(100, rp)}%;background:${rc}"></div>
        </div>
      </td>
      <td style="max-width:200px;font-size:10px;color:var(--muted2)">${tr.length > 40 ? tr.slice(0, 38) + '...' : tr}</td>
      ${SC.map(s => `<td class="r">${d.statuses[s] || 0}</td>`).join('')}
    </tr>`;
  });
  const grp = gC > 0 ? ((gR / gC) * 100).toFixed(1) : '0.0';
  html += `<tr class="grand"><td colspan="2">GRAND TOTAL</td><td class="r">${gT}</td>
    <td class="r" style="color:var(--green)">${gR}</td><td class="r" style="color:var(--red)">${gC}</td>
    <td class="r" style="color:${parseFloat(grp) >= 30 ? 'var(--green)' : 'var(--red)'}"><strong>${grp}%</strong></td>
    <td>â€”</td>${SC.map(s => `<td class="r">${ALL_STATUSES[s] || 0}</td>`).join('')}
  </tr></tbody>`;
  t.innerHTML = html;
}
function sortTable(col) { if (sortCol === col) sortDir *= -1; else { sortCol = col; sortDir = -1; } buildAgentTable(); }
function filterAgents() {
  const q = document.getElementById('cancelSearch').value.toLowerCase();
  document.querySelectorAll('#agentBody tr').forEach(tr => {
    if (tr.classList.contains('grand')) { tr.style.display = ''; return; }
    tr.style.display = (tr.getAttribute('data-ag') || '').includes(q) ? '' : 'none';
  });
}
function copyTable() {
  const rows = document.querySelectorAll('#agentTbl tr');
  const lines = [];
  rows.forEach(tr => {
    if (tr.style.display === 'none') return;
    const cells = tr.querySelectorAll('th,td');
    lines.push([...cells].map(c => c.innerText.replace(/\n/g, ' ').trim()).join('\t'));
  });
  navigator.clipboard.writeText(lines.join('\n'))
    .then(() => showToast('âœ… Table clipboard mein copy ho gaya!', 'ok'))
    .catch(() => showToast('âŒ Copy failed', 'err'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB 1: STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildStatusTab(total, retained, cancelled) {
  const sorted = Object.entries(ALL_STATUSES).sort((a, b) => b[1] - a[1]);
  const mx = sorted[0]?.[1] || 1;
  document.getElementById('statusBreakdown').innerHTML = sorted.map(([s, c]) => {
    const isR = s === 'RETAINED';
    return `<div class="reason-bar">
      <div class="reason-label"><span class="sb ${isR ? 'sb-green' : 'sb-red'}" style="margin-right:8px">${s}</span></div>
      <div class="reason-track" style="width:130px"><div class="reason-fill ${isR ? 'teal' : ''}" style="width:${(c / mx) * 100}%"></div></div>
      <div class="reason-count">${c}</div><div class="reason-pct">${((c / total) * 100).toFixed(1)}%</div>
    </div>`;
  }).join('');

  const rs = Object.entries(AGENT_DATA).filter(([, d]) => d.retained > 0).sort((a, b) => b[1].retained - a[1].retained).slice(0, 10);
  const mxR = rs[0]?.[1]?.retained || 1;
  document.getElementById('topRetainers').innerHTML = rs.map(([ag, d], i) => {
    const rp = d.cancelled > 0 ? ((d.retained / d.cancelled) * 100).toFixed(0) : '100';
    return `<div class="reason-bar">
      <div class="reason-label" style="display:flex;align-items:center;gap:8px">
        <span style="color:var(--muted);font-size:10px;min-width:18px">#${i + 1}</span>
        <span style="font-size:12px;font-weight:700">${ag}</span>
      </div>
      <div class="reason-track"><div class="reason-fill teal" style="width:${(d.retained / mxR) * 100}%"></div></div>
      <div class="reason-count" style="color:var(--green)">${d.retained}</div><div class="reason-pct">${rp}%</div>
    </div>`;
  }).join('') || '<p style="color:var(--muted);padding:20px;text-align:center">No retained records</p>';

  const hr = Object.entries(AGENT_DATA).filter(([, d]) => d.total >= 3)
    .map(([ag, d]) => ({ ag, ...d, rp: d.cancelled > 0 ? (d.retained / d.cancelled * 100) : 0 }))
    .sort((a, b) => a.rp - b.rp).slice(0, 15);
  document.getElementById('riskTbl').innerHTML = `<thead><tr><th>Agent</th><th class="r">Total</th><th class="r">Retained</th><th class="r">Cancelled</th><th class="r">Retention%</th><th>Risk</th></tr></thead><tbody>${
    hr.map(d => {
      const lbl = d.rp < 10 ? 'ğŸ”´ Critical' : d.rp < 25 ? 'ğŸŸ  High' : d.rp < 40 ? 'ğŸŸ¡ Medium' : 'ğŸŸ¢ Stable';
      const cls = d.rp < 10 ? 'sb-red' : d.rp < 25 ? 'sb-orange' : d.rp < 40 ? 'sb-yellow' : 'sb-green';
      return `<tr><td style="font-weight:700">${d.ag}</td><td class="r">${d.total}</td>
        <td class="r" style="color:var(--green)">${d.retained}</td>
        <td class="r" style="color:var(--red)">${d.cancelled}</td>
        <td class="r" style="font-weight:800;color:${d.rp < 25 ? 'var(--red)' : 'var(--orange)'}">${d.rp.toFixed(1)}%</td>
        <td><span class="sb ${cls}">${lbl}</span></td></tr>`;
    }).join('')
  }</tbody>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB 2: REASONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildReasonTab() {
  function renderBars(el, entries, cls) {
    const mx = entries[0]?.[1] || 1;
    const tot = entries.reduce((s, [, c]) => s + c, 0);
    el.innerHTML = entries.map(([r, c]) => `<div class="reason-bar">
      <div class="reason-label" style="font-size:11px">${r.length > 35 ? r.slice(0, 33) + '...' : r}</div>
      <div class="reason-track"><div class="reason-fill ${cls}" style="width:${(c / mx) * 100}%"></div></div>
      <div class="reason-count">${c}</div><div class="reason-pct">${((c / tot) * 100).toFixed(1)}%</div>
    </div>`).join('') || '<p style="color:var(--muted);font-size:12px">No data</p>';
  }
  renderBars(document.getElementById('cancelReasons'), Object.entries(ALL_REASONS_CANCEL).sort((a, b) => b[1] - a[1]).slice(0, 10), '');
  renderBars(document.getElementById('retainedReasons'), Object.entries(ALL_REASONS_RETAIN).sort((a, b) => b[1] - a[1]).slice(0, 10), 'teal');

  const agents = Object.entries(AGENT_DATA).sort((a, b) => b[1].total - a[1].total);
  let html = `<thead><tr><th>Agent</th><th class="r">Total</th><th class="r">Retained</th><th class="r">Cancelled</th><th>Top Reason</th><th>2nd Reason</th></tr></thead><tbody>`;
  for (const [ag, d] of agents) {
    const rs = Object.entries(d.rc).sort((a, b) => b[1] - a[1]);
    const r1 = rs[0]?.[0] || 'â€”', r2 = rs[1]?.[0] || 'â€”';
    html += `<tr data-ar="${ag.toLowerCase()}">
      <td style="font-weight:700">${ag}</td><td class="r">${d.total}</td>
      <td class="r" style="color:var(--green)">${d.retained}</td>
      <td class="r" style="color:var(--red)">${d.cancelled}</td>
      <td style="font-size:10px;max-width:180px;color:var(--muted2)">${r1.length > 36 ? r1.slice(0, 34) + '...' : r1}</td>
      <td style="font-size:10px;max-width:180px;color:var(--muted)">${r2.length > 36 ? r2.slice(0, 34) + '...' : r2}</td>
    </tr>`;
  }
  document.getElementById('reasonTbl').innerHTML = html + '</tbody>';
}
function filterReasons() {
  const q = document.getElementById('reasonSearch').value.toLowerCase();
  document.querySelectorAll('#reasonTbl tbody tr').forEach(tr => { tr.style.display = (tr.getAttribute('data-ar') || '').includes(q) ? '' : 'none'; });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB 3: HOURLY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildHourlyTab() {
  const hours = Array.from({ length: 24 }, (_, i) => i).filter(h => HOURLY_DATA[h]);
  if (!hours.length) { document.getElementById('cancelHourlyBreakdown').innerHTML = '<p style="color:var(--muted);font-size:12px;padding:20px">Time column nahi mila</p>'; return; }
  const mxT = Math.max(...hours.map(h => HOURLY_DATA[h].total)) || 1;
  let html = `<table><thead><tr><th>Hour</th><th class="r">Total</th><th class="r">Retained</th><th class="r">Cancelled</th><th class="r">Retention%</th><th>Volume</th></tr></thead><tbody>`;
  for (const h of hours.sort((a, b) => a - b)) {
    const d = HOURLY_DATA[h];
    const rp = d.cancelled > 0 ? ((d.retained / d.cancelled) * 100).toFixed(1) : '0.0';
    const cls = d.total > mxT * .7 ? 'hm-high' : d.total > mxT * .4 ? 'hm-med' : 'hm-low';
    const rc = parseFloat(rp) >= 40 ? 'var(--green)' : parseFloat(rp) >= 20 ? 'var(--orange)' : 'var(--red)';
    html += `<tr>
      <td class="${cls}" style="text-align:left">${String(h).padStart(2, '0')}:00â€“${String(h + 1).padStart(2, '0')}:00</td>
      <td class="r ${cls}">${d.total}</td>
      <td class="r" style="color:var(--green)">${d.retained}</td>
      <td class="r" style="color:var(--red)">${d.cancelled}</td>
      <td class="r" style="font-weight:700;color:${rc}">${rp}%</td>
      <td><div style="background:var(--border);border-radius:99px;height:6px;width:120px;overflow:hidden">
        <div style="background:linear-gradient(90deg,var(--teal),var(--blue));height:100%;width:${Math.round(d.total / mxT * 100)}%;border-radius:99px"></div>
      </div></td>
    </tr>`;
  }
  document.getElementById('cancelHourlyBreakdown').innerHTML = html + '</tbody></table>';

  const ph = [...hours].sort((a, b) => HOURLY_DATA[b].total - HOURLY_DATA[a].total).slice(0, 5);
  document.getElementById('peakHours').innerHTML = ph.map((h, i) => {
    const d = HOURLY_DATA[h];
    const rp = d.cancelled > 0 ? ((d.retained / d.cancelled) * 100).toFixed(1) : '0';
    return `<div class="reason-bar">
      <div class="reason-label">
        <span style="color:var(--muted);font-size:10px;min-width:20px;display:inline-block">#${i + 1}</span>
        <span style="font-family:'JetBrains Mono',monospace;font-weight:700">${String(h).padStart(2, '0')}:00â€“${String(h + 1).padStart(2, '0')}:00</span>
      </div>
      <div class="reason-track"><div class="reason-fill" style="width:${(d.total / (HOURLY_DATA[ph[0]].total || 1)) * 100}%"></div></div>
      <div class="reason-count">${d.total}</div>
      <div class="reason-pct" style="color:${parseFloat(rp) >= 30 ? 'var(--green)' : 'var(--red)'}">${rp}%</div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CI = {};
function destroyChart(id) { if (CI[id]) { CI[id].destroy(); delete CI[id]; } }
function buildCharts() {
  if (!Object.keys(AGENT_DATA).length) return;
  const topAgents = Object.entries(AGENT_DATA).sort((a, b) => b[1].total - a[1].total).slice(0, 10);
  const labels = topAgents.map(([a]) => a.length > 13 ? a.slice(0, 11) + '..' : a);
  const COPTS = {
    responsive: true,
    plugins: { legend: { labels: { color: '#94a3b8', font: { family: 'JetBrains Mono', size: 11 } } } },
    scales: {
      x: { ticks: { color: '#64748b', font: { size: 10 } }, grid: { color: 'rgba(30,45,69,.5)' } },
      y: { ticks: { color: '#64748b', font: { size: 10 } }, grid: { color: 'rgba(30,45,69,.5)' } }
    }
  };
  destroyChart('ab');
  CI['ab'] = new Chart(document.getElementById('chartAgentBar'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Total', data: topAgents.map(([, d]) => d.total), backgroundColor: 'rgba(59,130,246,.7)', borderRadius: 4 },
        { label: 'Retained', data: topAgents.map(([, d]) => d.retained), backgroundColor: 'rgba(16,185,129,.7)', borderRadius: 4 },
        { label: 'Cancelled', data: topAgents.map(([, d]) => d.cancelled), backgroundColor: 'rgba(239,68,68,.65)', borderRadius: 4 }
      ]
    },
    options: COPTS
  });
  destroyChart('sp');
  const statusEntries = Object.entries(ALL_STATUSES).sort((a, b) => b[1] - a[1]);
  CI['sp'] = new Chart(document.getElementById('chartStatusPie'), {
    type: 'doughnut',
    data: {
      labels: statusEntries.map(([s]) => s),
      datasets: [{ data: statusEntries.map(([, c]) => c), backgroundColor: ['#ef4444','#f97316','#eab308','#10b981','#3b82f6','#8b5cf6','#ec4899','#14b8a6'], borderWidth: 2, borderColor: '#101828' }]
    },
    options: { responsive: true, plugins: { legend: { labels: { color: '#94a3b8', font: { family: 'JetBrains Mono', size: 11 } } } } }
  });
  destroyChart('rb');
  const retSorted = Object.entries(AGENT_DATA).map(([a, d]) => ({ a, rp: d.cancelled > 0 ? d.retained / d.cancelled * 100 : 0 })).sort((x, y) => y.rp - x.rp).slice(0, 10);
  CI['rb'] = new Chart(document.getElementById('chartRetBar'), {
    type: 'bar',
    data: {
      labels: retSorted.map(r => r.a.length > 13 ? r.a.slice(0, 11) + '..' : r.a),
      datasets: [{ label: 'Retention %', data: retSorted.map(r => parseFloat(r.rp.toFixed(1))), backgroundColor: retSorted.map(r => r.rp >= 40 ? 'rgba(16,185,129,.7)' : r.rp >= 20 ? 'rgba(249,115,22,.7)' : 'rgba(239,68,68,.7)'), borderRadius: 4 }]
    },
    options: COPTS
  });
  destroyChart('rsb');
  const topReasons = Object.entries(ALL_REASONS_CANCEL).sort((a, b) => b[1] - a[1]).slice(0, 8);
  CI['rsb'] = new Chart(document.getElementById('chartReasonBar'), {
    type: 'bar',
    data: {
      labels: topReasons.map(([r]) => r.length > 28 ? r.slice(0, 26) + '..' : r),
      datasets: [{ label: 'Count', data: topReasons.map(([, c]) => c), backgroundColor: 'rgba(239,68,68,.7)', borderRadius: 4 }]
    },
    options: { ...COPTS, indexAxis: 'y' }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TARGET TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let AGENT_TARGETS = {};
function loadTargets() {
  try { AGENT_TARGETS = JSON.parse(localStorage.getItem('lv_targets') || '{}'); renderTargets(); showToast('âœ… Targets loaded!', 'ok'); } catch (e) { }
}
function saveTargets() {
  document.querySelectorAll('.tnum').forEach(inp => { const ag = inp.getAttribute('data-ag'); if (ag) AGENT_TARGETS[ag] = parseInt(inp.value) || 0; });
  localStorage.setItem('lv_targets', JSON.stringify(AGENT_TARGETS));
  showToast('ğŸ’¾ Targets saved!', 'ok');
}
function renderTargets() {
  if (!Object.keys(AGENT_DATA).length) return;
  const teamTarget = parseInt(document.getElementById('teamTargetPct').value) || 30;
  const agents = Object.keys(AGENT_DATA).sort((a, b) => AGENT_DATA[b].total - AGENT_DATA[a].total);
  let html = `<thead><tr><th>#</th><th>Agent</th><th class="r">Total</th><th class="r">Retained</th><th class="r">Cancelled</th><th class="r">Actual%</th><th style="text-align:center">Target%</th><th>Progress</th><th>Status</th></tr></thead><tbody>`;
  let teamMet = 0;
  agents.forEach((ag, i) => {
    const d = AGENT_DATA[ag];
    const actual = d.cancelled > 0 ? (d.retained / d.cancelled * 100) : 0;
    const tgt = AGENT_TARGETS[ag] || teamTarget;
    const prog = tgt > 0 ? Math.min(100, (actual / tgt) * 100) : 0;
    const met = actual >= tgt;
    if (met) teamMet++;
    const bc = met ? 'var(--green)' : prog >= 70 ? 'var(--orange)' : 'var(--red)';
    html += `<tr>
      <td style="color:var(--muted);font-weight:700">${i + 1}</td>
      <td style="font-weight:700;font-family:'Syne',sans-serif;font-size:12px">${ag}</td>
      <td class="r">${d.total}</td>
      <td class="r" style="color:var(--green)">${d.retained}</td>
      <td class="r" style="color:var(--red)">${d.cancelled}</td>
      <td class="r" style="font-weight:800;color:${met?'var(--green)':'var(--red)'}">${actual.toFixed(1)}%</td>
      <td style="text-align:center"><input type="number" class="tnum" data-ag="${ag}" value="${tgt}" min="0" max="200" oninput="renderTargets()" style="width:60px;text-align:center;background:var(--card2);border:1px solid var(--border2);border-radius:6px;padding:5px;color:var(--text);font-size:12px;font-family:'JetBrains Mono',monospace"></td>
      <td><div style="display:flex;align-items:center;gap:8px">
        <div class="target-bar-wrap"><div class="target-bar-fill" style="width:${prog}%;background:${bc}"></div></div>
        <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted2);width:30px">${Math.round(prog)}%</span>
      </div></td>
      <td><span class="sb ${met?'sb-green':'sb-red'}">${met?'âœ… Met':'âŒ Miss'}</span></td>
    </tr>`;
  });
  document.getElementById('targetTbl').innerHTML = html + '</tbody>';
  const sp = agents.length > 0 ? (teamMet / agents.length * 100).toFixed(0) : 0;
  document.getElementById('teamSummary').innerHTML = `<div style="display:flex;gap:16px;flex-wrap:wrap">
    <div style="text-align:center"><div style="font-size:24px;font-weight:800;color:var(--green)">${teamMet}</div><div style="font-size:10px;color:var(--muted2);font-family:'JetBrains Mono',monospace;text-transform:uppercase">Met</div></div>
    <div style="text-align:center"><div style="font-size:24px;font-weight:800;color:var(--red)">${agents.length - teamMet}</div><div style="font-size:10px;color:var(--muted2);font-family:'JetBrains Mono',monospace;text-transform:uppercase">Miss</div></div>
    <div style="text-align:center"><div style="font-size:24px;font-weight:800;color:${sp>=70?'var(--green)':'var(--orange)'}">${sp}%</div><div style="font-size:10px;color:var(--muted2);font-family:'JetBrains Mono',monospace;text-transform:uppercase">Team Score</div></div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUYBACK CALCULATOR (exact Excel formula)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BB = {
  RR: 423.728813559322, MC: 5932.2033898305, PF: 200, INST: 250,
  PG: 0.016, CAC: 1200, AI: 0.12, MI: 0.01, DEP: 61.7937853107343, ACMC: 100, MARGIN: 0.3
};
function calcCancelBuyback() {
  const m12 = parseInt(document.getElementById('bb12').value) || 0;
  const m6  = parseInt(document.getElementById('bb6').value) || 0;
  const m3  = parseInt(document.getElementById('bb3').value) || 0;
  const m1  = parseInt(document.getElementById('bb1').value) || 0;
  const months = m12*12 + m6*6 + m3*3 + m1;
  document.getElementById('bbTotalMonths').textContent = months;
  if (months === 0) { document.getElementById('bbResult').style.display = 'none'; document.getElementById('bbEmpty').style.display = 'block'; return; }

  const dep = parseInt(document.getElementById('bbDeposit').value) || 0;
  const mi = BB.MI, MC = BB.MC, RR = BB.RR, PG = BB.PG;

  // Excel formula chain (E4 to E19)
  const E4  = RR * ((1 + mi)**months - 1) / mi * (1 - PG);
  const E5  = BB.DEP * months;
  const E6  = (MC - 1500) * BB.AI * months / 12;
  const E7  = BB.INST * (1 + BB.AI)**(months / 12);
  const E8  = BB.ACMC * ((1 + mi)**months - 1) / mi;
  const E9  = BB.PF * (1 + BB.AI)**(months / 12);
  const E10 = (MC - E5) * 0.02;
  const E11 = BB.CAC * (1 + BB.AI)**(months / 12);
  const E12 = E5 + E6 + E7 + E8 + E9 + E10 + E11;
  const E14 = MC - E5;
  const E15 = E12 + E14;
  const E18 = E15 / (1 - BB.MARGIN);
  const E19 = E18 - E4;
  const beforeMin = E19 * 1.18 / (1 - PG);
  const base = Math.max(beforeMin, 5000);

  let discount = 0;
  if (document.getElementById('bbDiscount').checked) {
    if (base >= 11000) discount = 1000;
    else if (base >= 6500) discount = 500;
  }
  const deductDep = document.getElementById('bbDeductDep').checked ? dep : 0;
  const final = Math.round(base - discount - deductDep);
  const fmt = n => 'â‚¹' + Math.round(n).toLocaleString('en-IN');

  document.getElementById('bbFinal').textContent = fmt(final);
  document.getElementById('bbLabel').textContent = `${months} months | ${m12}Ã—12m + ${m6}Ã—6m + ${m3}Ã—3m + ${m1}Ã—1m`;
  document.getElementById('bbBreakdown').innerHTML = `
    <div class="bb-step">ğŸ“Š Formula: (Revenue Gap Ã— 1.18) Ã· (1âˆ’PG%) | Min â‚¹5000</div>
    <div class="bb-step">E4 Present Value Revenue: ${fmt(E4)}</div>
    <div class="bb-step">E5 Depreciation: ${fmt(E5)}</div>
    <div class="bb-step">E12 Total Costs: ${fmt(E12)}</div>
    <div class="bb-step">E14 Machine Value: ${fmt(E14)}</div>
    <div class="bb-step">E15 Total Cost on Buyback: ${fmt(E15)}</div>
    <div class="bb-step">E18 Revenue with Margin: ${fmt(E18)}</div>
    <div class="bb-step">E19 Revenue Gap: ${fmt(E19)}</div>
    <div class="bb-step">Base Buyback (min â‚¹5000): ${fmt(base)}</div>
    ${discount > 0 ? `<div class="bb-step adj">âˆ’ Discount: ${fmt(discount)}</div>` : ''}
    ${deductDep > 0 ? `<div class="bb-step adj">âˆ’ Deposit: ${fmt(deductDep)}</div>` : ''}
    <div class="bb-step">âœ… Final Buyback: ${fmt(final)}</div>`;
  document.getElementById('bbResult').style.display = 'block';
  document.getElementById('bbEmpty').style.display = 'none';
}
function toggleBreakdown() {
  const bd = document.getElementById('bbBreakdown');
  const btn = event.target;
  if (bd.style.display === 'none') { bd.style.display = 'block'; btn.textContent = 'ğŸ”¼ Hide Details'; }
  else { bd.style.display = 'none'; btn.textContent = 'ğŸ” Details'; }
}
function copyBuyback() {
  const amt = document.getElementById('bbFinal').textContent;
  navigator.clipboard.writeText(amt).then(() => showToast('âœ… ' + amt + ' copy ho gaya!', 'ok'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY (localStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveToHistory(fileName, total, ret, can, retPct) {
  try {
    const hist = JSON.parse(localStorage.getItem('lv_hist') || '[]');
    hist.unshift({ id: Date.now(), fileName, total, retained: ret, cancelled: can, retPct, date: new Date().toLocaleString('en-IN'), agents: Object.keys(AGENT_DATA).length });
    if (hist.length > 20) hist.splice(20);
    localStorage.setItem('lv_hist', JSON.stringify(hist));
    updateHistCount();
  } catch (e) { }
}
function renderHistory() {
  const hist = JSON.parse(localStorage.getItem('lv_hist') || '[]');
  document.getElementById('histBadge').textContent = hist.length + ' reports';
  document.getElementById('histEmpty').style.display = hist.length ? 'none' : 'block';
  document.getElementById('histList').innerHTML = hist.map(h => `
    <div class="hist-item">
      <span style="font-size:24px">ğŸ“‚</span>
      <div class="hist-info">
        <div class="hist-name">${h.fileName}</div>
        <div class="hist-meta">ğŸ•’ ${h.date} Â· ${h.agents} agents</div>
      </div>
      <div class="hist-stats">
        <div class="hist-stat"><div class="v" style="color:var(--teal)">${h.total}</div><div class="l">Total</div></div>
        <div class="hist-stat"><div class="v" style="color:var(--green)">${h.retained}</div><div class="l">Ret</div></div>
        <div class="hist-stat"><div class="v" style="color:var(--red)">${h.cancelled}</div><div class="l">Can</div></div>
        <div class="hist-stat"><div class="v" style="color:var(--orange)">${h.retPct}%</div><div class="l">%</div></div>
      </div>
      <button class="hist-del" onclick="deleteHist(${h.id})">ğŸ—‘</button>
    </div>`).join('');
}
function deleteHist(id) {
  let hist = JSON.parse(localStorage.getItem('lv_hist') || '[]');
  hist = hist.filter(h => h.id !== id);
  localStorage.setItem('lv_hist', JSON.stringify(hist));
  renderHistory(); updateHistCount(); showToast('ğŸ—‘ Deleted', 'ok');
}
function clearHistory() {
  if (!confirm('Poori history delete karo?')) return;
  localStorage.removeItem('lv_hist'); renderHistory(); updateHistCount(); showToast('ğŸ—‘ History cleared', 'ok');
}
function updateHistCount() {
  const hist = JSON.parse(localStorage.getItem('lv_hist') || '[]');
  const el = document.getElementById('histCount');
  if(el) el.textContent = hist.length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXCEL EXPORT (4 sheets)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportExcel() {
  const btn = document.getElementById('excelBtn');
  btn.disabled = true; btn.textContent = 'â³ Generating...';
  try {
    const wb = new ExcelJS.Workbook(); wb.creator = 'Pranamya Upadhyay'; wb.created = new Date();
    const C = { DK:'FF0A1628', HD:'FF0F1E35', TL:'FF14B8A6', GR:'FF10B981', RD:'FFEF4444', OR:'FFF97316', WH:'FFF1F5F9', MT:'FF64748B' };
    function sty(cell, {bold=false,fg=C.WH,bg=null,sz=11,h='left',fmt=null,wrap=false}={}) {
      cell.font = {bold, color:{argb:fg}, size:sz, name:'Calibri'};
      cell.alignment = {horizontal:h, vertical:'middle', wrapText:wrap};
      if (bg) cell.fill = {type:'pattern', pattern:'solid', fgColor:{argb:bg}};
      if (fmt) cell.numFmt = fmt;
    }
    const SC = Object.keys(ALL_STATUSES).sort();
    const agents = Object.keys(AGENT_DATA).sort((a,b) => AGENT_DATA[b].total - AGENT_DATA[a].total);

    // Sheet 1: Agent Report
    const ws1 = wb.addWorksheet('Agent Report', {views:[{state:'frozen',ySplit:3}], properties:{tabColor:{argb:'14B8A6'}}});
    ws1.mergeCells(1,1,1,7+SC.length); ws1.getCell(1,1).value = `LIVSMART â€” Cancellation & Retention v3  |  ${CUR_FILE}  |  Retention% = RetainedÃ·CancelledÃ—100`;
    sty(ws1.getCell(1,1), {bold:true,fg:C.WH,bg:C.DK,sz:12,h:'center'}); ws1.getRow(1).height = 26;
    ws1.mergeCells(2,1,2,7+SC.length); ws1.getCell(2,1).value = `Generated: ${new Date().toLocaleString('en-IN')}  |  Bug Fixed: CSV trailing spaces handled`;
    sty(ws1.getCell(2,1), {fg:C.MT,bg:C.HD,sz:10,h:'center'}); ws1.getRow(2).height = 18;
    ['#','Agent','Total','Retained','Cancelled','Retention%','Top Cancel Reason',...SC].forEach((h,i)=>{ const c=ws1.getCell(3,i+1); c.value=h; sty(c,{bold:true,fg:C.WH,bg:C.HD,sz:10,h:i>1?'center':'left'}); });
    ws1.getRow(3).height = 22;
    ws1.getColumn(1).width=5; ws1.getColumn(2).width=28; ws1.getColumn(3).width=10;
    ws1.getColumn(4).width=12; ws1.getColumn(5).width=12; ws1.getColumn(6).width=14; ws1.getColumn(7).width=42;
    SC.forEach((_,i)=>ws1.getColumn(8+i).width=16);
    let gT=0,gR=0,gC=0;
    agents.forEach((ag,i)=>{
      const d=AGENT_DATA[ag]; gT+=d.total; gR+=d.retained; gC+=d.cancelled;
      const rp=d.cancelled>0?(d.retained/d.cancelled):0;
      const rpC=rp*100>=40?C.GR:rp*100>=20?C.OR:C.RD;
      const tr=Object.entries(d.rc).sort((a,b)=>b[1]-a[1])[0]?.[0]||'â€”';
      const bg=i%2===0?C.DK:C.HD; const row=ws1.getRow(4+i); row.height=20;
      [i+1,ag,d.total,d.retained,d.cancelled,rp,tr,...SC.map(s=>d.statuses[s]||0)].forEach((v,j)=>{
        const c=row.getCell(j+1); c.value=v;
        sty(c,{fg:j===3?C.GR:j===4?C.RD:j===5?rpC:C.WH,bg,bold:j===5,sz:11,h:j>1?'center':'left',fmt:j===5?'0.0%':null});
      });
    });
    const grp=gC>0?gR/gC:0; const gtRow=ws1.getRow(4+agents.length); gtRow.height=24;
    ['GRAND TOTAL','',gT,gR,gC,grp,'â€”',...SC.map(s=>ALL_STATUSES[s]||0)].forEach((v,j)=>{
      const c=gtRow.getCell(j+1); c.value=v; sty(c,{bold:true,fg:C.WH,bg:'FF060D1C',sz:12,h:j>1?'center':'left',fmt:j===5?'0.0%':null});
    });

    // Sheet 2: Status
    const ws2=wb.addWorksheet('Status Breakdown',{properties:{tabColor:{argb:'F97316'}}});
    ws2.mergeCells(1,1,1,4); ws2.getCell(1,1).value='Status Distribution'; sty(ws2.getCell(1,1),{bold:true,fg:C.WH,bg:C.DK,sz:13,h:'center'}); ws2.getRow(1).height=26;
    ['Status','Count','% of Total','Type'].forEach((h,i)=>{const c=ws2.getCell(2,i+1);c.value=h;sty(c,{bold:true,fg:C.WH,bg:C.HD,sz:10,h:'center'});});
    ws2.getRow(2).height=20; ws2.getColumn(1).width=22; ws2.getColumn(2).width=12; ws2.getColumn(3).width=14; ws2.getColumn(4).width=18;
    const tot2=Object.values(ALL_STATUSES).reduce((a,b)=>a+b,0);
    Object.entries(ALL_STATUSES).sort((a,b)=>b[1]-a[1]).forEach(([s,c],i)=>{
      const isR=s==='RETAINED'; const row=ws2.getRow(3+i); row.height=18;
      [s,c,c/tot2,isR?'Positive':'Cancellation'].forEach((v,j)=>{const cell=row.getCell(j+1);cell.value=v;sty(cell,{fg:isR?C.GR:C.RD,bg:i%2===0?C.DK:C.HD,bold:isR,h:j===0?'left':'center',fmt:j===2?'0.0%':null});});
    });

    // Sheet 3: Reasons
    const ws3=wb.addWorksheet('Cancel Reasons',{properties:{tabColor:{argb:'EF4444'}}});
    ws3.mergeCells(1,1,1,3); ws3.getCell(1,1).value='Top Cancellation Reasons'; sty(ws3.getCell(1,1),{bold:true,fg:C.WH,bg:C.DK,sz:13,h:'center'}); ws3.getRow(1).height=26;
    ['Reason','Count','%'].forEach((h,i)=>{const c=ws3.getCell(2,i+1);c.value=h;sty(c,{bold:true,fg:C.WH,bg:C.HD,sz:10,h:i===0?'left':'center'});});
    ws3.getRow(2).height=20; ws3.getColumn(1).width=52; ws3.getColumn(2).width=12; ws3.getColumn(3).width=16;
    const totCan=Object.values(ALL_REASONS_CANCEL).reduce((a,b)=>a+b,0);
    Object.entries(ALL_REASONS_CANCEL).sort((a,b)=>b[1]-a[1]).forEach(([r,c],i)=>{
      const row=ws3.getRow(3+i); row.height=18;
      [r,c,c/totCan].forEach((v,j)=>{const cell=row.getCell(j+1);cell.value=v;sty(cell,{fg:C.WH,bg:i%2===0?C.DK:C.HD,h:j===0?'left':'center',fmt:j===2?'0.0%':null,wrap:j===0});});
    });

    // Sheet 4: Targets
    const ws4=wb.addWorksheet('Target Tracker',{properties:{tabColor:{argb:'8B5CF6'}}});
    ws4.mergeCells(1,1,1,7); ws4.getCell(1,1).value='Team Target Tracker'; sty(ws4.getCell(1,1),{bold:true,fg:C.WH,bg:C.DK,sz:13,h:'center'}); ws4.getRow(1).height=26;
    ['Agent','Total','Retained','Cancelled','Actual%','Target%','Status'].forEach((h,i)=>{const c=ws4.getCell(2,i+1);c.value=h;sty(c,{bold:true,fg:C.WH,bg:C.HD,sz:10,h:i===0?'left':'center'});});
    ws4.getRow(2).height=20; ws4.getColumn(1).width=28; [2,3,4,5,6,7].forEach(i=>ws4.getColumn(i).width=14);
    const tt=parseInt(document.getElementById('teamTargetPct').value)||30;
    agents.forEach((ag,i)=>{
      const d=AGENT_DATA[ag]; const ac=d.cancelled>0?(d.retained/d.cancelled):0; const tgt=(AGENT_TARGETS[ag]||tt)/100; const met=ac>=tgt;
      const row=ws4.getRow(3+i); row.height=18;
      [ag,d.total,d.retained,d.cancelled,ac,tgt,met?'Met':'Miss'].forEach((v,j)=>{
        const c=row.getCell(j+1);c.value=v;sty(c,{fg:j===4||j===6?(met?C.GR:C.RD):C.WH,bg:i%2===0?C.DK:C.HD,h:j===0?'left':'center',fmt:(j===4||j===5)?'0.0%':null});
      });
    });

    const buf=await wb.xlsx.writeBuffer();
    const blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    const ts=new Date();
    a.download=`Livsmart_Cancel_v3_${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,'0')}${String(ts.getDate()).padStart(2,'0')}.xlsx`;
    a.click(); URL.revokeObjectURL(a.href);
    showToast('âœ… Excel downloaded!', 'ok');
  } catch (err) { alert('Export error: ' + err.message); }
  finally { btn.disabled = false; btn.textContent = 'â¬‡ Excel'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// showToast defined in main engine above; toastT is shared
function switchCancelTabInner(idx) { ["ct0","ct1","ct2","ct3"].forEach((id,i)=>{ const el=document.getElementById(id); if(el) el.style.display=i===idx?"block":"none"; }); }
function resetTool() {
  AGENT_DATA={}; HOURLY_DATA={}; ALL_STATUSES={}; ALL_REASONS_CANCEL={}; ALL_REASONS_RETAIN={};
  document.getElementById('cancelResults').style.display='none';
  document.getElementById('cancelUpZone').style.display='block';
  document.getElementById('fileInput').value='';
  document.getElementById('cancelFileBadge').style.display='none';
  document.getElementById('chartsContent').style.display='none';
  document.getElementById('chartsEmptyNote').style.display='inline';
  document.getElementById('targetEmpty').style.display='block';
  document.getElementById('targetContent').style.display='none';
  Object.values(CI).forEach(c => c.destroy()); CI={};
  switchTab(0); prog(0,''); showToast('ğŸ”„ Reset!','ok');
}

// Init
(function(){ const el=document.getElementById('histCount'); if(el) updateHistCount(); })();

// Cancel tool tab switching wrapper
function switchCancelTab(idx) {
  ['ct0','ct1','ct2','ct3'].forEach((id,i) => {
    const el = document.getElementById(id);
    if(el) el.style.display = i===idx?'block':'none';
  });
  document.querySelectorAll('#panel-cancel .tab-btn').forEach((b,i) => {
    b.classList[i===idx?'add':'remove']('on');
  });
}
function initCancelPanel() {
  initCancel && initCancel();
  renderCancelTags();
}
function toggleAllCancel(val) { toggleAll(val); }
function addCancelAgent() { addAgent(); }
function cancelOnDrag2(e) { e.preventDefault(); document.getElementById('cancelUpZone').classList.add('drag'); }
function cancelOnDrag2Leave() { document.getElementById('cancelUpZone').classList.remove('drag'); }
function onCancelDrop(e) { e.preventDefault(); onCancelDragLeave(); if(e.dataTransfer.files[0]) processCancelFile(e.dataTransfer.files[0]); }
function handleCancelFile(el) { if(el.files[0]) processCancelFile(el.files[0]); }
function checkCancelDate() {
  const f = document.getElementById('cancelDateFrom').value;
  const t = document.getElementById('cancelDateTo').value;
  const badge = document.getElementById('cancelDateBadge');
  if(badge) badge.style.display = (f||t)?'inline-flex':'none';
}
function clearCancelDates() {
  ['cancelDateFrom','cancelDateTo'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const badge=document.getElementById('cancelDateBadge'); if(badge) badge.style.display='none';
}
function resetCancelTool() { resetReport && resetReport(); document.getElementById('cancelResults').style.display='none'; }
function filterCancelAgents() { renderAgentTable && renderAgentTable(); }


// â•â•â•â• AI REMARKS ENGINE â•â•â•â•
// â”€â”€ AUTH CHECK â”€â”€ auto-fill from Firebase session
(function(){
  try {
    var p = JSON.parse(localStorage.getItem('lv_profile')||'null');
    if(!p) { window.location.href='index.html'; return; }
    // Agent name auto-fill from Firebase profile
    var savedName = localStorage.getItem('lv_aname') || p.name || '';
    if(savedName) {
      var el = document.getElementById('rmAgent');
      if(el){ el.value = savedName; el.disabled = true; el.title = 'Firebase se auto-fill hua'; }
    }
  } catch(e){}
})();

var SEL={}, SC={};
var EXTRA = JSON.parse(localStorage.getItem('lv_extra')||'[]');
var HIST  = JSON.parse(localStorage.getItem('lv_hist2')||'[]');

// Agent name is auto-filled from Firebase â€” but allow manual override if needed
var _agentEl = document.getElementById('rmAgent');
if(_agentEl && !_agentEl.value) {
  _agentEl.value = localStorage.getItem('lv_aname')||'';
}
if(_agentEl) _agentEl.oninput = function(){ localStorage.setItem('lv_aname', this.value); };

var _sk = localStorage.getItem('lv_groq_key')||'';
if(_sk){ document.getElementById('rmApiKey').value=_sk; updateKeyStatus(_sk); }

renderExtra(); renderHist();

// Panel toggle
function togglePanel(){
  var p=document.getElementById('scPanel');
  p.classList.toggle('open');
}

// Sc count update
function updateScCount(){
  var n=Object.keys(SC).filter(function(k){return SC[k];}).length;
  var el=document.getElementById('scCount');
  if(n>0){ el.textContent=n+' selected'; el.classList.add('show'); }
  else { el.classList.remove('show'); }
}

function togSc(k){
  SC[k]=!SC[k];
  var e=document.getElementById('sc-'+k);
  if(e) e.className='sc-chip'+(SC[k]?' on':'');
  updateScCount();
}

function tog(k){
  SEL[k]=!SEL[k];
  var e=document.getElementById('chip-'+k);
  if(!e) return;
  var base=e.className.replace(' on','');
  e.className=base+(SEL[k]?' on':'');
}

function renderExtra(){
  var h='';
  EXTRA.forEach(function(t){
    var on=SEL[t.id]?' on':'';
    h+='<div class="team-chip team-chip-e'+on+'" id="chip-'+t.id+'" onclick="togE(\''+t.id+'\')">'+t.name+'</div> ';
  });
  document.getElementById('extraTeamChips').innerHTML=h;
}
function togE(id){ SEL[id]=!SEL[id]; var e=document.getElementById('chip-'+id); if(e)e.className='team-chip team-chip-e'+(SEL[id]?' on':''); }

// â”€â”€ KEY â”€â”€
function saveKey(){
  var k=document.getElementById('rmApiKey').value.trim();
  if(!k){ toast('Key daalo pehle','err'); return; }
  if(!k.startsWith('gsk_')){ toast('Invalid key â€” gsk_ se shuru honi chahiye','err'); return; }
  localStorage.setItem('lv_groq_key',k);
  updateKeyStatus(k);
  toast('Groq Key saved âœ“','ok');
}
function updateKeyStatus(k){
  var el=document.getElementById('keyStatus');
  if(!el) return;
  if(k&&k.startsWith('gsk_')){ el.textContent='âœ“'; el.style.color='var(--green)'; }
  else { el.textContent='âœ—'; el.style.color='var(--red)'; }
}

// â”€â”€ AUTO DETECT â”€â”€
function detect(t){
  t=t.toLowerCase(); var s=[];
  if(/senior.?tech|senior.?technician/.test(t)) s.push('senior');
  else if(/tech.?visit|technician|engineer|arrange.?tech/.test(t)) s.push('tech');
  if(/replac/.test(t)) s.push('replace');
  if(/buyback|buy.?back|link shared|link send/.test(t)) s.push('buyback');
  if(/tds|taste|smell|water quality/.test(t)) s.push('tds');
  if(/pcb/.test(t)) s.push('pcb');
  if(/sync|syncing|connectivity|connect/.test(t)) s.push('sync');
  if(/recurring|multiple.?issue|multiple.?error/.test(t)) s.push('recurring');
  if(/delay.?service|service.?delay|delay.?install/.test(t)) s.push('delay');
  if(/flow.?sensor|consumption.*zero|zero.*consumption/.test(t)) s.push('flow');
  if(/litre.*finish|finish.*earl|exhausted.*earl|consumption.*issue|incorrect.*consumption/.test(t)) s.push('consumption');
  if(/leakage|leak/.test(t)) s.push('leakage');
  if(/filter.?change|filter.?replac/.test(t)) s.push('filter');
  if(/beep/.test(t)) s.push('beep');
  if(/reinstall/.test(t)) s.push('reinstall');
  if(/not feasible|nf area|not serviceab|shifting.*not.*service|out of city.*service not/.test(t)) s.push('shift-nf');
  else if(/shift|reloc|pickup/.test(t)) s.push('shift-sv');
  if(/ownership|ot|transfer/.test(t)) s.push('ownership');
  if(/purchased.*new.*ro|new.*ro|buy.*new|own.*ro/.test(t)) s.push('newro');
  if(/competitor|cheaper|other.*brand|drinkprime|kent|aquaguard/.test(t)) s.push('competitor');
  if(/billing.?cycle|billing.?issue|not happy with billing/.test(t)) s.push('billing');
  if(/negative.?balance|neg.?balance/.test(t)) s.push('negbal');
  if(/holiday.?plan/.test(t)) s.push('holiday');
  if(/custom.?plan|coupon|500.?rs|250.?rs|6.?month.?offer/.test(t)) s.push('customplan');
  if(/price.?hike|recent.?price/.test(t)) s.push('pricehike');
  if(/consumer.?court|court/.test(t)) s.push('court');
  if(/locking|lock.?period|90.?days/.test(t)) s.push('locking');
  if(/refurb/.test(t)) s.push('refurb');
  if(/waive.?off|waiveoff/.test(t)) s.push('waiveoff');
  if(/low.?cons|consumption.?low/.test(t)) s.push('lowcons');
  if(/tds.?controller/.test(t)) s.push('tdsctrl');
  if(/angry|frustrat|escalat|unsatisfied/.test(t)) s.push('angry');
  return s;
}

// â”€â”€ REMARKS â”€â”€
function genRemarks(rough,agent,sc,ex){
  var s={};sc.forEach(function(k){s[k]=true;});
  var bb=ex.bb,gg=ex.gg,vb=ex.visitBy,det=ex.detail;
  var lines=[];
  if(s.court){lines.push('Customer informed that due to delay in service, he has purchased a new RO from another brand.');lines.push('Customer is highly dissatisfied and stated that he may proceed with a complaint in consumer court.');if(s.locking)lines.push('As per policy, account is currently under locking period. No cancellation request has been raised as of now.');else lines.push('As of now, no cancellation request has been raised from customer\'s end. Case handled and documented accordingly.');return lines.join('\n');}
  if(s.tdsctrl){lines.push('Customer wanted TDS controller installation before RO installation.');lines.push('Informed the customer that as per process, RO installation needs to be completed first. Post-installation, TDS level will be checked, and TDS controller can only be installed if TDS level is found to be low.');lines.push('Customer agreed to the process. Case retained on technician visit.');return lines.join('\n');}
  if(s.holiday){lines.push('Customer raised cancellation concern due to holiday plan / recharge issue.');lines.push('Informed customer about the correct recharge process. Customer was advised to make a fresh normal recharge after which the machine will be activated.');lines.push('Customer agreed to continue. Hence, case retained.');return lines.join('\n');}
  if(s.negbal){if(s.waiveoff){lines.push('Customer raised cancellation concern due to negative balance in account.');lines.push('Waive off has been requested. Mail shared to senior for approval of waive off amount.');lines.push('Customer agreed to wait for waive off confirmation. Hence, case retained.');}else{lines.push('Customer raised cancellation concern due to not being happy with the negative balance policy.');lines.push('All information regarding the policy was shared with the customer.');lines.push(gg?gg+' days validity extension given. Customer agreed on the same. Hence, case retained.':'Customer agreed to continue after information shared. Hence, case retained.');}return lines.join('\n');}
  if(s.billing){lines.push('Customer raised cancellation concern due to billing cycle issue.');if(gg)lines.push(gg+' days validity extension provided to customer as goodwill gesture.');else lines.push('All information regarding the billing cycle and plan was shared with the customer.');lines.push('Customer agreed to continue. Hence, case retained.');return lines.join('\n');}
  if(s.ownership&&!s['shift-nf']&&!s.buyback){lines.push('Customer raised cancellation concern'+(s['shift-sv']?' due to shifting':'')+'.');lines.push('Ownership transfer option was suggested and process was explained to the customer.');lines.push('Customer agreed to think about it and confirm. Hence, case retained pending customer confirmation.');return lines.join('\n');}
  if(s['shift-nf']){lines.push('Customer raised cancellation concern due to shifting to a non-serviceable area.');if(s.buyback){var amt=bb?'â‚¹'+bb:'the applicable buyback amount';lines.push('As service is not available at the new location, buyback option was suggested and offered at '+amt+'.');lines.push('Customer '+(bb?'agreed on the buyback amount':'will confirm after discussing')+'.');if(s.ownership)lines.push('Ownership transfer option was also suggested as an alternative.');lines.push('Hence, case retained.');}else if(s.ownership){lines.push('Ownership transfer option was suggested as service is not available at new location. Customer agreed to consider and confirm. Hence, case retained.');}else{lines.push('Buyback and ownership transfer options were suggested. Customer will think and confirm. Hence, case retained for now.');}return lines.join('\n');}
  if(s['shift-sv']||s['shift-nc']){lines.push('Customer raised cancellation concern due to shifting'+(s['shift-nc']?' (location not yet confirmed)':'')+'.');if(s.buyback){var amt2=bb?'â‚¹'+bb:'the applicable amount';lines.push('Buyback option was suggested at '+amt2+'. Customer will confirm after discussion. Hence, case retained.');}else if(s.ownership){lines.push('Ownership transfer option was explained. Customer agreed to process accordingly. Hence, case retained.');}else{lines.push('Shifting process was explained in detail. Difference between company pickup and self-pickup options along with charges was shared. Customer agreed to proceed with self-pickup shifting. Hence, case retained.');}return lines.join('\n');}
  if(s.newro){if(s.buyback){var amt3=bb?'â‚¹'+bb:'the applicable buyback amount';lines.push('Customer raised cancellation concern as he/she has purchased a new RO from another brand.');lines.push('Buyback option was suggested and offered at '+amt3+(bb?' after adjusting all applicable charges':'')+'.');lines.push('Customer '+(bb?'agreed on the amount and will confirm after discussion.':'will decide and update.')+' Hence, case retained on buyback offer.');}else if(s.ownership){lines.push('Customer raised cancellation concern as he/she has purchased a new RO. Ownership transfer option was suggested. Customer agreed to consider and confirm. Hence, case retained.');}else{lines.push('Customer raised cancellation concern as he/she has purchased a new RO. Retention offer was shared with the customer. Customer agreed to continue. Hence, case retained.');}return lines.join('\n');}
  if(s.competitor||s.pricehike||(s.customplan&&!s.replace)){lines.push('Customer raised cancellation concern due to'+(s.competitor?' cost issue as competitor is offering cheaper plan.':(s.pricehike?' recent price hike.':' cost issue and request for customized plan.')));if(s.buyback){var amt4=bb?'â‚¹'+bb:'the applicable amount';lines.push('Buyback option was suggested at '+amt4+'. Customer '+(bb?'agreed and will confirm.':'will decide and update.')+' Hence, case retained on buyback offer.');}else if(det&&det.match(/coupon|rs|offer/i)){lines.push('Retention offer shared â€” '+det+'. Customer agreed to recharge with the coupon applied. Hence, case retained.');}else{lines.push('Applicable retention offer and plan benefits were explained. Customer agreed to continue. Hence, case retained.');}return lines.join('\n');}
  if(s.buyback&&!s.replace&&!s['shift-nf']&&!s['shift-sv']&&!s.newro){var amt5=bb?'â‚¹'+bb:'the applicable amount';lines.push('Customer raised cancellation concern.');lines.push('Buyback option was suggested and offered at '+amt5+(bb?' after applicable adjustments and discount.':'.'));lines.push('Customer will '+(bb?'think and revert with final confirmation.':'decide and update.'));lines.push('Hence, case retained on buyback offer.');return lines.join('\n');}
  if(s.replace){if(s.refurb){lines.push('Customer raised cancellation concern stating that a refurbished RO unit was received. Images were reviewed and discussed over the call.');}else if(s.pcb){lines.push('As per update, PCB needs to be replaced; however, PCB is currently not available in the service area.');lines.push('Customer clearly stated that only replacement or cancellation would be acceptable.');}else if(s.recurring){lines.push('Customer is facing recurring service issues and clearly stated that only replacement or cancellation would be acceptable.');}else{lines.push('Customer was demanding either replacement or cancellation and clearly stated that only replacement would be acceptable.');}lines.push('To avoid cancellation, replacement has been provided'+(det?' with '+det+' machine':'')+' as per applicable policy.');if(s.pcb||s.replace)lines.push('Mail shared with concerned team for further action.');lines.push('Hence, case retained on replacement.');return lines.join('\n');}
  var isSenior=s.senior||s.pcb||(s.recurring&&!s.tech);
  var techWord=isSenior?'senior technician':'technician';
  if(s.recurring){lines.push('Customer is facing recurring service issues and raised cancellation concern.');if(s.tds)lines.push('Customer also reported taste and TDS concern in the RO unit.');if(s.leakage)lines.push('Leakage issue has also been reported.');if(s.filter)lines.push('Customer also requested filter replacement.');}else if(s.pcb&&s.sync){lines.push('Customer is facing repeated syncing issue in the RO unit. As confirmed internally, PCB issue has been identified.');}else if(s.pcb){lines.push('Customer is facing repeated syncing issue in the RO unit. PCB issue confirmed from backend team.');}else if(s.beep&&s.sync){lines.push('Customer reported beep sound issue and sync issue in the RO unit.');}else if(s.beep){lines.push('Customer reported beep sound issue in the RO unit.');}else if(s.sync){lines.push('Customer is facing sync / connectivity issue with the RO unit.');}else if(s.tds&&s.leakage){lines.push('Customer is facing taste issue, TDS concern, and leakage issue in the RO unit.');if(s.filter)lines.push('Customer also requested filter replacement.');}else if(s.tds){lines.push('Customer is facing taste issue and TDS concern in the RO unit.');}else if(s.leakage){lines.push('Customer is facing leakage issue in the RO unit.');}else if(s.flow){lines.push('Customer is using the RO; however, consumption is showing zero. Flow sensor issue confirmed from backend team.');}else if(s.consumption){lines.push('Customer raised concern that consumption is showing incorrect data. Litres are getting exhausted earlier than expected.');}else if(s.lowcons){lines.push('Customer informed that water consumption is low and expressed concern regarding the same.');}else if(s.delay){lines.push('Customer raised cancellation concern due to delay in service'+(s.reinstall?' / reinstallation':'')+'.');}else{lines.push('Customer raised cancellation concern due to service issue and requested immediate resolution.');}
  if(s.lowcons&&s.buyback){lines.push('Information regarding the plan and consumption was shared. Buyback option was also suggested at '+(bb?'â‚¹'+bb:'applicable amount')+'.');lines.push('Customer will update with final decision. Hence, case retained.');return lines.join('\n');}
  var waitTime=vb?'till '+vb:'for 24 hours';
  if(isSenior){lines.push('Informed customer to wait '+waitTime+' for senior technician visit for proper checking and resolution.');if(s.filter)lines.push('Filter replacement request has also been noted and will be checked during the visit.');if(s.tds)lines.push('TDS and taste concern has also been noted for resolution during the visit.');}else{lines.push('Informed customer to wait '+waitTime+' for technician visit for proper checking and resolution.');if(s.tds)lines.push('TDS and taste concern to be resolved during the visit.');}
  if(gg)lines.push(gg+' days given as GG.');
  lines.push('Same has been informed to the service team for necessary action.');
  lines.push('Customer agreed to wait. Hence, case retained on '+techWord+' visit.');
  return lines.join('\n');
}

function genServiceMail(rough,agent,sc,ex){
  var s={};sc.forEach(function(k){s[k]=true;});
  var vb=ex.visitBy,gg=ex.gg;
  var isSenior=s.senior||s.pcb||s.recurring||(s.beep&&s.sync);
  var tw=isSenior?'senior technician':'technician';
  var timeline=vb?'by '+vb:'within 24 hours';
  var issues=[];
  if(s.beep)issues.push('Beep Sound Issue');if(s.pcb)issues.push('PCB Issue');if(s.sync)issues.push('Sync Issue');if(s.tds)issues.push('Taste & TDS Issue');if(s.leakage)issues.push('Leakage Issue');if(s.filter)issues.push('Filter Replacement Required');if(s.flow)issues.push('Flow Sensor Issue');if(s.recurring)issues.push('Recurring Multiple Issues');if(s.consumption)issues.push('Incorrect Consumption');if(s.lowcons)issues.push('Consumption Issue');if(s.delay)issues.push('Service Delay');if(s.reinstall)issues.push('Reinstallation Pending');
  if(issues.length===0)issues.push('Priority');
  var subj=(isSenior?'Arrange Senior Technician Visit':'Arrange Technician Visit')+' â€“ '+issues.join(' & ');
  var body='Dear Service Team,\n\n';
  if(s.pcb)body+='Customer is facing repeated syncing issue in RO. Internally, PCB issue has been confirmed.\n\n';
  else if(s.beep&&s.sync)body+='Customer is facing beep sound issue and sync issue in the RO unit.\n\n';
  else if(s.tds&&s.leakage)body+='Customer is facing taste issue, TDS concern, and leakage issue.\n\n';
  else if(s.tds)body+='Customer is facing taste issue and TDS concern in the RO unit.\n\n';
  else if(s.flow)body+='Customer\'s consumption is showing zero. Flow sensor issue confirmed by backend.\n\n';
  else if(s.consumption)body+='Customer is facing incorrect consumption â€” litres exhausting before expected time.\n\n';
  else if(s.recurring)body+='Customer is facing recurring multiple issues in the RO unit.\n\n';
  else if(s.delay)body+='Customer is facing delay in service'+(s.reinstall?' / reinstallation':'')+'. \n\n';
  else body+='Customer has raised concern regarding the RO unit.\n\n';
  if(s.filter)body+='Please check and replace filter as required during the visit.\n\n';
  body+='Kindly arrange '+tw+' visit '+timeline+' on priority basis.\n\n';
  if(gg)body+='Note: '+gg+' days GG committed. Please ensure resolution within this timeline.\n\n';
  body+='Please update once visit is completed.\n\nRegards,\n'+agent;
  return {subject:subj,body:body};
}

function genReplacementMail(rough,agent,sc,ex){
  var s={};sc.forEach(function(k){s[k]=true;});
  var det=ex.detail;
  var subj,body;
  if(s.pcb){subj='Replacement Required â€“ PCB Unavailable in Area';body='Dear Replacement Team,\n\nPCB replacement is required; however, PCB is currently not available in the service area.\n\nCustomer has clearly stated only replacement or cancellation is acceptable. Kindly process on priority to avoid cancellation.\n\nPlease confirm once done.\n\nRegards,\n'+agent;}
  else if(s.refurb){subj='Replacement Required â€“ Refurbished Unit Issue';body='Dear Replacement Team,\n\nCustomer raised concern regarding receiving a refurbished RO unit. Images reviewed over the call.\n\nKindly process replacement on priority and confirm.\n\nRegards,\n'+agent;}
  else if(det){subj='Replacement Required â€“ '+det+' Machine';body='Dear Replacement Team,\n\nReplacement with '+det+' machine has been committed to the customer.\n\nKindly process on priority and confirm once done.\n\nRegards,\n'+agent;}
  else if(s.recurring){subj='Replacement Required â€“ Recurring Issue';body='Dear Replacement Team,\n\nCustomer is facing recurring issues and clearly requested replacement to avoid cancellation. Replacement committed from our end.\n\nKindly process on priority.\n\nRegards,\n'+agent;}
  else{subj='Replacement Processing Required â€“ Priority';body='Dear Replacement Team,\n\nCustomer has clearly stated only replacement is acceptable to avoid cancellation. Replacement committed.\n\nKindly process on priority and confirm.\n\nRegards,\n'+agent;}
  return {subject:subj,body:body};
}

function genConcernMail(rough,agent,sc,ex){
  var s={};sc.forEach(function(k){s[k]=true;});
  var bb=ex.bb;
  var subj,body;
  if(s.waiveoff){subj='Waive Off Request â€“ Customer Case';body='Dear Team,\n\nCustomer is requesting waive off of negative balance amount.\n\nKindly review and approve the waive off request on priority to avoid cancellation.\n\nPlease confirm once processed.\n\nRegards,\n'+agent;}
  else if(s.court){subj='Escalation â€“ Consumer Court Concern';body='Dear Concern Team,\n\nCustomer has threatened to proceed with consumer court complaint due to service delay. No cancellation raised as of now.\n\nKindly take necessary action on priority to avoid further escalation.\n\nRegards,\n'+agent;}
  else if(s.replace){subj='Replacement Approval Required â€“ Priority';body='Dear Concern Team,\n\nReplacement committed to customer to avoid cancellation. Kindly process and approve at the earliest.\n\nPlease update once done.\n\nRegards,\n'+agent;}
  else if(s.buyback&&bb){subj='Buyback Case â€“ Amount â‚¹'+bb+' â€“ Action Required';body='Dear Concern Team,\n\nBuyback offered to customer at â‚¹'+bb+'. Customer will confirm after discussion.\n\nKindly process the buyback once customer confirms. Please ensure link is sent if not done.\n\nRegards,\n'+agent;}
  else if(s.angry){subj='Escalation Case â€“ Action Required';body='Dear Concern Team,\n\nCustomer is highly dissatisfied. Kindly ensure immediate follow-up and resolution to prevent further escalation.\n\nRegards,\n'+agent;}
  else{subj='Concern Case â€“ Action Required';body='Dear Concern Team,\n\nSharing case for your necessary action. Kindly ensure committed resolution is fulfilled within the agreed timeline.\n\nRegards,\n'+agent;}
  return {subject:subj,body:body};
}

function genCustomMail(teamName,rough,agent,sc,ex){
  return {subject:teamName+' â€“ Action Required',body:'Dear '+teamName+',\n\nSharing case for your necessary action. Kindly ensure the committed action is fulfilled within the agreed timeline.\n\nRegards,\n'+agent};
}

// â”€â”€ MAIN GENERATE â”€â”€
async function doGen(){
  var rough=document.getElementById('roughInp').value.trim();
  var agent=document.getElementById('rmAgent').value.trim()||'Agent';
  if(!rough){ toast('Pehle remarks daalo','err'); return; }

  var apiKey=localStorage.getItem('lv_groq_key')||'';
  if(!apiKey){ toast('Pehle Groq API Key save karo!','err'); return; }

  var ex={bb:document.getElementById('bbAmt').value.trim(),gg:document.getElementById('ggDays').value.trim(),visitBy:document.getElementById('visitBy').value.trim(),detail:document.getElementById('extraDetail').value.trim()};
  var btn=document.getElementById('genBtn');
  btn.disabled=true; btn.textContent='â³ Generating...';

  var manualSc=Object.keys(SC).filter(function(k){return SC[k];});
  var autoSc=detect(rough);
  var allSc=manualSc.slice();
  autoSc.forEach(function(s){if(allSc.indexOf(s)===-1)allSc.push(s);});

  var teams=[];
  if(SEL['s'])teams.push('Service Team');
  if(SEL['r'])teams.push('Replacement Team');
  if(SEL['c'])teams.push('Concern Team');
  EXTRA.forEach(function(t){if(SEL[t.id])teams.push(t.name);});

  var extraCtx='';
  if(ex.bb) extraCtx+='\nBuyback Amount: â‚¹'+ex.bb;
  if(ex.gg) extraCtx+='\nGG Days: '+ex.gg;
  if(ex.visitBy) extraCtx+='\nVisit By: '+ex.visitBy;
  if(ex.detail) extraCtx+='\nMachine/Detail: '+ex.detail;

  var mailInstr='';
  if(teams.length>0){
    mailInstr='\n\nAb in teams ke liye professional emails generate karo:\n'+teams.map(function(t){return'- '+t;}).join('\n');
    mailInstr+='\n\nHar email exactly is format mein do:\n~~~EMAIL~~~\nTEAM: [team name]\nSUBJECT: [subject line]\nBODY:\n[email body]\n~~~END~~~';
    mailInstr+='\n\nEmail rules:\n- Service Team mail mein retention/retained BILKUL mat likho â€” sirf issue aur action needed\n- Short, direct, professional\n- End with: Regards,\n'+agent;
  }

  var prompt='Tu Livsmart RO company ka CX Retention Agent hai. Rough remarks ko professional format mein convert kar.\n\nROUGH REMARKS: "'+rough+'"'+extraCtx+'\n\nStep 1 â€” Agent Remarks exactly is format mein likho:\n~~~REMARKS~~~\n[Professional remarks â€” past tense, 3-4 lines, "Hence, case retained." se khatam karo]\n~~~END~~~\n'+mailInstr+'\n\nSirf format mein response do, extra explanation nahi.';

  try {
    var res=await fetch('https://api.groq.com/openai/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},
      body:JSON.stringify({model:'llama-3.3-70b-versatile',max_tokens:1500,temperature:0.3,messages:[{role:'user',content:prompt}]})
    });
    var data=await res.json();
    if(data.error) throw new Error(data.error.message||'API error');
    var text='';
    if(data.choices&&data.choices[0]&&data.choices[0].message){
      text=data.choices[0].message.content||'';
    }
    if(!text) throw new Error('Empty response');

    var rm='';
    var rmMatch=text.match(/~~~REMARKS~~~([\s\S]*?)~~~END~~~/);
    if(rmMatch) rm=rmMatch[1].trim();
    else rm=text.split('~~~EMAIL~~~')[0].replace(/~~~REMARKS~~~/g,'').trim();

    var emails={};
    var start=0;
    while(true){
      var eStart=text.indexOf('~~~EMAIL~~~',start);
      if(eStart===-1) break;
      var eEnd=text.indexOf('~~~END~~~',eStart);
      if(eEnd===-1) break;
      var block=text.substring(eStart+11,eEnd).trim();
      var lines=block.split('\n');
      var teamName='',subject='',bodyLines=[],inBody=false;
      for(var li=0;li<lines.length;li++){
        var line=lines[li];
        if(line.indexOf('TEAM:')===0) teamName=line.substring(5).trim();
        else if(line.indexOf('SUBJECT:')===0) subject=line.substring(8).trim();
        else if(line.indexOf('BODY:')===0) inBody=true;
        else if(inBody) bodyLines.push(line);
      }
      if(teamName) emails[teamName]={subject:subject,body:bodyLines.join('\n').trim()};
      start=eEnd+9;
    }

    renderOut(teams,rm,emails);
    saveHist({rough:rough,agent:agent,teams:teams,rm:rm,emails:emails});
    toast('Generated âœ“','ok');
  } catch(e) {
    toast('Error: '+e.message,'err');
    console.error(e);
  }
  btn.disabled=false; btn.textContent='âš¡ Generate Remarks & Mails';
}

function renderOut(teams,rm,emails){
  ['rm','s','r','c'].forEach(function(k){var c=document.getElementById('card-'+k);c.classList.remove('show','full');});
  document.querySelectorAll('.xcard').forEach(function(e){e.remove();});
  var rmCard=document.getElementById('card-rm');
  rmCard.classList.add('show');
  if(teams.length===0) rmCard.classList.add('full');
  document.getElementById('rm-body').textContent=rm;
  var kmap={'Service Team':'s','Replacement Team':'r','Concern Team':'c'};
  teams.forEach(function(team){
    var ed=emails[team]||{subject:'',body:''};
    var k=kmap[team];
    if(k){
      document.getElementById('card-'+k).classList.add('show');
      document.getElementById(k+'-subj').innerHTML='Subject: <b>'+ed.subject+'</b>';
      document.getElementById(k+'-body').textContent=ed.body;
    } else {
      var nc=document.createElement('div');
      nc.className='out-card show xcard';
      var xid='x'+Date.now()+Math.random().toString(36).substr(2,4);
      nc.innerHTML='<div class="out-hdr"><div class="out-title"><span class="out-dot" style="background:var(--blue)"></span>'+team+'</div><button class="copy-btn" onclick="doCopy(\''+xid+'-b\',null,\''+xid+'-s\')">Copy</button></div><div class="out-subj" id="'+xid+'-s">Subject: <b>'+ed.subject+'</b></div><div class="out-body" id="'+xid+'-b">'+ed.body+'</div>';
      document.getElementById('rmOutput').appendChild(nc);
    }
  });
}

function doCopy(bodyId,btnId,subjId){
  var body=document.getElementById(bodyId)?document.getElementById(bodyId).textContent:'';
  var text=body;
  if(subjId&&document.getElementById(subjId)){var b=document.getElementById(subjId).querySelector('b');text='Subject: '+(b?b.textContent:'')+'\n\n'+body;}
  navigator.clipboard.writeText(text).then(function(){
    toast('Copied!','ok');
    if(btnId){var el=document.getElementById(btnId);if(el){el.textContent='âœ“ Copied';el.classList.add('done');setTimeout(function(){el.textContent='Copy';el.classList.remove('done');},2000);}}
  });
}

function saveHist(d){HIST.unshift({id:Date.now(),rough:d.rough.substring(0,120),teams:d.teams,rm:d.rm,emails:d.emails,agent:d.agent,at:new Date().toISOString()});if(HIST.length>15)HIST=HIST.slice(0,15);localStorage.setItem('lv_hist2',JSON.stringify(HIST));renderHist();}
function renderHist(){
  var sec=document.getElementById('histSec'),list=document.getElementById('rmHistList');
  if(!HIST.length){sec.style.display='none';return;}
  sec.style.display='block';
  var tm={'Service Team':'ts','Replacement Team':'tr','Concern Team':'tc'};
  var h='';
  HIST.slice(0,8).forEach(function(x){
    var tags=(x.teams||[]).map(function(t){return'<span class="htag '+(tm[t]||'te')+'">'+t.split(' ')[0]+'</span>';}).join('');
    h+='<div class="h-item" onclick="loadH('+x.id+')"><div class="h-row"><span class="h-time">'+new Date(x.at).toLocaleString('en-IN')+'</span><div class="h-tags">'+tags+'</div></div><div class="h-text">'+x.rough+'</div></div>';
  });
  list.innerHTML=h;
}
function loadH(id){var item=HIST.filter(function(h){return h.id===id;})[0];if(!item)return;document.getElementById('roughInp').value=item.rough;renderOut(item.teams||[],item.rm||'',item.emails||{});toast('Loaded from history','ok');window.scrollTo({top:0,behavior:'smooth'});}
function clearHist(){HIST=[];localStorage.removeItem('lv_hist2');renderHist();toast('History cleared','ok');}

function openModal(){document.getElementById('addModal').classList.add('show');setTimeout(function(){document.getElementById('newTeamInp').focus();},80);}
function closeModal(){document.getElementById('addModal').classList.remove('show');document.getElementById('newTeamInp').value='';}
document.getElementById('addModal').onclick=function(e){if(e.target===this)closeModal();};
function saveTeam(){var name=document.getElementById('newTeamInp').value.trim();if(!name){toast('Team naam likho','err');return;}var id='e'+Date.now();EXTRA.push({id:id,name:name});localStorage.setItem('lv_extra',JSON.stringify(EXTRA));renderExtra();closeModal();toast('Team added âœ“','ok');}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ CALLING ENGINE â€” JsSIP + WebRTC + tel: fallback
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _ua = null;          // JsSIP UserAgent
let _session = null;     // Active call session
let _callTimer = null;   // Timer interval
let _callSeconds = 0;    // Call duration counter
let _dialNumber = '';    // Current dialed number
let _sipReady = false;   // SIP connection status
let _callStartTime = null;

// â”€â”€ Load SIP config from localStorage â”€â”€
function getSIPConfig() {
  try { return JSON.parse(localStorage.getItem('lv_sip_config') || '{}'); } catch(e) { return {}; }
}

// â”€â”€ Dialer open/close â”€â”€
function openDialer() {
  const w = document.getElementById('dialerWidget');
  if(!w) return;
  if(w.style.display === 'none' || !w.style.display) {
    w.style.display = 'block';
    w.style.animation = 'fadeIn .3s ease';
    // Auto-connect SIP if config exists
    const cfg = getSIPConfig();
    if(cfg.server && cfg.user && cfg.pass && !_sipReady) connectSIP();
    // Show tel fallback if no SIP
    if(!cfg.server) {
      document.getElementById('telFallback').style.display = 'flex';
    }
  } else {
    w.style.display = 'none';
  }
}

// â”€â”€ Dialpad input â”€â”€
function dialPad(key) {
  if(_dialNumber.length >= 15) return;
  _dialNumber += key;
  updateDialDisplay();
  // DTMF during call
  if(_session && _session.isEstablished()) {
    try { _session.sendDTMF(key); } catch(e) {}
  }
}

function dialBackspace() {
  _dialNumber = _dialNumber.slice(0, -1);
  updateDialDisplay();
}

function updateDialDisplay() {
  const el = document.getElementById('dialDisplay');
  if(el) el.textContent = _dialNumber || 'Enter Number';
}

// â”€â”€ Format number for SIP â”€â”€
function formatSIPNumber(num) {
  const clean = num.replace(/\D/g, '');
  // Add country code if needed
  if(clean.length === 10) return '91' + clean;
  return clean;
}

// â”€â”€ Connect SIP â”€â”€
function connectSIP() {
  if(typeof JsSIP === 'undefined') {
    console.warn('JsSIP not loaded');
    updateSIPStatus(false, 'JsSIP load nahi hua');
    return;
  }
  const cfg = getSIPConfig();
  if(!cfg.server || !cfg.user || !cfg.pass) {
    updateSIPStatus(false, 'SIP config missing');
    return;
  }

  try {
    // Disconnect existing
    if(_ua) { try { _ua.stop(); } catch(e) {} }

    JsSIP.debug.disable('JsSIP:*');

    const socket = new JsSIP.WebSocketInterface(cfg.server);
    _ua = new JsSIP.UA({
      sockets: [socket],
      uri: `sip:${cfg.user}@${cfg.server.replace('wss://','').replace('ws://','').split('/')[0].split(':')[0]}`,
      password: cfg.pass,
      display_name: cfg.name || window._profile?.name || 'Agent',
      register: true,
      register_expires: 300,
      contact_uri: `sip:${cfg.user}@${cfg.server.replace('wss://','').replace('ws://','').split('/')[0].split(':')[0]}`,
      user_agent: 'LivsmartCRM/3.0'
    });

    _ua.on('registered', () => {
      _sipReady = true;
      updateSIPStatus(true, 'SIP: Connected âœ…');
      showToast('SIP Connected! Calls ready ğŸ“', 'ok');
    });

    _ua.on('unregistered', () => {
      _sipReady = false;
      updateSIPStatus(false, 'SIP: Disconnected');
    });

    _ua.on('registrationFailed', (e) => {
      _sipReady = false;
      updateSIPStatus(false, 'SIP: Auth failed âŒ');
      showToast('SIP registration failed: ' + (e.cause || 'Check credentials'), 'err');
    });

    _ua.on('newRTCSession', (data) => {
      if(data.originator === 'remote') {
        // Incoming call
        _session = data.session;
        handleIncomingCall(data);
      }
    });

    _ua.start();
    updateSIPStatus(null, 'SIP: Connecting...');

  } catch(e) {
    console.error('SIP connect error:', e);
    updateSIPStatus(false, 'SIP Error: ' + e.message);
  }
}

function disconnectSIP() {
  if(_ua) { try { _ua.stop(); } catch(e) {} _ua = null; }
  _sipReady = false;
  _session = null;
  updateSIPStatus(false, 'SIP: Disconnected');
  showToast('SIP disconnected', 'info');
}

// â”€â”€ Update SIP status indicator â”€â”€
function updateSIPStatus(connected, text) {
  const dot = document.getElementById('sipStatusDot');
  const txt = document.getElementById('sipStatusText');
  if(dot) dot.style.background = connected === true ? '#22c55e' : connected === null ? '#f59e0b' : '#ef4444';
  if(txt) txt.textContent = text || '';
}

// â”€â”€ Start Call â”€â”€
function startCall() {
  if(!_dialNumber || _dialNumber.length < 6) {
    showToast('Number daalo pehle!', 'warn'); return;
  }

  const cfg = getSIPConfig();

  // Try SIP first
  if(_sipReady && _ua && typeof JsSIP !== 'undefined') {
    startSIPCall();
  } else if(cfg.fallback !== false) {
    // Fallback to tel: link
    startTelCall();
  } else {
    showToast('SIP connect nahi hai. Settings check karo.', 'err');
  }
}

// â”€â”€ SIP Call â”€â”€
function startSIPCall() {
  const cfg = getSIPConfig();
  const domain = cfg.server.replace('wss://','').replace('ws://','').split('/')[0].split(':')[0];
  const target = `sip:${formatSIPNumber(_dialNumber)}@${domain}`;

  const options = {
    mediaConstraints: { audio: true, video: false },
    rtcOfferConstraints: { offerToReceiveAudio: true, offerToReceiveVideo: false },
    pcConfig: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    }
  };

  try {
    _session = _ua.call(target, options);
    _callStartTime = Date.now();

    _session.on('progress', () => {
      showCallStatus('ğŸ“', 'Ringing...', true);
    });

    _session.on('accepted', () => {
      showCallStatus('âœ…', 'Connected', true);
      startCallTimer();
      // Connect remote audio
      _session.connection.addEventListener('track', (e) => {
        const audio = document.getElementById('remoteAudio');
        if(audio && e.streams[0]) audio.srcObject = e.streams[0];
      });
      document.getElementById('callBtn').style.display = 'none';
      document.getElementById('hangupBtn').style.display = 'flex';
    });

    _session.on('ended', () => onCallEnded('connected'));
    _session.on('failed', (e) => {
      showToast('Call failed: ' + (e.cause || 'unknown'), 'err');
      onCallEnded('not_connected');
    });

  } catch(e) {
    console.error('SIP call error:', e);
    showToast('Call error: ' + e.message, 'err');
    // Fallback to tel:
    startTelCall();
  }
}

// â”€â”€ tel: Fallback â”€â”€
function startTelCall() {
  const num = formatSIPNumber(_dialNumber);
  const telLink = document.getElementById('telFallback');

  // Show tel link for mobile
  if(telLink) {
    telLink.href = `tel:+${num}`;
    telLink.style.display = 'flex';
    telLink.click(); // Auto-open on mobile
  }

  // Start timer anyway (manual tracking)
  _callStartTime = Date.now();
  showCallStatus('ğŸ“±', 'Mobile Dialer opened', true);
  startCallTimer();
  document.getElementById('callBtn').style.display = 'none';
  document.getElementById('hangupBtn').style.display = 'flex';
  showToast('ğŸ“± Mobile dialer opened. Timer start hua!', 'info');
}

// â”€â”€ Hang Up â”€â”€
function hangupCall() {
  if(_session) {
    try { _session.terminate(); } catch(e) {}
    _session = null;
  }
  onCallEnded('connected');
}

// â”€â”€ Call ended handler â”€â”€
function onCallEnded(status) {
  stopCallTimer();
  const duration = _callSeconds;
  const mins = String(Math.floor(duration/60)).padStart(2,'0');
  const secs = String(duration%60).padStart(2,'0');
  const durStr = `${mins}:${secs}`;

  document.getElementById('callBtn').style.display = 'flex';
  document.getElementById('hangupBtn').style.display = 'none';
  showCallStatus('ğŸ”´', `Ended Â· ${durStr}`, false);
  document.getElementById('postCallBar').style.display = 'block';

  // Store for quick log
  window._lastCallData = { phone: _dialNumber, duration: durStr, durationSec: duration, status };
  _session = null;
}

// â”€â”€ Incoming call handler â”€â”€
function handleIncomingCall(data) {
  const caller = data.session.remote_identity?.uri?.user || 'Unknown';
  const accept = confirm(`ğŸ“ Incoming call from: ${caller}\n\nAccept karo?`);
  if(accept) {
    data.session.answer({ mediaConstraints: { audio: true, video: false } });
    _dialNumber = caller;
    updateDialDisplay();
    _callStartTime = Date.now();
    showCallStatus('âœ…', 'Connected', true);
    startCallTimer();
    document.getElementById('callBtn').style.display = 'none';
    document.getElementById('hangupBtn').style.display = 'flex';
    document.getElementById('dialerWidget').style.display = 'block';
    data.session.on('ended', () => onCallEnded('connected'));
    data.session.on('failed', () => onCallEnded('not_connected'));
  } else {
    data.session.terminate();
  }
}

// â”€â”€ Timer â”€â”€
function startCallTimer() {
  _callSeconds = 0;
  clearInterval(_callTimer);
  _callTimer = setInterval(() => {
    _callSeconds++;
    const m = String(Math.floor(_callSeconds/60)).padStart(2,'0');
    const s = String(_callSeconds%60).padStart(2,'0');
    const el = document.getElementById('liveTimer');
    if(el) el.textContent = `${m}:${s}`;
  }, 1000);
}

function stopCallTimer() {
  clearInterval(_callTimer);
  _callTimer = null;
}

// â”€â”€ Call status bar â”€â”€
function showCallStatus(icon, msg, show) {
  const bar = document.getElementById('callStatusBar');
  if(!bar) return;
  bar.style.display = show ? 'block' : 'none';
  const ic = document.getElementById('callStatusIcon');
  const ms = document.getElementById('callStatusMsg');
  if(ic) ic.textContent = icon;
  if(ms) ms.textContent = msg;
}

// â”€â”€ Quick log after call â”€â”€
function quickLog(status) {
  const d = window._lastCallData || {};
  // Pre-fill call modal
  const modal = document.getElementById('callModal');
  if(modal) {
    modal.classList.add('show');
    setTimeout(() => {
      const ph = document.getElementById('cm-phone');
      const dur = document.getElementById('cm-duration');
      const st = document.getElementById('cm-status');
      if(ph && d.phone) ph.value = d.phone;
      if(dur && d.duration) dur.value = d.duration;
      if(st) st.value = status;
    }, 100);
  }
  document.getElementById('postCallBar').style.display = 'none';
  // Reset dialer
  _dialNumber = '';
  updateDialDisplay();
  document.getElementById('liveTimer').textContent = '00:00';
  showCallStatus('', '', false);
}

// â”€â”€ Call from number (used in call log rows) â”€â”€
function callNumber(num, name) {
  _dialNumber = num.replace(/\D/g,'');
  updateDialDisplay();
  // Show caller name
  const cn = document.getElementById('callerName');
  if(cn) cn.textContent = name || '';
  openDialer();
  // Auto start call after brief delay
  setTimeout(startCall, 500);
}

// â”€â”€ SIP Settings â”€â”€
function openSIPSettings() {
  const cfg = getSIPConfig();
  const sv = document.getElementById('sip-server'); if(sv) sv.value = cfg.server || 'wss://sip.zadarma.com';
  const su = document.getElementById('sip-user'); if(su) su.value = cfg.user || '';
  const sp = document.getElementById('sip-pass'); if(sp) sp.value = cfg.pass || '';
  const sn = document.getElementById('sip-name'); if(sn) sn.value = cfg.name || window._profile?.name || '';
  const sf = document.getElementById('sip-fallback'); if(sf) sf.checked = cfg.fallback !== false;
  const m = document.getElementById('sipModal');
  if(m) m.classList.add('show');
}

function closeSIPSettings() {
  const m = document.getElementById('sipModal');
  if(m) m.classList.remove('show');
}

function saveSIPConfig() {
  const cfg = {
    server: document.getElementById('sip-server').value.trim(),
    user: document.getElementById('sip-user').value.trim(),
    pass: document.getElementById('sip-pass').value.trim(),
    name: document.getElementById('sip-name').value.trim(),
    fallback: document.getElementById('sip-fallback').checked
  };
  if(!cfg.server || !cfg.user || !cfg.pass) {
    showToast('Server, username aur password required!', 'err'); return;
  }
  localStorage.setItem('lv_sip_config', JSON.stringify(cfg));
  showToast('SIP config saved! Connecting...', 'ok');
  closeSIPSettings();
  connectSIP();
}

// â”€â”€ Auto-connect on calls panel open â”€â”€
const _origSwitchPanel = window.switchPanel;

// toastT defined above; toast() â†’ alias for showToast()
function toast(msg,type){ showToast(msg, type||'ok'); }

// â”€â”€ REMARKS STUB FUNCTIONS (if not defined by remarks engine) â”€â”€
if(typeof loadRemarksKey === 'undefined') {
  window.loadRemarksKey = function() {
    const key = localStorage.getItem('lv_ai_key2') || '';
    const inp = document.getElementById('rmApiKey');
    if(inp) inp.value = key;
    updateKeyStatus(key);
  };
}
if(typeof renderScChips === 'undefined') {
  window.renderScChips = function() {
    const el = document.getElementById('scChips');
    if(el && el.children.length === 0) el.innerHTML = '<span style="color:var(--muted);font-size:12px">Scenarios load ho rahe hain...</span>';
  };
}
if(typeof renderTeamChips === 'undefined') {
  window.renderTeamChips = function() {
    const el = document.getElementById('teamChips');
    if(el && el.children.length === 0) el.innerHTML = '<span style="color:var(--muted);font-size:12px">Teams load ho rahe hain...</span>';
  };
}
if(typeof renderRmHist === 'undefined') {
  window.renderRmHist = function() {
    try {
      const hist = JSON.parse(localStorage.getItem('lv_hist2') || '[]');
      const el = document.getElementById('rmHistList');
      if(!el) return;
      if(!hist.length) { el.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px">No history yet</div>'; return; }
      el.innerHTML = hist.map((h,i) => `<div style="padding:6px 8px;border-bottom:1px solid var(--border);font-size:12px;cursor:pointer" onclick="loadFromHist(${i})">${h.rough || 'Report '+i}</div>`).join('');
    } catch(e) {}
  };
}

function initRemarksPanel() {
  try { if(typeof loadRemarksKey==='function') loadRemarksKey(); } catch(e){}
  try { if(typeof renderScChips==='function') renderScChips(); } catch(e){}
  try { if(typeof renderTeamChips==='function') renderTeamChips(); } catch(e){}
  try { if(typeof renderRmHist==='function') renderRmHist(); } catch(e){}
}
function openAddTeamModal() { const m=document.getElementById('addTeamModal'); if(m) m.classList.add('show'); }
function closeTeamModal() { const m=document.getElementById('addTeamModal'); if(m) m.classList.remove('show'); }
function saveApiKey() {
  const key = document.getElementById('rmApiKey')?.value.trim();
  if(key) { localStorage.setItem('lv_ai_key2', key); showToast('API key saved!'); updateKeyStatus(key); }
}
function clearRmHist() { if(confirm('History clear karo?')){ localStorage.removeItem('lv_hist2'); renderRmHist && renderRmHist(); } }
// saveTeam defined above from remarks engine

</script>

<!-- â•â•â•â•â•â• SIP SETTINGS MODAL â•â•â•â•â•â• -->
<div class="modal-bg" id="sipModal">
<div class="modal" style="max-width:440px">
  <div class="modal-box" style="max-width:440px">
    <div class="modal-hdr">
      <span>âš™ï¸ SIP / Calling Setup</span>
      <button class="modal-close" onclick="closeSIPSettings()">âœ•</button>
    </div>
    <div style="padding:20px">
      <div style="background:rgba(20,184,166,0.08);border:1px solid #14b8a640;border-radius:10px;padding:12px;margin-bottom:16px;font-size:12px;color:var(--muted)">
        ğŸ’¡ <strong style="color:#14b8a6">Free SIP Account kaise banaye?</strong><br>
        1. <a href="https://zadarma.com" target="_blank" style="color:#14b8a6">zadarma.com</a> pe free account banao<br>
        2. SIP credentials copy karo (Settings â†’ SIP)<br>
        3. Neeche fill karo â†’ Connect dabao<br><br>
        Ya <a href="https://linphone.org" target="_blank" style="color:#14b8a6">linphone.org</a> pe bhi free account milega
      </div>
      <div style="display:flex;flex-direction:column;gap:12px">
        <div>
          <label class="form-label">SIP Server (WebSocket)</label>
          <input class="form-inp" id="sip-server" placeholder="wss://zadarma.com:443" value="">
          <div style="font-size:11px;color:var(--muted);margin-top:3px">Zadarma: wss://sip.zadarma.com Â· Linphone: wss://sip.linphone.org</div>
        </div>
        <div>
          <label class="form-label">SIP Username</label>
          <input class="form-inp" id="sip-user" placeholder="your_sip_username">
        </div>
        <div>
          <label class="form-label">SIP Password</label>
          <input class="form-inp" id="sip-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <div>
          <label class="form-label">Display Name (Agent naam)</label>
          <input class="form-inp" id="sip-name" placeholder="Agent Name">
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
          <label style="font-size:13px;color:var(--muted)">Mobile Fallback (tel: link):</label>
          <input type="checkbox" id="sip-fallback" checked style="width:16px;height:16px;accent-color:#14b8a6">
          <span style="font-size:12px;color:var(--muted)">SIP fail hone pe mobile dialer</span>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:20px">
        <button class="btn btn-pri" onclick="saveSIPConfig()" style="flex:1">ğŸ’¾ Save & Connect</button>
        <button class="btn btn-ghost" onclick="disconnectSIP()" style="flex:1">ğŸ”Œ Disconnect</button>
      </div>
      <div id="sipTestResult" style="display:none;margin-top:12px;padding:10px;border-radius:8px;font-size:13px"></div>
    </div>
  </div>
</div>
</div>

<!-- Audio element for calls -->
<audio id="remoteAudio" autoplay style="display:none"></audio>

</body>
</html>
